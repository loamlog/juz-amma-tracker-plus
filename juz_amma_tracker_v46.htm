<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5">
<title>Juz' Amma Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
/* Colors */
--bg:#FAF9F7;--card:#FFFFFF;--card2:#F5F3F0;
--pri:#6B5B7A;--pri-l:#8A7A99;--pri-ll:#E8E4EC;
--sec:#7A9E9F;--sec-l:#B5D1D1;--sec-ll:#E5F0F0;
--tafsir:#C4867B;--tafsir-l:#E8C4BE;--tafsir-ll:#FBF0EE;
--overview:#8B9DC3;--overview-l:#C5D0E8;--overview-ll:#E8ECF5;
--reasons:#A89078;--reasons-l:#D4C4B4;--reasons-ll:#F0EAE4;
--gold:#B8956B;--gold-l:#F5EEE4;--note:#E8A64C;--note-l:#FFF8EC;
--done:#7A9E7A;--done-l:#E5F0E5;
--pink:#D4738C;--pink-l:#EFBBC9;--pink-ll:#FDF2F5;
--txt:#333333;--txt2:#555555;--txt3:#777777;
--bdr:#E5E2DE;--bdr-l:#EFECE8;
/* Type Scale - 8 sizes */
--text-3xs:clamp(0.5rem,0.45rem + 0.25vw,0.625rem);
--text-2xs:clamp(0.625rem,0.575rem + 0.25vw,0.75rem);
--text-xs:clamp(0.75rem,0.7rem + 0.25vw,0.875rem);
--text-sm:clamp(0.813rem,0.763rem + 0.25vw,0.938rem);
--text-base:clamp(0.875rem,0.825rem + 0.25vw,1rem);
--text-md:clamp(1rem,0.95rem + 0.25vw,1.125rem);
--text-lg:clamp(1.125rem,1.075rem + 0.25vw,1.25rem);
--text-xl:clamp(1.25rem,1.2rem + 0.25vw,1.5rem);
--text-2xl:clamp(1.5rem,1.4rem + 0.5vw,1.875rem);
/* Spacing Scale - 8 sizes */
--sp-1:4px;--sp-2:8px;--sp-3:12px;--sp-4:16px;--sp-5:20px;--sp-6:24px;--sp-8:32px;--sp-10:40px;
/* Border Radius - 5 sizes */
--r-xs:4px;--r-sm:8px;--r-md:12px;--r-lg:16px;--r-xl:24px;--r-full:9999px;
/* Shadows */
--shadow-sm:0 1px 2px rgba(0,0,0,0.04);
--shadow:0 2px 8px rgba(0,0,0,0.06);
--shadow-md:0 4px 16px rgba(0,0,0,0.08);
/* Focus */
--focus-ring:0 0 0 3px rgba(107,91,122,0.3);
}
html{font-size:16px}
body{font-family:'Noto Sans Thai',sans-serif;background:var(--bg);color:var(--txt);line-height:1.6;-webkit-font-smoothing:antialiased}
.app{max-width:100%;margin:0 auto;padding:0 var(--sp-4) 100px}
@media(min-width:600px){.app{max-width:560px;padding:0 var(--sp-5) 100px}}
@media(min-width:1024px){.app{max-width:640px;padding:0 var(--sp-6) 100px}}
/* Focus styles for accessibility */
:focus{outline:none}
:focus-visible{outline:2px solid var(--pri);outline-offset:2px;border-radius:var(--r-xs)}
button:focus-visible,a:focus-visible,[tabindex]:focus-visible{box-shadow:var(--focus-ring)}
/* Skip link for screen readers */
.skip-link{position:absolute;top:-40px;left:0;background:var(--pri);color:#fff;padding:var(--sp-2) var(--sp-4);z-index:100;border-radius:0 0 var(--r-sm) 0}
.skip-link:focus{top:0}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

.icon{width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;vertical-align:middle;display:inline-block}
.icon-sm{width:14px;height:14px}

.hdr{padding:var(--sp-8) 0 var(--sp-4);display:flex;justify-content:space-between;align-items:center}
.hdr h1{font-size:var(--text-lg);font-weight:600;color:var(--pri)}
.hdr-user{font-size:var(--text-2xs);color:var(--txt3);margin-top:2px;cursor:pointer;font-family:'Noto Sans Thai',sans-serif}
.streak-box{display:flex;align-items:center;gap:var(--sp-2);background:linear-gradient(135deg,var(--pri),var(--pri-l));color:#fff;padding:var(--sp-2) var(--sp-3);border-radius:var(--r-full);font-size:var(--text-xs);font-weight:600}
.streak-box svg{width:14px;height:14px;fill:#fff;stroke:none}

.basmala{text-align:center;padding:var(--sp-6) var(--sp-4);background:linear-gradient(135deg,var(--tafsir-ll),var(--pri-ll));border-radius:var(--r-lg);margin-bottom:var(--sp-3)}
.basmala-ar{font-family:'Amiri',serif;font-size:var(--text-2xl);color:var(--pri);line-height:1.8}
.basmala-th{font-size:var(--text-2xs);color:var(--txt2);margin-top:var(--sp-2)}

.hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-3);margin-bottom:var(--sp-3)}
.hero-card{background:var(--card);border-radius:var(--r-md);padding:var(--sp-3);box-shadow:var(--shadow-sm);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;border:1px solid var(--bdr-l);min-height:72px;display:flex;flex-direction:column}
.hero-card:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:var(--pri-ll)}
.hero-card:focus-visible{box-shadow:var(--focus-ring)}
.hero-label{font-size:var(--text-3xs);color:var(--txt3);margin-bottom:var(--sp-1);display:flex;justify-content:space-between;align-items:center;font-weight:500}
.hero-label svg{width:12px;height:12px;stroke:var(--pri-l);fill:none;margin-right:4px}
.hero-label a{color:var(--pri);font-weight:500;font-size:var(--text-3xs)}
.hero-text{font-size:var(--text-2xs);color:var(--txt2);line-height:1.5;flex:1}

.stats-box{background:linear-gradient(135deg,var(--pri),var(--pri-l));border-radius:var(--r-xl);padding:var(--sp-4);margin-bottom:var(--sp-3);color:#fff}
.stats-top{display:flex;align-items:center;gap:var(--sp-4);margin-bottom:var(--sp-4)}
.ring-wrap{position:relative;width:60px;height:60px;flex-shrink:0}
.ring-wrap svg{transform:rotate(-90deg)}
.ring-wrap circle{fill:none;stroke-width:5}
.ring-bg{stroke:rgba(255,255,255,0.2)}
.ring-fg{stroke:#E8C4BE;stroke-linecap:round;transition:stroke-dashoffset 0.5s}
.ring-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:var(--text-base);font-weight:700}
.stats-info h2{font-size:var(--text-md);font-weight:500}
.stats-info p{font-size:var(--text-2xs);opacity:0.85}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--sp-2)}
.stat-item{text-align:center;padding:var(--sp-3) var(--sp-2);background:rgba(255,255,255,0.12);border-radius:var(--r-sm);cursor:pointer;transition:background 0.2s}
.stat-item:hover{background:rgba(255,255,255,0.2)}
.stat-item:focus-visible{box-shadow:0 0 0 3px rgba(255,255,255,0.5)}
.stat-num{font-size:var(--text-xs);font-weight:600}
.stat-label{font-size:var(--text-3xs);opacity:0.9;margin-top:2px}
@media(max-width:600px){.stat-num{font-size:var(--text-md)}}

.chart-card{background:var(--card);border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);position:relative;border:1px solid var(--bdr-l)}
.chart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-2)}
.chart-title{font-size:var(--text-2xs);font-weight:500;display:flex;align-items:center;gap:var(--sp-2)}
.chart-title svg{width:14px;height:14px;stroke:var(--pri);fill:none}
.chart-legend{display:flex;gap:var(--sp-3)}
.chart-leg{display:flex;align-items:center;gap:4px;font-size:var(--text-3xs);color:var(--txt2)}
.chart-dot{width:6px;height:6px;border-radius:var(--r-full)}
.chart-dot.d1{background:var(--pri)}
.chart-dot.d2{background:var(--sec)}
.chart-dot.d3{background:var(--tafsir)}
.chart-area{height:90px;cursor:pointer}
.chart-svg{width:100%;height:100%}
.chart-line{fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.chart-line.l1{stroke:var(--pri)}
.chart-line.l2{stroke:var(--sec)}
.chart-line.l3{stroke:var(--tafsir)}
.chart-point{cursor:pointer;transition:r 0.15s}
.chart-point.p1{fill:var(--pri)}
.chart-point.p2{fill:var(--sec)}
.chart-point.p3{fill:var(--tafsir)}
.chart-grid-line{stroke:var(--bdr-l);stroke-width:1}
.chart-label{font-size:9px;fill:var(--txt3)}

.chart-tooltip{position:absolute;background:#fff;border-radius:var(--r-sm);padding:var(--sp-2);box-shadow:var(--shadow-md);z-index:50;display:none;min-width:100px}
.chart-tooltip.show{display:block}
.chart-tooltip-date{font-size:var(--text-3xs);color:var(--txt3);margin-bottom:var(--sp-1);font-weight:500}
.chart-tooltip-row{display:flex;align-items:center;gap:var(--sp-1);font-size:var(--text-2xs);margin-bottom:2px}
.chart-tooltip-dot{width:6px;height:6px;border-radius:var(--r-full)}
.chart-tooltip-val{font-weight:600;margin-left:auto}
.chart-range-btn{padding:3px 8px;border:1px solid var(--bdr);border-radius:var(--r-full);font-size:0.5rem;background:#fff;color:var(--txt3);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;transition:all 0.2s}
.chart-range-btn:hover{border-color:var(--pri-l);color:var(--pri)}
.chart-range-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}

.section{margin-bottom:var(--sp-3)}
.section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-2)}
.section-title{font-size:var(--text-sm);font-weight:600;color:var(--txt);display:flex;align-items:center;gap:var(--sp-2)}
.section-title svg{width:14px;height:14px;stroke:var(--pri);fill:none}
.section-link{font-size:var(--text-2xs);color:var(--pri);font-weight:500;cursor:pointer;padding:var(--sp-1);border-radius:var(--r-sm);transition:background 0.2s}
.section-link:hover{background:var(--pri-ll)}

.surah-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-2)}
@media(min-width:600px){.surah-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.surah-grid{grid-template-columns:repeat(4,1fr)}}
.surah-card{background:var(--card);border-radius:var(--r-lg);padding:var(--sp-3) var(--sp-2);cursor:pointer;box-shadow:var(--shadow-sm);transition:all 0.2s;position:relative;overflow:hidden;border:1px solid var(--bdr-l);min-height:90px}
@media(max-width:600px){.surah-card{min-height:110px;padding:var(--sp-3);border-radius:16px}}
@media(min-width:1024px){.surah-card{min-height:70px;padding:var(--sp-2)}}
.surah-card:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.surah-card:focus-visible{box-shadow:var(--focus-ring)}
.surah-card.s1{background:linear-gradient(135deg,var(--pri-ll),var(--card))}
.surah-card.s2{background:linear-gradient(135deg,var(--sec-ll),var(--card))}
.surah-card.s3{background:linear-gradient(135deg,var(--tafsir-ll),var(--card))}
.surah-card.s4{background:linear-gradient(135deg,var(--gold-l),var(--done-l))}
.surah-done{position:absolute;bottom:var(--sp-2);right:var(--sp-2);width:18px;height:18px;background:var(--done);border-radius:var(--r-full);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-sm)}
.surah-done svg{width:10px;height:10px;stroke:#fff;stroke-width:2.5;fill:none}
.surah-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.surah-num{font-size:var(--text-3xs);font-weight:600;color:var(--txt3);background:var(--card2);padding:2px 6px;border-radius:var(--r-xs)}
.surah-card.s4 .surah-num{background:var(--done);color:#fff}
.surah-ar{font-family:'Amiri',serif;font-size:var(--text-sm);color:var(--txt)}
@media(max-width:600px){.surah-ar{font-size:var(--text-md)}}
@media(min-width:1024px){.surah-ar{font-size:var(--text-xs)}}
.surah-name{font-size:var(--text-2xs);font-weight:600;margin-bottom:4px}
@media(max-width:600px){.surah-name{font-size:var(--text-xs)}}
@media(min-width:1024px){.surah-name{font-size:var(--text-3xs)}}
@media(min-width:1024px){.surah-name{font-size:var(--text-3xs)}}
.surah-meta{font-size:var(--text-3xs);color:var(--txt3);margin-bottom:var(--sp-2)}
@media(max-width:600px){.surah-meta{font-size:var(--text-2xs)}}
.surah-bars{display:flex;gap:2px;height:4px}
.surah-bar{flex:1;background:rgba(0,0,0,0.06);border-radius:2px;overflow:hidden}
.surah-bar-fill{height:100%;border-radius:2px}
.surah-bar.b1 .surah-bar-fill{background:var(--pri)}
.surah-bar.b2 .surah-bar-fill{background:var(--sec)}
.surah-bar.b3 .surah-bar-fill{background:var(--tafsir)}

.goals-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--sp-2)}
@media(min-width:600px){.goals-grid{grid-template-columns:repeat(5,1fr)}}
.goal-card{background:var(--card);border-radius:var(--r-sm);padding:var(--sp-3) var(--sp-2);text-align:center;box-shadow:var(--shadow);transition:transform 0.2s}
.goal-card:hover{transform:translateY(-2px)}
.goal-card.done{background:linear-gradient(135deg,var(--done-l),var(--gold-l))}
.goal-emoji{font-size:var(--text-lg);margin-bottom:2px}
.goal-name{font-size:var(--text-2xs);font-weight:500;line-height:1.3}
.goal-prog{font-size:var(--text-3xs);color:var(--txt3);margin-top:2px}
.goal-card.done .goal-prog{color:var(--done);font-weight:600}
@media(min-width:1024px){.goal-emoji{font-size:var(--text-base)}.goal-name{font-size:var(--text-3xs)}.goal-prog{font-size:0.5rem}}

.nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--bdr);padding:var(--sp-2) 0 calc(var(--sp-2) + env(safe-area-inset-bottom));z-index:100;box-shadow:0 -2px 10px rgba(0,0,0,0.05)}
.nav-inner{display:flex;max-width:640px;margin:0 auto;padding:0 var(--sp-4)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:var(--sp-1);background:none;border:none;cursor:pointer;border-radius:var(--r-sm);transition:background 0.2s;min-height:44px;font-family:'Noto Sans Thai',sans-serif}
.nav-btn:hover{background:var(--card2)}
.nav-btn:focus-visible{box-shadow:var(--focus-ring)}
.nav-btn svg{width:22px;height:22px;stroke:var(--txt3);stroke-width:1.5;fill:none}
.nav-btn span{font-size:var(--text-3xs);color:var(--txt3);font-family:'Noto Sans Thai',sans-serif}
.nav-btn.active svg{stroke:var(--pri)}
.nav-btn.active span{color:var(--pri);font-weight:600}

.page{display:none}.page.active{display:block}

.detail-header{padding:var(--sp-8) 0 var(--sp-4)}
.back-btn{display:inline-flex;align-items:center;gap:var(--sp-1);font-size:var(--text-sm);color:var(--pri);background:none;border:none;cursor:pointer;margin-bottom:var(--sp-3);font-weight:500;padding:var(--sp-2);border-radius:var(--r-sm);min-height:40px}
.back-btn:hover{background:var(--pri-ll)}
.back-btn:focus-visible{box-shadow:var(--focus-ring)}
.back-btn svg{width:18px;height:18px;fill:none}
.detail-top{display:flex;justify-content:space-between;align-items:flex-end}
.detail-name{font-size:var(--text-lg);font-weight:600;color:var(--pri)}
.detail-meta{font-size:var(--text-2xs);color:var(--txt3);margin-top:2px}
.detail-ar{font-family:'Amiri',serif;font-size:var(--text-lg)}

.rings-row{display:flex;justify-content:center;gap:var(--sp-4);padding:var(--sp-3);background:var(--card);border-radius:var(--r-md);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l)}
.ring-item{text-align:center}
.mini-ring{position:relative;width:48px;height:48px}
.mini-ring svg{transform:rotate(-90deg)}
.mini-ring circle{fill:none;stroke-width:4}
.mini-ring .bg{stroke:var(--bdr)}
.mini-ring .fg{stroke-linecap:round}
.ring-item.r1 .fg{stroke:var(--pri)}
.ring-item.r2 .fg{stroke:var(--sec)}
.ring-item.r3 .fg{stroke:var(--tafsir)}
.mini-ring-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:var(--text-2xs);font-weight:600}
.ring-item.r1 .mini-ring-num{color:var(--pri)}
.ring-item.r2 .mini-ring-num{color:var(--sec)}
.ring-item.r3 .mini-ring-num{color:var(--tafsir)}
.ring-item-label{font-size:var(--text-3xs);color:var(--txt3);margin-top:2px}

.input-card{background:var(--card);border-radius:var(--r-md);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l)}
.input-title{font-size:var(--text-2xs);font-weight:600;margin-bottom:var(--sp-2);display:flex;align-items:center;gap:var(--sp-2)}
.input-title svg{width:14px;height:14px;stroke:var(--pri);fill:none}
.input-row{display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2) 0;border-bottom:1px solid var(--bdr-l)}
.input-row:last-child{border-bottom:none}
.input-dot{width:10px;height:10px;border-radius:var(--r-full);flex-shrink:0}
.input-dot.c1{background:var(--pri)}
.input-dot.c2{background:var(--sec)}
.input-dot.c3{background:var(--tafsir)}
.input-label{flex:1;font-size:var(--text-2xs)}
.input-field{width:44px;padding:4px;border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-xs);text-align:center;background:var(--card2);min-height:30px}
.input-field:focus{outline:none;border-color:var(--pri);box-shadow:var(--focus-ring)}
.input-max{font-size:var(--text-3xs);color:var(--txt3)}

.tabs{display:flex;gap:2px;margin-bottom:var(--sp-2);background:var(--card2);padding:3px;border-radius:var(--r-sm)}
.tab{flex:1;padding:var(--sp-2);border:none;background:transparent;border-radius:var(--r-xs);font-size:var(--text-2xs);font-weight:500;cursor:pointer;color:var(--txt3);min-height:36px;transition:all 0.2s}
.tab:focus-visible{box-shadow:var(--focus-ring)}
.tab.active{background:var(--card);color:var(--pri);box-shadow:var(--shadow-sm)}
.tab-content{display:none}
.tab-content.active{display:block}

.notebook{background:var(--card);border-radius:var(--r-md);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);overflow:hidden;border:1px solid var(--bdr-l)}
.notebook-head{padding:var(--sp-2) var(--sp-3);display:flex;justify-content:space-between;align-items:center}
.notebook-head.nh-overview{background:var(--overview-ll)}
.notebook-head.nh-reasons{background:var(--reasons-ll)}
.notebook-head.nh-stories{background:#fff3e0}
.notebook-head.nh-notes{background:var(--pri-ll)}
.notebook-head.nh-meanings{background:var(--sec-ll)}
.notebook-head.nh-tafsirs{background:var(--tafsir-ll)}
.notebook-title{font-size:var(--text-2xs);font-weight:600;color:var(--txt);display:flex;align-items:center;gap:var(--sp-2)}
.notebook-title svg{width:14px;height:14px;fill:none}
.notebook-title.nt-overview svg{stroke:var(--overview)}
.notebook-title.nt-reasons svg{stroke:var(--reasons)}
.notebook-title.nt-stories svg{stroke:#e65100}
.notebook-title.nt-notes svg{stroke:var(--pri)}
.notebook-title.nt-meanings svg{stroke:var(--sec)}
.notebook-title.nt-tafsirs svg{stroke:var(--tafsir)}
/* Toolbar - ขนาดเท่ากันทุกอุปกรณ์ 20x20px */
.toolbar{display:flex;gap:3px;align-items:center;flex-wrap:wrap}
.tb-btn{width:20px;height:20px;min-width:20px;min-height:20px;max-width:20px;max-height:20px;border:1px solid rgba(0,0,0,0.1);border-radius:4px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--txt2);transition:all 0.15s;font-weight:600;flex-shrink:0;box-sizing:border-box}
.tb-btn:hover{background:#f5f5f5;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.tb-color{width:20px;height:20px;min-width:20px;min-height:20px;max-width:20px;max-height:20px;border-radius:4px;cursor:pointer;transition:transform 0.15s;border:1px solid rgba(0,0,0,0.1);flex-shrink:0;box-sizing:border-box}
.tb-color:hover{transform:scale(1.1);box-shadow:0 2px 6px rgba(0,0,0,0.15)}
.tb-color.c1{background:#FADEE3}
.tb-color.c2{background:#D4EDEC}
.tb-color.c3{background:#FFF3CD}
.tb-color.c4{background:#E8D5E8}
.tb-color.c5{background:linear-gradient(135deg,#a8edea 0%,#fed6e3 50%,#d299c2 100%)}
.tb-color-add{width:20px;height:20px;min-width:20px;min-height:20px;max-width:20px;max-height:20px;border-radius:4px;cursor:pointer;border:1px dashed rgba(0,0,0,0.25);background:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;line-height:1;color:#999;transition:all 0.15s;flex-shrink:0;box-sizing:border-box;padding:0;padding-bottom:2px}
.tb-color-add:hover{border-color:var(--pri);color:var(--pri);background:#fef5f8}
/* Color popup for compact toolbar on mobile */
.tb-colors-wrap{position:relative;display:inline-flex;align-items:center}
.tb-colors-btn{width:20px;height:20px;min-width:20px;border:1px solid rgba(0,0,0,0.1);border-radius:4px;background:linear-gradient(135deg,#FADEE3 0%,#D4EDEC 33%,#FFF3CD 66%,#E8D5E8 100%);cursor:pointer;flex-shrink:0}
.tb-colors-btn:hover{transform:scale(1.1)}
.tb-colors-popup{position:absolute;top:100%;right:0;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.2);padding:8px;display:none;gap:4px;z-index:200;margin-top:6px;flex-wrap:wrap;width:max-content}
.tb-colors-wrap.open .tb-colors-popup{display:flex}
/* Special tools dropdown - ยางลบ */
.tb-special-wrap{position:relative;display:inline-block}
.tb-special-btn{width:20px;height:20px;min-width:20px;min-height:20px;max-width:20px;max-height:20px;border:1px solid rgba(0,0,0,0.1);border-radius:4px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;box-sizing:border-box}
.tb-special-btn:hover{background:#ffebee}
.tb-special-btn svg{width:12px;height:12px;stroke:#888;fill:none;stroke-width:2}
.tb-special-menu{position:absolute;bottom:100%;right:0;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.18);padding:6px;display:none;flex-direction:row;gap:4px;z-index:200;margin-bottom:6px}
.tb-special-wrap.open .tb-special-menu{display:flex}
.tb-special-wrap.menu-down .tb-special-menu{bottom:auto;top:100%;margin-bottom:0;margin-top:6px}
.tb-special-item{width:24px;height:24px;border:none;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-size:7px;font-weight:600}
.tb-special-item:hover{transform:scale(1.05)}
.tb-special-item.item-hl{background:#fff3e0;color:#e65100}
.tb-special-item.item-tc{background:#e3f2fd;color:#1565c0}
.tb-special-item.item-sz{background:#e8f5e9;color:#2e7d32}
.tb-special-item.item-all{background:#fce4ec;color:#c2185b}
/* Ayah mini tools - ปุ่มเครื่องมือเล็กในกล่องอายะฮ์ */
.ayah-mini-tools{display:inline-flex;gap:2px;margin-left:4px;vertical-align:middle}
.ayah-mini-btn{width:18px;height:18px;border:none;border-radius:4px;background:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;opacity:0.4;transition:all 0.15s}
.ayah-mini-btn:hover{opacity:0.7}
.ayah-mini-btn svg{width:12px;height:12px;stroke:var(--gold)}
.ayah-mini-wrap{position:relative;display:inline-block;vertical-align:middle}
.ayah-mini-menu{position:absolute;bottom:100%;left:0;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.2);padding:8px;display:none;flex-wrap:wrap;gap:4px;z-index:300;margin-bottom:6px;min-width:140px}
.ayah-mini-wrap.open .ayah-mini-menu{display:flex}
.ayah-mini-item{width:24px;height:24px;border:none;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-size:8px;font-weight:600}
.ayah-mini-item:hover{transform:scale(1.1)}
.ayah-mini-color{width:20px;height:20px;border-radius:4px;cursor:pointer;border:1px solid rgba(0,0,0,0.08);transition:all 0.15s;padding:0}
.ayah-mini-color:hover{transform:scale(1.15)}
.ayah-mini-sep{width:100%;height:1px;background:rgba(0,0,0,0.08);margin:2px 0}
.ayah-mini-hl-btn{width:20px;height:20px;border:none;border-radius:4px;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0.5;transition:all 0.15s}
.ayah-mini-hl-btn:hover{opacity:0.8}
.ayah-mini-hl-btn svg{width:14px;height:14px}
/* Basmala style - เรียบหรูสวยงาม */
.basmala-wrap{text-align:center;padding:12px 8px 16px;margin:4px 0 8px}
.basmala-inner{display:flex;align-items:center;justify-content:center;gap:8px}
.basmala-line{flex:0 0 30px;height:1px;background:linear-gradient(90deg,transparent,#d4c4e4,transparent)}
.basmala-dot{width:3px;height:3px;border-radius:50%;background:#c4b4d4}
.basmala-text{font-family:'Scheherazade New','Amiri',serif;font-size:clamp(1rem,4vw,1.4rem);color:#6d5d7d;direction:rtl;line-height:1.4;font-weight:400;padding:0 2px;white-space:nowrap}
/* Color picker modal */
.color-picker-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:500}
.color-picker-modal.show{display:flex}
.color-picker-box{background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.3);text-align:center;min-width:220px}
.color-picker-box h4{margin:0 0 16px;font-size:14px;color:var(--txt);font-weight:600}
.color-picker-box input[type="color"]{width:100px;height:60px;border:none;cursor:pointer;border-radius:12px;margin-bottom:16px}
.color-picker-box .btn-row{display:flex;gap:10px}
.color-picker-box button{flex:1;padding:12px;border:none;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit}
.color-picker-box .btn-cancel{background:#f5f5f5;color:#666}
.color-picker-box .btn-apply{background:linear-gradient(135deg,var(--pri),var(--pink));color:#fff}
/* Responsive toolbar - compact colors: ซ่อนสีทั้งหมด ให้ใช้ popup อย่างเดียว */
.toolbar.compact-colors>.tb-color,.toolbar.compact-colors>.tb-color-add{display:none}
.toolbar.compact-colors .tb-colors-wrap{display:inline-flex}
.tb-colors-popup .tb-color,.tb-colors-popup .tb-color-add{display:block!important}
.notebook-body{padding:0}
.note-edit{padding:var(--sp-2) var(--sp-3);font-size:var(--text-xs);font-family:inherit;line-height:1.6;min-height:60px;border:none;background:transparent;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap}
.note-edit:focus{outline:none;background:rgba(0,0,0,0.02)}
.note-edit:empty:before{content:attr(data-placeholder);color:var(--txt3)}
.note-edit[contenteditable],.ayah-input[contenteditable]{-webkit-user-modify:read-write-plaintext-only;-webkit-user-modify:read-write}
[contenteditable] b,[contenteditable] strong{font-weight:700}
[contenteditable] i,[contenteditable] em{font-style:italic}

.note-tabs{display:flex;background:var(--card2);border-radius:var(--r-sm);padding:var(--sp-1);margin-bottom:var(--sp-2)}
.note-tab{flex:1;padding:var(--sp-2);border:none;background:transparent;border-radius:var(--r-xs);font-size:var(--text-2xs);font-weight:500;cursor:pointer;color:var(--txt3);display:flex;align-items:center;justify-content:center;gap:4px;min-height:36px;transition:all 0.2s}
.note-tab:focus-visible{box-shadow:var(--focus-ring)}
.note-tab svg{width:12px;height:12px;fill:none;stroke:currentColor;stroke-width:1.5}
.note-tab.active{background:var(--card);box-shadow:var(--shadow-sm)}
.note-tab.active.t-notes{color:var(--pri)}
.note-tab.active.t-meanings{color:var(--sec)}
.note-tab.active.t-tafsirs{color:var(--tafsir)}
.note-tab.t-notes svg{stroke:var(--txt3)}
.note-tab.t-meanings svg{stroke:var(--txt3)}
.note-tab.t-tafsirs svg{stroke:var(--txt3)}
.note-tab.active.t-notes svg{stroke:var(--pri)}
.note-tab.active.t-meanings svg{stroke:var(--sec)}
.note-tab.active.t-tafsirs svg{stroke:var(--tafsir)}
.note-tab-content{display:none}
.note-tab-content.active{display:block}

.ayah-list{padding:0 var(--sp-3) var(--sp-3)}
.ayah-item{display:flex;flex-direction:column;gap:4px;padding:var(--sp-2) 0;border-bottom:1px solid var(--bdr-l)}
.ayah-item-row{display:flex;align-items:flex-start;gap:var(--sp-2)}
.ayah-ar-wrap{margin-bottom:6px}
.ayah-ar-header{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;cursor:pointer;border-radius:var(--r-sm);transition:all 0.2s;font-size:var(--text-3xs);color:var(--txt3)}
.ayah-ar-header:hover{background:rgba(184,149,107,0.1);color:var(--gold)}
.ayah-ar-header.has-text{color:var(--gold)}
.ayah-ar-header svg{width:12px;height:12px;flex-shrink:0;transition:transform 0.2s}
.ayah-ar-header.open svg{transform:rotate(180deg)}
.ayah-ar-body{display:none;padding:10px 12px;background:linear-gradient(135deg,rgba(184,149,107,0.04),transparent);border-radius:var(--r-sm);margin-top:4px}
.ayah-ar-wrap.open .ayah-ar-body{display:block}
.ayah-ar-text{font-family:'Amiri',serif;font-size:clamp(0.95rem,2.5vw,1.1rem);color:var(--txt);direction:rtl;text-align:right;line-height:2.2;word-spacing:4px}
.ayah-ar-text[contenteditable]{cursor:text;padding:4px;border-radius:var(--r-xs);transition:background 0.15s}
.ayah-ar-text[contenteditable]:focus{background:rgba(184,149,107,0.08);outline:none}
/* Ayah Highlight Toolbar */
.ayah-ar-toolbar{display:flex;align-items:center;gap:4px;margin-top:8px;padding:6px 8px;background:rgba(184,149,107,0.08);border-radius:var(--r-sm);flex-wrap:wrap}
.ayah-ar-toolbar .at-label{font-size:8px;color:var(--txt3);margin-right:4px}
.ayah-ar-toolbar .at-color{width:18px;height:18px;border-radius:4px;cursor:pointer;border:1px solid rgba(0,0,0,0.08);transition:transform 0.15s}
.ayah-ar-toolbar .at-color:hover{transform:scale(1.15)}
.ayah-ar-toolbar .at-color.c1{background:#FADEE3}
.ayah-ar-toolbar .at-color.c2{background:#D4EDEC}
.ayah-ar-toolbar .at-color.c3{background:#FFF3CD}
.ayah-ar-toolbar .at-color-picker{width:18px;height:18px;border:none;padding:0;cursor:pointer;border-radius:4px;background:linear-gradient(135deg,#ff6b6b,#feca57,#48dbfb);-webkit-appearance:none}
.ayah-ar-toolbar .at-eraser{width:22px;height:22px;border:none;border-radius:4px;background:rgba(255,255,255,0.8);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;margin-left:4px}
.ayah-ar-toolbar .at-eraser:hover{background:#ffebee}
.ayah-ar-toolbar .at-eraser svg{width:12px;height:12px;stroke:#e53935;fill:none;stroke-width:2}
.ayah-ar-edit{display:flex;align-items:center;gap:4px;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(184,149,107,0.2)}
.ayah-ar-edit-btn{font-size:var(--text-3xs);color:var(--gold);cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:3px 6px;border-radius:var(--r-xs);transition:all 0.2s}
.ayah-ar-edit-btn:hover{background:rgba(184,149,107,0.1)}
.ayah-ar-edit-btn svg{width:11px;height:11px}
.ayah-item:last-child{border-bottom:none}
.ayah-num{width:28px;height:28px;border-radius:var(--r-full);display:flex;align-items:center;justify-content:center;font-size:var(--text-2xs);font-weight:600;flex-shrink:0;transition:all 0.2s}
.ayah-num.an-notes{background:var(--pri-ll);color:var(--pri);border:2px solid var(--pri)}
.ayah-num.an-meanings{background:var(--sec-ll);color:var(--sec);border:2px solid var(--sec)}
.ayah-num.an-tafsirs{background:var(--tafsir-ll);color:var(--tafsir);border:2px solid var(--tafsir)}
.ayah-input{flex:1;border:none;padding:var(--sp-1) 0;font-size:var(--text-xs);font-family:inherit;line-height:1.5;background:transparent;resize:none;min-height:36px;word-wrap:break-word;overflow-wrap:break-word}
.ayah-input:focus{outline:none}
/* Notebook ayah ar - หน้าแยกตามซูเราะฮ์ */
.notebook-ayah-ar{font-family:'Amiri',serif;font-size:clamp(0.95rem,2.5vw,1.1rem);color:var(--txt);direction:rtl;text-align:right;line-height:2.2;padding:8px 12px;background:linear-gradient(135deg,rgba(107,91,122,0.04),transparent);border-radius:var(--r-sm);margin:6px 0;word-spacing:4px}
.notebook-ayah-ar-toggle{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;cursor:pointer;font-size:var(--text-3xs);color:var(--gold);border-radius:var(--r-xs);transition:all 0.2s;margin-left:6px}
.notebook-ayah-ar-toggle:hover{background:rgba(184,149,107,0.1)}
.notebook-ayah-ar-toggle svg{width:11px;height:11px;transition:transform 0.2s}
.notebook-ayah-ar-toggle.open svg{transform:rotate(180deg)}
.ayah-input:empty:before{content:attr(data-placeholder);color:var(--txt3)}

.habits-container{margin-bottom:var(--sp-3)}
.habit-add-row{display:flex;gap:var(--sp-2);margin-bottom:var(--sp-2);flex-wrap:wrap}
.habit-input{flex:1;padding:var(--sp-2);border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card);min-width:70px;min-height:36px}
.habit-input:focus{outline:none;border-color:var(--pri);box-shadow:var(--focus-ring)}
.habit-input-sm{width:50px;text-align:center;min-width:50px;flex:0 0 50px}
.add-btn{padding:var(--sp-2);background:var(--pri);color:#fff;border:none;border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;font-weight:500;cursor:pointer;min-height:36px;transition:all 0.2s}
.add-btn:hover{opacity:0.9}
.add-btn:focus-visible{box-shadow:var(--focus-ring)}
.habits-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-2)}
@media(min-width:600px){.habits-grid{grid-template-columns:repeat(3,1fr)}}
.habit-card{background:linear-gradient(135deg,var(--card),var(--sec-ll));border-radius:var(--r-md);padding:var(--sp-2) var(--sp-3);display:flex;gap:var(--sp-2);align-items:center;box-shadow:var(--shadow-sm);border:1px solid rgba(122,158,159,0.12);min-height:52px;position:relative;cursor:pointer;transition:all 0.15s}
.habit-card:hover{background:linear-gradient(135deg,var(--sec-ll),var(--card))}
.habit-check{width:18px;height:18px;border:2px solid var(--bdr);border-radius:var(--r-full);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:#fff;transition:all 0.2s;margin-top:1px}
.habit-check svg{width:10px;height:10px;stroke-width:2.5;fill:none}
.habit-check:not(.done) svg{stroke:transparent}
.habit-check.done{background:linear-gradient(135deg,#7A9E9F,#5d8a8b);border-color:#7A9E9F;box-shadow:0 2px 8px rgba(122,158,159,0.4)}
.habit-check.done svg{stroke:#fff}

/* ===== PREMIUM CARD STYLES ===== */

/* Surah Knowledge Cards */
.surah-know-card{background:#fff;border-radius:var(--r-lg);margin-bottom:var(--sp-3);box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow:hidden}
.surah-know-card .skc-header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.05)}
.surah-know-card .skc-icon{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.surah-know-card .skc-title{font-size:var(--text-2xs);font-weight:600;color:var(--txt)}
.surah-know-card .skc-subtitle{font-size:9px;color:var(--txt3);margin-left:auto}
.surah-know-card .skc-count{font-size:9px;color:#fff;background:var(--pri);padding:2px 8px;border-radius:var(--r-full);margin-left:auto}
.surah-know-card .skc-body{padding:14px 16px}
.surah-know-card.names-card .skc-count{background:var(--pink)}
.surah-know-card.habits-card .skc-count{background:var(--sec)}
.surah-know-card.notes-card .skc-count{background:var(--pri)}

/* Names Pills */
.names-body{display:flex;flex-wrap:wrap;gap:8px}
.name-pill{background:linear-gradient(135deg,#fff,var(--pink-ll));padding:8px 14px;border-radius:var(--r-full);font-size:var(--text-2xs);color:var(--pink);cursor:pointer;border:1px solid rgba(212,115,140,0.2);transition:all 0.2s;font-weight:500}
.name-pill:hover{background:var(--pink);color:#fff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(212,115,140,0.3)}

/* Habit Category Groups */
.habit-cat-group{margin-bottom:12px}
.habit-cat-group:last-child{margin-bottom:0}
.habit-cat-label{font-size:9px;font-weight:600;color:var(--txt3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-left:2px}
.habit-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(135deg,#fafafa,#fff);border-radius:var(--r-sm);margin-bottom:6px;border:1px solid rgba(0,0,0,0.04)}
.habit-row:last-child{margin-bottom:0}
.habit-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.habit-row-text{flex:1;font-size:var(--text-2xs);color:var(--txt)}
.habit-row-status{font-size:9px;font-weight:500;padding:3px 8px;border-radius:var(--r-full);background:rgba(0,0,0,0.04)}

/* ===== PREMIUM NAMES PAGE ===== */
.names-page-header{background:linear-gradient(135deg,#f093fb 0%,#f5576c 50%,#f9a8d4 100%);padding:20px;border-radius:var(--r-lg);margin-bottom:var(--sp-3);position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(245,87,108,0.3)}
.names-page-header::before{content:'';position:absolute;top:-50%;right:-20%;width:200px;height:200px;background:radial-gradient(circle,rgba(255,255,255,0.15) 0%,transparent 70%);border-radius:50%}
.names-page-header::after{content:'';position:absolute;bottom:-30%;left:-10%;width:150px;height:150px;background:radial-gradient(circle,rgba(255,255,255,0.1) 0%,transparent 70%);border-radius:50%}
.names-page-header .nph-content{position:relative;z-index:1;text-align:center}
.names-page-header .nph-icon{width:48px;height:48px;background:rgba(255,255,255,0.25);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center}
.names-page-header .nph-title{font-size:var(--text-sm);font-weight:600;color:#fff;margin-bottom:4px}
.names-page-header .nph-subtitle{font-size:var(--text-3xs);color:rgba(255,255,255,0.9)}
.names-page-header .nph-fc-btn{position:absolute;top:10px;right:10px;width:44px;height:44px;background:rgba(255,255,255,0.3);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;z-index:10}
.names-page-header .nph-fc-btn:hover,.names-page-header .nph-fc-btn:active{background:rgba(255,255,255,0.5);transform:scale(1.05)}
.names-page-header .nph-fc-btn svg{stroke:#fff}

/* ===== PREMIUM HABITS PAGE ===== */
.habits-page-header{background:linear-gradient(135deg,#324b4c 0%,#884c60 50%,#7a9e9f 100%);padding:20px;border-radius:var(--r-lg);margin-bottom:var(--sp-3);position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(136,76,96,0.3)}
.habits-page-header::before{content:'';position:absolute;top:-40%;right:-15%;width:180px;height:180px;background:radial-gradient(circle,rgba(255,255,255,0.12) 0%,transparent 70%);border-radius:50%}
.habits-page-header .hph-content{position:relative;z-index:1;text-align:center}
.habits-page-header .hph-icon{width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center}
.habits-page-header .hph-title{font-size:var(--text-sm);font-weight:600;color:#fff;margin-bottom:4px}
.habits-page-header .hph-subtitle{font-size:var(--text-3xs);color:rgba(255,255,255,0.85)}

/* Habit Status Sections - Premium */
.habit-status-section{margin-bottom:var(--sp-3)}
.habit-status-header{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--r-md);margin-bottom:8px}
.habit-status-header .hsh-indicator{width:6px;height:24px;border-radius:3px}
.habit-status-header .hsh-info{flex:1}
.habit-status-header .hsh-label{font-size:var(--text-2xs);font-weight:600}
.habit-status-header .hsh-count{font-size:9px;opacity:0.7}
.habit-category-section{margin-bottom:var(--sp-4)}
.hcs-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:var(--r-md);margin-bottom:8px}
.hcs-title{font-size:var(--text-2xs);font-weight:600}
.hcs-count{font-size:9px;opacity:0.7}
.hcs-items{display:grid;gap:8px}
.habit-status-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#fff;border-radius:var(--r-md);margin-bottom:0;border:1px solid rgba(0,0,0,0.06);box-shadow:0 1px 4px rgba(0,0,0,0.04);transition:all 0.2s}
.habit-status-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-1px)}
.habit-status-card .hsc-indicator{width:4px;height:100%;min-height:32px;border-radius:2px;flex-shrink:0}
.habit-status-card .hsc-info{flex:1;min-width:0}
.habit-status-card .hsc-text{font-size:var(--text-2xs);color:var(--txt);margin-bottom:2px}
.habit-status-card .hsc-meta{font-size:9px;color:var(--txt3)}
.habit-status-card .hsc-select{padding:6px 10px;border:1px solid rgba(0,0,0,0.1);border-radius:var(--r-sm);font-size:9px;background:#fff;cursor:pointer;font-family:'Noto Sans Thai',sans-serif;min-width:100px}

/* Flip Card Premium */
.flip-card-container{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:4px}
@media(min-width:600px){.flip-card-container{grid-template-columns:repeat(3,1fr)}}
@media(min-width:900px){.flip-card-container{grid-template-columns:repeat(4,1fr)}}
.flip-card{perspective:1000px;height:110px;cursor:pointer}
.flip-card-inner{position:relative;width:100%;height:100%;transition:transform 0.5s ease;transform-style:preserve-3d}
.flip-card.flipped .flip-card-inner{transform:rotateY(180deg)}
.flip-card-front,.flip-card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-md);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px}
.flip-card-front{background:linear-gradient(145deg,#fff 0%,#fef7f9 100%);border:1px solid rgba(212,115,140,0.15);box-shadow:0 4px 15px rgba(212,115,140,0.12)}
.flip-card-front .name-ar{font-size:1.2rem;font-weight:600;color:#c2185b;font-family:'Amiri',serif;text-align:center}
.flip-card-back{background:linear-gradient(145deg,#c2185b,#e91e63);transform:rotateY(180deg);color:#fff;box-shadow:0 4px 15px rgba(194,24,91,0.3)}
.flip-card-back .name-meaning{font-size:var(--text-2xs);text-align:center;font-family:'Noto Sans Thai',sans-serif;line-height:1.5}
.flip-card-more{position:absolute;bottom:6px;right:6px;width:24px;height:24px;background:rgba(0,0,0,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;transition:all 0.2s}
.flip-card-more:hover{background:rgba(0,0,0,0.15);transform:scale(1.1)}

/* ===== FLASHCARD SETTINGS MODAL ===== */
.fc-settings-panel{display:none;background:rgba(0,0,0,0.4);padding:12px;border-radius:var(--r-md);margin-bottom:12px;max-width:340px;width:100%}
.fc-settings-panel.show{display:block}
.fc-settings-section{margin-bottom:10px}
.fc-settings-section:last-child{margin-bottom:0}
.fc-settings-title{font-size:9px;color:rgba(255,255,255,0.6);margin-bottom:6px;text-transform:uppercase}
.fc-surah-grid{display:flex;flex-wrap:wrap;gap:4px}
.fc-surah-btn{padding:4px 8px;border-radius:var(--r-xs);font-size:9px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:rgba(255,255,255,0.7);cursor:pointer;font-family:'Noto Sans Thai',sans-serif}
.fc-surah-btn.active{background:rgba(255,255,255,0.2);color:#fff;border-color:rgba(255,255,255,0.4)}
.fc-type-row{display:flex;flex-wrap:wrap;gap:4px}
.fc-type-btn{padding:4px 8px;border-radius:var(--r-xs);font-size:9px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:rgba(255,255,255,0.7);cursor:pointer;font-family:'Noto Sans Thai',sans-serif}
.fc-type-btn.active{background:rgba(255,255,255,0.2);color:#fff}
.fc-card-opts{display:flex;flex-wrap:wrap;gap:4px;align-items:center;font-size:9px;color:rgba(255,255,255,0.6)}
.fc-opt-btn{padding:3px 8px;border-radius:var(--r-xs);font-size:9px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:rgba(255,255,255,0.7);cursor:pointer;font-family:'Noto Sans Thai',sans-serif}
.fc-opt-btn.active{background:rgba(255,255,255,0.2);color:#fff}
.fc-mini-settings{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.fc-toggle-btn{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fc-toggle-btn:hover{background:rgba(255,255,255,0.1)}
.fc-count{font-size:11px;color:rgba(255,255,255,0.6)}
.fc-mode-toggle{display:flex;gap:2px;background:rgba(255,255,255,0.1);border-radius:var(--r-full);padding:2px}
.fc-mode-btn{padding:4px 12px;border-radius:var(--r-full);font-size:10px;border:none;background:transparent;color:rgba(255,255,255,0.7);cursor:pointer;font-family:'Noto Sans Thai',sans-serif}
.fc-mode-btn.active{background:rgba(255,255,255,0.2);color:#fff}
.flashcard-controls-simple{display:flex;gap:20px;margin-top:20px}
.fc-btn-simple{width:56px;height:56px;border-radius:50%;border:2px solid;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.fc-btn-simple.wrong{background:rgba(244,67,54,0.1);border-color:rgba(244,67,54,0.4);color:#ff6b6b}
.fc-btn-simple.wrong:hover{background:rgba(244,67,54,0.2);transform:scale(1.1)}
.fc-btn-simple.correct{background:rgba(76,175,80,0.1);border-color:rgba(76,175,80,0.4);color:#81c784}
.fc-btn-simple.correct:hover{background:rgba(76,175,80,0.2);transform:scale(1.1)}
.fc-settings-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
.fc-settings-row:last-child{margin-bottom:0}
.fc-settings-label{font-size:10px;color:rgba(255,255,255,0.7);width:100%;margin-bottom:4px}
.fc-settings-chips{display:flex;flex-wrap:wrap;gap:6px}
.fc-chip{padding:6px 12px;border-radius:var(--r-full);font-size:10px;border:1px solid rgba(255,255,255,0.3);background:transparent;color:#fff;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif}
.fc-chip.active{background:rgba(255,255,255,0.25);border-color:rgba(255,255,255,0.5)}
.fc-chip:hover{background:rgba(255,255,255,0.15)}

/* ===== FLASHCARD OVERLAY ===== */
.flashcard-overlay{position:fixed;inset:0;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f0f1a 100%);z-index:1000;display:flex;flex-direction:column;align-items:center;padding:20px;overflow-y:auto}
.flashcard-close{position:fixed;top:16px;right:16px;width:44px;height:44px;background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;z-index:1001}
.flashcard-close:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
.flashcard-progress{color:rgba(255,255,255,0.6);font-size:var(--text-2xs);margin-bottom:16px;font-weight:500}
.flashcard-main{width:100%;max-width:340px;perspective:1000px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.flashcard-card{position:relative;width:100%;min-height:200px;transition:transform 0.5s ease;transform-style:preserve-3d}
.flashcard-card.flipped{transform:rotateY(180deg)}
.flashcard-face{position:absolute;width:100%;min-height:200px;backface-visibility:hidden;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 15px 50px rgba(0,0,0,0.4);padding:24px;box-sizing:border-box}
.flashcard-front{background:linear-gradient(145deg,#fff,#f8f4ff)}
.flashcard-front .fc-text{font-size:1.5rem;font-weight:600;color:var(--pri);text-align:center}
.flashcard-back{background:linear-gradient(145deg,var(--pri),#7c4dff);transform:rotateY(180deg);color:#fff;padding:24px}
.flashcard-back .fc-text{font-size:var(--text-sm);text-align:center;line-height:1.7}
.flashcard-controls{display:flex;gap:12px;margin-top:24px}
.flashcard-btn{padding:12px 20px;border-radius:12px;border:none;font-size:11px;cursor:pointer;font-family:'Noto Sans Thai',sans-serif;transition:all 0.2s;min-width:80px;text-align:center;font-weight:500}
.flashcard-btn.hard{background:rgba(244,67,54,0.15);color:#ff6b6b;border:1px solid rgba(244,67,54,0.3)}
.flashcard-btn.good{background:rgba(255,193,7,0.15);color:#ffc107;border:1px solid rgba(255,193,7,0.3)}
.flashcard-btn.easy{background:rgba(76,175,80,0.15);color:#81c784;border:1px solid rgba(76,175,80,0.3)}
.flashcard-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.fc-mini-settings{display:flex;align-items:center;gap:10px;margin-top:60px;margin-bottom:16px}
.fc-toggle-btn{width:36px;height:36px;border:none;background:rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.7);transition:all 0.2s}
.fc-toggle-btn:hover{background:rgba(255,255,255,0.2)}
.fc-count{color:rgba(255,255,255,0.7);font-size:var(--text-2xs)}
.fc-settings-panel{display:none;position:absolute;top:110px;left:50%;transform:translateX(-50%);width:calc(100% - 40px);max-width:320px;background:rgba(255,255,255,0.98);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10}
.fc-settings-panel.show{display:block}
.fc-settings-section{margin-bottom:12px}
.fc-settings-section:last-child{margin-bottom:0}
.fc-settings-title{font-size:var(--text-3xs);color:var(--txt3);margin-bottom:8px;font-weight:600}
.fc-surah-grid{display:flex;flex-wrap:wrap;gap:6px}
.fc-surah-btn,.fc-type-btn,.fc-opt-btn{padding:6px 14px;border:1px solid #e0e0e0;border-radius:20px;background:#fff;color:var(--txt2);font-size:var(--text-3xs);cursor:pointer;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif}
.fc-surah-btn.active,.fc-type-btn.active,.fc-opt-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.fc-type-row{display:flex;flex-wrap:wrap;gap:6px}
.fc-card-opts{display:flex;flex-wrap:wrap;align-items:center;gap:6px}
.fc-card-opts span{font-size:var(--text-3xs);color:var(--txt3)}
.fc-mode-toggle{display:flex;background:rgba(255,255,255,0.1);border-radius:20px;padding:3px}
.fc-mode-btn{padding:6px 14px;border:none;border-radius:18px;background:transparent;color:rgba(255,255,255,0.6);font-size:var(--text-3xs);cursor:pointer;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif}
.fc-mode-btn.active{background:rgba(255,255,255,0.2);color:#fff}
.flashcard-controls-simple{display:flex;gap:24px;margin-top:24px;margin-bottom:20px;flex-shrink:0}
.fc-btn-simple{width:68px;height:68px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;box-shadow:0 6px 25px rgba(0,0,0,0.3)}
.fc-btn-simple.wrong{background:linear-gradient(145deg,#ff6b6b,#ee5a5a);color:#fff}
.fc-btn-simple.correct{background:linear-gradient(145deg,#51cf66,#40c057);color:#fff}
.fc-btn-simple:hover{transform:scale(1.08)}
.fc-btn-simple:active{transform:scale(0.95)}
.fc-text{text-align:center;line-height:1.6;word-break:break-word}
.flashcard-nav{display:flex;align-items:center;justify-content:center;gap:12px;width:100%}
.fc-nav-btn{width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.15);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;opacity:0.7}
.fc-nav-btn:hover{background:rgba(255,255,255,0.25);opacity:1;transform:scale(1.1)}
.fc-nav-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none}
.habit-info{flex:1;min-width:0}
.habit-text{font-size:var(--text-2xs);font-weight:500;line-height:1.4}
.habit-meta{font-size:var(--text-3xs);color:var(--txt3);margin-top:2px}
.habit-del{font-size:var(--text-xs);color:var(--txt3);cursor:pointer;opacity:0.4}
.habit-category{position:absolute;bottom:4px;right:8px;font-size:var(--text-3xs);color:var(--sec);background:rgba(122,158,159,0.15);padding:1px 6px;border-radius:var(--r-full)}

.names-container{margin-bottom:var(--sp-3)}
/* ปุ่มเพิ่มพระนามเล็กๆ */
.name-add-toggle{display:flex;align-items:center;justify-content:center;gap:var(--sp-2);padding:var(--sp-2);background:var(--pink-ll);border:1px dashed var(--pink);border-radius:var(--r-md);color:var(--pink);font-size:var(--text-2xs);font-weight:500;cursor:pointer;margin-bottom:var(--sp-3);transition:all 0.2s;min-height:40px}
.name-add-toggle:hover{background:var(--pink-l);border-style:solid}
.name-add-toggle svg{width:14px;height:14px;stroke:var(--pink);fill:none}
/* ฟอร์มเพิ่มพระนาม - ซ่อนเป็นค่าเริ่มต้น */
.name-add-form{display:none;padding:var(--sp-3);background:linear-gradient(135deg,var(--card),var(--pink-ll));border-radius:var(--r-md);box-shadow:var(--shadow-sm);margin-bottom:var(--sp-3);border:1px solid rgba(212,115,140,0.15)}
.name-add-form.show{display:block}
.name-add-form-title{font-size:var(--text-2xs);font-weight:600;color:var(--pink);margin-bottom:var(--sp-2);display:flex;align-items:center;gap:var(--sp-2)}
.name-add-form-title svg{width:14px;height:14px;stroke:var(--pink);fill:none}
.name-add-grid{display:grid;grid-template-columns:100px 1fr 60px;gap:var(--sp-2);margin-bottom:var(--sp-2)}
.name-add-input{padding:var(--sp-2) var(--sp-3);border:1px solid var(--pink-l);border-radius:var(--r-full);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:#fff;min-height:38px}
.name-add-input:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px rgba(212,115,140,0.15)}
.name-add-input.ar{font-family:'Amiri',serif;font-size:var(--text-base);text-align:center;border-radius:var(--r-full)}
.name-add-row2{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-2);margin-bottom:var(--sp-2)}
.name-add-col label{font-size:var(--text-3xs);color:var(--txt3);display:block;margin-bottom:var(--sp-1)}
.name-add-col .name-toolbar{display:flex;gap:4px;margin-bottom:4px}
.name-add-col .name-toolbar button{width:24px;height:24px;border:1px solid var(--pink-l);border-radius:var(--r-xs);background:#fff;cursor:pointer;font-size:var(--text-2xs);color:var(--pink);transition:all 0.15s}
.name-add-col .name-toolbar button:hover{background:var(--pink-ll)}
.name-add-col .name-toolbar .tb-bold{font-weight:700}
.name-add-col .name-toolbar .tb-italic{font-style:italic}
.name-add-col .name-toolbar .tb-hl{width:20px;height:20px;border-radius:var(--r-xs)}
.name-add-col .name-toolbar .tb-hl.c1{background:#FADEE3}
.name-add-col .name-toolbar .tb-hl.c2{background:#D4EDEC}
.name-add-col .name-toolbar .tb-hl.c3{background:#FFF3CD}
.name-add-edit{min-height:60px;padding:var(--sp-2);border:1px solid var(--bdr);border-radius:var(--r-sm);background:#fff;font-size:var(--text-2xs);line-height:1.5}
.name-add-edit:focus{outline:none;border-color:var(--pink)}
.name-add-edit:empty:before{content:attr(data-placeholder);color:var(--txt3)}
.name-add-btns{display:flex;justify-content:flex-end}
.name-add-btn{padding:var(--sp-2) var(--sp-4);border:none;border-radius:var(--r-full);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;font-weight:500;cursor:pointer;min-height:38px;transition:all 0.2s}
.name-add-btn.primary{background:var(--pink);color:#fff}
.name-add-btn.primary:hover{opacity:0.9}
.name-add-btn.secondary{display:none}

.names-list{display:grid;gap:var(--sp-3)}

.name-card{background:linear-gradient(145deg,#FFFFFF 0%,var(--pink-ll) 50%,var(--pink-l) 100%);border-radius:var(--r-md);padding:var(--sp-3);position:relative;box-shadow:var(--shadow-sm);border:1px solid rgba(212,115,140,0.12)}
.name-del{position:absolute;top:var(--sp-2);right:var(--sp-2);width:24px;height:24px;background:rgba(180,80,80,0.08);border:none;border-radius:var(--r-full);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.name-del:hover{background:rgba(180,80,80,0.15)}
.name-del:focus-visible{box-shadow:var(--focus-ring)}
.name-del svg{width:12px;height:12px;stroke:#B45050;stroke-width:2;fill:none}
.name-edit-btn{position:absolute;top:var(--sp-2);left:var(--sp-2);width:24px;height:24px;background:rgba(212,115,140,0.1);border:none;border-radius:var(--r-full);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.name-edit-btn:hover{background:rgba(212,115,140,0.2)}
.name-edit-btn:focus-visible{box-shadow:var(--focus-ring)}
.name-edit-btn svg{width:12px;height:12px;stroke:var(--pink);stroke-width:2;fill:none}
.name-ar{font-family:'Amiri',serif;font-size:var(--text-lg);font-weight:700;color:var(--pink);text-align:center;margin:var(--sp-1) 0 var(--sp-2);line-height:1.4}
.name-meaning-main{font-size:var(--text-2xs);color:var(--pri);text-align:center;margin-bottom:var(--sp-2);font-weight:500}
.name-src{font-size:var(--text-3xs);color:var(--txt3);text-align:center;margin-bottom:var(--sp-2)}
.name-content-box{background:#fff;padding:var(--sp-2);border-radius:var(--r-sm);border:1px solid var(--pink-l);min-height:60px;display:flex;flex-direction:column}
.name-content-label{font-size:var(--text-3xs);color:var(--pink);margin-bottom:var(--sp-1);font-weight:600;display:flex;align-items:center;gap:var(--sp-1)}
.name-content-label svg{width:11px;height:11px;stroke:var(--pink);fill:none}
.name-content-text{font-size:var(--text-2xs);line-height:1.5;color:var(--txt);flex:1}

/* Continue Card - ดำเนินการต่อ */
.continue-card{background:linear-gradient(135deg,var(--pri-ll),var(--sec-ll));border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);cursor:pointer;transition:all 0.2s;border:1px solid rgba(107,91,122,0.1)}
.continue-card:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.continue-card:active{transform:scale(0.99)}
.continue-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-2)}
.continue-label{font-size:var(--text-3xs);color:var(--pri);font-weight:600;display:flex;align-items:center;gap:var(--sp-1)}
.continue-label svg{width:12px;height:12px;stroke:var(--pri);fill:none}
.continue-btn{padding:var(--sp-1) var(--sp-2);background:var(--pri);color:#fff;border:none;border-radius:var(--r-full);font-size:var(--text-3xs);font-weight:500;cursor:pointer;display:flex;align-items:center;gap:4px}
.continue-btn svg{width:10px;height:10px;stroke:#fff;fill:none}
.continue-info{display:flex;align-items:center;gap:var(--sp-2)}
.continue-surah{flex:1}
.continue-name{font-size:var(--text-2xs);font-weight:600;color:var(--txt)}
.continue-ar{font-family:'Amiri',serif;font-size:var(--text-sm);color:var(--txt2)}
.continue-progress{display:flex;gap:4px;align-items:center}
.continue-bar{width:40px;height:4px;background:rgba(0,0,0,0.08);border-radius:2px;overflow:hidden}
.continue-bar-fill{height:100%;border-radius:2px}
.continue-bar.b1 .continue-bar-fill{background:var(--pri)}
.continue-bar.b2 .continue-bar-fill{background:var(--sec)}
.continue-bar.b3 .continue-bar-fill{background:var(--tafsir)}

.know-header{background:linear-gradient(135deg,#ae6aa7 0%,#fff4ff 50%,#dc679c 100%);border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:0 4px 20px rgba(174,106,167,0.25)}

/* Paper Card Styles - A4 Feel */
.paper-card{background:#fff;border-radius:var(--r-lg);overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.05)}
.paper-header{padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.paper-header-content{display:flex;align-items:center;gap:12px}
.paper-header-content svg{flex-shrink:0}
.paper-title{color:#fff;font-size:var(--text-sm);font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.1)}
.paper-subtitle{color:rgba(255,255,255,0.9);font-size:var(--text-3xs);margin-top:2px}
.paper-action-btn{width:32px;height:32px;background:rgba(255,255,255,0.2);border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s}
.paper-action-btn:hover{background:rgba(255,255,255,0.3)}
.paper-body{padding:var(--sp-3)}
.know-header h2{font-size:var(--text-sm);font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:var(--sp-2);color:#fff}
.know-header h2 svg{width:16px;height:16px;stroke:#fff;fill:none}
.know-header p{font-size:var(--text-2xs);color:rgba(255,255,255,0.9)}
.know-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-2);margin-top:var(--sp-2);margin-bottom:var(--sp-3)}
.know-stat{text-align:center;padding:var(--sp-3);background:#fff;border-radius:var(--r-md);box-shadow:0 2px 8px rgba(0,0,0,0.06);cursor:pointer;transition:all 0.2s}
.know-stat:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.know-stat:active{transform:scale(0.98)}
.know-stat.ks-notes .know-stat-num{color:var(--pri)}
.know-stat.ks-habits .know-stat-num{color:var(--sec)}
.know-stat.ks-names .know-stat-num{color:var(--pink)}
.know-stat-num{font-size:var(--text-md);font-weight:700}
.know-stat-label{font-size:var(--text-3xs);color:var(--txt3);margin-top:1px}

.names-section{background:#fff;border-radius:12px;padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.names-section-title{font-size:var(--text-sm);font-weight:600;margin-bottom:var(--sp-3);color:var(--txt);display:flex;align-items:center;gap:var(--sp-2)}
.names-section-title svg{width:14px;height:14px;stroke:var(--pink);fill:none}
.names-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-2)}
@media(min-width:600px){.names-grid{grid-template-columns:repeat(3,1fr)}}
.name-chip{background:linear-gradient(145deg,#fff,var(--pink-ll));border-radius:12px;padding:var(--sp-2) var(--sp-3);text-align:center;cursor:pointer;transition:all 0.15s;min-height:52px;display:flex;flex-direction:column;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
.name-chip:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(212,115,140,0.15)}
.name-chip:focus-visible{box-shadow:var(--focus-ring)}
.name-chip-ar{font-family:'Amiri',serif;font-size:var(--text-sm);font-weight:600;color:var(--pink)}
.name-chip-meaning{font-size:var(--text-3xs);color:var(--txt2);margin-top:var(--sp-1);line-height:1.35}

.habits-section{background:#fff;border-radius:12px;padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.habits-section-title{font-size:var(--text-sm);font-weight:600;margin-bottom:var(--sp-2);color:var(--txt);display:flex;align-items:center;gap:var(--sp-2)}
.habits-section-title svg{width:14px;height:14px;stroke:var(--done);fill:none}
.habits-filter-row{display:flex;gap:4px;margin-bottom:var(--sp-2);flex-wrap:wrap}
.habits-filter-btn{padding:4px 10px;background:#f8f8f8;border:none;border-radius:16px;font-size:var(--text-3xs);font-family:'Noto Sans Thai',sans-serif;cursor:pointer;color:var(--txt3);font-weight:500;transition:all 0.15s}
.habits-filter-btn:focus-visible{box-shadow:var(--focus-ring)}
.habits-filter-btn.active{background:rgba(122,158,159,0.2);color:#324b4c}

.random-section{margin-bottom:var(--sp-3)}
.filter-row{display:flex;gap:4px;margin-bottom:var(--sp-2);flex-wrap:wrap}
.filter-btn{padding:4px 10px;background:#f8f8f8;border:none;border-radius:16px;font-size:var(--text-3xs);font-family:'Noto Sans Thai',sans-serif;cursor:pointer;color:var(--txt3);font-weight:500;transition:all 0.15s}
.filter-btn:focus-visible{box-shadow:var(--focus-ring)}
.filter-btn.active{background:rgba(59,45,73,0.15);color:#3b2d49}
.random-controls{display:flex;gap:var(--sp-2);margin-bottom:var(--sp-2);flex-wrap:wrap;align-items:center}
.random-select{padding:var(--sp-1);border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card);min-height:32px}
.random-list{display:flex;flex-direction:column;gap:var(--sp-2)}
.random-card{background:#fff;border-radius:12px;padding:var(--sp-2) var(--sp-3);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.random-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-1)}
.random-type{font-size:var(--text-3xs);font-weight:500;padding:2px 8px;border-radius:var(--r-xs)}
.random-type.t-notes{background:var(--pri-ll);color:var(--pri)}
.random-type.t-meanings{background:var(--sec-ll);color:var(--sec)}
.random-type.t-tafsirs{background:var(--tafsir-ll);color:var(--tafsir)}
.random-type.t-overview{background:var(--overview-ll);color:var(--overview)}
.random-type.t-reasons{background:var(--reasons-ll);color:var(--reasons)}
.random-source{font-size:var(--text-3xs);color:var(--txt3)}
.random-ar-wrap{margin:4px 0}
.random-ar-toggle{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;cursor:pointer;font-size:var(--text-3xs);color:var(--gold);border-radius:var(--r-xs);transition:all 0.2s}
.random-ar-toggle:hover{background:rgba(184,149,107,0.1)}
.random-ar-toggle svg{width:11px;height:11px;transition:transform 0.2s}
.random-ar-toggle.open svg{transform:rotate(180deg)}
.random-ar-text{font-family:'Amiri',serif;font-size:clamp(0.95rem,2.5vw,1.1rem);color:var(--txt);direction:rtl;text-align:right;line-height:2.2;padding:8px 12px;background:linear-gradient(135deg,rgba(184,149,107,0.04),transparent);border-radius:var(--r-sm);margin-top:4px;word-spacing:4px}
.random-text{line-height:1.6}
.font-size-controls{display:flex;gap:4px;align-items:center}
.font-size-btn{width:24px;height:24px;border:1px solid var(--bdr);border-radius:var(--r-sm);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:var(--text-2xs);color:var(--txt2);transition:all 0.15s}
.font-size-btn:hover{background:var(--pri-ll);border-color:var(--pri-l)}
.font-size-btn:active{transform:scale(0.95)}

.surah-filter{margin-bottom:var(--sp-3)}
.surah-filter-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-3)}
.surah-filter-title{font-size:var(--text-sm);font-weight:600;display:flex;align-items:center;gap:var(--sp-2)}
.surah-filter-title svg{width:14px;height:14px;stroke:var(--pri);fill:none}
.surah-filter-select{padding:var(--sp-2);border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card);min-height:36px;min-width:100px}

.notebook-view{background:var(--card);border-radius:var(--r-md);box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:var(--sp-3);border:1px solid var(--bdr-l)}
.notebook-view-head{background:linear-gradient(135deg,var(--pri-ll),var(--sec-ll));padding:var(--sp-3)}
.notebook-view-title{font-size:var(--text-sm);font-weight:600;color:var(--pri);display:flex;align-items:center;gap:var(--sp-2)}
.notebook-view-title svg{width:16px;height:16px;stroke:var(--pri);fill:none}
.notebook-view-subtitle{font-size:var(--text-2xs);color:var(--txt2);margin-top:2px}
.notebook-page{padding:var(--sp-3)}
.notebook-overview{padding:var(--sp-3);background:var(--overview-ll);border-radius:var(--r-sm);margin-bottom:var(--sp-3)}

.empty-state{font-size:var(--text-2xs);color:var(--txt3);text-align:center;padding:var(--sp-3)}
.notebook-overview-label{font-size:var(--text-2xs);font-weight:600;color:var(--overview);margin-bottom:4px}
.notebook-overview-text{font-size:var(--text-xs);line-height:1.6}
.notebook-reasons{padding:var(--sp-3);background:var(--reasons-ll);border-radius:var(--r-sm);margin-bottom:var(--sp-3)}
.notebook-reasons-label{font-size:var(--text-2xs);font-weight:600;color:var(--reasons);margin-bottom:4px}
.notebook-reasons-text{font-size:var(--text-xs);line-height:1.6}
.notebook-stories{padding:var(--sp-3);background:#fff3e0;border-radius:var(--r-sm);margin-bottom:var(--sp-3)}
.notebook-stories-label{font-size:var(--text-2xs);font-weight:600;color:#e65100;margin-bottom:4px}
.notebook-stories-text{font-size:var(--text-xs);line-height:1.6}
.notebook-ayah{margin-bottom:var(--sp-2)}
.notebook-ayah-head{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.notebook-ayah-num{background:linear-gradient(135deg,var(--pri),var(--pri-l));color:#fff;padding:3px 10px;border-radius:var(--r-xs);font-size:var(--text-2xs);font-weight:600}
.notebook-ayah-ar{font-family:'Amiri',serif;font-size:clamp(0.95rem,2.5vw,1.1rem);color:var(--txt);direction:rtl;text-align:right;line-height:2.2;padding:8px 12px;background:linear-gradient(135deg,rgba(139,115,176,0.06),transparent);border-radius:var(--r-sm);margin-bottom:6px;word-spacing:4px}
.notebook-ayah-content{padding-left:6px}
.notebook-note{display:flex;gap:6px;margin-bottom:3px;font-size:var(--text-xs);line-height:1.5}
.notebook-note-label{font-weight:500;min-width:40px;flex-shrink:0;font-size:0.55rem}
.notebook-note-label.nl-notes{color:var(--pri)}
.notebook-note-label.nl-meanings{color:var(--sec)}
.notebook-note-label.nl-tafsirs{color:var(--tafsir)}

.cal-header{background:linear-gradient(135deg,#D4A5D9 0%,#B8E0D2 40%,#F8C8C8 100%);border-radius:var(--r-md);padding:var(--sp-3);margin-bottom:var(--sp-3);color:#fff}
.cal-header-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:var(--sp-2)}
.cal-header h2{font-size:var(--text-sm);font-weight:500;display:flex;align-items:center;gap:6px}
.cal-header h2 svg{width:14px;height:14px;stroke:#fff;fill:none}
.cal-header-date{font-size:var(--text-2xs);opacity:0.9;margin-top:2px}
.cal-header-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-2)}
.cal-stat{text-align:center;padding:var(--sp-2);background:rgba(255,255,255,0.12);border-radius:var(--r-sm)}
.cal-stat-num{font-size:var(--text-sm);font-weight:600}
.cal-stat-label{font-size:var(--text-3xs);opacity:0.85;margin-top:1px}
.cal-info-row{display:flex;gap:var(--sp-2);margin-top:var(--sp-2)}
.cal-info-item{flex:1;display:flex;align-items:center;gap:6px;padding:var(--sp-2);background:rgba(255,255,255,0.12);border-radius:var(--r-sm);font-size:var(--text-3xs)}
.cal-info-item svg{width:12px;height:12px;stroke:rgba(255,255,255,0.85);fill:none}
.cal-predict-mini{background:rgba(255,255,255,0.15);padding:var(--sp-2);border-radius:var(--r-sm)}
.cal-predict-mini .cal-predict-label{font-size:var(--text-3xs);color:#fff;opacity:0.9}

.goal-check-card{background:#fff;border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l)}
.goal-check-title{font-size:var(--text-2xs);font-weight:600;margin-bottom:var(--sp-2);display:flex;align-items:center;gap:6px;color:var(--txt2)}
.goal-check-title svg{width:14px;height:14px;stroke:var(--done);fill:none}
.goal-check-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-2)}
.goal-check-item{display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2) var(--sp-3);border-radius:var(--r-lg);background:linear-gradient(135deg,var(--done-l),var(--card2));transition:all 0.2s;border:1px solid rgba(122,158,122,0.15);min-height:44px}
.goal-check-item:focus-visible{box-shadow:var(--focus-ring)}
.goal-check-item.completed{background:linear-gradient(135deg,var(--done-l),rgba(122,158,122,0.15));border-color:rgba(122,158,122,0.25)}
.goal-checkbox{width:18px;height:18px;border:2px solid var(--bdr);border-radius:var(--r-full);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;background:#fff}
.goal-checkbox svg{width:10px;height:10px;stroke-width:2.5;fill:none}
.goal-checkbox:not(.checked) svg{stroke:transparent}
.goal-checkbox.checked{border-color:transparent}
.goal-checkbox.checked svg{stroke:#fff}
.goal-check-info{flex:1;min-width:0}
.goal-check-text{font-size:var(--text-2xs);font-weight:500;white-space:normal;overflow:visible;text-overflow:clip;line-height:1.4}
.goal-check-meta{font-size:var(--text-3xs);color:var(--txt3);margin-top:1px}

.cal-review{background:#fff;border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l);overflow:hidden}
.cal-review-title{font-size:var(--text-2xs);font-weight:600;margin-bottom:var(--sp-2);display:flex;align-items:center;gap:6px;color:var(--txt2)}
.cal-review-title svg{width:14px;height:14px;stroke:var(--sec);fill:none}
.review-list{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-2)}
@media(min-width:500px){.review-list{grid-template-columns:repeat(3,1fr)}}
.review-item{display:flex;align-items:center;gap:6px;padding:var(--sp-2) var(--sp-2);border-radius:var(--r-lg);background:linear-gradient(135deg,var(--sec-ll),var(--card2));transition:all 0.15s;cursor:pointer;border:1px solid rgba(122,158,159,0.15);min-height:40px;min-width:0;overflow:hidden}
.review-item:hover{background:linear-gradient(135deg,var(--sec-ll),var(--sec-l));border-color:var(--sec-l)}
.review-item:focus-visible{box-shadow:var(--focus-ring)}
.review-item.done-item{background:linear-gradient(135deg,var(--done-l),rgba(122,158,122,0.1));border-color:rgba(122,158,122,0.2)}
.review-text{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:var(--text-3xs)}
.review-badge{flex-shrink:0;font-size:6px;padding:2px 4px;border-radius:4px}
.review-check{width:14px;height:14px;border:2px solid var(--bdr);border-radius:var(--r-full);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:#fff}
.review-check svg{width:8px;height:8px;stroke-width:2.5;fill:none}
.review-check:not(.done) svg{stroke:transparent}
.review-check.done{background:var(--done);border-color:var(--done)}
.review-check.done svg{stroke:#fff}
.review-text{font-size:var(--text-3xs);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.review-text.done-text{text-decoration:line-through;color:var(--txt3)}
.review-badge{font-size:8px;padding:2px 8px;border-radius:var(--r-full);font-weight:500;flex-shrink:0}
.review-badge.rb1{background:var(--pri-ll);color:var(--pri)}
.review-badge.rb2{background:var(--sec-ll);color:var(--sec)}
.review-badge.rb3{background:var(--tafsir-ll);color:var(--tafsir)}

.calendar-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l)}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;padding:var(--sp-2) var(--sp-3);background:linear-gradient(135deg,var(--pri-ll),var(--sec-ll),var(--tafsir-ll))}
.calendar-nav-btn{width:32px;height:32px;border:none;background:rgba(255,255,255,0.8);border-radius:var(--r-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.calendar-nav-btn:hover{background:#fff}
.calendar-nav-btn:focus-visible{box-shadow:var(--focus-ring)}
.calendar-nav-btn svg{width:14px;height:14px;stroke:var(--txt2);fill:none}
.calendar-title{font-size:var(--text-sm);font-weight:600;color:var(--pri)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr)}
.calendar-day-name{padding:var(--sp-1);text-align:center;font-size:var(--text-3xs);color:var(--txt3);font-weight:500}
.calendar-day{padding:var(--sp-1);text-align:center;cursor:pointer;min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:2px;position:relative;transition:all 0.15s}
.calendar-day:hover{background:rgba(122,158,159,0.08)}
.calendar-day:focus-visible{box-shadow:inset var(--focus-ring)}
/* วันนี้ - วงกลมสีชัดเจน */
.calendar-day.today{background:rgba(122,158,159,0.15)}
.calendar-day.today .day-num{background:var(--sec);color:#fff;font-weight:700}
.day-num{width:24px;height:24px;border-radius:var(--r-full);display:flex;align-items:center;justify-content:center;font-size:var(--text-2xs);font-weight:500;transition:all 0.2s}
.calendar-dots{display:flex;gap:2px;margin-top:1px}
.calendar-dot{width:4px;height:4px;border-radius:var(--r-full)}
.calendar-dot.cd1{background:var(--pri)}
.calendar-dot.cd2{background:var(--sec)}
.calendar-dot.cd3{background:var(--tafsir)}
/* Gradient levels สำหรับความเข้มการท่อง - ยิ่งเข้มยิ่งขยัน */
/* lv1-2: เริ่มต้น (1-1.5x), lv3-4: ดี (1.5-2.5x), lv5-6: ยอดเยี่ยม (2.5x+) */
/* สี pastel ไล่ระดับ: ม่วงอ่อน → เขียวมิ้นท์ → ชมพูอ่อน */
.calendar-day.lv1{background:rgba(183,177,206,0.25)}
.calendar-day.lv2{background:rgba(183,177,206,0.4)}
.calendar-day.lv3{background:rgba(210,225,225,0.6)}
.calendar-day.lv4{background:rgba(210,225,225,0.8)}
.calendar-day.lv5{background:linear-gradient(135deg,rgba(183,177,206,0.5),rgba(230,238,239,0.7))}
.calendar-day.lv6{background:linear-gradient(135deg,rgba(183,177,206,0.6),rgba(230,238,239,0.8),rgba(233,199,215,0.6))}
/* ตัวเลขสีเข้มชัดเจน */
.calendar-day.lv1 .day-num,.calendar-day.lv2 .day-num{color:#6b5a8e}
.calendar-day.lv3 .day-num,.calendar-day.lv4 .day-num{color:#4a6b6b;font-weight:600}
.calendar-day.lv5 .day-num,.calendar-day.lv6 .day-num{color:#4a4063;font-weight:700}
.calendar-day.predict-day .day-num{color:var(--gold);font-weight:600;text-shadow:0 1px 2px rgba(255,255,255,0.8)}

/* การ์ดวันนี้สำหรับหน้าปฏิทิน - ออกแบบใหม่ */
.cal-today-card{background:linear-gradient(135deg,var(--pri-ll) 0%,var(--sec-ll) 50%,var(--tafsir-ll) 100%);border-radius:var(--r-lg);padding:var(--sp-3);margin-bottom:var(--sp-3);box-shadow:var(--shadow);border:1px solid rgba(107,91,122,0.1)}
.cal-today-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-2)}
.cal-today-title{display:flex;align-items:center;gap:var(--sp-2)}
.cal-today-title svg{width:16px;height:16px;stroke:var(--pri);fill:none}
.cal-today-title h2{font-size:var(--text-sm);font-weight:600;color:var(--pri)}
.cal-today-date{font-size:var(--text-2xs);color:#fff;background:linear-gradient(135deg,var(--pri),var(--sec));padding:var(--sp-1) var(--sp-2);border-radius:var(--r-full);font-weight:500}
.cal-today-hadith{font-size:var(--text-2xs);color:var(--txt2);text-align:center;font-style:italic;line-height:1.6;padding:0;margin-bottom:var(--sp-3)}
.cal-today-hadith .hadith-ref{display:inline;font-size:var(--text-3xs);color:var(--pri);font-style:normal;font-weight:500;margin-left:6px}
.cal-today-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-2)}
.cal-today-stat{text-align:center;padding:var(--sp-2) var(--sp-3);background:#fff;border-radius:var(--r-md);box-shadow:var(--shadow-sm);cursor:pointer;transition:all 0.2s}
.cal-today-stat:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.cal-today-stat:active{transform:scale(0.98)}
.cal-today-stat-num{font-size:var(--text-md);font-weight:700}
.cal-today-stat.s1 .cal-today-stat-num{color:var(--pri)}
.cal-today-stat.s2 .cal-today-stat-num{color:var(--sec)}
.cal-today-stat.s3 .cal-today-stat-num{color:var(--tafsir)}
.cal-today-stat-label{font-size:var(--text-3xs);color:var(--txt3);margin-top:1px}
.cal-today-info{display:flex;gap:var(--sp-2)}
.cal-today-info-item{flex:1;display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2) var(--sp-3);background:linear-gradient(135deg,var(--pri-ll),#fff);border-radius:var(--r-full);font-size:var(--text-2xs);color:var(--pri);border:1px solid rgba(107,91,122,0.1);font-weight:500}
.cal-today-info-item svg{width:12px;height:12px;stroke:var(--pri);fill:none;flex-shrink:0}
.cal-today-info-item.predict{background:linear-gradient(135deg,var(--gold-l),#fff);color:var(--gold);border-color:rgba(184,149,107,0.15);border-radius:var(--r-full)}
.cal-today-info-item.predict svg{stroke:var(--gold)}

/* Knowledge Tabs - 6 tabs */
.know-tabs-wrap{overflow-x:auto;margin:0 calc(-1 * var(--sp-4));padding:0 var(--sp-4);margin-bottom:var(--sp-3)}
.know-tabs{display:flex;background:var(--card2);border-radius:var(--r-lg);padding:3px;gap:2px;min-width:max-content}
.know-tab{flex:1;min-width:50px;padding:6px 8px;border:none;background:transparent;border-radius:var(--r-md);font-size:var(--text-3xs);font-weight:500;color:var(--txt3);cursor:pointer;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif;display:flex;flex-direction:column;align-items:center;gap:2px}
.know-tab svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5}
.know-tab span{white-space:nowrap}
.know-tab.active{background:var(--card);color:var(--pri);box-shadow:var(--shadow-sm)}
.know-tab.active svg{stroke:var(--pri)}
.know-tab:hover:not(.active){background:rgba(255,255,255,0.5)}
.know-content{animation:fadeIn 0.3s ease}
.know-section-header{text-align:center;padding:var(--sp-3);border-radius:var(--r-lg);margin-bottom:var(--sp-3)}
.know-section-header.names-header{background:linear-gradient(135deg,var(--pink),var(--pink-l))}
.know-section-header.names-header .know-section-title{color:#fff}
.know-section-header.names-header .know-section-title svg{stroke:#fff}
.know-section-header.names-header p{color:rgba(255,255,255,0.8)}
.know-section-header.habits-header{background:linear-gradient(135deg,var(--sec),#5d8a8b)}
.know-section-header.habits-header .know-section-title{color:#fff}
.know-section-header.habits-header .know-section-title svg{stroke:#fff}
.know-section-header.habits-header p{color:rgba(255,255,255,0.8)}
.know-section-title{display:flex;align-items:center;justify-content:center;gap:var(--sp-2);font-size:var(--text-sm);font-weight:600;color:var(--pri)}
.know-section-title svg{width:18px;height:18px;stroke:var(--pri);fill:none}
.know-section-header p{font-size:var(--text-3xs);color:var(--txt3);margin-top:4px}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* Resources Styles - Advanced */
.resources-container{background:var(--card);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow-sm);border:1px solid var(--bdr-l)}
.resources-header{padding:var(--sp-3);background:linear-gradient(135deg,#640000 0%,#eb6677 50%,#5b0000 100%);text-align:center;border-bottom:none;border-radius:var(--r-lg) var(--r-lg) 0 0;margin-bottom:0;color:#fff}
.resources-title{display:flex;align-items:center;justify-content:center;gap:var(--sp-2);font-size:var(--text-sm);font-weight:600;color:var(--pri)}
.resources-title svg{stroke:var(--pri);fill:none}
.resources-header-actions{display:flex;gap:6px;justify-content:center;margin-top:var(--sp-2)}
.res-header-btn{display:flex;align-items:center;gap:4px;padding:5px 10px;border:1px solid var(--bdr);border-radius:var(--r-full);background:var(--card);color:var(--txt2);font-size:var(--text-3xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;transition:all 0.2s}
.res-header-btn:hover{background:var(--card2);border-color:var(--pri-l)}
.res-header-btn.primary{background:var(--pri);color:#fff;border-color:var(--pri)}
.res-header-btn.primary:hover{opacity:0.9}
.res-header-btn svg{stroke:currentColor;fill:none}
.resources-cats{display:flex;gap:6px;padding:var(--sp-2);overflow-x:auto;background:#fef8f8}
.resources-cats::-webkit-scrollbar{height:0}
.res-cat-btn{padding:5px 12px;border-radius:16px;border:none;background:#fff;color:#8b4545;font-size:var(--text-3xs);cursor:pointer;white-space:nowrap;font-family:'Noto Sans Thai',sans-serif;transition:all 0.2s;display:flex;align-items:center;gap:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.res-cat-btn .cat-color{width:8px;height:8px;border-radius:50%}
.res-cat-btn.active{background:#640000;color:#fff}
.res-cat-btn:hover:not(.active){background:#fee}
.resources-list{padding:var(--sp-2)}
.resources-list::-webkit-scrollbar{width:3px}
.resources-list::-webkit-scrollbar-track{background:transparent}
.resources-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08);border-radius:3px}
.resources-list::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0.12)}
.res-group{border-bottom:1px solid var(--bdr-l)}
.res-group:last-child{border-bottom:none}
.res-group-header{display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2) var(--sp-3);cursor:pointer;transition:background 0.2s}
.res-group-header:hover{background:var(--card2)}
.res-group-icon{width:28px;height:28px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:0.9rem}
.res-group-info{flex:1}
.res-group-name{font-size:var(--text-2xs);font-weight:600;color:var(--txt)}
.res-group-desc{font-size:var(--text-3xs);color:var(--txt3)}
.res-group-actions{display:flex;gap:4px}
.res-group-btn{width:24px;height:24px;border:none;background:none;color:var(--txt3);cursor:pointer;border-radius:var(--r-xs);display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.res-group-btn:hover{background:var(--card2);color:var(--pri)}
.res-group-btn svg{width:12px;height:12px;stroke:currentColor;fill:none}
.res-group-items{padding:0 var(--sp-2) var(--sp-2) 40px}
.res-item{display:flex;align-items:center;gap:var(--sp-2);padding:6px var(--sp-2);border-radius:var(--r-sm);transition:background 0.2s;margin-bottom:2px}
.res-item:hover{background:var(--card2)}
.res-item:last-child{margin-bottom:0}
.res-icon{width:24px;height:24px;border-radius:var(--r-xs);display:flex;align-items:center;justify-content:center;font-size:0.8rem;flex-shrink:0}
.res-info{flex:1;min-width:0}
.res-info-name{font-size:var(--text-3xs);font-weight:500;color:var(--txt);text-decoration:none;display:block}
.res-info-name:hover{color:var(--pri)}
.res-info-desc{font-size:9px;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.res-info-cats{display:flex;gap:2px;margin-top:2px}
.res-info-cat{font-size:8px;padding:1px 4px;background:var(--card2);border-radius:4px;color:var(--txt3)}
.res-link{width:22px;height:22px;border-radius:var(--r-xs);display:flex;align-items:center;justify-content:center;flex-shrink:0;text-decoration:none;transition:transform 0.2s}
.res-link:hover{transform:scale(1.1)}
.res-link svg{width:10px;height:10px;stroke:#fff;fill:none}
.res-actions{display:flex;gap:2px;opacity:0;transition:opacity 0.2s}
.res-item:hover .res-actions{opacity:1}
.res-action-btn{width:20px;height:20px;background:none;border:none;color:var(--txt3);cursor:pointer;border-radius:var(--r-xs);display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.res-action-btn:hover{background:var(--card2);color:var(--pri)}
.res-action-btn.del:hover{color:#B45050}
.res-action-btn svg{width:11px;height:11px}
.res-standalone{padding:var(--sp-2) var(--sp-3)}

/* Resource Modal Styles */
.res-modal-form{display:flex;flex-direction:column;gap:var(--sp-2)}
.res-modal-row{display:flex;gap:var(--sp-2);align-items:center}
.res-modal-input{flex:1;padding:8px 10px;border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif}
.res-modal-input:focus{outline:none;border-color:var(--pri)}
.res-modal-input.sm{width:50px;flex:none;text-align:center}
.res-modal-select{padding:8px 10px;border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card)}
.res-modal-label{font-size:var(--text-3xs);color:var(--txt3);margin-bottom:2px}
.res-modal-cats{display:flex;flex-wrap:wrap;gap:4px;padding:var(--sp-2);background:var(--card2);border-radius:var(--r-sm);max-height:80px;overflow-y:auto}
.res-modal-cat{padding:3px 8px;border-radius:var(--r-full);border:1px solid var(--bdr);background:var(--card);font-size:var(--text-3xs);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:4px}
.res-modal-cat.selected{border-color:var(--pri);background:var(--pri-ll);color:var(--pri)}
.res-modal-cat .cat-dot{width:6px;height:6px;border-radius:50%}
.res-color-picker{display:flex;gap:4px;flex-wrap:wrap}
.res-color-opt{width:24px;height:24px;border-radius:var(--r-sm);cursor:pointer;border:2px solid transparent;transition:all 0.2s}
.res-color-opt:hover{transform:scale(1.1)}
.res-color-opt.selected{border-color:var(--txt)}
.res-modal-group-select{margin-top:var(--sp-2)}

.settings-section{margin-bottom:var(--sp-3)}
.settings-title{font-size:var(--text-2xs);font-weight:600;color:var(--txt3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:var(--sp-2);padding-left:var(--sp-1)}
.settings-card{background:#fff;border-radius:var(--r-lg);box-shadow:var(--shadow-sm);overflow:hidden;border:1px solid var(--bdr-l)}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:var(--sp-3);border-bottom:1px solid var(--bdr-l);flex-wrap:wrap;gap:var(--sp-2)}
.settings-row:last-child{border-bottom:none}
.settings-row-left{display:flex;align-items:center;gap:var(--sp-2);flex-shrink:0}
.settings-icon{width:36px;height:36px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1px solid;background:#fff}
.settings-icon svg{width:16px;height:16px;stroke-width:1.5;fill:none}
.settings-icon.si1{border-color:var(--pri-l)}
.settings-icon.si1 svg{stroke:var(--pri)}
.settings-icon.si2{border-color:var(--sec-l)}
.settings-icon.si2 svg{stroke:var(--sec)}
.settings-icon.si3{border-color:var(--tafsir-l)}
.settings-icon.si3 svg{stroke:var(--tafsir)}
.settings-icon.si4{border-color:var(--gold)}
.settings-icon.si4 svg{stroke:var(--gold)}
.settings-icon.si5{border-color:var(--pink-l)}
.settings-icon.si5 svg{stroke:var(--pink)}
.settings-info h4{font-size:var(--text-2xs);font-weight:500;font-family:'Noto Sans Thai',sans-serif}
.settings-info p{font-size:var(--text-3xs);color:var(--txt3);font-family:'Noto Sans Thai',sans-serif}
.settings-row-right{display:flex;align-items:center;gap:var(--sp-2);flex-wrap:wrap;flex:1;justify-content:flex-end}
.settings-input{padding:var(--sp-2) var(--sp-3);border:1px solid var(--bdr);border-radius:var(--r-md);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card2);width:80px;min-height:36px}
.settings-input:focus{outline:none;border-color:var(--pri);box-shadow:var(--focus-ring)}
.settings-input-sm{width:55px;text-align:center;padding:var(--sp-2)}
.settings-input-wide{width:auto;flex:1;min-width:100px;max-width:150px}
.settings-btn{padding:var(--sp-2) var(--sp-3);background:var(--pri);color:#fff;border:none;border-radius:var(--r-md);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;font-weight:500;cursor:pointer;min-height:36px;transition:all 0.2s}
.settings-btn:hover{opacity:0.9}
.settings-btn:focus-visible{box-shadow:var(--focus-ring)}
.settings-btn-light{background:var(--pri-ll);color:var(--pri)}
.settings-btn-danger{background:rgba(180,80,80,0.1);color:#B45050}

.settings-calc-row{display:flex;align-items:center;justify-content:space-between;padding:var(--sp-2);flex-wrap:wrap;gap:var(--sp-2)}
.settings-calc-left{display:flex;align-items:center;gap:var(--sp-2)}
.settings-calc-label{font-size:var(--text-2xs);color:var(--txt2)}
.settings-calc-input{width:55px;padding:var(--sp-2);border:1px solid var(--bdr);border-radius:var(--r-md);font-size:var(--text-2xs);text-align:center;background:var(--card2);min-height:36px}
.settings-calc-result{display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2);background:var(--done-l);border-radius:var(--r-md);margin:0 var(--sp-2) var(--sp-2)}
.settings-calc-result svg{width:16px;height:16px;stroke:var(--done);fill:none}
.settings-calc-date{font-size:var(--text-sm);font-weight:600;color:var(--done)}

.settings-predict-row{display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-2);background:linear-gradient(135deg,var(--pri-ll),var(--sec-ll));border-radius:0 0 var(--r-lg) var(--r-lg);margin-top:-1px}
.settings-predict-icon{width:32px;height:32px;background:var(--card);border-radius:var(--r-md);display:flex;align-items:center;justify-content:center}
.settings-predict-icon svg{width:16px;height:16px;stroke:var(--pri);fill:none}
.settings-predict-info{flex:1}
.settings-predict-label{font-size:var(--text-3xs);color:var(--txt3)}
.settings-predict-date{font-size:var(--text-sm);font-weight:600;color:var(--pri)}

.settings-goals-area{padding:var(--sp-2)}
.settings-goals-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--sp-2);margin-bottom:var(--sp-2)}
.settings-goal{background:var(--card2);border-radius:var(--r-md);padding:var(--sp-2);text-align:center;position:relative}
.settings-goal-emoji{font-size:var(--text-base)}
.settings-goal-name{font-size:var(--text-3xs);font-weight:500;margin-top:2px;line-height:1.2}
.settings-goal-prog{font-size:var(--text-3xs);color:var(--txt3)}
@media(min-width:1024px){.settings-goal-name{font-size:0.55rem}.settings-goal-prog{font-size:0.5rem}.settings-goal-emoji{font-size:var(--text-sm)}}
.settings-goal-del{position:absolute;top:2px;right:2px;width:16px;height:16px;background:rgba(180,80,80,0.1);color:#B45050;border:none;border-radius:var(--r-full);font-size:var(--text-3xs);cursor:pointer}
.settings-add-row{display:flex;gap:var(--sp-2);flex-wrap:wrap;padding-top:var(--sp-2);border-top:1px solid var(--bdr-l)}
.settings-add-input{flex:1;min-width:60px;padding:var(--sp-2) var(--sp-3);border:1px solid var(--bdr);border-radius:var(--r-md);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card);min-height:36px}
.settings-add-select{padding:var(--sp-2) var(--sp-3);border:1px solid var(--bdr);border-radius:var(--r-md);font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif;background:var(--card);min-height:36px}

/* Plus Page Styles */
.plus-card{background:var(--card);border-radius:var(--r-lg);padding:var(--sp-3) var(--sp-2);margin-bottom:var(--sp-2);display:flex;align-items:center;justify-content:space-between;border:1px solid var(--bdr-l);cursor:pointer;transition:all 0.2s;min-height:90px;box-shadow:var(--shadow-sm)}
@media(max-width:600px){.plus-card{min-height:110px;padding:var(--sp-3);border-radius:16px}}
@media(min-width:768px) and (max-width:1023px){.plus-card{min-height:90px;padding:var(--sp-3)}}
@media(min-width:1024px){.plus-card{min-height:70px;padding:var(--sp-2)}}
.plus-card:hover{border-color:var(--gold);box-shadow:var(--shadow)}
.plus-card.done{background:linear-gradient(135deg,var(--done-l),#fff);border-color:var(--done)}
.plus-card-left{display:flex;align-items:center;gap:var(--sp-3)}
.plus-card-check{width:22px;height:22px;border-radius:var(--r-sm);border:2px solid var(--bdr);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.plus-card-check.checked{background:var(--done);border-color:var(--done)}
.plus-card-check svg{width:12px;height:12px;stroke:#fff;stroke-width:3;fill:none;opacity:0}
.plus-card-check.checked svg{opacity:1}
.plus-card-info{flex:1}
.plus-card-name{font-size:var(--text-sm);font-weight:600;color:var(--txt)}
@media(min-width:768px){.plus-card-name{font-size:var(--text-base)}}
.plus-card-ar{font-family:'Amiri',serif;font-size:var(--text-md);color:var(--gold);margin:4px 0}
@media(min-width:768px){.plus-card-ar{font-size:var(--text-lg)}}
.plus-card-ref{font-size:var(--text-2xs);color:var(--txt3)}
@media(min-width:768px){.plus-card-ref{font-size:var(--text-xs)}}
.plus-card-theme{font-size:var(--text-3xs);color:var(--pri);margin-top:4px;padding:2px 8px;background:var(--pri-ll);border-radius:var(--r-xs);display:inline-block}
@media(min-width:768px){.plus-card-theme{font-size:var(--text-2xs);padding:3px 10px}}
.plus-card-right{flex-shrink:0}
.plus-card-progress{position:relative;width:40px;height:40px}
.plus-ring{transform:rotate(-90deg)}
.plus-ring-bg{fill:none;stroke:var(--bdr);stroke-width:3}
.plus-ring-fill{fill:none;stroke:var(--gold);stroke-width:3;stroke-linecap:round;transition:stroke-dasharray 0.3s}
.plus-ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:var(--text-3xs);font-weight:600;color:var(--txt)}
.plus-card.done .plus-ring-fill{stroke:var(--done)}
/* Hadith Strength Badge */
.hadith-badge{font-size:6px;padding:1px 4px;border-radius:4px;display:inline-block;margin-left:3px;font-weight:500;vertical-align:middle}
.hadith-badge.sahih{background:linear-gradient(135deg,#c8e6c9,#a5d6a7);color:#1b5e20}
/* Plus card gradient styles */
/* Plus card ใช้ CSS เดียวกับ surah-card ปกติ */
.hadith-badge.hasan{background:linear-gradient(135deg,#ffe0b2,#ffcc80);color:#e65100}
.hadith-badge.daif{background:linear-gradient(135deg,#ffcdd2,#ef9a9a);color:#b71c1c}
.hadith-badge.quran{background:linear-gradient(135deg,#e1bee7,#ce93d8);color:#6a1b9a}

.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:200;padding:var(--sp-4)}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:16px;padding:var(--sp-4);width:100%;max-width:360px;max-height:85vh;overflow-y:auto;overflow-x:hidden;box-shadow:var(--shadow-md)}
.modal-title{font-size:var(--text-sm);font-weight:600;margin-bottom:var(--sp-3);text-align:center;color:var(--pri)}
.modal-input{width:100%;padding:var(--sp-2);border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:var(--text-xs);margin-bottom:var(--sp-2);background:var(--card)}
.modal-input:focus{outline:none;border-color:var(--pri)}
.modal-textarea{min-height:80px;resize:none;line-height:1.6}
.modal-btn{width:100%;padding:var(--sp-2);border:none;border-radius:var(--r-sm);font-size:var(--text-xs);font-weight:500;cursor:pointer;margin-top:var(--sp-2);font-family:'Noto Sans Thai',sans-serif}
.modal-btn-primary{background:var(--pri);color:#fff}
.modal-btn-secondary{background:var(--card2);color:var(--txt2)}

.modal-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-2);margin-bottom:var(--sp-3)}
.modal-stat{text-align:center;padding:var(--sp-2);border-radius:var(--r-sm)}
.modal-stat.ms1{background:var(--pri-ll)}
.modal-stat.ms2{background:var(--sec-ll)}
.modal-stat.ms3{background:var(--tafsir-ll)}
.modal-stat-num{font-size:var(--text-md);font-weight:600}
.modal-stat.ms1 .modal-stat-num{color:var(--pri)}
.modal-stat.ms2 .modal-stat-num{color:var(--sec)}
.modal-stat.ms3 .modal-stat-num{color:var(--tafsir)}
.modal-stat-label{font-size:var(--text-3xs);color:var(--txt3);margin-top:2px}

.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--txt);color:#fff;padding:var(--sp-2) var(--sp-4);border-radius:var(--r-sm);font-size:var(--text-xs);z-index:300;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.empty-state{text-align:center;padding:var(--sp-3);color:var(--txt3);font-size:var(--text-2xs)}
</style>
</head>
<body>
<div class="app">
<div id="page-home" class="page active">
<div class="hdr">
    <div>
        <h1>Juz' Amma</h1>
        <div class="hdr-user" id="hdr-user" onclick="openModal('setup')">ตั้งชื่อผู้ใช้</div>
    </div>
    <div class="streak-box">
        <svg viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
        <span id="streak-num">0</span>
    </div>
</div>

<div class="basmala">
    <div class="basmala-ar">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>
    <div class="basmala-th">ด้วยพระนามของอัลลอฮ์ ผู้ทรงกรุณาปรานี ผู้ทรงเมตตาเสมอ</div>
</div>

<div class="hero-grid">
    <div class="hero-card" onclick="openModal('intention')">
        <div class="hero-label"><span><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>เจตนา</span><a>แก้ไข</a></div>
        <div class="hero-text" id="intention-text">แตะเพื่อตั้งเจตนา</div>
    </div>
    <div class="hero-card" onclick="openModal('quotes')">
        <div class="hero-label"><span><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>กำลังใจ</span><a>จัดการ</a></div>
        <div class="hero-text" id="quote-text">กำลังโหลด</div>
    </div>
</div>

<div class="stats-box" style="background:linear-gradient(135deg,#6B5B7A 0%,#8A7A99 30%,#7A6A89 50%,#9D8DAC 70%,#8A7A99 100%);padding:14px 16px;border-radius:var(--r-lg);box-shadow:0 4px 20px rgba(107,91,122,0.3)">
    <div style="display:flex;align-items:center;gap:14px">
        <div style="flex:1">
            <div style="font-size:9px;opacity:0.9;color:#fff">Juz' Amma</div>
            <div style="font-size:var(--text-md);font-weight:700;color:#fff" id="main-percent">0%</div>
            <div style="font-size:8px;opacity:0.8;color:#fff" id="total-ayah">0 / 571 อายะฮ์</div>
        </div>
        <div style="display:flex;gap:8px">
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="main-ring-text"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="main-text-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ตัวบท</div>
            </div>
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#a8edea" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="main-ring-meaning"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="main-meaning-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ความหมาย</div>
            </div>
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#f8bbd9" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="main-ring-tafsir"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="main-tafsir-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ตัฟซีร</div>
            </div>
        </div>
    </div>
    <div class="stats-grid" style="margin-top:12px">
        <div class="stat-item" onclick="showStatModal('surah')"><div class="stat-num" id="stat-surah">0</div><div class="stat-label">ซูเราะฮ์</div></div>
        <div class="stat-item" onclick="showStatModal('text')"><div class="stat-num" id="stat-text">0</div><div class="stat-label">ตัวบท</div></div>
        <div class="stat-item" onclick="showStatModal('meaning')"><div class="stat-num" id="stat-meaning">0</div><div class="stat-label">ความหมาย</div></div>
        <div class="stat-item" onclick="showStatModal('tafsir')"><div class="stat-num" id="stat-tafsir">0</div><div class="stat-label">ตัฟซีร</div></div>
    </div>
</div>

<!-- ดำเนินการต่อ -->
<div class="continue-card" id="continue-card" style="display:none" onclick="openContinueSurah()"></div>

<!-- กิจกรรมท่องจำวันนี้ -->
<!-- เป้าหมายและทบทวนวันนี้ -->
<div class="goal-check-card" id="home-goal-card" role="region" aria-label="เป้าหมายวันนี้"></div>
<div class="cal-review" id="home-review" role="region" aria-label="งานทบทวนวันนี้">
    <div class="cal-review-title"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ทบทวนวันนี้</div>
    <div class="review-list" id="home-review-list" role="list"></div>
</div>

<div class="section" role="region" aria-label="รายการซูเราะฮ์">
    <div class="section-title"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>ซูเราะฮ์</div>
    <div class="surah-grid" id="surah-grid" role="list"></div>
</div>

<div class="section">
    <div class="section-head"><div class="section-title"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>เป้าหมาย</div><a class="section-link" onclick="goToPage('settings')">แก้ไข</a></div>
    <div class="goals-grid" id="goals-grid"></div>
</div>

<div class="section">
    <div class="section-head"><div class="section-title"><svg viewBox="0 0 24 24"><path d="M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6"/><path d="M12 2L2 7l10 5 10-5-10-5z"/></svg>รางวัล</div><a class="section-link" onclick="goToPage('settings')">แก้ไข</a></div>
    <div class="goals-grid" id="rewards-grid"></div>
</div>
</div>

<div id="page-detail" class="page">
<div class="detail-header">
    <button class="back-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>กลับ</button>
    <div class="detail-top">
        <div><div class="detail-name" id="detail-name"></div><div class="detail-meta" id="detail-meta"></div></div>
        <div class="detail-ar" id="detail-ar"></div>
    </div>
</div>
<div id="detail-plus-info"></div>
<div class="rings-row" id="detail-rings"></div>
<div id="detail-body"></div>
</div>

<div id="page-plus" class="page">
<div class="hdr"><h1>Plus</h1></div>

<!-- Stats Box with premium gradient and 3 compact rings -->
<div class="stats-box" style="background:linear-gradient(135deg,#B8956B 0%,#D4A574 30%,#C9A06D 50%,#E8C9A0 70%,#D4A574 100%);padding:14px 16px;border-radius:var(--r-lg);box-shadow:0 4px 20px rgba(184,149,107,0.3)">
    <div style="display:flex;align-items:center;gap:14px">
        <div style="flex:1">
            <div style="font-size:9px;opacity:0.9;color:#fff">ความคืบหน้า Plus</div>
            <div style="font-size:var(--text-md);font-weight:700;color:#fff" id="plus-main-percent">0%</div>
            <div style="font-size:8px;opacity:0.8;color:#fff" id="plus-total-ayah">0 อายะฮ์</div>
        </div>
        <div style="display:flex;gap:8px">
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="plus-ring-text"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="plus-text-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ตัวบท</div>
            </div>
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#a8edea" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="plus-ring-meaning"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="plus-meaning-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ความหมาย</div>
            </div>
            <div style="text-align:center">
                <div style="position:relative;width:34px;height:34px">
                    <svg viewBox="0 0 40 40" style="transform:rotate(-90deg)">
                        <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="20" cy="20" r="16" fill="none" stroke="#f8bbd9" stroke-width="3" stroke-linecap="round" stroke-dasharray="100.5" stroke-dashoffset="100.5" id="plus-ring-tafsir"/>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:7px;font-weight:700;color:#fff" id="plus-tafsir-num">0%</div>
                </div>
                <div style="font-size:6px;color:#fff;opacity:0.9;margin-top:2px">ตัฟซีร</div>
            </div>
        </div>
    </div>
</div>

<!-- Section Headers + Grids -->
<div style="margin-bottom:var(--sp-4)">
    <div style="display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-3)">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,var(--sec),var(--sec-l));border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#fff" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <div>
            <div style="font-size:var(--text-xs);font-weight:600;color:var(--txt)">การคุ้มครองและบะเราะกะฮ์</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3)">อ่านทุกวัน เช้า-เย็น และก่อนนอน</div>
        </div>
    </div>
    <div class="surah-grid" id="plus-grid-daily"></div>
</div>

<div style="margin-bottom:var(--sp-4)">
    <div style="display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-3)">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,var(--pri),var(--pri-l));border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#fff" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        </div>
        <div>
            <div style="font-size:var(--text-xs);font-weight:600;color:var(--txt)">สุนนะฮ์รายสัปดาห์</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3)">วันศุกร์ และละหมาดอีด</div>
        </div>
    </div>
    <div class="surah-grid" id="plus-grid-weekly"></div>
</div>

<div style="margin-bottom:var(--sp-4)">
    <div style="display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-3)">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,var(--tafsir),var(--tafsir-l));border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#fff" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
        </div>
        <div>
            <div style="font-size:var(--text-xs);font-weight:600;color:var(--txt)">หลักมันฮัจญ์และอัคลาก</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3)">ท่องจำและปฏิบัติ</div>
        </div>
    </div>
    <div class="surah-grid" id="plus-grid-manhaj"></div>
</div>
</div>

<div id="page-knowledge" class="page">
<div class="hdr"><h1>ความรู้</h1></div>

<!-- Segmented Tab Bar - 6 Tabs with Icons -->
<div class="know-tabs-wrap">
    <div class="know-tabs">
        <button class="know-tab active" onclick="switchKnowTab('overview',this)" id="know-tab-overview" title="ภาพรวม">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <span>ภาพรวม</span>
        </button>
        <button class="know-tab" onclick="switchKnowTab('names',this)" id="know-tab-names" title="พระนาม">
            <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
            <span>พระนาม</span>
        </button>
        <button class="know-tab" onclick="switchKnowTab('habits',this)" id="know-tab-habits" title="นิสัย">
            <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            <span>นิสัย</span>
        </button>
        <button class="know-tab" onclick="switchKnowTab('random',this)" id="know-tab-random" title="สุ่ม">
            <svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
            <span>สุ่ม</span>
        </button>
        <button class="know-tab" onclick="switchKnowTab('surah',this)" id="know-tab-surah" title="ซูเราะฮ์">
            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            <span>ซูเราะฮ์</span>
        </button>
        <button class="know-tab" onclick="switchKnowTab('resources',this)" id="know-tab-resources" title="แหล่งเรียนรู้">
            <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
            <span>เรียนรู้</span>
        </button>
    </div>
</div>

<!-- แท็บ 1: ภาพรวม -->
<div class="know-content" id="know-content-overview">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#ae6aa7 0%,#fff4ff 50%,#dc679c 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#fff" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                <div>
                    <div class="paper-title">คลังความรู้</div>
                    <div class="paper-subtitle">รวบรวมความรู้จากการท่องอัลกุรอาน</div>
                </div>
            </div>
        </div>
        <div class="paper-body">
            <div class="know-stats">
                <div class="know-stat ks-names" onclick="showKnowledgePopup('names');switchKnowTab('names',document.getElementById('know-tab-names'))"><div class="know-stat-num" id="know-names">0</div><div class="know-stat-label">พระนาม</div></div>
                <div class="know-stat ks-habits" onclick="showKnowledgePopup('habits');switchKnowTab('habits',document.getElementById('know-tab-habits'))"><div class="know-stat-num" id="know-habits">0</div><div class="know-stat-label">นิสัย</div></div>
                <div class="know-stat ks-notes" onclick="showKnowledgePopup('notes');switchKnowTab('random',document.getElementById('know-tab-random'))"><div class="know-stat-num" id="know-notes">0</div><div class="know-stat-label">บันทึก</div></div>
            </div>
            <div id="know-names-section"></div>
            <div id="know-habits-section"></div>
        </div>
    </div>
</div>

<!-- แท็บ 2: พระนามอัลลอฮ์ -->
<div class="know-content" id="know-content-names" style="display:none">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#e57399 0%,#f8bbd9 50%,#f48fb1 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#fff" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                <div>
                    <div class="paper-title">พระนามของอัลลอฮ์</div>
                    <div class="paper-subtitle">แตะการ์ดเพื่อดูความหมาย • กดค้างเพื่อดูรายละเอียด</div>
                </div>
            </div>
            <button class="paper-action-btn" onclick="openNamesFlashcard()" title="Flashcard"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#fff" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/></svg></button>
        </div>
        <div class="paper-body" id="know-names-full-section"></div>
    </div>
</div>

<!-- แท็บ 3: นิสัยจากอัลกุรอาน -->
<div class="know-content" id="know-content-habits" style="display:none">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#324b4c 0%,#7a9e9f 50%,#a8c5c6 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#fff" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <div>
                    <div class="paper-title">นิสัยจากอัลกุรอาน</div>
                    <div class="paper-subtitle">พัฒนาตนเองทีละขั้น • เลือกสถานะเพื่อติดตามความก้าวหน้า</div>
                </div>
            </div>
        </div>
        <div class="paper-body" id="know-habits-full-section"></div>
    </div>
</div>

<!-- แท็บ 4: แยกตามซูเราะฮ์ -->
<div class="know-content" id="know-content-surah" style="display:none">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#965971 0%,#dabfc9 50%,#f9e8d2 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <div>
                    <div class="paper-title">แยกตามซูเราะฮ์</div>
                    <div class="paper-subtitle">ดูความรู้ที่บันทึกไว้ในแต่ละซูเราะฮ์</div>
                </div>
            </div>
        </div>
        <div class="paper-body">
            <div style="display:flex;justify-content:flex-end;gap:6px;padding-bottom:12px;border-bottom:1px solid #eee;margin-bottom:12px">
                <select id="surah-know-select" onchange="renderSurahKnowledge()" style="padding:6px 12px;border-radius:20px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);font-size:var(--text-3xs);font-family:'Noto Sans Thai',sans-serif"></select>
                <div style="display:flex;gap:2px;background:#f5f5f5;border-radius:20px;padding:2px"><button onclick="changeSurahFontSize(-1)" style="width:26px;height:26px;background:#fff;border:none;border-radius:50%;color:var(--txt);font-size:11px;cursor:pointer;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,0.1)">A-</button><button onclick="changeSurahFontSize(1)" style="width:26px;height:26px;background:#fff;border:none;border-radius:50%;color:var(--txt);font-size:11px;cursor:pointer;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,0.1)">A+</button></div>
            </div>
            <div id="surah-know-list"></div>
        </div>
    </div>
</div>

<!-- แท็บ 5: สุ่มความรู้ -->
<div class="know-content" id="know-content-random" style="display:none">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#3b2d49 0%,#6b5b7a 50%,#a896b8 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#fff" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
                <div>
                    <div class="paper-title">สุ่มความรู้</div>
                    <div class="paper-subtitle">ทบทวนความรู้แบบสุ่ม</div>
                </div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
                <button onclick="openFlashcardMode()" class="paper-action-btn" title="Flashcard"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#fff" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/></svg></button>
                <button onclick="shuffleRandom()" style="padding:6px 12px;background:rgba(255,255,255,0.2);border:none;border-radius:8px;color:#fff;font-size:var(--text-3xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif">สุ่มใหม่</button>
            </div>
        </div>
        <div class="paper-body">
            <div style="display:flex;justify-content:flex-end;gap:6px;padding-bottom:12px;border-bottom:1px solid #eee;margin-bottom:12px">
                <select id="random-surah-filter" onchange="renderKnowledge()" style="padding:6px 12px;border-radius:20px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);font-size:var(--text-3xs);font-family:'Noto Sans Thai',sans-serif"><option value="all">ทุกซูเราะฮ์</option></select>
                <div style="display:flex;gap:2px;background:#f5f5f5;border-radius:20px;padding:2px"><button onclick="changeFontSize(-1)" style="width:26px;height:26px;background:#fff;border:none;border-radius:50%;color:var(--txt);font-size:11px;cursor:pointer;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,0.1)">A-</button><button onclick="changeFontSize(1)" style="width:26px;height:26px;background:#fff;border:none;border-radius:50%;color:var(--txt);font-size:11px;cursor:pointer;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,0.1)">A+</button></div>
            </div>
            <div class="filter-row" id="filter-row" style="margin-bottom:12px;display:flex;flex-wrap:wrap;gap:4px"></div>
            <div class="random-list" id="random-list"></div>
        </div>
    </div>
</div>

<!-- แท็บ 6: แหล่งเรียนรู้ -->
<div class="know-content" id="know-content-resources" style="display:none">
    <div class="paper-card">
        <div class="paper-header" style="background:linear-gradient(135deg,#7c082d 0%,#b6465a 50%,#bd8187 100%)">
            <div class="paper-header-content">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="#fff" fill="none" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                <div>
                    <div class="paper-title">แหล่งเรียนรู้</div>
                    <div class="paper-subtitle">รวมลิงก์สำหรับเรียนอัลกุรอาน</div>
                </div>
            </div>
            <div style="display:flex;gap:4px;align-items:center">
                <button onclick="exportResources()" class="paper-action-btn" title="ส่งออก"><svg viewBox="0 0 24 24" width="14" height="14" stroke="#fff" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
                <button onclick="importResources()" class="paper-action-btn" title="นำเข้า"><svg viewBox="0 0 24 24" width="14" height="14" stroke="#fff" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                <button onclick="openResourceSettings()" class="paper-action-btn" title="หมวด"><svg viewBox="0 0 24 24" width="14" height="14" stroke="#fff" fill="none" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
                <button onclick="openAddResourceModal()" style="padding:6px 12px;background:rgba(255,255,255,0.9);border:none;border-radius:8px;color:#640000;font-size:var(--text-3xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;font-weight:600;display:flex;align-items:center;gap:4px"><svg viewBox="0 0 24 24" width="12" height="12" stroke="#640000" fill="none" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>เพิ่ม</button>
            </div>
        </div>
        <div class="paper-body" style="padding:0">
            <div class="resources-cats" id="resources-cats" style="padding:12px;background:#fef6f6;border-bottom:1px solid #fee"></div>
            <div class="resources-list" id="resources-list"></div>
        </div>
    </div>
</div>
</div>

<div id="page-calendar" class="page" role="main" aria-label="หน้าปฏิทิน">
<a href="#main-content" class="skip-link">ข้ามไปเนื้อหาหลัก</a>
<div class="hdr"><h1>ปฏิทิน</h1></div>

<!-- การ์ดวันนี้ - ออกแบบใหม่รวมทุกอย่าง -->
<div class="cal-today-card" id="cal-today-card" role="region" aria-label="สรุปวันนี้"></div>

<!-- Chart สถิติ -->
<div class="chart-card" role="region" aria-label="สถิติ">
    <div class="chart-head">
        <div class="chart-title"><svg viewBox="0 0 24 24" aria-hidden="true"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>สถิติ <span id="chart-days-label">14</span> วัน</div>
        <div class="chart-legend">
            <span class="chart-leg"><span class="chart-dot d1" aria-hidden="true"></span>ตัวบท</span>
            <span class="chart-leg"><span class="chart-dot d2" aria-hidden="true"></span>ความหมาย</span>
            <span class="chart-leg"><span class="chart-dot d3" aria-hidden="true"></span>ตัฟซีร</span>
        </div>
    </div>
    <div class="chart-area" role="img" aria-label="กราฟแสดงสถิติการท่อง"><svg class="chart-svg" id="chart-svg"></svg></div>
    <div style="display:flex;gap:2px;margin-top:6px;justify-content:center">
        <button class="chart-range-btn active" onclick="setChartRange(7,this)">7</button>
        <button class="chart-range-btn" onclick="setChartRange(14,this)">14</button>
        <button class="chart-range-btn" onclick="setChartRange(30,this)">30</button>
        <button class="chart-range-btn" onclick="setChartRange(90,this)">90</button>
    </div>
    <div class="chart-tooltip" id="chart-tooltip" role="tooltip">
        <div class="chart-tooltip-date" id="tooltip-date"></div>
        <div class="chart-tooltip-row"><div class="chart-tooltip-dot" style="background:var(--pri)"></div><span>ตัวบท</span><span class="chart-tooltip-val" id="tooltip-text">0</span></div>
        <div class="chart-tooltip-row"><div class="chart-tooltip-dot" style="background:var(--sec)"></div><span>ความหมาย</span><span class="chart-tooltip-val" id="tooltip-meaning">0</span></div>
        <div class="chart-tooltip-row"><div class="chart-tooltip-dot" style="background:var(--tafsir)"></div><span>ตัฟซีร</span><span class="chart-tooltip-val" id="tooltip-tafsir">0</span></div>
    </div>
</div>

<!-- ปฏิทินรายเดือน -->
<div class="calendar-box" role="region" aria-label="ปฏิทินรายเดือน" id="main-content">
    <div class="calendar-nav">
        <button class="calendar-nav-btn" onclick="prevMonth()" aria-label="เดือนก่อนหน้า"><svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
        <div class="calendar-title" id="calendar-title" aria-live="polite"></div>
        <button class="calendar-nav-btn" onclick="nextMonth()" aria-label="เดือนถัดไป"><svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg></button>
    </div>
    <div class="calendar-grid" role="row">
        <div class="calendar-day-name" role="columnheader">อา</div><div class="calendar-day-name" role="columnheader">จ</div><div class="calendar-day-name" role="columnheader">อ</div><div class="calendar-day-name" role="columnheader">พ</div><div class="calendar-day-name" role="columnheader">พฤ</div><div class="calendar-day-name" role="columnheader">ศ</div><div class="calendar-day-name" role="columnheader">ส</div>
    </div>
    <div class="calendar-grid" id="calendar-days" role="grid" aria-label="วันในเดือน"></div>
    <!-- Legend สำหรับสีปฏิทิน -->
    <div style="padding:var(--sp-3);border-top:1px solid var(--bdr-l)">
        <div style="display:flex;justify-content:center;gap:var(--sp-3);flex-wrap:wrap;margin-bottom:6px">
            <div style="display:flex;align-items:center;gap:4px;font-size:7px;color:var(--txt3)"><div style="width:18px;height:18px;border-radius:var(--r-full);background:var(--sec);display:flex;align-items:center;justify-content:center;color:#fff;font-size:7px;font-weight:600" id="legend-today-num"></div>วันนี้</div>
            <div style="display:flex;align-items:center;gap:2px;font-size:7px;color:var(--txt3)">
                <div style="width:10px;height:10px;border-radius:2px;background:rgba(183,177,206,0.35)"></div>
                <div style="width:10px;height:10px;border-radius:2px;background:rgba(210,225,225,0.7)"></div>
                <div style="width:10px;height:10px;border-radius:2px;background:linear-gradient(135deg,rgba(183,177,206,0.5),rgba(230,238,239,0.7))"></div>
                <div style="width:10px;height:10px;border-radius:2px;background:linear-gradient(135deg,rgba(183,177,206,0.6),rgba(233,199,215,0.6))"></div>
                <span style="margin-left:2px">ท่องครบเป้า</span>
            </div>
        </div>
        <div style="display:flex;justify-content:center;gap:var(--sp-3);flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:4px;font-size:7px;color:var(--txt3)"><span class="calendar-dot cd1" style="width:6px;height:6px"></span>ตัวบท / ทบทวน</div>
            <div style="display:flex;align-items:center;gap:4px;font-size:7px;color:var(--txt3)"><span class="calendar-dot cd2" style="width:6px;height:6px"></span>ความหมาย</div>
            <div style="display:flex;align-items:center;gap:4px;font-size:7px;color:var(--txt3)"><span class="calendar-dot cd3" style="width:6px;height:6px"></span>ตัฟซีร</div>
        </div>
    </div>
</div>
</div>

<div id="page-settings" class="page">
<div class="hdr"><h1>ตั้งค่า</h1></div>
<div class="settings-section">
    <div class="settings-title">ข้อมูลส่วนตัว</div>
    <div class="settings-card">
        <div class="settings-row">
            <div class="settings-row-left">
                <div class="settings-icon si1"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                <div class="settings-info"><h4>ชื่อผู้ใช้</h4><p>แสดงในไฟล์ส่งออก</p></div>
            </div>
            <div class="settings-row-right">
                <input type="text" class="settings-input settings-input-wide" id="settings-username" placeholder="ชื่อ">
                <button class="settings-btn" onclick="saveUsername()">บันทึก</button>
            </div>
        </div>
    </div>
</div>
<div class="settings-section">
    <div class="settings-title">เป้าหมายรายวัน</div>
    <div class="settings-card">
        <div class="settings-row">
            <div class="settings-row-left">
                <div class="settings-icon si1"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg></div>
                <div class="settings-info"><h4>ตัวบท</h4><p>ขั้นต่ำ - สูงสุด</p></div>
            </div>
            <div class="settings-row-right">
                <input type="number" class="settings-input settings-input-sm" id="goal-text-min" onchange="saveSettings()">
                <span style="color:var(--txt3)">-</span>
                <input type="number" class="settings-input settings-input-sm" id="goal-text-max" onchange="saveSettings()">
            </div>
        </div>
        <div class="settings-row">
            <div class="settings-row-left">
                <div class="settings-icon si2"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                <div class="settings-info"><h4>ความหมาย</h4><p>ขั้นต่ำ - สูงสุด</p></div>
            </div>
            <div class="settings-row-right">
                <input type="number" class="settings-input settings-input-sm" id="goal-meaning-min" onchange="saveSettings()">
                <span style="color:var(--txt3)">-</span>
                <input type="number" class="settings-input settings-input-sm" id="goal-meaning-max" onchange="saveSettings()">
            </div>
        </div>
        <div class="settings-row" style="border-bottom:none">
            <div class="settings-row-left">
                <div class="settings-icon si3"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg></div>
                <div class="settings-info"><h4>ตัฟซีร</h4><p>ขั้นต่ำ - สูงสุด</p></div>
            </div>
            <div class="settings-row-right">
                <input type="number" class="settings-input settings-input-sm" id="goal-tafsir-min" onchange="saveSettings()">
                <span style="color:var(--txt3)">-</span>
                <input type="number" class="settings-input settings-input-sm" id="goal-tafsir-max" onchange="saveSettings()">
            </div>
        </div>
        <div id="settings-predict-wrapper" style="padding:var(--sp-3);background:linear-gradient(180deg,rgba(122,158,159,0.08),rgba(122,158,159,0.15));border-top:1px solid rgba(122,158,159,0.12)">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:var(--sp-2)">
                <div style="width:28px;height:28px;background:linear-gradient(135deg,var(--sec),#5d8a8b);border-radius:6px;display:flex;align-items:center;justify-content:center"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="12" y1="10" x2="14" y2="10"/><line x1="16" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="12" y1="14" x2="14" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="10" y2="18"/><line x1="12" y1="18" x2="16" y2="18"/></svg></div>
                <div><div style="font-size:var(--text-2xs);font-weight:600;color:var(--sec)">คาดการณ์</div><div style="font-size:var(--text-3xs);color:var(--txt3)">ตามเป้าหมายขั้นต่ำ</div></div>
            </div>
            <div id="settings-predict"></div>
        </div>
    </div>
</div>
<div class="settings-section">
    <div class="settings-title">เป้าหมายย่อย</div>
    <div class="settings-card">
        <div class="settings-goals-area">
            <div class="settings-goals-grid" id="settings-goals"></div>
            <div class="settings-add-row">
                <input type="text" class="settings-add-input" id="add-goal-emoji" placeholder="🎯" style="width:40px;text-align:center">
                <input type="text" class="settings-add-input" id="add-goal-name" placeholder="ชื่อเป้าหมาย">
                <select class="settings-add-select" id="add-goal-type"><option value="surah">ซูเราะฮ์</option><option value="ayah">อายะฮ์</option><option value="streak">วัน</option></select>
                <input type="number" class="settings-add-input" id="add-goal-target" placeholder="N" style="width:40px">
                <button class="settings-btn" onclick="addGoal()">+</button>
            </div>
        </div>
    </div>
</div>
<div class="settings-section">
    <div class="settings-title">รางวัล</div>
    <div class="settings-card">
        <div class="settings-goals-area">
            <div class="settings-goals-grid" id="settings-rewards"></div>
            <div class="settings-add-row">
                <input type="text" class="settings-add-input" id="add-reward-emoji" placeholder="🎁" style="width:40px;text-align:center">
                <input type="text" class="settings-add-input" id="add-reward-name" placeholder="รางวัล">
                <select class="settings-add-select" id="add-reward-type"><option value="surah">ซูเราะฮ์</option><option value="ayah">อายะฮ์</option><option value="streak">วัน</option></select>
                <input type="number" class="settings-add-input" id="add-reward-target" placeholder="N" style="width:40px">
                <button class="settings-btn" onclick="addReward()">+</button>
            </div>
        </div>
    </div>
</div>
<div class="settings-section">
    <div class="settings-title">ระบบทบทวนตัวบท</div>
    <div class="settings-card">
        <div class="settings-row">
            <div class="settings-row-left">
                <div class="settings-icon si1"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg></div>
                <div class="settings-info"><h4>ทบทวนต่อวัน</h4><p>จำนวนซูเราะฮ์ที่ต้องทบทวนต่อวัน</p></div>
            </div>
            <div class="settings-row-right">
                <input type="number" class="settings-input settings-input-sm" id="settings-review-perday" min="0" max="37" onchange="saveReviewSettings()">
                <span style="color:var(--txt3);font-size:var(--text-3xs)">ซูเราะฮ์</span>
            </div>
        </div>
        <div class="settings-row" style="border-bottom:none">
            <div class="settings-row-left">
                <div class="settings-icon si2"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                <div class="settings-info"><h4>จัดการซูเราะฮ์</h4><p>เพิ่ม/ลบซูเราะฮ์ที่ท่องได้แล้ว</p></div>
            </div>
            <div class="settings-row-right">
                <button class="settings-btn" onclick="openMemorizedManager()">จัดการ</button>
            </div>
        </div>
        <div id="memorized-summary" style="padding:var(--sp-3);background:linear-gradient(180deg,rgba(139,115,176,0.08),rgba(139,115,176,0.15));border-top:1px solid rgba(139,115,176,0.12)"></div>
    </div>
</div>
<div class="settings-section">
    <div class="settings-title">ข้อมูล</div>
    <div class="settings-card">
        <div class="settings-row">
            <div class="settings-row-left">
                <div class="settings-icon si3"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
                <div class="settings-info"><h4>จัดการข้อมูล</h4><p>ส่งออก นำเข้า ลบ</p></div>
            </div>
            <div class="settings-row-right">
                <button class="settings-btn settings-btn-light" onclick="exportData()">ส่งออก</button>
                <button class="settings-btn settings-btn-light" onclick="document.getElementById('import-file').click()">นำเข้า</button>
                <button class="settings-btn settings-btn-danger" onclick="clearData()">ลบ</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </div>
    </div>
</div>
</div>

<div class="modal" id="modal-setup" onclick="if(event.target===this)closeModal('setup')">
    <div class="modal-content" style="max-width:360px">
        <!-- Step 1: ชื่อ -->
        <div id="setup-step1">
            <div class="modal-title">ยินดีต้อนรับ</div>
            <p style="text-align:center;font-size:var(--text-2xs);color:var(--txt2);margin-bottom:14px;font-family:'Noto Sans Thai',sans-serif">ใส่ชื่อของคุณเพื่อเริ่มต้น</p>
            <input type="text" class="modal-input" id="setup-name" placeholder="ชื่อของคุณ" style="font-family:'Noto Sans Thai',sans-serif">
            <button class="modal-btn modal-btn-primary" onclick="goToSetupStep2()">ถัดไป</button>
        </div>
        <!-- Step 2: เลือกซูเราะฮ์ที่ท่องตัวบทได้แล้ว -->
        <div id="setup-step2" style="display:none">
            <div class="modal-title">ซูเราะฮ์ที่ท่องได้แล้ว</div>
            <p style="text-align:center;font-size:var(--text-2xs);color:var(--txt2);margin-bottom:14px;font-family:'Noto Sans Thai',sans-serif">เลือกซูเราะฮ์ที่คุณท่องตัวบทได้แล้ว</p>
            <div id="setup-surah-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:280px;overflow-y:auto;margin-bottom:16px;padding:4px"></div>
            <div style="display:flex;gap:8px">
                <button class="modal-btn modal-btn-secondary" onclick="goToSetupStep1()" style="flex:1">ย้อนกลับ</button>
                <button class="modal-btn modal-btn-primary" onclick="goToSetupStep3()" style="flex:1">ถัดไป</button>
            </div>
        </div>
        <!-- Step 3: ตั้งค่าการทบทวน -->
        <div id="setup-step3" style="display:none">
            <div class="modal-title">วางแผนการทบทวน</div>
            <p style="text-align:center;font-size:var(--text-2xs);color:var(--txt2);margin-bottom:12px;font-family:'Noto Sans Thai',sans-serif">คุณเลือกไว้ <span id="setup-count" style="font-weight:600;color:var(--pri)">0</span> ซูเราะฮ์</p>
            
            <div style="margin-bottom:16px">
                <label style="font-size:var(--text-2xs);color:var(--txt);font-weight:500;display:block;margin-bottom:8px;font-family:'Noto Sans Thai',sans-serif">ทบทวนวันละกี่ซูเราะฮ์ ?</label>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
                    <input type="number" id="review-per-day-input" min="0" max="37" value="3" onchange="selectReviewCount(parseInt(this.value)||0)" style="width:70px;padding:12px;border:2px solid var(--pri);border-radius:10px;font-size:var(--text-base);font-weight:700;text-align:center;font-family:'Noto Sans Thai',sans-serif">
                    <span style="font-size:var(--text-2xs);color:var(--txt2);font-family:'Noto Sans Thai',sans-serif">ซูเราะฮ์ / วัน</span>
                    <button type="button" onclick="selectReviewCount(0);document.getElementById('review-per-day-input').value=0" style="margin-left:auto;padding:8px 12px;border:1px solid #ddd;background:#f5f5f5;color:var(--txt3);border-radius:8px;cursor:pointer;font-size:var(--text-3xs);font-family:'Noto Sans Thai',sans-serif">ไม่ทบทวน</button>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                    <button type="button" class="setup-review-btn" data-count="1" onclick="selectReviewCount(1);document.getElementById('review-per-day-input').value=1" style="flex:1;min-width:50px;padding:8px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);border-radius:8px;cursor:pointer;text-align:center;font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif">1</button>
                    <button type="button" class="setup-review-btn" data-count="3" onclick="selectReviewCount(3);document.getElementById('review-per-day-input').value=3" style="flex:1;min-width:50px;padding:8px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);border-radius:8px;cursor:pointer;text-align:center;font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif">3</button>
                    <button type="button" class="setup-review-btn" data-count="5" onclick="selectReviewCount(5);document.getElementById('review-per-day-input').value=5" style="flex:1;min-width:50px;padding:8px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);border-radius:8px;cursor:pointer;text-align:center;font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif">5</button>
                    <button type="button" class="setup-review-btn" data-count="10" onclick="selectReviewCount(10);document.getElementById('review-per-day-input').value=10" style="flex:1;min-width:50px;padding:8px;border:1px solid #e0e0e0;background:#fff;color:var(--txt);border-radius:8px;cursor:pointer;text-align:center;font-size:var(--text-2xs);font-family:'Noto Sans Thai',sans-serif">10</button>
                </div>
            </div>
            
            <!-- แสดงแผนการทบทวน -->
            <div id="review-plan-preview" style="background:#f9f9f9;border-radius:10px;padding:12px;margin-bottom:12px"></div>
            
            <div style="display:flex;gap:8px">
                <button class="modal-btn modal-btn-secondary" onclick="goToSetupStep2From3()" style="flex:1">ย้อนกลับ</button>
                <button class="modal-btn modal-btn-primary" onclick="saveSetupComplete()" style="flex:1">เริ่มต้น</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal-intention" onclick="if(event.target===this)closeModal('intention')">
    <div class="modal-content">
        <div class="modal-title">เจตนา</div>
        <textarea class="modal-input modal-textarea" id="intention-input" placeholder="เจตนาที่บริสุทธิ์เพื่ออัลลอฮ์"></textarea>
        <button class="modal-btn modal-btn-primary" onclick="saveIntention()">บันทึก</button>
    </div>
</div>
<div class="modal" id="modal-quotes" onclick="if(event.target===this)closeModal('quotes')">
    <div class="modal-content">
        <div class="modal-title">กำลังใจ</div>
        <div id="quotes-list" style="margin-bottom:14px"></div>
        <textarea class="modal-input modal-textarea" id="new-quote" placeholder="เพิ่มหะดีษ/อายะฮ์" style="min-height:70px"></textarea>
        <button class="modal-btn modal-btn-secondary" onclick="addQuote()">เพิ่ม</button>
    </div>
</div>
<div class="modal" id="modal-today" onclick="if(event.target===this)closeModal('today')">
    <div class="modal-content"><div class="modal-title" id="modal-today-title">วันนี้</div><div id="modal-today-body"></div></div>
</div>
<div class="modal" id="modal-day" onclick="if(event.target===this)closeModal('day')">
    <div class="modal-content" style="max-width:340px;padding:16px 16px 16px 16px"><div id="modal-day-body"></div></div>
</div>
<div class="modal" id="modal-stat" onclick="if(event.target===this)closeModal('stat')">
    <div class="modal-content" style="max-width:320px;padding:0 16px 16px 16px"><div id="modal-stat-body"></div></div>
</div>
<div class="modal" id="modal-name" onclick="if(event.target===this)closeModal('name')">
    <div class="modal-content" style="max-width:340px;padding:16px"><div class="modal-title" id="modal-name-title"></div><div id="modal-name-body"></div></div>
</div>
<div class="modal" id="modal-plus" onclick="if(event.target===this)closeModal('plus')">
    <div class="modal-content" style="max-width:340px;padding:16px" id="modal-plus-content"></div>
</div>
<div class="modal" id="modal-category" onclick="if(event.target===this)closeModal('category')">
    <div class="modal-content"><div class="modal-title">จัดการหมวดหมู่นิสัย</div><div id="modal-category-body"></div></div>
</div>
<div class="modal" id="modal-knowledge" onclick="if(event.target===this)closeModal('knowledge')">
    <div class="modal-content" id="modal-knowledge-content" style="max-width:340px;padding:0 12px 12px 12px"></div>
</div>
<div class="modal" id="modal-ayah-ar" onclick="if(event.target===this)closeModal('ayah-ar')">
    <div class="modal-content" id="modal-ayah-ar-content" style="max-width:340px;padding:0 12px 12px 12px"></div>
</div>

<!-- Color Picker Modal -->
<div class="color-picker-modal" id="color-picker-modal" onclick="if(event.target===this)closeColorPicker()">
    <div class="color-picker-box">
        <h4>เลือกสีไฮไลท์</h4>
        <input type="color" id="custom-color-input" value="#ffd700">
        <div class="btn-row">
            <button class="btn-cancel" onclick="closeColorPicker()">ยกเลิก</button>
            <button class="btn-apply" onclick="applyCustomColor()">ใช้สีนี้</button>
        </div>
    </div>
</div>
<div class="modal" id="modal-today-detail" onclick="if(event.target===this)closeModal('today-detail')">
    <div class="modal-content" id="modal-today-detail-content" style="max-width:320px;padding:0 12px 12px 12px"></div>
</div>
<div class="modal" id="modal-habit-edit" onclick="if(event.target===this)closeModal('habit-edit')">
    <div class="modal-content" id="modal-habit-edit-content" style="max-width:300px;padding:0 12px 12px 12px"></div>
</div>
<div class="modal" id="modal-memorized" onclick="if(event.target===this)closeModal('memorized')">
    <div class="modal-content" style="max-width:380px">
        <div class="modal-title">จัดการซูเราะฮ์ที่ท่องได้แล้ว</div>
        <p style="font-size:var(--text-3xs);color:var(--txt2);margin-bottom:12px;text-align:center;font-family:'Noto Sans Thai',sans-serif">เลือกซูเราะฮ์ที่ต้องการเข้าระบบทบทวน</p>
        <div id="memorized-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:320px;overflow-y:auto;margin-bottom:16px;padding:4px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
            <button class="modal-btn modal-btn-secondary" onclick="selectAllMemorized()" style="flex:1;font-size:var(--text-3xs)">เลือกทั้งหมด</button>
            <button class="modal-btn modal-btn-secondary" onclick="clearAllMemorized()" style="flex:1;font-size:var(--text-3xs)">ล้างทั้งหมด</button>
        </div>
        <button class="modal-btn modal-btn-primary" onclick="closeModal('memorized')">เสร็จสิ้น</button>
    </div>
</div>
<!-- Resource Modals -->
<div class="modal" id="modal-add-resource" onclick="if(event.target===this)closeModal('add-resource')">
    <div class="modal-content" style="max-width:360px">
        <div class="modal-title">เพิ่มแหล่งเรียนรู้</div>
        <div class="res-modal-form">
            <div class="res-modal-row">
                <input type="text" id="new-res-emoji" class="res-modal-input sm" placeholder="📚" value="📚">
                <input type="text" id="new-res-name" class="res-modal-input" placeholder="ชื่อ">
            </div>
            <input type="url" id="new-res-url" class="res-modal-input" placeholder="https://...">
            <input type="text" id="new-res-desc" class="res-modal-input" placeholder="คำอธิบาย (ไม่บังคับ)">
            <div class="res-modal-label">หมวดหมู่ (เลือกได้หลายหมวด)</div>
            <div class="res-modal-cats" id="new-res-cats"></div>
            <div class="res-modal-label">เลือกกลุ่ม (ไม่บังคับ)</div>
            <select id="new-res-group" class="res-modal-select">
                <option value="">ไม่อยู่ในกลุ่ม</option>
            </select>
            <div class="res-modal-label">สีพื้นหลัง</div>
            <div class="res-color-picker" id="new-res-color"></div>
            <div style="display:flex;gap:8px;margin-top:var(--sp-2)">
                <button onclick="closeModal('add-resource')" class="modal-btn modal-btn-secondary" style="flex:1">ยกเลิก</button>
                <button onclick="saveNewResource()" class="modal-btn modal-btn-primary" style="flex:1">เพิ่ม</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal-edit-resource" onclick="if(event.target===this)closeModal('edit-resource')">
    <div class="modal-content" style="max-width:360px">
        <div class="modal-title">แก้ไขแหล่งเรียนรู้</div>
        <div class="res-modal-form">
            <div class="res-modal-row">
                <input type="text" id="edit-res-emoji" class="res-modal-input sm" placeholder="📚">
                <input type="text" id="edit-res-name" class="res-modal-input" placeholder="ชื่อ">
            </div>
            <input type="url" id="edit-res-url" class="res-modal-input" placeholder="https://...">
            <input type="text" id="edit-res-desc" class="res-modal-input" placeholder="คำอธิบาย">
            <div class="res-modal-label">หมวดหมู่</div>
            <div class="res-modal-cats" id="edit-res-cats"></div>
            <div class="res-modal-label">กลุ่ม</div>
            <select id="edit-res-group" class="res-modal-select"></select>
            <div class="res-modal-label">สีพื้นหลัง</div>
            <div class="res-color-picker" id="edit-res-color"></div>
            <input type="hidden" id="edit-res-idx">
            <div style="display:flex;gap:8px;margin-top:var(--sp-2)">
                <button onclick="deleteResourceFromModal()" class="modal-btn" style="flex:1;background:rgba(180,80,80,0.1);color:#B45050">ลบ</button>
                <button onclick="saveEditResource()" class="modal-btn modal-btn-primary" style="flex:1">บันทึก</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal-resource-settings" onclick="if(event.target===this)closeModal('resource-settings')">
    <div class="modal-content" style="max-width:380px">
        <div class="modal-title">จัดการหมวดหมู่และกลุ่ม</div>
        <div style="display:flex;gap:8px;margin-bottom:var(--sp-3)">
            <button onclick="showResSettingsTab('cats')" id="res-settings-tab-cats" class="settings-btn" style="flex:1;font-size:var(--text-3xs)">หมวดหมู่</button>
            <button onclick="showResSettingsTab('groups')" id="res-settings-tab-groups" class="settings-btn settings-btn-light" style="flex:1;font-size:var(--text-3xs)">กลุ่ม</button>
        </div>
        <div id="res-settings-cats-content">
            <div id="res-cats-list" style="max-height:200px;overflow-y:auto;margin-bottom:var(--sp-2)"></div>
            <div class="res-modal-row">
                <input type="text" id="new-cat-name" class="res-modal-input" placeholder="ชื่อหมวดหมู่">
                <input type="color" id="new-cat-color" value="#6B5B7A" style="width:40px;height:36px;border:none;cursor:pointer">
                <button onclick="addResourceCategory()" class="modal-btn modal-btn-primary" style="padding:8px 12px">เพิ่ม</button>
            </div>
        </div>
        <div id="res-settings-groups-content" style="display:none">
            <div id="res-groups-list" style="max-height:200px;overflow-y:auto;margin-bottom:var(--sp-2)"></div>
            <div class="res-modal-row">
                <input type="text" id="new-group-emoji" class="res-modal-input sm" placeholder="🌿" value="🌿">
                <input type="text" id="new-group-name" class="res-modal-input" placeholder="ชื่อกลุ่ม">
            </div>
            <div class="res-modal-row" style="margin-top:6px">
                <input type="text" id="new-group-desc" class="res-modal-input" placeholder="คำอธิบาย">
                <input type="color" id="new-group-color" value="#4CAF50" style="width:40px;height:36px;border:none;cursor:pointer">
                <button onclick="addResourceGroup()" class="modal-btn modal-btn-primary" style="padding:8px 12px">เพิ่ม</button>
            </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:var(--sp-3)">
            <button onclick="resetResourceData()" class="modal-btn" style="flex:1;background:rgba(180,80,80,0.1);color:#B45050;font-size:var(--text-3xs)">รีเซ็ตทั้งหมด</button>
            <button onclick="closeModal('resource-settings')" class="modal-btn modal-btn-primary" style="flex:1">เสร็จสิ้น</button>
        </div>
    </div>
</div>

<nav class="nav" role="navigation" aria-label="เมนูหลัก">
    <div class="nav-inner">
        <button class="nav-btn active" data-page="home" aria-label="หน้าหลัก" aria-current="page"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>หลัก</span></button>
        <button class="nav-btn" data-page="plus" aria-label="ซูเราะฮ์เพิ่มเติม"><svg viewBox="0 0 24 24" aria-hidden="true"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span>Plus</span></button>
        <button class="nav-btn" data-page="knowledge" aria-label="ความรู้"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg><span>ความรู้</span></button>
        <button class="nav-btn" data-page="calendar" aria-label="ปฏิทิน"><svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>ปฏิทิน</span></button>
        <button class="nav-btn" data-page="settings" aria-label="ตั้งค่า"><svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg><span>ตั้งค่า</span></button>
    </div>
</nav>
<script>
const SURAHS=[{n:1,name:"อัลฟาติหะฮ์",ar:"الفاتحة",ayah:7},{n:78,name:"อันนะบาอ์",ar:"النبأ",ayah:40},{n:79,name:"อันนาซิอาต",ar:"النازعات",ayah:46},{n:80,name:"อะบะซะ",ar:"عبس",ayah:42},{n:81,name:"อัตตักวีร",ar:"التكوير",ayah:29},{n:82,name:"อัลอินฟิฏอร",ar:"الانفطار",ayah:19},{n:83,name:"อัลมุฏ็อฟฟิฟีน",ar:"المطففين",ayah:36},{n:84,name:"อัลอินชิกอก",ar:"الانشقاق",ayah:25},{n:85,name:"อัลบุรูจญ์",ar:"البروج",ayah:22},{n:86,name:"อัฏฏอริก",ar:"الطارق",ayah:17},{n:87,name:"อัลอะอ์ลา",ar:"الأعلى",ayah:19},{n:88,name:"อัลฆอชิยะฮ์",ar:"الغاشية",ayah:26},{n:89,name:"อัลฟัจญร์",ar:"الفجر",ayah:30},{n:90,name:"อัลบะลัด",ar:"البلد",ayah:20},{n:91,name:"อัชชัมซ์",ar:"الشمس",ayah:15},{n:92,name:"อัลลัยล์",ar:"الليل",ayah:21},{n:93,name:"อัฎฎุฮา",ar:"الضحى",ayah:11},{n:94,name:"อัชชัรห์",ar:"الشرح",ayah:8},{n:95,name:"อัตตีน",ar:"التين",ayah:8},{n:96,name:"อัลอะลัก",ar:"العلق",ayah:19},{n:97,name:"อัลก็อดร์",ar:"القدر",ayah:5},{n:98,name:"อัลบัยยินะฮ์",ar:"البينة",ayah:8},{n:99,name:"อัซซัลซะละฮ์",ar:"الزلزلة",ayah:8},{n:100,name:"อัลอาดิยาต",ar:"العاديات",ayah:11},{n:101,name:"อัลกอริอะฮ์",ar:"القارعة",ayah:11},{n:102,name:"อัตตะกาษุร",ar:"التكاثر",ayah:8},{n:103,name:"อัลอัศร์",ar:"العصر",ayah:3},{n:104,name:"อัลฮุมะซะฮ์",ar:"الهمزة",ayah:9},{n:105,name:"อัลฟีล",ar:"الفيل",ayah:5},{n:106,name:"กุร็อยช์",ar:"قريش",ayah:4},{n:107,name:"อัลมาอูน",ar:"الماعون",ayah:7},{n:108,name:"อัลเกาษัร",ar:"الكوثر",ayah:3},{n:109,name:"อัลกาฟิรูน",ar:"الكافرون",ayah:6},{n:110,name:"อันนัศร์",ar:"النصر",ayah:3},{n:111,name:"อัลมะซัด",ar:"المسد",ayah:5},{n:112,name:"อัลอิคลาศ",ar:"الإخلاص",ayah:4},{n:113,name:"อัลฟะลัก",ar:"الفلق",ayah:5},{n:114,name:"อันนาส",ar:"الناس",ayah:6}];

// ===== Quran Verses - ตัวบทอาหรับสำหรับทุกอายะฮ์ =====
const QURAN_VERSES={
1:{1:'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ',2:'الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ',3:'الرَّحْمَٰنِ الرَّحِيمِ',4:'مَالِكِ يَوْمِ الدِّينِ',5:'إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ',6:'اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ',7:'صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ الْمَغْضُوبِ عَلَيْهِمْ وَلَا الضَّالِّينَ'},
112:{1:'قُلْ هُوَ اللَّهُ أَحَدٌ',2:'اللَّهُ الصَّمَدُ',3:'لَمْ يَلِدْ وَلَمْ يُولَدْ',4:'وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ'},
113:{1:'قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ',2:'مِن شَرِّ مَا خَلَقَ',3:'وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ',4:'وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ',5:'وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ'},
114:{1:'قُلْ أَعُوذُ بِرَبِّ النَّاسِ',2:'مَلِكِ النَّاسِ',3:'إِلَٰهِ النَّاسِ',4:'مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ',5:'الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ',6:'مِنَ الْجِنَّةِ وَالنَّاسِ'},
108:{1:'إِنَّا أَعْطَيْنَاكَ الْكَوْثَرَ',2:'فَصَلِّ لِرَبِّكَ وَانْحَرْ',3:'إِنَّ شَانِئَكَ هُوَ الْأَبْتَرُ'},
109:{1:'قُلْ يَا أَيُّهَا الْكَافِرُونَ',2:'لَا أَعْبُدُ مَا تَعْبُدُونَ',3:'وَلَا أَنتُمْ عَابِدُونَ مَا أَعْبُدُ',4:'وَلَا أَنَا عَابِدٌ مَّا عَبَدتُّمْ',5:'وَلَا أَنتُمْ عَابِدُونَ مَا أَعْبُدُ',6:'لَكُمْ دِينُكُمْ وَلِيَ دِينِ'},
110:{1:'إِذَا جَاءَ نَصْرُ اللَّهِ وَالْفَتْحُ',2:'وَرَأَيْتَ النَّاسَ يَدْخُلُونَ فِي دِينِ اللَّهِ أَفْوَاجًا',3:'فَسَبِّحْ بِحَمْدِ رَبِّكَ وَاسْتَغْفِرْهُ ۚ إِنَّهُ كَانَ تَوَّابًا'},
111:{1:'تَبَّتْ يَدَا أَبِي لَهَبٍ وَتَبَّ',2:'مَا أَغْنَىٰ عَنْهُ مَالُهُ وَمَا كَسَبَ',3:'سَيَصْلَىٰ نَارًا ذَاتَ لَهَبٍ',4:'وَامْرَأَتُهُ حَمَّالَةَ الْحَطَبِ',5:'فِي جِيدِهَا حَبْلٌ مِّن مَّسَدٍ'},
103:{1:'وَالْعَصْرِ',2:'إِنَّ الْإِنسَانَ لَفِي خُسْرٍ',3:'إِلَّا الَّذِينَ آمَنُوا وَعَمِلُوا الصَّالِحَاتِ وَتَوَاصَوْا بِالْحَقِّ وَتَوَاصَوْا بِالصَّبْرِ'},
104:{1:'وَيْلٌ لِّكُلِّ هُمَزَةٍ لُّمَزَةٍ',2:'الَّذِي جَمَعَ مَالًا وَعَدَّدَهُ',3:'يَحْسَبُ أَنَّ مَالَهُ أَخْلَدَهُ',4:'كَلَّا ۖ لَيُنبَذَنَّ فِي الْحُطَمَةِ',5:'وَمَا أَدْرَاكَ مَا الْحُطَمَةُ',6:'نَارُ اللَّهِ الْمُوقَدَةُ',7:'الَّتِي تَطَّلِعُ عَلَى الْأَفْئِدَةِ',8:'إِنَّهَا عَلَيْهِم مُّؤْصَدَةٌ',9:'فِي عَمَدٍ مُّمَدَّدَةٍ'},
105:{1:'أَلَمْ تَرَ كَيْفَ فَعَلَ رَبُّكَ بِأَصْحَابِ الْفِيلِ',2:'أَلَمْ يَجْعَلْ كَيْدَهُمْ فِي تَضْلِيلٍ',3:'وَأَرْسَلَ عَلَيْهِمْ طَيْرًا أَبَابِيلَ',4:'تَرْمِيهِم بِحِجَارَةٍ مِّن سِجِّيلٍ',5:'فَجَعَلَهُمْ كَعَصْفٍ مَّأْكُولٍ'},
106:{1:'لِإِيلَافِ قُرَيْشٍ',2:'إِيلَافِهِمْ رِحْلَةَ الشِّتَاءِ وَالصَّيْفِ',3:'فَلْيَعْبُدُوا رَبَّ هَٰذَا الْبَيْتِ',4:'الَّذِي أَطْعَمَهُم مِّن جُوعٍ وَآمَنَهُم مِّنْ خَوْفٍ'},
107:{1:'أَرَأَيْتَ الَّذِي يُكَذِّبُ بِالدِّينِ',2:'فَذَٰلِكَ الَّذِي يَدُعُّ الْيَتِيمَ',3:'وَلَا يَحُضُّ عَلَىٰ طَعَامِ الْمِسْكِينِ',4:'فَوَيْلٌ لِّلْمُصَلِّينَ',5:'الَّذِينَ هُمْ عَن صَلَاتِهِمْ سَاهُونَ',6:'الَّذِينَ هُمْ يُرَاءُونَ',7:'وَيَمْنَعُونَ الْمَاعُونَ'},
102:{1:'أَلْهَاكُمُ التَّكَاثُرُ',2:'حَتَّىٰ زُرْتُمُ الْمَقَابِرَ',3:'كَلَّا سَوْفَ تَعْلَمُونَ',4:'ثُمَّ كَلَّا سَوْفَ تَعْلَمُونَ',5:'كَلَّا لَوْ تَعْلَمُونَ عِلْمَ الْيَقِينِ',6:'لَتَرَوُنَّ الْجَحِيمَ',7:'ثُمَّ لَتَرَوُنَّهَا عَيْنَ الْيَقِينِ',8:'ثُمَّ لَتُسْأَلُنَّ يَوْمَئِذٍ عَنِ النَّعِيمِ'},
101:{1:'الْقَارِعَةُ',2:'مَا الْقَارِعَةُ',3:'وَمَا أَدْرَاكَ مَا الْقَارِعَةُ',4:'يَوْمَ يَكُونُ النَّاسُ كَالْفَرَاشِ الْمَبْثُوثِ',5:'وَتَكُونُ الْجِبَالُ كَالْعِهْنِ الْمَنفُوشِ',6:'فَأَمَّا مَن ثَقُلَتْ مَوَازِينُهُ',7:'فَهُوَ فِي عِيشَةٍ رَّاضِيَةٍ',8:'وَأَمَّا مَنْ خَفَّتْ مَوَازِينُهُ',9:'فَأُمُّهُ هَاوِيَةٌ',10:'وَمَا أَدْرَاكَ مَا هِيَهْ',11:'نَارٌ حَامِيَةٌ'},
100:{1:'وَالْعَادِيَاتِ ضَبْحًا',2:'فَالْمُورِيَاتِ قَدْحًا',3:'فَالْمُغِيرَاتِ صُبْحًا',4:'فَأَثَرْنَ بِهِ نَقْعًا',5:'فَوَسَطْنَ بِهِ جَمْعًا',6:'إِنَّ الْإِنسَانَ لِرَبِّهِ لَكَنُودٌ',7:'وَإِنَّهُ عَلَىٰ ذَٰلِكَ لَشَهِيدٌ',8:'وَإِنَّهُ لِحُبِّ الْخَيْرِ لَشَدِيدٌ',9:'أَفَلَا يَعْلَمُ إِذَا بُعْثِرَ مَا فِي الْقُبُورِ',10:'وَحُصِّلَ مَا فِي الصُّدُورِ',11:'إِنَّ رَبَّهُم بِهِمْ يَوْمَئِذٍ لَّخَبِيرٌ'},
99:{1:'إِذَا زُلْزِلَتِ الْأَرْضُ زِلْزَالَهَا',2:'وَأَخْرَجَتِ الْأَرْضُ أَثْقَالَهَا',3:'وَقَالَ الْإِنسَانُ مَا لَهَا',4:'يَوْمَئِذٍ تُحَدِّثُ أَخْبَارَهَا',5:'بِأَنَّ رَبَّكَ أَوْحَىٰ لَهَا',6:'يَوْمَئِذٍ يَصْدُرُ النَّاسُ أَشْتَاتًا لِّيُرَوْا أَعْمَالَهُمْ',7:'فَمَن يَعْمَلْ مِثْقَالَ ذَرَّةٍ خَيْرًا يَرَهُ',8:'وَمَن يَعْمَلْ مِثْقَالَ ذَرَّةٍ شَرًّا يَرَهُ'},
97:{1:'إِنَّا أَنزَلْنَاهُ فِي لَيْلَةِ الْقَدْرِ',2:'وَمَا أَدْرَاكَ مَا لَيْلَةُ الْقَدْرِ',3:'لَيْلَةُ الْقَدْرِ خَيْرٌ مِّنْ أَلْفِ شَهْرٍ',4:'تَنَزَّلُ الْمَلَائِكَةُ وَالرُّوحُ فِيهَا بِإِذْنِ رَبِّهِم مِّن كُلِّ أَمْرٍ',5:'سَلَامٌ هِيَ حَتَّىٰ مَطْلَعِ الْفَجْرِ'},
93:{1:'وَالضُّحَىٰ',2:'وَاللَّيْلِ إِذَا سَجَىٰ',3:'مَا وَدَّعَكَ رَبُّكَ وَمَا قَلَىٰ',4:'وَلَلْآخِرَةُ خَيْرٌ لَّكَ مِنَ الْأُولَىٰ',5:'وَلَسَوْفَ يُعْطِيكَ رَبُّكَ فَتَرْضَىٰ',6:'أَلَمْ يَجِدْكَ يَتِيمًا فَآوَىٰ',7:'وَوَجَدَكَ ضَالًّا فَهَدَىٰ',8:'وَوَجَدَكَ عَائِلًا فَأَغْنَىٰ',9:'فَأَمَّا الْيَتِيمَ فَلَا تَقْهَرْ',10:'وَأَمَّا السَّائِلَ فَلَا تَنْهَرْ',11:'وَأَمَّا بِنِعْمَةِ رَبِّكَ فَحَدِّثْ'},
94:{1:'أَلَمْ نَشْرَحْ لَكَ صَدْرَكَ',2:'وَوَضَعْنَا عَنكَ وِزْرَكَ',3:'الَّذِي أَنقَضَ ظَهْرَكَ',4:'وَرَفَعْنَا لَكَ ذِكْرَكَ',5:'فَإِنَّ مَعَ الْعُسْرِ يُسْرًا',6:'إِنَّ مَعَ الْعُسْرِ يُسْرًا',7:'فَإِذَا فَرَغْتَ فَانصَبْ',8:'وَإِلَىٰ رَبِّكَ فَارْغَب'},
95:{1:'وَالتِّينِ وَالزَّيْتُونِ',2:'وَطُورِ سِينِينَ',3:'وَهَٰذَا الْبَلَدِ الْأَمِينِ',4:'لَقَدْ خَلَقْنَا الْإِنسَانَ فِي أَحْسَنِ تَقْوِيمٍ',5:'ثُمَّ رَدَدْنَاهُ أَسْفَلَ سَافِلِينَ',6:'إِلَّا الَّذِينَ آمَنُوا وَعَمِلُوا الصَّالِحَاتِ فَلَهُمْ أَجْرٌ غَيْرُ مَمْنُونٍ',7:'فَمَا يُكَذِّبُكَ بَعْدُ بِالدِّينِ',8:'أَلَيْسَ اللَّهُ بِأَحْكَمِ الْحَاكِمِينَ'},
96:{1:'اقْرَأْ بِاسْمِ رَبِّكَ الَّذِي خَلَقَ',2:'خَلَقَ الْإِنسَانَ مِنْ عَلَقٍ',3:'اقْرَأْ وَرَبُّكَ الْأَكْرَمُ',4:'الَّذِي عَلَّمَ بِالْقَلَمِ',5:'عَلَّمَ الْإِنسَانَ مَا لَمْ يَعْلَمْ',6:'كَلَّا إِنَّ الْإِنسَانَ لَيَطْغَىٰ',7:'أَن رَّآهُ اسْتَغْنَىٰ',8:'إِنَّ إِلَىٰ رَبِّكَ الرُّجْعَىٰ',9:'أَرَأَيْتَ الَّذِي يَنْهَىٰ',10:'عَبْدًا إِذَا صَلَّىٰ',11:'أَرَأَيْتَ إِن كَانَ عَلَى الْهُدَىٰ',12:'أَوْ أَمَرَ بِالتَّقْوَىٰ',13:'أَرَأَيْتَ إِن كَذَّبَ وَتَوَلَّىٰ',14:'أَلَمْ يَعْلَم بِأَنَّ اللَّهَ يَرَىٰ',15:'كَلَّا لَئِن لَّمْ يَنتَهِ لَنَسْفَعًا بِالنَّاصِيَةِ',16:'نَاصِيَةٍ كَاذِبَةٍ خَاطِئَةٍ',17:'فَلْيَدْعُ نَادِيَهُ',18:'سَنَدْعُ الزَّبَانِيَةَ',19:'كَلَّا لَا تُطِعْهُ وَاسْجُدْ وَاقْتَرِب'},
98:{1:'لَمْ يَكُنِ الَّذِينَ كَفَرُوا مِنْ أَهْلِ الْكِتَابِ وَالْمُشْرِكِينَ مُنفَكِّينَ حَتَّىٰ تَأْتِيَهُمُ الْبَيِّنَةُ',2:'رَسُولٌ مِّنَ اللَّهِ يَتْلُو صُحُفًا مُّطَهَّرَةً',3:'فِيهَا كُتُبٌ قَيِّمَةٌ',4:'وَمَا تَفَرَّقَ الَّذِينَ أُوتُوا الْكِتَابَ إِلَّا مِن بَعْدِ مَا جَاءَتْهُمُ الْبَيِّنَةُ',5:'وَمَا أُمِرُوا إِلَّا لِيَعْبُدُوا اللَّهَ مُخْلِصِينَ لَهُ الدِّينَ حُنَفَاءَ وَيُقِيمُوا الصَّلَاةَ وَيُؤْتُوا الزَّكَاةَ ۚ وَذَٰلِكَ دِينُ الْقَيِّمَةِ',6:'إِنَّ الَّذِينَ كَفَرُوا مِنْ أَهْلِ الْكِتَابِ وَالْمُشْرِكِينَ فِي نَارِ جَهَنَّمَ خَالِدِينَ فِيهَا ۚ أُولَٰئِكَ هُمْ شَرُّ الْبَرِيَّةِ',7:'إِنَّ الَّذِينَ آمَنُوا وَعَمِلُوا الصَّالِحَاتِ أُولَٰئِكَ هُمْ خَيْرُ الْبَرِيَّةِ',8:'جَزَاؤُهُمْ عِندَ رَبِّهِمْ جَنَّاتُ عَدْنٍ تَجْرِي مِن تَحْتِهَا الْأَنْهَارُ خَالِدِينَ فِيهَا أَبَدًا ۖ رَّضِيَ اللَّهُ عَنْهُمْ وَرَضُوا عَنْهُ ۚ ذَٰلِكَ لِمَنْ خَشِيَ رَبَّهُ'},
86:{1:'وَالسَّمَاءِ وَالطَّارِقِ',2:'وَمَا أَدْرَاكَ مَا الطَّارِقُ',3:'النَّجْمُ الثَّاقِبُ',4:'إِن كُلُّ نَفْسٍ لَّمَّا عَلَيْهَا حَافِظٌ',5:'فَلْيَنظُرِ الْإِنسَانُ مِمَّ خُلِقَ',6:'خُلِقَ مِن مَّاءٍ دَافِقٍ',7:'يَخْرُجُ مِن بَيْنِ الصُّلْبِ وَالتَّرَائِبِ',8:'إِنَّهُ عَلَىٰ رَجْعِهِ لَقَادِرٌ',9:'يَوْمَ تُبْلَى السَّرَائِرُ',10:'فَمَا لَهُ مِن قُوَّةٍ وَلَا نَاصِرٍ',11:'وَالسَّمَاءِ ذَاتِ الرَّجْعِ',12:'وَالْأَرْضِ ذَاتِ الصَّدْعِ',13:'إِنَّهُ لَقَوْلٌ فَصْلٌ',14:'وَمَا هُوَ بِالْهَزْلِ',15:'إِنَّهُمْ يَكِيدُونَ كَيْدًا',16:'وَأَكِيدُ كَيْدًا',17:'فَمَهِّلِ الْكَافِرِينَ أَمْهِلْهُمْ رُوَيْدًا'},
87:{1:'سَبِّحِ اسْمَ رَبِّكَ الْأَعْلَى',2:'الَّذِي خَلَقَ فَسَوَّىٰ',3:'وَالَّذِي قَدَّرَ فَهَدَىٰ',4:'وَالَّذِي أَخْرَجَ الْمَرْعَىٰ',5:'فَجَعَلَهُ غُثَاءً أَحْوَىٰ',6:'سَنُقْرِئُكَ فَلَا تَنسَىٰ',7:'إِلَّا مَا شَاءَ اللَّهُ ۚ إِنَّهُ يَعْلَمُ الْجَهْرَ وَمَا يَخْفَىٰ',8:'وَنُيَسِّرُكَ لِلْيُسْرَىٰ',9:'فَذَكِّرْ إِن نَّفَعَتِ الذِّكْرَىٰ',10:'سَيَذَّكَّرُ مَن يَخْشَىٰ',11:'وَيَتَجَنَّبُهَا الْأَشْقَى',12:'الَّذِي يَصْلَى النَّارَ الْكُبْرَىٰ',13:'ثُمَّ لَا يَمُوتُ فِيهَا وَلَا يَحْيَىٰ',14:'قَدْ أَفْلَحَ مَن تَزَكَّىٰ',15:'وَذَكَرَ اسْمَ رَبِّهِ فَصَلَّىٰ',16:'بَلْ تُؤْثِرُونَ الْحَيَاةَ الدُّنْيَا',17:'وَالْآخِرَةُ خَيْرٌ وَأَبْقَىٰ',18:'إِنَّ هَٰذَا لَفِي الصُّحُفِ الْأُولَىٰ',19:'صُحُفِ إِبْرَاهِيمَ وَمُوسَىٰ'},
91:{1:'وَالشَّمْسِ وَضُحَاهَا',2:'وَالْقَمَرِ إِذَا تَلَاهَا',3:'وَالنَّهَارِ إِذَا جَلَّاهَا',4:'وَاللَّيْلِ إِذَا يَغْشَاهَا',5:'وَالسَّمَاءِ وَمَا بَنَاهَا',6:'وَالْأَرْضِ وَمَا طَحَاهَا',7:'وَنَفْسٍ وَمَا سَوَّاهَا',8:'فَأَلْهَمَهَا فُجُورَهَا وَتَقْوَاهَا',9:'قَدْ أَفْلَحَ مَن زَكَّاهَا',10:'وَقَدْ خَابَ مَن دَسَّاهَا',11:'كَذَّبَتْ ثَمُودُ بِطَغْوَاهَا',12:'إِذِ انبَعَثَ أَشْقَاهَا',13:'فَقَالَ لَهُمْ رَسُولُ اللَّهِ نَاقَةَ اللَّهِ وَسُقْيَاهَا',14:'فَكَذَّبُوهُ فَعَقَرُوهَا فَدَمْدَمَ عَلَيْهِمْ رَبُّهُم بِذَنبِهِمْ فَسَوَّاهَا',15:'وَلَا يَخَافُ عُقْبَاهَا'},
92:{1:'وَاللَّيْلِ إِذَا يَغْشَىٰ',2:'وَالنَّهَارِ إِذَا تَجَلَّىٰ',3:'وَمَا خَلَقَ الذَّكَرَ وَالْأُنثَىٰ',4:'إِنَّ سَعْيَكُمْ لَشَتَّىٰ',5:'فَأَمَّا مَنْ أَعْطَىٰ وَاتَّقَىٰ',6:'وَصَدَّقَ بِالْحُسْنَىٰ',7:'فَسَنُيَسِّرُهُ لِلْيُسْرَىٰ',8:'وَأَمَّا مَن بَخِلَ وَاسْتَغْنَىٰ',9:'وَكَذَّبَ بِالْحُسْنَىٰ',10:'فَسَنُيَسِّرُهُ لِلْعُسْرَىٰ',11:'وَمَا يُغْنِي عَنْهُ مَالُهُ إِذَا تَرَدَّىٰ',12:'إِنَّ عَلَيْنَا لَلْهُدَىٰ',13:'وَإِنَّ لَنَا لَلْآخِرَةَ وَالْأُولَىٰ',14:'فَأَنذَرْتُكُمْ نَارًا تَلَظَّىٰ',15:'لَا يَصْلَاهَا إِلَّا الْأَشْقَى',16:'الَّذِي كَذَّبَ وَتَوَلَّىٰ',17:'وَسَيُجَنَّبُهَا الْأَتْقَى',18:'الَّذِي يُؤْتِي مَالَهُ يَتَزَكَّىٰ',19:'وَمَا لِأَحَدٍ عِندَهُ مِن نِّعْمَةٍ تُجْزَىٰ',20:'إِلَّا ابْتِغَاءَ وَجْهِ رَبِّهِ الْأَعْلَىٰ',21:'وَلَسَوْفَ يَرْضَىٰ'}
};

const TOTAL_AYAH=571;
const DEFAULT_QUOTES=['ผู้ที่ประเสริฐที่สุดในหมู่พวกท่าน คือผู้ที่เรียนอัลกุรอานและสอนมัน — อัลบุคอรีย์ 5027','ด้วยการรำลึกถึงอัลลอฮ์เท่านั้น ทำให้จิตใจสงบ — อัร-เราะอ์ด 13:28','แท้จริง อัลกุรอานนี้นำสู่ทางที่เที่ยงตรงยิ่ง — อัล-อิสรออ์ 17:9'];
const DEFAULT_GOALS=[{e:'⭐',t:'5 ซูเราะฮ์',ty:'surah',n:5},{e:'🎯',t:'ครึ่งทาง',ty:'ayah',n:285},{e:'🔥',t:'7 วัน',ty:'streak',n:7}];
const DEFAULT_REWARDS=[{e:'📚',t:'หนังสือ',ty:'surah',n:5},{e:'💝',t:'บริจาค',ty:'streak',n:7}];

// ===== Plus Surahs - ซูเราะฮ์และอายะฮ์พิเศษนอก Juz' Amma =====
// หลักฐานตามมันฮัจญ์สะลัฟ - แยกระดับความน่าเชื่อถือชัดเจน
const PLUS_SURAHS=[
    // ===== DAILY - อ่านประจำวัน (หลักฐานเศาะเฮียะห์) =====
    {n:'p1',name:'อายะฮ์ อัลกุรซีย์',ar:'آية الكرسي',ayah:1,ref:'2:255',category:'daily',
        usage:'หลังละหมาดฟัรฎู / ก่อนนอน',
        hadith:'เศาะเฮียะห์ อัลบุคอรีย์ 5010',
        hadithStrength:'sahih',
        note:'อายะฮ์ที่ยิ่งใหญ่ที่สุดในอัลกุรอาน ผู้อ่านก่อนนอนจะมีผู้คุ้มครองจากอัลลอฮ์ ชัยฏอนไม่อาจเข้าใกล้ได้จนกระทั่งเช้า',
        extraHadith:'เศาะเฮียะห์ ตามเงื่อนไขอันนะซาอีย์: ผู้อ่านหลังละหมาดฟัรฎูจะไม่มีอะไรกั้นเขากับสวรรค์นอกจากความตาย',
        verses:[
            {num:'255.1',ar:'اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ'},
            {num:'255.2',ar:'لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ'},
            {num:'255.3',ar:'لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ'},
            {num:'255.4',ar:'مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ'},
            {num:'255.5',ar:'يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ'},
            {num:'255.6',ar:'وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ'},
            {num:'255.7',ar:'وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ'},
            {num:'255.8',ar:'وَلَا يَئُودُهُ حِفْظُهُمَا'},
            {num:'255.9',ar:'وَهُوَ الْعَلِيُّ الْعَظِيمُ'}
        ]},
    {n:'p2',name:'ท้าย อัลบะเกาะเราะฮ์',ar:'آخر البقرة',ayah:2,ref:'2:285-286',category:'daily',
        usage:'ก่อนนอนทุกคืน',
        hadith:'เศาะเฮียะห์ อัลบุคอรีย์ 5009, มุสลิม 807',
        hadithStrength:'sahih',
        note:'ท่านนบี ﷺ กล่าวว่า "ผู้ใดอ่านสองอายะฮ์ท้ายซูเราะฮ์อัลบะเกาะเราะฮ์ในคืนหนึ่ง มันจะเพียงพอสำหรับเขา"',
        verses:[
            {num:'285.1',ar:'آمَنَ الرَّسُولُ بِمَا أُنْزِلَ إِلَيْهِ مِنْ رَبِّهِ وَالْمُؤْمِنُونَ'},
            {num:'285.2',ar:'كُلٌّ آمَنَ بِاللَّهِ وَمَلَائِكَتِهِ وَكُتُبِهِ وَرُسُلِهِ'},
            {num:'285.3',ar:'لَا نُفَرِّقُ بَيْنَ أَحَدٍ مِنْ رُسُلِهِ'},
            {num:'285.4',ar:'وَقَالُوا سَمِعْنَا وَأَطَعْنَا غُفْرَانَكَ رَبَّنَا وَإِلَيْكَ الْمَصِيرُ'},
            {num:'286.1',ar:'لَا يُكَلِّفُ اللَّهُ نَفْسًا إِلَّا وُسْعَهَا'},
            {num:'286.2',ar:'لَهَا مَا كَسَبَتْ وَعَلَيْهَا مَا اكْتَسَبَتْ'},
            {num:'286.3',ar:'رَبَّنَا لَا تُؤَاخِذْنَا إِنْ نَسِينَا أَوْ أَخْطَأْنَا'},
            {num:'286.4',ar:'رَبَّنَا وَلَا تَحْمِلْ عَلَيْنَا إِصْرًا كَمَا حَمَلْتَهُ عَلَى الَّذِينَ مِنْ قَبْلِنَا'},
            {num:'286.5',ar:'رَبَّنَا وَلَا تُحَمِّلْنَا مَا لَا طَاقَةَ لَنَا بِهِ'},
            {num:'286.6',ar:'وَاعْفُ عَنَّا وَاغْفِرْ لَنَا وَارْحَمْنَا'},
            {num:'286.7',ar:'أَنْتَ مَوْلَانَا فَانْصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ'}
        ]},
    {n:'p3',name:'ซูเราะฮ์ อัลมุลก์',ar:'تبارك (الملك)',ayah:30,ref:'67:1-30',category:'daily',
        usage:'อ่านทุกคืนก่อนนอน',
        hadith:'สุนัน อัตติรมิซีย์ 2891',
        hadithStrength:'hasan',
        note:'หะดีษหะสัน: ซูเราะฮ์นี้จะให้ชะฟาอะฮ์แก่ผู้อ่าน และจะคุ้มครองจากอะซาบในหลุมฝังศพ',
        verses:[
            {num:'1',ar:'تَبَارَكَ الَّذِي بِيَدِهِ الْمُلْكُ وَهُوَ عَلَىٰ كُلِّ شَيْءٍ قَدِيرٌ'},
            {num:'2',ar:'الَّذِي خَلَقَ الْمَوْتَ وَالْحَيَاةَ لِيَبْلُوَكُمْ أَيُّكُمْ أَحْسَنُ عَمَلًا ۚ وَهُوَ الْعَزِيزُ الْغَفُورُ'},
            {num:'3',ar:'الَّذِي خَلَقَ سَبْعَ سَمَاوَاتٍ طِبَاقًا ۖ مَا تَرَىٰ فِي خَلْقِ الرَّحْمَٰنِ مِنْ تَفَاوُتٍ ۖ فَارْجِعِ الْبَصَرَ هَلْ تَرَىٰ مِنْ فُطُورٍ'},
            {num:'4',ar:'ثُمَّ ارْجِعِ الْبَصَرَ كَرَّتَيْنِ يَنْقَلِبْ إِلَيْكَ الْبَصَرُ خَاسِئًا وَهُوَ حَسِيرٌ'},
            {num:'5',ar:'وَلَقَدْ زَيَّنَّا السَّمَاءَ الدُّنْيَا بِمَصَابِيحَ وَجَعَلْنَاهَا رُجُومًا لِلشَّيَاطِينِ ۖ وَأَعْتَدْنَا لَهُمْ عَذَابَ السَّعِيرِ'},
            {num:'6',ar:'وَلِلَّذِينَ كَفَرُوا بِرَبِّهِمْ عَذَابُ جَهَنَّمَ ۖ وَبِئْسَ الْمَصِيرُ'},
            {num:'7',ar:'إِذَا أُلْقُوا فِيهَا سَمِعُوا لَهَا شَهِيقًا وَهِيَ تَفُورُ'},
            {num:'8',ar:'تَكَادُ تَمَيَّزُ مِنَ الْغَيْظِ ۖ كُلَّمَا أُلْقِيَ فِيهَا فَوْجٌ سَأَلَهُمْ خَزَنَتُهَا أَلَمْ يَأْتِكُمْ نَذِيرٌ'},
            {num:'9',ar:'قَالُوا بَلَىٰ قَدْ جَاءَنَا نَذِيرٌ فَكَذَّبْنَا وَقُلْنَا مَا نَزَّلَ اللَّهُ مِنْ شَيْءٍ إِنْ أَنْتُمْ إِلَّا فِي ضَلَالٍ كَبِيرٍ'},
            {num:'10',ar:'وَقَالُوا لَوْ كُنَّا نَسْمَعُ أَوْ نَعْقِلُ مَا كُنَّا فِي أَصْحَابِ السَّعِيرِ'},
            {num:'11',ar:'فَاعْتَرَفُوا بِذَنْبِهِمْ فَسُحْقًا لِأَصْحَابِ السَّعِيرِ'},
            {num:'12',ar:'إِنَّ الَّذِينَ يَخْشَوْنَ رَبَّهُمْ بِالْغَيْبِ لَهُمْ مَغْفِرَةٌ وَأَجْرٌ كَبِيرٌ'},
            {num:'13',ar:'وَأَسِرُّوا قَوْلَكُمْ أَوِ اجْهَرُوا بِهِ ۖ إِنَّهُ عَلِيمٌ بِذَاتِ الصُّدُورِ'},
            {num:'14',ar:'أَلَا يَعْلَمُ مَنْ خَلَقَ وَهُوَ اللَّطِيفُ الْخَبِيرُ'},
            {num:'15',ar:'هُوَ الَّذِي جَعَلَ لَكُمُ الْأَرْضَ ذَلُولًا فَامْشُوا فِي مَنَاكِبِهَا وَكُلُوا مِنْ رِزْقِهِ ۖ وَإِلَيْهِ النُّشُورُ'},
            {num:'16',ar:'أَأَمِنْتُمْ مَنْ فِي السَّمَاءِ أَنْ يَخْسِفَ بِكُمُ الْأَرْضَ فَإِذَا هِيَ تَمُورُ'},
            {num:'17',ar:'أَمْ أَمِنْتُمْ مَنْ فِي السَّمَاءِ أَنْ يُرْسِلَ عَلَيْكُمْ حَاصِبًا ۖ فَسَتَعْلَمُونَ كَيْفَ نَذِيرِ'},
            {num:'18',ar:'وَلَقَدْ كَذَّبَ الَّذِينَ مِنْ قَبْلِهِمْ فَكَيْفَ كَانَ نَكِيرِ'},
            {num:'19',ar:'أَوَلَمْ يَرَوْا إِلَى الطَّيْرِ فَوْقَهُمْ صَافَّاتٍ وَيَقْبِضْنَ ۚ مَا يُمْسِكُهُنَّ إِلَّا الرَّحْمَٰنُ ۚ إِنَّهُ بِكُلِّ شَيْءٍ بَصِيرٌ'},
            {num:'20',ar:'أَمَّنْ هَٰذَا الَّذِي هُوَ جُنْدٌ لَكُمْ يَنْصُرُكُمْ مِنْ دُونِ الرَّحْمَٰنِ ۚ إِنِ الْكَافِرُونَ إِلَّا فِي غُرُورٍ'},
            {num:'21',ar:'أَمَّنْ هَٰذَا الَّذِي يَرْزُقُكُمْ إِنْ أَمْسَكَ رِزْقَهُ ۚ بَلْ لَجُّوا فِي عُتُوٍّ وَنُفُورٍ'},
            {num:'22',ar:'أَفَمَنْ يَمْشِي مُكِبًّا عَلَىٰ وَجْهِهِ أَهْدَىٰ أَمَّنْ يَمْشِي سَوِيًّا عَلَىٰ صِرَاطٍ مُسْتَقِيمٍ'},
            {num:'23',ar:'قُلْ هُوَ الَّذِي أَنْشَأَكُمْ وَجَعَلَ لَكُمُ السَّمْعَ وَالْأَبْصَارَ وَالْأَفْئِدَةَ ۖ قَلِيلًا مَا تَشْكُرُونَ'},
            {num:'24',ar:'قُلْ هُوَ الَّذِي ذَرَأَكُمْ فِي الْأَرْضِ وَإِلَيْهِ تُحْشَرُونَ'},
            {num:'25',ar:'وَيَقُولُونَ مَتَىٰ هَٰذَا الْوَعْدُ إِنْ كُنْتُمْ صَادِقِينَ'},
            {num:'26',ar:'قُلْ إِنَّمَا الْعِلْمُ عِنْدَ اللَّهِ وَإِنَّمَا أَنَا نَذِيرٌ مُبِينٌ'},
            {num:'27',ar:'فَلَمَّا رَأَوْهُ زُلْفَةً سِيئَتْ وُجُوهُ الَّذِينَ كَفَرُوا وَقِيلَ هَٰذَا الَّذِي كُنْتُمْ بِهِ تَدَّعُونَ'},
            {num:'28',ar:'قُلْ أَرَأَيْتُمْ إِنْ أَهْلَكَنِيَ اللَّهُ وَمَنْ مَعِيَ أَوْ رَحِمَنَا فَمَنْ يُجِيرُ الْكَافِرِينَ مِنْ عَذَابٍ أَلِيمٍ'},
            {num:'29',ar:'قُلْ هُوَ الرَّحْمَٰنُ آمَنَّا بِهِ وَعَلَيْهِ تَوَكَّلْنَا ۖ فَسَتَعْلَمُونَ مَنْ هُوَ فِي ضَلَالٍ مُبِينٍ'},
            {num:'30',ar:'قُلْ أَرَأَيْتُمْ إِنْ أَصْبَحَ مَاؤُكُمْ غَوْرًا فَمَنْ يَأْتِيكُمْ بِمَاءٍ مَعِينٍ'}
        ]},
    {n:'p4',name:'ท้าย อัลฮัชร์',ar:'خواتيم الحشر',ayah:3,ref:'59:22-24',category:'daily',
        usage:'เช้า-เย็น',
        hadith:'สุนัน อัตติรมิซีย์ 2922',
        hadithStrength:'daif',
        note:'หะดีษฎออีฟ (อ่อน) - อย่างไรก็ตาม อายะฮ์เหล่านี้รวมอัสมาอุลฮุสนา (พระนามอันงดงาม) ซึ่งเป็นความรู้ที่ประเสริฐ',
        verses:[
            {num:'22',ar:'هُوَ اللَّهُ الَّذِي لَا إِلَٰهَ إِلَّا هُوَ ۖ عَالِمُ الْغَيْبِ وَالشَّهَادَةِ ۖ هُوَ الرَّحْمَٰنُ الرَّحِيمُ'},
            {num:'23',ar:'هُوَ اللَّهُ الَّذِي لَا إِلَٰهَ إِلَّا هُوَ الْمَلِكُ الْقُدُّوسُ السَّلَامُ الْمُؤْمِنُ الْمُهَيْمِنُ الْعَزِيزُ الْجَبَّارُ الْمُتَكَبِّرُ ۚ سُبْحَانَ اللَّهِ عَمَّا يُشْرِكُونَ'},
            {num:'24',ar:'هُوَ اللَّهُ الْخَالِقُ الْبَارِئُ الْمُصَوِّرُ ۖ لَهُ الْأَسْمَاءُ الْحُسْنَىٰ ۚ يُسَبِّحُ لَهُ مَا فِي السَّمَاوَاتِ وَالْأَرْضِ ۖ وَهُوَ الْعَزِيزُ الْحَكِيمُ'}
        ]},
    // ===== WEEKLY - สุนนะฮ์รายสัปดาห์ (หลักฐานเศาะเฮียะห์) =====
    {n:'p5',name:'ซูเราะฮ์ อัลกะฮ์ฟิ',ar:'الكهف',ayah:110,ref:'18:1-110',category:'weekly',
        usage:'ทุกวันศุกร์',
        hadith:'เศาะเฮียะห์ มุสลิม 809',
        hadithStrength:'sahih',
        note:'ผู้อ่านซูเราะฮ์อัลกะฮ์ฟิในวันศุกร์ จะมีนูรส่องสว่างระหว่างสองศุกร์ และผู้อ่านสิบอายะฮ์แรกจะได้รับการคุ้มครองจากฟิตนะฮ์ดัจญาล'},
    {n:'p6',name:'ซูเราะฮ์ อัสซัจญดะฮ์',ar:'السجدة',ayah:30,ref:'32:1-30',category:'weekly',
        usage:'ละหมาดฟัจญ์ร์วันศุกร์ ร็อกอะฮ์ที่ 1',
        hadith:'เศาะเฮียะห์ อัลบุคอรีย์ 891, มุสลิม 880',
        hadithStrength:'sahih',
        note:'สุนนะฮ์มุอักกะดะฮ์: ท่านนบี ﷺ อ่านซูเราะฮ์นี้ในร็อกอะฮ์ที่ 1 ของละหมาดฟัจญ์ร์วันศุกร์'},
    {n:'p7',name:'ซูเราะฮ์ อัลอินซาน',ar:'الإنسان (الدهر)',ayah:31,ref:'76:1-31',category:'weekly',
        usage:'ละหมาดฟัจญ์ร์วันศุกร์ ร็อกอะฮ์ที่ 2',
        hadith:'เศาะเฮียะห์ อัลบุคอรีย์ 891, มุสลิม 880',
        hadithStrength:'sahih',
        note:'สุนนะฮ์มุอักกะดะฮ์: ท่านนบี ﷺ อ่านซูเราะฮ์นี้ในร็อกอะฮ์ที่ 2 ของละหมาดฟัจญ์ร์วันศุกร์ คู่กับอัสซัจญดะฮ์'},
    // ===== MANHAJ - อายะฮ์สำคัญสำหรับการดำเนินชีวิต (จากอัลกุรอาน) =====
    {n:'p8',name:'อายะฮ์ อัลบิรร์',ar:'آية البر',ayah:1,ref:'2:177',category:'manhaj',
        usage:'ท่องจำและปฏิบัติ',
        hadithStrength:'quran',
        note:'นิยามความดีงาม (อัลบิรร์) อย่างครอบคลุม รวมรุก่นอีมานและการปฏิบัติอิสลาม อิบนุกะษีร กล่าวว่าเป็นอายะฮ์ที่รวบรวมคุณลักษณะผู้ศรัทธาที่แท้จริง',
        theme:'ความดีงามครบถ้วน',
        verses:[
            {num:'177.1',ar:'لَيْسَ الْبِرَّ أَنْ تُوَلُّوا وُجُوهَكُمْ قِبَلَ الْمَشْرِقِ وَالْمَغْرِبِ'},
            {num:'177.2',ar:'وَلَٰكِنَّ الْبِرَّ مَنْ آمَنَ بِاللَّهِ وَالْيَوْمِ الْآخِرِ وَالْمَلَائِكَةِ وَالْكِتَابِ وَالنَّبِيِّينَ'},
            {num:'177.3',ar:'وَآتَى الْمَالَ عَلَىٰ حُبِّهِ ذَوِي الْقُرْبَىٰ وَالْيَتَامَىٰ وَالْمَسَاكِينَ وَابْنَ السَّبِيلِ وَالسَّائِلِينَ وَفِي الرِّقَابِ'},
            {num:'177.4',ar:'وَأَقَامَ الصَّلَاةَ وَآتَى الزَّكَاةَ'},
            {num:'177.5',ar:'وَالْمُوفُونَ بِعَهْدِهِمْ إِذَا عَاهَدُوا'},
            {num:'177.6',ar:'وَالصَّابِرِينَ فِي الْبَأْسَاءِ وَالضَّرَّاءِ وَحِينَ الْبَأْسِ'},
            {num:'177.7',ar:'أُولَٰئِكَ الَّذِينَ صَدَقُوا وَأُولَٰئِكَ هُمُ الْمُتَّقُونَ'}
        ]},
    {n:'p9',name:'ต้น อัลมุอ์มินูน',ar:'أول المؤمنون',ayah:11,ref:'23:1-11',category:'manhaj',
        usage:'ท่องจำและปฏิบัติ',
        hadithStrength:'quran',
        note:'คุณสมบัติผู้ศรัทธาที่ประสบความสำเร็จ (อัลมุฟลิฮูน) ซึ่งจะได้รับมรดกญันนะตุลฟิรเดาส์',
        theme:'คุณสมบัติผู้ศรัทธา',
        verses:[
            {num:'1',ar:'قَدْ أَفْلَحَ الْمُؤْمِنُونَ'},
            {num:'2',ar:'الَّذِينَ هُمْ فِي صَلَاتِهِمْ خَاشِعُونَ'},
            {num:'3',ar:'وَالَّذِينَ هُمْ عَنِ اللَّغْوِ مُعْرِضُونَ'},
            {num:'4',ar:'وَالَّذِينَ هُمْ لِلزَّكَاةِ فَاعِلُونَ'},
            {num:'5',ar:'وَالَّذِينَ هُمْ لِفُرُوجِهِمْ حَافِظُونَ'},
            {num:'6',ar:'إِلَّا عَلَىٰ أَزْوَاجِهِمْ أَوْ مَا مَلَكَتْ أَيْمَانُهُمْ فَإِنَّهُمْ غَيْرُ مَلُومِينَ'},
            {num:'7',ar:'فَمَنِ ابْتَغَىٰ وَرَاءَ ذَٰلِكَ فَأُولَٰئِكَ هُمُ الْعَادُونَ'},
            {num:'8',ar:'وَالَّذِينَ هُمْ لِأَمَانَاتِهِمْ وَعَهْدِهِمْ رَاعُونَ'},
            {num:'9',ar:'وَالَّذِينَ هُمْ عَلَىٰ صَلَوَاتِهِمْ يُحَافِظُونَ'},
            {num:'10',ar:'أُولَٰئِكَ هُمُ الْوَارِثُونَ'},
            {num:'11',ar:'الَّذِينَ يَرِثُونَ الْفِرْدَوْسَ هُمْ فِيهَا خَالِدُونَ'}
        ]},
    {n:'p10',name:'อิบาดุรเราะห์มาน',ar:'عباد الرحمن',ayah:15,ref:'25:63-77',category:'manhaj',
        usage:'ท่องจำและปฏิบัติ',
        hadithStrength:'quran',
        note:'คุณสมบัติและจริยธรรมของ "บ่าวแห่งเราะห์มาน" ซึ่งอัลลอฮ์ทรงยกย่องเป็นพิเศษ อิบนุกะษีร กล่าวว่าเป็นคุณลักษณะอันงดงามที่ผู้ศรัทธาพึงมี',
        theme:'จริยธรรมและอัคลาก',
        verses:[
            {num:'63',ar:'وَعِبَادُ الرَّحْمَٰنِ الَّذِينَ يَمْشُونَ عَلَى الْأَرْضِ هَوْنًا وَإِذَا خَاطَبَهُمُ الْجَاهِلُونَ قَالُوا سَلَامًا'},
            {num:'64',ar:'وَالَّذِينَ يَبِيتُونَ لِرَبِّهِمْ سُجَّدًا وَقِيَامًا'},
            {num:'65',ar:'وَالَّذِينَ يَقُولُونَ رَبَّنَا اصْرِفْ عَنَّا عَذَابَ جَهَنَّمَ ۖ إِنَّ عَذَابَهَا كَانَ غَرَامًا'},
            {num:'66',ar:'إِنَّهَا سَاءَتْ مُسْتَقَرًّا وَمُقَامًا'},
            {num:'67',ar:'وَالَّذِينَ إِذَا أَنفَقُوا لَمْ يُسْرِفُوا وَلَمْ يَقْتُرُوا وَكَانَ بَيْنَ ذَٰلِكَ قَوَامًا'},
            {num:'68',ar:'وَالَّذِينَ لَا يَدْعُونَ مَعَ اللَّهِ إِلَٰهًا آخَرَ وَلَا يَقْتُلُونَ النَّفْسَ الَّتِي حَرَّمَ اللَّهُ إِلَّا بِالْحَقِّ وَلَا يَزْنُونَ'},
            {num:'69',ar:'وَمَن يَفْعَلْ ذَٰلِكَ يَلْقَ أَثَامًا'},
            {num:'70',ar:'يُضَاعَفْ لَهُ الْعَذَابُ يَوْمَ الْقِيَامَةِ وَيَخْلُدْ فِيهِ مُهَانًا'},
            {num:'71',ar:'إِلَّا مَن تَابَ وَآمَنَ وَعَمِلَ عَمَلًا صَالِحًا فَأُولَٰئِكَ يُبَدِّلُ اللَّهُ سَيِّئَاتِهِمْ حَسَنَاتٍ'},
            {num:'72',ar:'وَمَن تَابَ وَعَمِلَ صَالِحًا فَإِنَّهُ يَتُوبُ إِلَى اللَّهِ مَتَابًا'},
            {num:'73',ar:'وَالَّذِينَ لَا يَشْهَدُونَ الزُّورَ وَإِذَا مَرُّوا بِاللَّغْوِ مَرُّوا كِرَامًا'},
            {num:'74',ar:'وَالَّذِينَ إِذَا ذُكِّرُوا بِآيَاتِ رَبِّهِمْ لَمْ يَخِرُّوا عَلَيْهَا صُمًّا وَعُمْيَانًا'},
            {num:'75',ar:'وَالَّذِينَ يَقُولُونَ رَبَّنَا هَبْ لَنَا مِنْ أَزْوَاجِنَا وَذُرِّيَّاتِنَا قُرَّةَ أَعْيُنٍ وَاجْعَلْنَا لِلْمُتَّقِينَ إِمَامًا'},
            {num:'76',ar:'أُولَٰئِكَ يُجْزَوْنَ الْغُرْفَةَ بِمَا صَبَرُوا وَيُلَقَّوْنَ فِيهَا تَحِيَّةً وَسَلَامًا'},
            {num:'77',ar:'خَالِدِينَ فِيهَا ۚ حَسُنَتْ مُسْتَقَرًّا وَمُقَامًا'}
        ]},
    {n:'p11',name:'ท้าย อาลิอิมรอน',ar:'خواتيم آل عمران',ayah:11,ref:'3:190-200',category:'manhaj',
        usage:'ละหมาดตะฮัจญุด',
        hadith:'เศาะเฮียะห์ อัลบุคอรีย์ 4569, มุสลิม 763',
        hadithStrength:'sahih',
        note:'ท่านนบี ﷺ อ่านอายะฮ์เหล่านี้เมื่อตื่นละหมาดกลางคืน จากหะดีษอิบนุอับบาส ร่อฎิยัลลอฮุอันฮุมา',
        theme:'การใคร่ครวญและดุอาอ์',
        verses:[
            {num:'190',ar:'إِنَّ فِي خَلْقِ السَّمَاوَاتِ وَالْأَرْضِ وَاخْتِلَافِ اللَّيْلِ وَالنَّهَارِ لَآيَاتٍ لِّأُولِي الْأَلْبَابِ'},
            {num:'191',ar:'الَّذِينَ يَذْكُرُونَ اللَّهَ قِيَامًا وَقُعُودًا وَعَلَىٰ جُنُوبِهِمْ وَيَتَفَكَّرُونَ فِي خَلْقِ السَّمَاوَاتِ وَالْأَرْضِ رَبَّنَا مَا خَلَقْتَ هَٰذَا بَاطِلًا سُبْحَانَكَ فَقِنَا عَذَابَ النَّارِ'},
            {num:'192',ar:'رَبَّنَا إِنَّكَ مَن تُدْخِلِ النَّارَ فَقَدْ أَخْزَيْتَهُ ۖ وَمَا لِلظَّالِمِينَ مِنْ أَنصَارٍ'},
            {num:'193',ar:'رَّبَّنَا إِنَّنَا سَمِعْنَا مُنَادِيًا يُنَادِي لِلْإِيمَانِ أَنْ آمِنُوا بِرَبِّكُمْ فَآمَنَّا ۚ رَبَّنَا فَاغْفِرْ لَنَا ذُنُوبَنَا وَكَفِّرْ عَنَّا سَيِّئَاتِنَا وَتَوَفَّنَا مَعَ الْأَبْرَارِ'},
            {num:'194',ar:'رَبَّنَا وَآتِنَا مَا وَعَدتَّنَا عَلَىٰ رُسُلِكَ وَلَا تُخْزِنَا يَوْمَ الْقِيَامَةِ ۗ إِنَّكَ لَا تُخْلِفُ الْمِيعَادَ'},
            {num:'195',ar:'فَاسْتَجَابَ لَهُمْ رَبُّهُمْ أَنِّي لَا أُضِيعُ عَمَلَ عَامِلٍ مِّنكُم مِّن ذَكَرٍ أَوْ أُنثَىٰ ۖ بَعْضُكُم مِّن بَعْضٍ'},
            {num:'196',ar:'لَا يَغُرَّنَّكَ تَقَلُّبُ الَّذِينَ كَفَرُوا فِي الْبِلَادِ'},
            {num:'197',ar:'مَتَاعٌ قَلِيلٌ ثُمَّ مَأْوَاهُمْ جَهَنَّمُ ۚ وَبِئْسَ الْمِهَادُ'},
            {num:'198',ar:'لَٰكِنِ الَّذِينَ اتَّقَوْا رَبَّهُمْ لَهُمْ جَنَّاتٌ تَجْرِي مِن تَحْتِهَا الْأَنْهَارُ خَالِدِينَ فِيهَا نُزُلًا مِّنْ عِندِ اللَّهِ'},
            {num:'199',ar:'وَإِنَّ مِنْ أَهْلِ الْكِتَابِ لَمَن يُؤْمِنُ بِاللَّهِ وَمَا أُنزِلَ إِلَيْكُمْ وَمَا أُنزِلَ إِلَيْهِمْ خَاشِعِينَ لِلَّهِ'},
            {num:'200',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا اصْبِرُوا وَصَابِرُوا وَرَابِطُوا وَاتَّقُوا اللَّهَ لَعَلَّكُمْ تُفْلِحُونَ'}
        ]},
    // ===== ซูเราะฮ์ อัลหุญุรอต - อัคลากและมารยาท =====
    {n:'p12',name:'ซูเราะฮ์ อัลหุญุรอต',ar:'الحجرات',ayah:18,ref:'49:1-18',category:'manhaj',
        usage:'ซูเราะฮ์แห่งมารยาทและจริยธรรมอิสลาม',
        hadith:'อัลกุรอาน ซูเราะฮ์ที่ 49 มะดะนียะฮ์',
        hadithStrength:'quran',
        note:'ซูเราะฮ์นี้ประทานลงที่มะดีนะฮ์ วางหลักมารยาทต่ออัลลอฮ์ ต่อท่านนบี ﷺ และต่อพี่น้องมุสลิม รวมถึงห้ามนินทา (ฆีบะฮ์) สอดแนม (ตะญัสซุส) เยาะเย้ย และตั้งฉายาที่ไม่ดี อิบนุกะษีรกล่าวว่า "ซูเราะฮ์นี้รวบรวมมารยาทที่ดีงามทั้งหมด"',
        verses:[
            {num:'1',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تُقَدِّمُوا بَيْنَ يَدَيِ اللَّهِ وَرَسُولِهِ ۖ وَاتَّقُوا اللَّهَ ۚ إِنَّ اللَّهَ سَمِيعٌ عَلِيمٌ'},
            {num:'2',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تَرْفَعُوا أَصْوَاتَكُمْ فَوْقَ صَوْتِ النَّبِيِّ وَلَا تَجْهَرُوا لَهُ بِالْقَوْلِ كَجَهْرِ بَعْضِكُمْ لِبَعْضٍ أَنْ تَحْبَطَ أَعْمَالُكُمْ وَأَنْتُمْ لَا تَشْعُرُونَ'},
            {num:'3',ar:'إِنَّ الَّذِينَ يَغُضُّونَ أَصْوَاتَهُمْ عِنْدَ رَسُولِ اللَّهِ أُولَٰئِكَ الَّذِينَ امْتَحَنَ اللَّهُ قُلُوبَهُمْ لِلتَّقْوَىٰ ۚ لَهُمْ مَغْفِرَةٌ وَأَجْرٌ عَظِيمٌ'},
            {num:'4',ar:'إِنَّ الَّذِينَ يُنَادُونَكَ مِنْ وَرَاءِ الْحُجُرَاتِ أَكْثَرُهُمْ لَا يَعْقِلُونَ'},
            {num:'5',ar:'وَلَوْ أَنَّهُمْ صَبَرُوا حَتَّىٰ تَخْرُجَ إِلَيْهِمْ لَكَانَ خَيْرًا لَهُمْ ۚ وَاللَّهُ غَفُورٌ رَحِيمٌ'},
            {num:'6',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا إِنْ جَاءَكُمْ فَاسِقٌ بِنَبَإٍ فَتَبَيَّنُوا أَنْ تُصِيبُوا قَوْمًا بِجَهَالَةٍ فَتُصْبِحُوا عَلَىٰ مَا فَعَلْتُمْ نَادِمِينَ'},
            {num:'7',ar:'وَاعْلَمُوا أَنَّ فِيكُمْ رَسُولَ اللَّهِ ۚ لَوْ يُطِيعُكُمْ فِي كَثِيرٍ مِنَ الْأَمْرِ لَعَنِتُّمْ وَلَٰكِنَّ اللَّهَ حَبَّبَ إِلَيْكُمُ الْإِيمَانَ وَزَيَّنَهُ فِي قُلُوبِكُمْ وَكَرَّهَ إِلَيْكُمُ الْكُفْرَ وَالْفُسُوقَ وَالْعِصْيَانَ ۚ أُولَٰئِكَ هُمُ الرَّاشِدُونَ'},
            {num:'8',ar:'فَضْلًا مِنَ اللَّهِ وَنِعْمَةً ۚ وَاللَّهُ عَلِيمٌ حَكِيمٌ'},
            {num:'9',ar:'وَإِنْ طَائِفَتَانِ مِنَ الْمُؤْمِنِينَ اقْتَتَلُوا فَأَصْلِحُوا بَيْنَهُمَا ۖ فَإِنْ بَغَتْ إِحْدَاهُمَا عَلَى الْأُخْرَىٰ فَقَاتِلُوا الَّتِي تَبْغِي حَتَّىٰ تَفِيءَ إِلَىٰ أَمْرِ اللَّهِ ۚ فَإِنْ فَاءَتْ فَأَصْلِحُوا بَيْنَهُمَا بِالْعَدْلِ وَأَقْسِطُوا ۖ إِنَّ اللَّهَ يُحِبُّ الْمُقْسِطِينَ'},
            {num:'10',ar:'إِنَّمَا الْمُؤْمِنُونَ إِخْوَةٌ فَأَصْلِحُوا بَيْنَ أَخَوَيْكُمْ ۚ وَاتَّقُوا اللَّهَ لَعَلَّكُمْ تُرْحَمُونَ'},
            {num:'11',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا لَا يَسْخَرْ قَوْمٌ مِنْ قَوْمٍ عَسَىٰ أَنْ يَكُونُوا خَيْرًا مِنْهُمْ وَلَا نِسَاءٌ مِنْ نِسَاءٍ عَسَىٰ أَنْ يَكُنَّ خَيْرًا مِنْهُنَّ ۖ وَلَا تَلْمِزُوا أَنْفُسَكُمْ وَلَا تَنَابَزُوا بِالْأَلْقَابِ ۖ بِئْسَ الِاسْمُ الْفُسُوقُ بَعْدَ الْإِيمَانِ ۚ وَمَنْ لَمْ يَتُبْ فَأُولَٰئِكَ هُمُ الظَّالِمُونَ'},
            {num:'12',ar:'يَا أَيُّهَا الَّذِينَ آمَنُوا اجْتَنِبُوا كَثِيرًا مِنَ الظَّنِّ إِنَّ بَعْضَ الظَّنِّ إِثْمٌ ۖ وَلَا تَجَسَّسُوا وَلَا يَغْتَبْ بَعْضُكُمْ بَعْضًا ۚ أَيُحِبُّ أَحَدُكُمْ أَنْ يَأْكُلَ لَحْمَ أَخِيهِ مَيْتًا فَكَرِهْتُمُوهُ ۚ وَاتَّقُوا اللَّهَ ۚ إِنَّ اللَّهَ تَوَّابٌ رَحِيمٌ'},
            {num:'13',ar:'يَا أَيُّهَا النَّاسُ إِنَّا خَلَقْنَاكُمْ مِنْ ذَكَرٍ وَأُنْثَىٰ وَجَعَلْنَاكُمْ شُعُوبًا وَقَبَائِلَ لِتَعَارَفُوا ۚ إِنَّ أَكْرَمَكُمْ عِنْدَ اللَّهِ أَتْقَاكُمْ ۚ إِنَّ اللَّهَ عَلِيمٌ خَبِيرٌ'},
            {num:'14',ar:'قَالَتِ الْأَعْرَابُ آمَنَّا ۖ قُلْ لَمْ تُؤْمِنُوا وَلَٰكِنْ قُولُوا أَسْلَمْنَا وَلَمَّا يَدْخُلِ الْإِيمَانُ فِي قُلُوبِكُمْ ۖ وَإِنْ تُطِيعُوا اللَّهَ وَرَسُولَهُ لَا يَلِتْكُمْ مِنْ أَعْمَالِكُمْ شَيْئًا ۚ إِنَّ اللَّهَ غَفُورٌ رَحِيمٌ'},
            {num:'15',ar:'إِنَّمَا الْمُؤْمِنُونَ الَّذِينَ آمَنُوا بِاللَّهِ وَرَسُولِهِ ثُمَّ لَمْ يَرْتَابُوا وَجَاهَدُوا بِأَمْوَالِهِمْ وَأَنْفُسِهِمْ فِي سَبِيلِ اللَّهِ ۚ أُولَٰئِكَ هُمُ الصَّادِقُونَ'},
            {num:'16',ar:'قُلْ أَتُعَلِّمُونَ اللَّهَ بِدِينِكُمْ وَاللَّهُ يَعْلَمُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ ۚ وَاللَّهُ بِكُلِّ شَيْءٍ عَلِيمٌ'},
            {num:'17',ar:'يَمُنُّونَ عَلَيْكَ أَنْ أَسْلَمُوا ۖ قُلْ لَا تَمُنُّوا عَلَيَّ إِسْلَامَكُمْ ۖ بَلِ اللَّهُ يَمُنُّ عَلَيْكُمْ أَنْ هَدَاكُمْ لِلْإِيمَانِ إِنْ كُنْتُمْ صَادِقِينَ'},
            {num:'18',ar:'إِنَّ اللَّهَ يَعْلَمُ غَيْبَ السَّمَاوَاتِ وَالْأَرْضِ ۚ وَاللَّهُ بَصِيرٌ بِمَا تَعْمَلُونَ'}
        ]}
];

const PLUS_TOTAL_AYAH=PLUS_SURAHS.reduce((sum,s)=>sum+s.ayah,0);

let currentMonth,currentYear,currentSurah=null,currentFilters=new Set(['all']),currentNoteTab='notes',pageHistory=['home'],chartData=[],predictDate=null;

function getLocalDate(){return new Date().toLocaleDateString('en-CA');}
function getLocalDateObj(){return new Date();}

const get=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))||d}catch{return d}};
const set=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
const getSurah=n=>{
    const key=typeof n==='string'&&n.startsWith('p')?'plus_'+n:'surah_'+n;
    return get(key,{text:0,meaning:0,tafsir:0,notes:{},meanings:{},tafsirs:{},overview:'',reasons:'',stories:'',habits:[],names:[]});
};
const setSurah=(n,d)=>{
    const key=typeof n==='string'&&n.startsWith('p')?'plus_'+n:'surah_'+n;
    set(key,d);
};
const getSettings=()=>get('settings',{intention:'',textMin:3,textMax:10,meaningMin:0,meaningMax:5,tafsirMin:0,tafsirMax:3});
const getQuotes=()=>get('quotes',DEFAULT_QUOTES);
const getGoals=()=>get('goals',DEFAULT_GOALS);
const getRewards=()=>get('rewards',DEFAULT_REWARDS);
const getLog=()=>get('log',{});
const getHistory=()=>get('history',[]);
const getUsername=()=>get('username','');
const getGoalPassed=()=>get('goalPassed',{});
const setGoalPassed=(d)=>set('goalPassed',d);
const calcStatus=(d,ay)=>{const t=d.text||0,m=d.meaning||0,f=d.tafsir||0;if(t>=ay&&m>=ay&&f>=ay)return 4;if(f>0)return 3;if(m>0)return 2;if(t>0)return 1;return 0;};

function init(){
    const now=getLocalDateObj();
    currentMonth=now.getMonth();
    currentYear=now.getFullYear();
    document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>goToPage(b.dataset.page)));
    window.addEventListener('popstate',goBack);
    window.addEventListener('resize',()=>{if(document.getElementById('page-calendar').classList.contains('active'))renderChart()});
    document.addEventListener('click',e=>{if(!e.target.closest('.chart-card'))hideTooltip();});
    // ปิด popup ทั้งหมดเมื่อคลิกข้างนอก
    document.addEventListener('click',e=>{
        if(!e.target.closest('.tb-special-wrap')&&!e.target.closest('.tb-colors-wrap')&&!e.target.closest('.ayah-mini-wrap')){
            closeAllSpecialMenus();
        }
    });
    if(!getUsername())setTimeout(()=>openModal('setup'),500);
    initSelectors();
    calculateCompletion();
    renderHome();
    // อัปเดตเลขวันนี้ใน legend ตอน init
    document.getElementById('legend-today-num').textContent=now.getDate();
    // Init สีล่าสุด - ถ้ามี savedColor จึงค่อยใช้
    const savedColor=get('lastCustomColor',null);
    if(savedColor){
        document.querySelectorAll('.tb-color.c5').forEach(btn=>{btn.style.background=savedColor;});
    }
}

function initSelectors(){
    const knowSel=document.getElementById('surah-know-select');
    const randomSel=document.getElementById('random-surah-filter');
    knowSel.innerHTML='<option value="all">ทั้งหมด</option><optgroup label="Juz\' Amma">';
    randomSel.innerHTML='<option value="all">ทุกซูเราะฮ์</option><optgroup label="Juz\' Amma">';
    SURAHS.forEach(s=>{
        knowSel.innerHTML+=`<option value="${s.n}">${s.name}</option>`;
        randomSel.innerHTML+=`<option value="${s.n}">${s.name}</option>`;
    });
    knowSel.innerHTML+='</optgroup><optgroup label="Plus">';
    randomSel.innerHTML+='</optgroup><optgroup label="Plus">';
    PLUS_SURAHS.forEach(s=>{
        knowSel.innerHTML+=`<option value="${s.n}">${s.name}</option>`;
        randomSel.innerHTML+=`<option value="${s.n}">${s.name}</option>`;
    });
    knowSel.innerHTML+='</optgroup>';
    randomSel.innerHTML+='</optgroup>';
}

function goToPage(page,addHistory=true){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('page-'+page).classList.add('active');
    document.querySelector('[data-page="'+page+'"]')?.classList.add('active');
    if(addHistory&&pageHistory[pageHistory.length-1]!==page){pageHistory.push(page);history.pushState({page},'');}
    if(page==='home')renderHome();
    if(page==='plus')renderPlus();
    if(page==='knowledge')renderKnowledge();
    if(page==='calendar')renderCalendar();
    if(page==='settings')renderSettings();
}

function goBack(){if(pageHistory.length>1){pageHistory.pop();goToPage(pageHistory[pageHistory.length-1],false);}}

function renderHome(){updateStreak();renderUsername();renderIntention();renderQuote();renderStats();renderContinueCard();renderHomeGoalsAndReview();renderSurahGrid();renderGoals();renderRewards();}

function renderHomeGoalsAndReview(){
    const today=getLocalDate(),log=getLog(),todayLog=log[today]||{text:0,meaning:0,tafsir:0},s=getSettings();
    const history=getHistory(),todayReviews=[];
    history.forEach(h=>{if(h.reviews){h.reviews.forEach((r,i)=>{if(r===today)todayReviews.push({...h,round:i+1,key:h.id+'-'+i})});}});
    
    // เพิ่มการทบทวนตัวบทที่ท่องได้แล้ว (Spaced Repetition)
    const memReviewTasks=getMemorizedReviewTasks();
    
    const reviewDone=get('reviewDone',{});
    const meetsTextMin=(todayLog.text||0)>=(s.textMin||0);
    const meetsMeaningMin=(todayLog.meaning||0)>=(s.meaningMin||0);
    const meetsTafsirMin=(todayLog.tafsir||0)>=(s.tafsirMin||0);
    
    // นับจำนวน done - ใช้ doneToday จาก task
    const memDoneCount=memReviewTasks.filter(r=>r.doneToday).length;
    const historyDoneCount=todayReviews.filter(r=>reviewDone[r.key]).length;
    const allReviewsDone=(todayReviews.length===0||historyDoneCount===todayReviews.length)&&(memReviewTasks.length===0||memDoneCount===memReviewTasks.length);
    const allGoalsMet=meetsTextMin&&meetsMeaningMin&&meetsTafsirMin&&allReviewsDone;
    
    const totalReviews=todayReviews.length+memReviewTasks.length;
    const doneReviews=historyDoneCount+memDoneCount;
    
    document.getElementById('home-goal-card').innerHTML=`<div class="goal-check-title"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>เป้าหมายวันนี้ ${allGoalsMet?'<span style="color:var(--done);margin-left:auto">✓ สำเร็จ</span>':''}</div><div class="goal-check-grid"><div class="goal-check-item ${meetsTextMin?'completed':''}"><div class="goal-checkbox ${meetsTextMin?'checked':''}" style="${meetsTextMin?'background:var(--pri);border-color:var(--pri)':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-check-info"><div class="goal-check-text">ตัวบท ${s.textMin||0}+</div><div class="goal-check-meta">${meetsTextMin?'✓ '+todayLog.text:'เหลือ '+Math.max(0,(s.textMin||0)-(todayLog.text||0))}</div></div></div><div class="goal-check-item ${meetsMeaningMin?'completed':''}"><div class="goal-checkbox ${meetsMeaningMin?'checked':''}" style="${meetsMeaningMin?'background:var(--sec);border-color:var(--sec)':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-check-info"><div class="goal-check-text">ความหมาย ${s.meaningMin||0}+</div><div class="goal-check-meta">${meetsMeaningMin?'✓ '+todayLog.meaning:'เหลือ '+Math.max(0,(s.meaningMin||0)-(todayLog.meaning||0))}</div></div></div><div class="goal-check-item ${meetsTafsirMin?'completed':''}"><div class="goal-checkbox ${meetsTafsirMin?'checked':''}" style="${meetsTafsirMin?'background:var(--tafsir);border-color:var(--tafsir)':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-check-info"><div class="goal-check-text">ตัฟซีร ${s.tafsirMin||0}+</div><div class="goal-check-meta">${meetsTafsirMin?'✓ '+todayLog.tafsir:'เหลือ '+Math.max(0,(s.tafsirMin||0)-(todayLog.tafsir||0))}</div></div></div><div class="goal-check-item ${allReviewsDone?'completed':''}"><div class="goal-checkbox ${allReviewsDone?'checked':''}" style="${allReviewsDone?'background:var(--done);border-color:var(--done)':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-check-info"><div class="goal-check-text">ทบทวน</div><div class="goal-check-meta">${totalReviews?`${doneReviews}/${totalReviews}`:'✓ ไม่มี'}</div></div></div></div>`;
    
    const typeLabel={'text':'ตัวบท','meaning':'ความหมาย','tafsir':'ตัฟซีร'};
    
    // รวมการทบทวนทั้งหมดเป็นหมวดเดียว
    let allReviewItems=[];
    
    // การทบทวนตัวบทที่ท่องได้แล้ว (Spaced Repetition)
    memReviewTasks.forEach(r=>{
        const isDone=r.doneToday;
        
        // สร้าง badge ที่บอกสถานะ
        let statusText='';
        if(isDone){
            statusText='✓';
        }else if(r.isNew || r.round===1){
            statusText='ร.1';
        }else{
            statusText='ร.'+r.round;
        }
        
        allReviewItems.push({
            key:r.key,
            name:r.surahName,
            badge:`ตัวบท ${statusText}`,
            badgeClass:'rb1',
            done:isDone,
            isMemReview:true
        });
    });
    
    // การทบทวนจาก history
    todayReviews.forEach(r=>{
        allReviewItems.push({
            key:r.key,
            name:`${r.name} ${r.from}-${r.to}`,
            badge:`${typeLabel[r.type]} ร.${r.round}`,
            badgeClass:'rb'+(r.type==='text'?'1':r.type==='meaning'?'2':'3'),
            done:reviewDone[r.key]||false,
            isMemReview:false
        });
    });
    
    let reviewHtml='';
    if(allReviewItems.length>0){
        reviewHtml=allReviewItems.map(r=>`<div class="review-item ${r.done?'done-item':''}" onclick="${r.isMemReview?`toggleMemorizedReview('${r.key}')`:`toggleReviewHome('${r.key}')`}" role="button" tabindex="0" aria-pressed="${r.done?'true':'false'}"><div class="review-check ${r.done?'done':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><span class="review-text ${r.done?'done-text':''}">${r.name}</span><span class="review-badge ${r.badgeClass}">${r.badge}</span></div>`).join('');
    }else{
        reviewHtml='<div class="empty-state" style="font-size:var(--text-3xs);color:var(--txt3);text-align:center;padding:var(--sp-2)">ไม่มีงานทบทวนวันนี้</div>';
    }
    
    document.getElementById('home-review-list').innerHTML=reviewHtml;
}

function toggleReviewHome(key){const done=get('reviewDone',{});done[key]=!done[key];set('reviewDone',done);renderHomeGoalsAndReview();if(document.getElementById('page-calendar').classList.contains('active'))renderCalendar();}

function renderUsername(){const n=getUsername();document.getElementById('hdr-user').textContent=n||'ตั้งชื่อผู้ใช้';if(document.getElementById('settings-username'))document.getElementById('settings-username').value=n;}
function saveUsername(){const n=document.getElementById('settings-username').value.trim();set('username',n);renderUsername();toast('บันทึกแล้ว');}

// ===== ระบบ Setup 3 Steps =====
let setupSelectedSurahs=[];
let setupReviewCount=3;

function goToSetupStep2(){
    const n=document.getElementById('setup-name').value.trim();
    if(!n)return toast('กรุณาใส่ชื่อ');
    
    // โหลดซูเราะฮ์ที่เลือกไว้แล้ว
    const memorizedSurahs=get('memorizedSurahs',[]);
    setupSelectedSurahs=[...memorizedSurahs];
    
    // สร้าง grid ซูเราะฮ์
    const grid=document.getElementById('setup-surah-grid');
    grid.innerHTML=SURAHS.map(s=>{
        const isSelected=setupSelectedSurahs.includes(s.n);
        return `<button type="button" class="setup-surah-btn" data-n="${s.n}" onclick="toggleSetupSurah(${s.n})" 
            style="padding:8px 4px;border-radius:8px;border:1px solid ${isSelected?'var(--pri)':'#e0e0e0'};background:${isSelected?'var(--pri)':'#fff'};color:${isSelected?'#fff':'var(--txt)'};font-size:var(--text-3xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;text-align:center;transition:all 0.2s">
            <div style="font-weight:600">${s.n}</div>
            <div style="font-size:7px;opacity:0.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
        </button>`;
    }).join('');
    
    document.getElementById('setup-step1').style.display='none';
    document.getElementById('setup-step2').style.display='block';
}

function goToSetupStep1(){
    document.getElementById('setup-step1').style.display='block';
    document.getElementById('setup-step2').style.display='none';
}

function goToSetupStep3(){
    // ถ้าไม่ได้เลือกซูเราะฮ์เลย ก็ข้ามไปเลย
    if(setupSelectedSurahs.length===0){
        saveSetupComplete();
        return;
    }
    
    document.getElementById('setup-step2').style.display='none';
    document.getElementById('setup-step3').style.display='block';
    document.getElementById('setup-count').textContent=setupSelectedSurahs.length;
    
    // โหลด reviewCount จาก settings
    const reviewSettings=get('reviewSettings',{});
    setupReviewCount=reviewSettings.perDay||3;
    
    // อัปเดต input field
    const input=document.getElementById('review-per-day-input');
    if(input)input.value=setupReviewCount;
    
    updateReviewCountButtons();
    updateReviewPlanPreview();
}

function goToSetupStep2From3(){
    document.getElementById('setup-step3').style.display='none';
    document.getElementById('setup-step2').style.display='block';
}

function toggleSetupSurah(n){
    const idx=setupSelectedSurahs.indexOf(n);
    if(idx>=0){
        setupSelectedSurahs.splice(idx,1);
        // ลบออกจาก memorizedSurahs และ reset data
        const memorizedSurahs=get('memorizedSurahs',[]);
        const mIdx=memorizedSurahs.indexOf(n);
        if(mIdx>=0)memorizedSurahs.splice(mIdx,1);
        set('memorizedSurahs',memorizedSurahs);
        const d=getSurah(n);
        d.text=0;d.memorized=false;
        setSurah(n,d);
    }else{
        setupSelectedSurahs.push(n);
        // เพิ่มใน memorizedSurahs และอัปเดต data ทันที
        const memorizedSurahs=get('memorizedSurahs',[]);
        if(!memorizedSurahs.includes(n))memorizedSurahs.push(n);
        set('memorizedSurahs',memorizedSurahs);
        const surah=SURAHS.find(s=>s.n===n);
        if(surah){
            const d=getSurah(n);
            d.text=surah.ayah;
            d.memorized=true;
            d.memorizedDate=new Date().toISOString();
            setSurah(n,d);
        }
    }
    
    // อัปเดต UI ปุ่ม
    document.querySelectorAll('.setup-surah-btn').forEach(btn=>{
        const sn=parseInt(btn.dataset.n);
        if(setupSelectedSurahs.includes(sn)){
            btn.style.background='var(--pri)';
            btn.style.color='#fff';
            btn.style.borderColor='var(--pri)';
        }else{
            btn.style.background='#fff';
            btn.style.color='var(--txt)';
            btn.style.borderColor='#e0e0e0';
        }
    });
    
    // อัปเดต UI ทันที
    renderSurahGrid();
    renderStats();
    renderHomeGoalsAndReview();
}

function selectReviewCount(count){
    setupReviewCount=count;
    
    // บันทึก reviewSettings ทันที
    const reviewSettings=get('reviewSettings',{});
    reviewSettings.perDay=count;
    if(!reviewSettings.setupDate)reviewSettings.setupDate=new Date().toISOString();
    set('reviewSettings',reviewSettings);
    
    updateReviewCountButtons();
    updateReviewPlanPreview();
    
    // อัปเดต UI หน้าหลักทันที
    renderHomeGoalsAndReview();
}

function updateReviewCountButtons(){
    document.querySelectorAll('.setup-review-btn').forEach(btn=>{
        const c=parseInt(btn.dataset.count);
        if(c===setupReviewCount){
            btn.style.borderColor='var(--pri)';
            btn.style.background='var(--pri-ll)';
        }else{
            btn.style.borderColor='#e0e0e0';
            btn.style.background='#fff';
        }
    });
}

function updateReviewPlanPreview(){
    const container=document.getElementById('review-plan-preview');
    if(!container)return;
    
    const memorizedSurahs=get('memorizedSurahs',[]);
    if(memorizedSurahs.length===0){
        container.innerHTML='<div style="text-align:center;color:var(--txt3);font-size:var(--text-3xs);padding:12px;font-family:\'Noto Sans Thai\',sans-serif">ยังไม่ได้เลือกซูเราะฮ์</div>';
        return;
    }
    
    if(setupReviewCount===0){
        container.innerHTML='<div style="text-align:center;color:var(--txt3);font-size:var(--text-3xs);padding:12px;font-family:\'Noto Sans Thai\',sans-serif">ไม่ต้องทบทวนอัตโนมัติ</div>';
        return;
    }
    
    let html='<div style="font-size:var(--text-3xs);color:var(--txt2);margin-bottom:8px;font-weight:600;font-family:\'Noto Sans Thai\',sans-serif">ระบบ Spaced Repetition</div>';
    
    // แสดงแผน 7 วันข้างหน้า
    const schedule=getFullReviewSchedule();
    const today=new Date();
    const dayNames=['อา.','จ.','อ.','พ.','พฤ.','ศ.','ส.'];
    
    html+='<div style="display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto;margin-bottom:8px">';
    
    for(let i=0;i<7;i++){
        const date=new Date(today);
        date.setDate(date.getDate()+i);
        const dateStr=date.toLocaleDateString('en-CA');
        const tasks=schedule[dateStr]||[];
        const dayName=i===0?'วันนี้':i===1?'พรุ่งนี้':dayNames[date.getDay()];
        
        if(tasks.length>0){
            const displayTasks=tasks.slice(0,setupReviewCount);
            const surahNames=displayTasks.map(t=>`${t.surahName}(ร.${t.round})`).join(', ');
            const extra=tasks.length>setupReviewCount?` +${tasks.length-setupReviewCount}`:'';
            
            html+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:#fff;border-radius:6px;border:1px solid #eee">
                <div style="font-size:var(--text-3xs);font-weight:600;color:var(--pri);min-width:45px;font-family:'Noto Sans Thai',sans-serif">${dayName}</div>
                <div style="font-size:7px;color:var(--txt);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Noto Sans Thai',sans-serif">${surahNames}${extra}</div>
                <div style="font-size:7px;color:var(--pri);font-weight:600">${Math.min(tasks.length,setupReviewCount)}</div>
            </div>`;
        }
    }
    
    html+='</div>';
    
    html+='<div style="font-size:6px;color:var(--txt3);text-align:center;font-family:\'Noto Sans Thai\',sans-serif">Interval: 1 → 3 → 7 → 14 → 30 → 60 → 90 วัน</div>';
    
    container.innerHTML=html;
}

function saveSetupComplete(){
    const n=document.getElementById('setup-name').value.trim();
    if(!n)return toast('กรุณาใส่ชื่อ');
    
    set('username',n);
    
    // บันทึกวิธีการทบทวน (ข้อมูลซูเราะฮ์บันทึกไปแล้วใน toggleSetupSurah)
    if(setupSelectedSurahs.length>0){
        const reviewSettings={
            perDay:setupReviewCount,
            setupDate:new Date().toISOString()
        };
        set('reviewSettings',reviewSettings);
    }
    
    closeModal('setup');
    renderUsername();
    renderCards();
    renderStats();
    renderHomeGoalsAndReview();
    renderSurahGrid();
    toast('ยินดีต้อนรับ '+n);
}

// ===== จัดการซูเราะฮ์ที่ท่องได้แล้ว (หน้าตั้งค่า) =====
function openMemorizedManager(){
    renderMemorizedGrid();
    openModal('memorized');
}

function renderMemorizedGrid(){
    const container=document.getElementById('memorized-grid');
    if(!container)return;
    
    const memorizedSurahs=get('memorizedSurahs',[]);
    
    // Juz Amma
    let html='<div style="font-size:var(--text-3xs);color:var(--pri);font-weight:600;margin-bottom:6px;grid-column:1/-1">Juz Amma</div>';
    html+=SURAHS.map(s=>{
        const isSelected=memorizedSurahs.includes(s.n);
        const reviewData=get('surahReviewData',{})[s.n]||{};
        const hasReviewHistory=reviewData.reviewCount>0;
        
        return `<button type="button" class="mem-surah-btn" data-n="${s.n}" onclick="toggleMemorizedSurahSettings(${s.n})" style="padding:8px 4px;border:2px solid ${isSelected?'var(--pri)':'#e0e0e0'};background:${isSelected?'var(--pri)':'#fff'};color:${isSelected?'#fff':'var(--txt)'};border-radius:8px;cursor:pointer;text-align:center;font-family:'Noto Sans Thai',sans-serif;position:relative">
            <div style="font-size:var(--text-2xs);font-weight:600">${s.n}</div>
            <div style="font-size:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
            ${hasReviewHistory?`<div style="position:absolute;top:2px;right:2px;width:6px;height:6px;background:var(--sec);border-radius:50%"></div>`:''}
        </button>`;
    }).join('');
    
    // Plus
    html+='<div style="font-size:var(--text-3xs);color:var(--gold);font-weight:600;margin:12px 0 6px;grid-column:1/-1;border-top:1px solid var(--bdr-l);padding-top:10px">Plus</div>';
    html+=PLUS_SURAHS.map(s=>{
        const isSelected=memorizedSurahs.includes(s.n);
        const reviewData=get('surahReviewData',{})[s.n]||{};
        const hasReviewHistory=reviewData.reviewCount>0;
        
        return `<button type="button" class="mem-surah-btn" data-n="${s.n}" onclick="toggleMemorizedSurahSettings('${s.n}')" style="padding:8px 4px;border:2px solid ${isSelected?'var(--gold)':'#e0e0e0'};background:${isSelected?'var(--gold)':'#fff'};color:${isSelected?'#fff':'var(--txt)'};border-radius:8px;cursor:pointer;text-align:center;font-family:'Noto Sans Thai',sans-serif;position:relative">
            <div style="font-size:var(--text-2xs);font-weight:600">${s.ref}</div>
            <div style="font-size:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
            ${hasReviewHistory?`<div style="position:absolute;top:2px;right:2px;width:6px;height:6px;background:var(--sec);border-radius:50%"></div>`:''}
        </button>`;
    }).join('');
    
    container.innerHTML=html;
}

function toggleMemorizedSurahSettings(n){
    const memorizedSurahs=get('memorizedSurahs',[]);
    const idx=memorizedSurahs.indexOf(n);
    const isPlus=typeof n==='string'&&n.startsWith('p');
    
    if(idx>=0){
        // ลบออก
        memorizedSurahs.splice(idx,1);
        const d=getSurah(n);
        d.text=0;d.memorized=false;
        setSurah(n,d);
    }else{
        // เพิ่มเข้า
        memorizedSurahs.push(n);
        const surah=isPlus?PLUS_SURAHS.find(s=>s.n===n):SURAHS.find(s=>s.n===n);
        if(surah){
            const d=getSurah(n);
            d.text=surah.ayah;
            d.memorized=true;
            d.memorizedDate=new Date().toISOString();
            setSurah(n,d);
        }
    }
    
    set('memorizedSurahs',memorizedSurahs);
    renderMemorizedGrid();
    renderMemorizedSummary();
    renderSurahGrid();
    renderStats();
    renderHomeGoalsAndReview();
    if(isPlus)renderPlus();
    if(document.getElementById('page-calendar').classList.contains('active'))renderCalendar();
}

function selectAllMemorized(){
    // เลือกเฉพาะ Juz Amma
    const memorizedSurahs=SURAHS.map(s=>s.n);
    set('memorizedSurahs',memorizedSurahs);
    
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        d.text=s.ayah;
        d.memorized=true;
        if(!d.memorizedDate)d.memorizedDate=new Date().toISOString();
        setSurah(s.n,d);
    });
    
    renderMemorizedGrid();
    renderMemorizedSummary();
    renderSurahGrid();
    renderStats();
    renderHomeGoalsAndReview();
}

function selectAllMemorizedWithPlus(){
    // เลือกทั้ง Juz Amma และ Plus
    const memorizedSurahs=[...SURAHS.map(s=>s.n),...PLUS_SURAHS.map(s=>s.n)];
    set('memorizedSurahs',memorizedSurahs);
    
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        d.text=s.ayah;
        d.memorized=true;
        if(!d.memorizedDate)d.memorizedDate=new Date().toISOString();
        setSurah(s.n,d);
    });
    
    PLUS_SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        d.text=s.ayah;
        d.memorized=true;
        if(!d.memorizedDate)d.memorizedDate=new Date().toISOString();
        setSurah(s.n,d);
    });
    
    renderMemorizedGrid();
    renderMemorizedSummary();
    renderSurahGrid();
    renderStats();
    renderHomeGoalsAndReview();
    renderPlus();
}

function clearAllMemorized(){
    set('memorizedSurahs',[]);
    set('surahReviewData',{});
    
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        d.text=0;
        d.memorized=false;
        setSurah(s.n,d);
    });
    
    PLUS_SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        d.text=0;
        d.memorized=false;
        setSurah(s.n,d);
    });
    
    renderMemorizedGrid();
    renderMemorizedSummary();
    renderSurahGrid();
    renderStats();
    renderHomeGoalsAndReview();
    renderPlus();
}

function saveReviewSettings(){
    const perDay=parseInt(document.getElementById('settings-review-perday').value)||0;
    const reviewSettings=get('reviewSettings',{});
    reviewSettings.perDay=perDay;
    if(!reviewSettings.setupDate)reviewSettings.setupDate=new Date().toISOString();
    set('reviewSettings',reviewSettings);
    
    renderMemorizedSummary();
    renderHomeGoalsAndReview();
    if(document.getElementById('page-calendar').classList.contains('active'))renderCalendar();
    toast('บันทึกแล้ว');
}

function renderMemorizedSummary(){
    const container=document.getElementById('memorized-summary');
    if(!container)return;
    
    const memorizedSurahs=get('memorizedSurahs',[]);
    const reviewSettings=get('reviewSettings',{});
    const perDay=reviewSettings.perDay!==undefined?reviewSettings.perDay:3;
    const reviewData=get('surahReviewData',{});
    
    // นับสถิติ
    let totalReviews=0;
    Object.keys(reviewData).forEach(sn=>{
        const rd=reviewData[sn];
        totalReviews+=rd.reviewCount||0;
    });
    
    // หาซูเราะฮ์ที่ต้องทบทวนวันนี้
    const todayTasks=getScheduledReviewsForDate(getLocalDate());
    const todayCount=todayTasks.length;
    
    let html=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:var(--sp-2)">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,var(--pri),#6d5a8f);border-radius:6px;display:flex;align-items:center;justify-content:center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
        </div>
        <div>
            <div style="font-size:var(--text-2xs);font-weight:600;color:var(--pri)">สรุประบบทบทวน</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3)">${memorizedSurahs.length} ซูเราะฮ์ในระบบ</div>
        </div>
    </div>`;
    
    html+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px">
        <div onclick="showReviewStatsDetail('perday')" style="background:#fff;border-radius:8px;padding:10px 8px;text-align:center;border:1px solid var(--bdr-l);cursor:pointer;transition:all 0.2s" onmouseover="this.style.boxShadow='0 2px 8px rgba(139,115,176,0.2)'" onmouseout="this.style.boxShadow='none'">
            <div style="font-size:var(--text-sm);font-weight:700;color:var(--pri)">${perDay}</div>
            <div style="font-size:6px;color:var(--txt3)">ซูเราะฮ์/วัน</div>
        </div>
        <div onclick="showReviewStatsDetail('today')" style="background:#fff;border-radius:8px;padding:10px 8px;text-align:center;border:1px solid var(--bdr-l);cursor:pointer;transition:all 0.2s" onmouseover="this.style.boxShadow='0 2px 8px rgba(122,158,159,0.2)'" onmouseout="this.style.boxShadow='none'">
            <div style="font-size:var(--text-sm);font-weight:700;color:var(--sec)">${todayCount}</div>
            <div style="font-size:6px;color:var(--txt3)">งานวันนี้</div>
        </div>
        <div onclick="showReviewStatsDetail('total')" style="background:#fff;border-radius:8px;padding:10px 8px;text-align:center;border:1px solid var(--bdr-l);cursor:pointer;transition:all 0.2s" onmouseover="this.style.boxShadow='0 2px 8px rgba(122,158,122,0.2)'" onmouseout="this.style.boxShadow='none'">
            <div style="font-size:var(--text-sm);font-weight:700;color:var(--done)">${totalReviews}</div>
            <div style="font-size:6px;color:var(--txt3)">ทบทวนแล้ว</div>
        </div>
    </div>`;
    
    // แสดงแผน 5 วันข้างหน้า - กดได้
    const schedule=getFullReviewSchedule();
    const today=new Date(getLocalDate());
    const dayNames=['อา.','จ.','อ.','พ.','พฤ.','ศ.','ส.'];
    
    html+=`<div style="font-size:7px;color:var(--txt2);margin-bottom:4px;font-weight:600">แผน 5 วันข้างหน้า (กดเพื่อดูรายละเอียด)</div>`;
    html+=`<div style="display:flex;gap:4px">`;
    
    for(let i=0;i<5;i++){
        const date=new Date(today);
        date.setDate(date.getDate()+i);
        const dateStr=date.toLocaleDateString('en-CA');
        const tasks=schedule[dateStr]||[];
        const count=tasks.length;
        const dayName=i===0?'วันนี้':dayNames[date.getDay()];
        const hasTask=count>0;
        
        html+=`<div onclick="showDayScheduleDetail('${dateStr}')" style="flex:1;text-align:center;padding:6px 2px;background:${hasTask?'linear-gradient(135deg,var(--pri-ll),#fff)':'#f5f5f5'};border-radius:6px;border:1px solid ${hasTask?'rgba(139,115,176,0.2)':'#eee'};cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <div style="font-size:6px;color:var(--txt3)">${dayName}</div>
            <div style="font-size:var(--text-2xs);font-weight:700;color:${hasTask?'var(--pri)':'var(--txt3)'}">${count}</div>
        </div>`;
    }
    
    html+=`</div>`;
    
    container.innerHTML=html;
}

function showDayScheduleDetail(dateStr){
    const tasks=getScheduledReviewsForDate(dateStr);
    const dateObj=new Date(dateStr);
    const dayLabel=dateObj.toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'});
    const isToday=dateStr===getLocalDate();
    
    let content='';
    if(tasks.length===0){
        content=`<div style="text-align:center;padding:20px;color:var(--txt3)">ไม่มีงานทบทวน 🎉</div>`;
    }else{
        content=`<div style="padding:8px 0">`;
        tasks.forEach(t=>{
            const statusText=t.round===1?'ครั้งแรก':`รอบ ${t.round}`;
            const color=t.round===1?'pri':'sec';
            content+=`<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--${color}-ll);border-radius:8px;margin-bottom:6px">
                <div style="width:24px;height:24px;background:var(--${color});border-radius:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700">${t.round}</div>
                <div><div style="font-size:var(--text-2xs);font-weight:600">${t.surahName}</div><div style="font-size:7px;color:var(--txt3)">${statusText}</div></div>
            </div>`;
        });
        content+=`</div>`;
    }
    
    document.getElementById('modal-knowledge-content').innerHTML=`
        <div style="text-align:center;padding:12px;background:linear-gradient(135deg,var(--pri-ll),var(--card));margin:0 -12px 12px -12px;border-radius:16px 16px 0 0">
            <div style="font-size:0.75rem;font-weight:600;color:var(--pri)">${isToday?'วันนี้':dayLabel}</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3)">${tasks.length} ซูเราะฮ์</div>
        </div>
        ${content}
    `;
    openModal('knowledge');
}

function showReviewStatsDetail(type){
    const reviewSettings=get('reviewSettings',{});
    const perDay=reviewSettings.perDay!==undefined?reviewSettings.perDay:3;
    const memorizedSurahs=get('memorizedSurahs',[]);
    const reviewData=get('surahReviewData',{});
    const todayTasks=getScheduledReviewsForDate(getLocalDate());
    
    let title='', content='';
    
    if(type==='perday'){
        title='ซูเราะฮ์ต่อวัน';
        content=`<div style="text-align:center;padding:16px">
            <div style="font-size:2rem;font-weight:700;color:var(--pri)">${perDay}</div>
            <div style="font-size:var(--text-2xs);color:var(--txt2);margin-bottom:12px">ซูเราะฮ์ที่ต้องทบทวนต่อวัน</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3);line-height:1.6;text-align:left;background:var(--pri-ll);padding:10px;border-radius:8px">
                <strong>Spaced Repetition:</strong><br>
                • รอบ 1 → รอ 1 วัน<br>
                • รอบ 2 → รอ 3 วัน<br>
                • รอบ 3 → รอ 7 วัน<br>
                • รอบ 4 → รอ 14 วัน<br>
                • รอบ 5+ → รอ 30-90 วัน
            </div>
        </div>`;
    }else if(type==='today'){
        title='งานวันนี้';
        if(todayTasks.length===0){
            content=`<div style="text-align:center;padding:20px;color:var(--txt3)">ไม่มีงานทบทวนวันนี้ 🎉</div>`;
        }else{
            content=`<div style="padding:8px 0">`;
            todayTasks.forEach(t=>{
                const statusText=t.round===1?'ครั้งแรก':`รอบ ${t.round}`;
                const color=t.round===1?'pri':'sec';
                content+=`<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--${color}-ll);border-radius:8px;margin-bottom:6px">
                    <div style="width:24px;height:24px;background:var(--${color});border-radius:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700">${t.round}</div>
                    <div><div style="font-size:var(--text-2xs);font-weight:600">${t.surahName}</div><div style="font-size:7px;color:var(--txt3)">${statusText}</div></div>
                </div>`;
            });
            content+=`</div>`;
        }
    }else if(type==='total'){
        title='สถิติการทบทวน';
        let totalReviews=0, maxRound=0;
        Object.keys(reviewData).forEach(sn=>{
            const rd=reviewData[sn];
            totalReviews+=rd.reviewCount||0;
            maxRound=Math.max(maxRound, rd.reviewCount||0);
        });
        
        content=`<div style="text-align:center;padding:16px">
            <div style="font-size:2rem;font-weight:700;color:var(--done)">${totalReviews}</div>
            <div style="font-size:var(--text-2xs);color:var(--txt2);margin-bottom:12px">ครั้งที่ทบทวนทั้งหมด</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div style="background:var(--pri-ll);padding:10px;border-radius:8px">
                    <div style="font-size:var(--text-base);font-weight:700;color:var(--pri)">${memorizedSurahs.length}</div>
                    <div style="font-size:7px;color:var(--txt3)">ซูเราะฮ์ในระบบ</div>
                </div>
                <div style="background:var(--sec-ll);padding:10px;border-radius:8px">
                    <div style="font-size:var(--text-base);font-weight:700;color:var(--sec)">${maxRound}</div>
                    <div style="font-size:7px;color:var(--txt3)">รอบสูงสุด</div>
                </div>
            </div>
        </div>`;
    }
    
    document.getElementById('modal-knowledge-content').innerHTML=`
        <div style="text-align:center;padding:12px;background:linear-gradient(135deg,var(--pri-ll),var(--card));margin:0 -12px 12px -12px;border-radius:16px 16px 0 0">
            <div style="font-size:0.75rem;font-weight:600;color:var(--pri)">${title}</div>
        </div>
        ${content}
    `;
    openModal('knowledge');
}

// ===== ระบบทบทวนตัวบท (Spaced Repetition) =====
// หลักการ : perDay = จำนวนซูเราะฮ์ใหม่ (รอบ 1) ที่เริ่มทบทวนต่อวัน
// รอบ 2, 3, 4, ... แสดงตาม due date จริง (สามารถชนกันได้)
// Interval : 1 → 3 → 7 → 14 → 30 → 60 → 90 วัน

const REVIEW_INTERVALS=[1,3,7,14,30,60,90];

// คำนวณแผนทบทวนทั้งหมดสำหรับ 180 วันข้างหน้า
function buildReviewSchedule(){
    const memorizedSurahs=get('memorizedSurahs',[]);
    const reviewData=get('surahReviewData',{});
    const reviewSettings=get('reviewSettings',{});
    const perDay=reviewSettings.perDay||3;
    const todayStr=getLocalDate();
    const today=new Date(todayStr);
    today.setHours(0,0,0,0);
    
    if(memorizedSurahs.length===0) return {};
    
    // ฟังก์ชันหา surah (รองรับ Plus)
    function findSurah(sn){
        const isPlus=typeof sn==='string'&&sn.startsWith('p');
        return isPlus?PLUS_SURAHS.find(s=>s.n===sn):SURAHS.find(s=>s.n===sn);
    }
    
    const schedule={}; // {dateStr: [{sn, surahName, round}]}
    
    // แยก 2 กลุ่ม: ยังไม่เคยทบทวน vs ทบทวนแล้ว
    const neverReviewed=[]; // รอบ 1 ที่ต้องจัดคิว
    const alreadyStarted=[]; // มี lastReview แล้ว
    
    memorizedSurahs.forEach(sn=>{
        const rd=reviewData[sn]||{};
        const surah=findSurah(sn);
        if(!surah)return;
        
        const isPlus=typeof sn==='string'&&sn.startsWith('p');
        const displayName=isPlus?surah.name+' (Plus)':surah.name;
        
        if(!rd.lastReview){
            neverReviewed.push({sn:sn, surahName:displayName});
        }else{
            alreadyStarted.push({sn:sn, surahName:displayName, rd:rd});
        }
    });
    
    // === 1. จัดคิวรอบ 1 วันละ perDay ===
    const round1Schedule={}; // {sn: scheduledDate}
    let dayOffset=0;
    let countToday=0;
    
    neverReviewed.forEach(item=>{
        if(countToday>=perDay){
            dayOffset++;
            countToday=0;
        }
        
        const scheduledDate=new Date(today);
        scheduledDate.setDate(scheduledDate.getDate()+dayOffset);
        round1Schedule[item.sn]=scheduledDate;
        
        countToday++;
    });
    
    // === 2. คำนวณทุกรอบในอนาคต (รวมรอบ 1 ที่จัดคิวแล้ว) ===
    
    // 2.1 สำหรับซูเราะฮ์ที่ยังไม่เคยทบทวน (เริ่มจากรอบ 1)
    neverReviewed.forEach(item=>{
        const startDate=round1Schedule[item.sn];
        let currentDate=new Date(startDate);
        
        // คำนวณรอบ 1, 2, 3, ... (สมมติทบทวนตรงเวลา)
        for(let round=1;round<=7;round++){
            const diffDays=Math.floor((currentDate-today)/(1000*60*60*24));
            if(diffDays>180)break;
            if(diffDays<0){
                // รอบนี้เลยไปแล้ว ข้ามไป
            }else{
                const dateStr=currentDate.toLocaleDateString('en-CA');
                if(!schedule[dateStr])schedule[dateStr]=[];
                schedule[dateStr].push({
                    sn:item.sn,
                    surahName:item.surahName,
                    round:round
                });
            }
            
            // คำนวณวันถัดไป
            const intervalIdx=Math.min(round-1,REVIEW_INTERVALS.length-1);
            const nextInterval=REVIEW_INTERVALS[intervalIdx];
            currentDate=new Date(currentDate);
            currentDate.setDate(currentDate.getDate()+nextInterval);
        }
    });
    
    // 2.2 สำหรับซูเราะฮ์ที่ทบทวนแล้ว (เริ่มจากรอบถัดไป)
    alreadyStarted.forEach(item=>{
        const rd=item.rd;
        const lastDate=new Date(rd.lastReview);
        lastDate.setHours(0,0,0,0);
        const startRound=(rd.reviewCount||0)+1;
        const startInterval=rd.interval||1;
        
        let currentDate=new Date(lastDate);
        currentDate.setDate(currentDate.getDate()+startInterval);
        
        // คำนวณรอบถัดไปและรอบอนาคต
        for(let round=startRound;round<=startRound+6;round++){
            const diffDays=Math.floor((currentDate-today)/(1000*60*60*24));
            if(diffDays>180)break;
            
            if(currentDate>=today){
                const dateStr=currentDate.toLocaleDateString('en-CA');
                if(!schedule[dateStr])schedule[dateStr]=[];
                schedule[dateStr].push({
                    sn:item.sn,
                    surahName:item.surahName,
                    round:round
                });
            }
            
            // คำนวณวันถัดไป
            const intervalIdx=Math.min(round-1,REVIEW_INTERVALS.length-1);
            const nextInterval=REVIEW_INTERVALS[intervalIdx];
            currentDate=new Date(currentDate);
            currentDate.setDate(currentDate.getDate()+nextInterval);
        }
    });
    
    // เรียงแต่ละวันตามรอบ
    Object.keys(schedule).forEach(dateStr=>{
        schedule[dateStr].sort((a,b)=>a.round-b.round);
    });
    
    return schedule;
}

// ดึงรายการทบทวนสำหรับวันที่กำหนด
function getScheduledReviewsForDate(dateStr){
    const schedule=buildReviewSchedule();
    return schedule[dateStr]||[];
}

// ดึง schedule ทั้งหมด
function getFullReviewSchedule(){
    return buildReviewSchedule();
}

function getMemorizedReviewTasks(){
    const todayStr=getLocalDate();
    const memorizedSurahs=get('memorizedSurahs',[]);
    const reviewData=get('surahReviewData',{});
    const reviewSettings=get('reviewSettings',{});
    const perDay=reviewSettings.perDay||3;
    const tasks=[];
    
    if(memorizedSurahs.length===0) return tasks;
    
    const today=new Date(todayStr);
    today.setHours(0,0,0,0);
    
    // ฟังก์ชันหา surah (รองรับ Plus)
    function findSurah(sn){
        const isPlus=typeof sn==='string'&&sn.startsWith('p');
        return isPlus?PLUS_SURAHS.find(s=>s.n===sn):SURAHS.find(s=>s.n===sn);
    }
    
    // แยก 3 กลุ่ม:
    // 1. ทำเสร็จแล้ววันนี้ (lastReview = วันนี้)
    // 2. due วันนี้แต่ยังไม่ได้ทำ (รอบ 2+)
    // 3. ยังไม่ได้เริ่ม (ไม่มี lastReview = รอบ 1)
    
    const doneToday=[];
    const dueToday=[];
    const notStarted=[];
    
    memorizedSurahs.forEach(sn=>{
        const rd=reviewData[sn]||{};
        const surah=findSurah(sn);
        if(!surah)return;
        
        const isPlus=typeof sn==='string'&&sn.startsWith('p');
        const displayName=isPlus?surah.name+' (Plus)':surah.name;
        
        if(rd.lastReview){
            const lastDate=new Date(rd.lastReview);
            lastDate.setHours(0,0,0,0);
            const lastDateStr=lastDate.toLocaleDateString('en-CA');
            
            if(lastDateStr===todayStr){
                // ทำเสร็จแล้ววันนี้
                doneToday.push({
                    sn:sn,
                    surahName:displayName,
                    round:rd.reviewCount||1
                });
            }else{
                // คำนวณ due date
                const interval=rd.interval||1;
                const dueDate=new Date(lastDate);
                dueDate.setDate(dueDate.getDate()+interval);
                
                if(dueDate<=today){
                    // due แล้ว (รอบ 2+)
                    dueToday.push({
                        sn:sn,
                        surahName:displayName,
                        round:(rd.reviewCount||0)+1
                    });
                }
            }
        }else{
            // ยังไม่ได้เริ่ม (รอบ 1)
            notStarted.push({
                sn:sn,
                surahName:displayName,
                round:1
            });
        }
    });
    
    // จัดคิว notStarted ตาม perDay
    // นับรอบ 1 ที่ทำเสร็จแล้ววันนี้ด้วย (ไม่ให้เพิ่มมาทดแทน)
    const doneRound1Count=doneToday.filter(d=>d.round===1).length;
    const availableSlots=Math.max(0, perDay - doneRound1Count);
    const notStartedToday=notStarted.slice(0, availableSlots);
    
    // สร้าง tasks
    // 1. done วันนี้ (แสดงก่อน)
    doneToday.forEach(item=>{
        tasks.push({
            surahNum:item.sn,
            surahName:item.surahName,
            type:'memorized-review',
            key:'mem-review-'+item.sn+'-'+todayStr,
            round:item.round,
            isNew:false,
            doneToday:true
        });
    });
    
    // 2. due วันนี้ (รอบ 2+)
    dueToday.forEach(item=>{
        tasks.push({
            surahNum:item.sn,
            surahName:item.surahName,
            type:'memorized-review',
            key:'mem-review-'+item.sn+'-'+todayStr,
            round:item.round,
            isNew:false,
            doneToday:false
        });
    });
    
    // 3. ยังไม่ได้เริ่ม (รอบ 1 ตาม slot ที่เหลือ)
    notStartedToday.forEach(item=>{
        tasks.push({
            surahNum:item.sn,
            surahName:item.surahName,
            type:'memorized-review',
            key:'mem-review-'+item.sn+'-'+todayStr,
            round:item.round,
            isNew:true,
            doneToday:false
        });
    });
    
    return tasks;
}

function toggleMemorizedReview(key){
    // อัปเดต Spaced Repetition data ทันที
    const match=key.match(/mem-review-(\d+)/);
    if(match){
        const sn=parseInt(match[1]);
        const reviewData=get('surahReviewData',{});
        const todayStr=getLocalDate();
        const rd=reviewData[sn]||{};
        
        // เช็คว่าทบทวนไปแล้ววันนี้หรือยัง
        const alreadyDone=rd.lastReview && new Date(rd.lastReview).toLocaleDateString('en-CA')===todayStr;
        
        if(alreadyDone){
            // ยกเลิก - ลบ lastReview ของวันนี้ออก (revert)
            reviewData[sn].lastReview=null;
            reviewData[sn].reviewCount=Math.max(0,(reviewData[sn].reviewCount||1)-1);
            // revert interval
            const prevInterval={3:1,7:3,14:7,30:14,60:30,90:60};
            reviewData[sn].interval=prevInterval[reviewData[sn].interval]||1;
        }else{
            // ทบทวนเสร็จ
            if(!reviewData[sn])reviewData[sn]={interval:1,reviewCount:0};
            reviewData[sn].lastReview=new Date().toISOString();
            reviewData[sn].reviewCount=(reviewData[sn].reviewCount||0)+1;
            // เพิ่ม interval
            const nextInterval={1:3,3:7,7:14,14:30,30:60,60:90};
            const currentInterval=reviewData[sn].interval||1;
            reviewData[sn].interval=nextInterval[currentInterval]||Math.min(currentInterval*2,90);
        }
        
        set('surahReviewData',reviewData);
    }
    
    // อัปเดต UI
    renderHomeGoalsAndReview();
    if(document.getElementById('page-calendar').classList.contains('active'))renderCalendar();
}

function updateStreak(){const today=getLocalDate(),last=get('lastActive','');let streak=get('streak',0);if(last!==today){const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);const yStr=yesterday.toLocaleDateString('en-CA');streak=(last===yStr)?streak+1:1;}set('streak',streak);set('lastActive',today);document.getElementById('streak-num').textContent=streak;}

function renderIntention(){const s=getSettings();document.getElementById('intention-text').textContent=s.intention||'แตะเพื่อตั้งเจตนา';}
function renderQuote(){const q=getQuotes(),i=getLocalDateObj().getDate()%q.length;document.getElementById('quote-text').textContent=q[i]||'';}

function renderStats(){
    let totalText=0,totalMeaning=0,totalTafsir=0,completedSurahs=0;
    SURAHS.forEach(s=>{const d=getSurah(s.n);totalText+=d.text||0;totalMeaning+=d.meaning||0;totalTafsir+=d.tafsir||0;if(calcStatus(d,s.ayah)===4)completedSurahs++;});
    const textP=Math.round(totalText/TOTAL_AYAH*100);
    const meaningP=Math.round(totalMeaning/TOTAL_AYAH*100);
    const tafsirP=Math.round(totalTafsir/TOTAL_AYAH*100);
    
    // อัปเดตข้อความหลัก
    document.getElementById('main-percent').textContent=textP+'%';
    document.getElementById('total-ayah').textContent=totalText+' / '+TOTAL_AYAH+' อายะฮ์';
    
    // อัปเดต 3 วงกลม (circumference = 100.5)
    const ringCircum=100.5;
    const textRing=document.getElementById('main-ring-text');
    const meaningRing=document.getElementById('main-ring-meaning');
    const tafsirRing=document.getElementById('main-ring-tafsir');
    if(textRing)textRing.style.strokeDashoffset=ringCircum-(ringCircum*textP/100);
    if(meaningRing)meaningRing.style.strokeDashoffset=ringCircum-(ringCircum*meaningP/100);
    if(tafsirRing)tafsirRing.style.strokeDashoffset=ringCircum-(ringCircum*tafsirP/100);
    
    const textNum=document.getElementById('main-text-num');
    const meaningNum=document.getElementById('main-meaning-num');
    const tafsirNum=document.getElementById('main-tafsir-num');
    if(textNum)textNum.textContent=textP+'%';
    if(meaningNum)meaningNum.textContent=meaningP+'%';
    if(tafsirNum)tafsirNum.textContent=tafsirP+'%';
    
    // อัปเดตสถิติ
    document.getElementById('stat-surah').textContent=completedSurahs;
    document.getElementById('stat-text').textContent=totalText;
    document.getElementById('stat-meaning').textContent=totalMeaning;
    document.getElementById('stat-tafsir').textContent=totalTafsir;
}

let continueSurah=null;
function renderContinueCard(){
    // หาซูเราะฮ์ที่กำลังเรียนอยู่ (ยังไม่จบ แต่มีความคืบหน้าแล้ว)
    let inProgress=[];
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        const textP=Math.min(100,Math.round((d.text||0)/s.ayah*100));
        const meaningP=Math.min(100,Math.round((d.meaning||0)/s.ayah*100));
        const tafsirP=Math.min(100,Math.round((d.tafsir||0)/s.ayah*100));
        const total=textP+meaningP+tafsirP;
        if(total>0&&total<300){
            inProgress.push({...s,textP,meaningP,tafsirP,total,d});
        }
    });
    
    // เรียงจากความคืบหน้ามากสุด
    inProgress.sort((a,b)=>b.total-a.total);
    
    const card=document.getElementById('continue-card');
    if(inProgress.length>0){
        const s=inProgress[0];
        continueSurah=s.n;
        card.style.display='block';
        card.innerHTML=`
            <div class="continue-head">
                <div class="continue-label"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>ดำเนินการต่อ</div>
                <div class="continue-btn"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>เปิด</div>
            </div>
            <div class="continue-info">
                <div class="continue-surah">
                    <div class="continue-name">${s.name}</div>
                    <div class="continue-ar">${s.ar}</div>
                </div>
                <div class="continue-progress">
                    <div class="continue-bar b1"><div class="continue-bar-fill" style="width:${s.textP}%"></div></div>
                    <div class="continue-bar b2"><div class="continue-bar-fill" style="width:${s.meaningP}%"></div></div>
                    <div class="continue-bar b3"><div class="continue-bar-fill" style="width:${s.tafsirP}%"></div></div>
                </div>
            </div>`;
    }else{
        card.style.display='none';
        continueSurah=null;
    }
}

function openContinueSurah(){
    if(continueSurah)openDetail(continueSurah);
}

function renderToday(){
    const today=getLocalDate(),log=getLog(),todayLog=log[today]||{text:0,meaning:0,tafsir:0},s=getSettings();
    document.getElementById('today-date').textContent=getLocalDateObj().toLocaleDateString('th-TH',{day:'numeric',month:'short'});
    document.getElementById('today-grid').innerHTML=`
        <div class="today-item"><div class="today-num c1">${todayLog.text||0}</div><div class="today-label">ตัวบท (${s.textMin}-${s.textMax})</div></div>
        <div class="today-item"><div class="today-num c2">${todayLog.meaning||0}</div><div class="today-label">ความหมาย</div></div>
        <div class="today-item"><div class="today-num c3">${todayLog.tafsir||0}</div><div class="today-label">ตัฟซีร</div></div>`;
}

function showTodayModal(){
    const today=getLocalDate(),log=getLog(),todayLog=log[today]||{text:0,meaning:0,tafsir:0},history=getHistory().filter(h=>h.date===today);
    let historyHtml=history.length?'<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--bdr)"><div style="font-size:0.65rem;font-weight:600;margin-bottom:10px">สิ่งที่ท่องวันนี้</div>'+history.map(h=>`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--card2);border-radius:var(--r-sm);margin-bottom:4px"><div style="width:8px;height:8px;border-radius:50%;background:var(--${h.type==='text'?'pri':h.type==='meaning'?'sec':'tafsir'})"></div><div style="flex:1"><div style="font-size:0.62rem;font-weight:500">${h.name}</div><div style="font-size:0.5rem;color:var(--txt3)">${h.type==='text'?'ตัวบท':h.type==='meaning'?'ความหมาย':'ตัฟซีร'} ${h.from}-${h.to}</div></div></div>`).join('')+'</div>':'';
    document.getElementById('modal-today-title').textContent=getLocalDateObj().toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long'});
    document.getElementById('modal-today-body').innerHTML=`<div class="modal-stats"><div class="modal-stat ms1"><div class="modal-stat-num">${todayLog.text||0}</div><div class="modal-stat-label">ตัวบท</div></div><div class="modal-stat ms2"><div class="modal-stat-num">${todayLog.meaning||0}</div><div class="modal-stat-label">ความหมาย</div></div><div class="modal-stat ms3"><div class="modal-stat-num">${todayLog.tafsir||0}</div><div class="modal-stat-label">ตัฟซีร</div></div></div>${historyHtml}`;
    openModal('today');
}

function renderChart(){
    const log=getLog(),svg=document.getElementById('chart-svg');
    chartData=[];
    const today=getLocalDateObj();
    const days=chartDays||14;
    document.getElementById('chart-days-label').textContent=days;
    for(let i=days-1;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toLocaleDateString('en-CA');const data=log[ds]||{text:0,meaning:0,tafsir:0};chartData.push({date:ds,day:d.getDate(),month:d.getMonth()+1,text:data.text||0,meaning:data.meaning||0,tafsir:data.tafsir||0});}
    const maxVal=Math.max(5,...chartData.map(d=>Math.max(d.text,d.meaning,d.tafsir)));
    const w=svg.parentElement.clientWidth||280,h=90,pad={t:8,r:8,b:16,l:24},cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
    const getX=i=>pad.l+(i/(days-1))*cw,getY=v=>pad.t+ch-(v/maxVal)*ch;
    const makePath=k=>chartData.map((d,i)=>(i===0?'M':'L')+getX(i)+','+getY(d[k])).join(' ');
    let grid='';for(let i=0;i<=2;i++){const y=pad.t+(i/2)*ch;grid+=`<line class="chart-grid-line" x1="${pad.l}" y1="${y}" x2="${w-pad.r}" y2="${y}"/>`;}
    let points='';const showEvery=days<=14?1:days<=30?2:4;chartData.forEach((d,i)=>{if(i%showEvery===0||i===days-1){const x=getX(i);points+=`<circle class="chart-point p1" cx="${x}" cy="${getY(d.text)}" r="3" onclick="showTooltip(event,${i})"/><circle class="chart-point p2" cx="${x}" cy="${getY(d.meaning)}" r="3" onclick="showTooltip(event,${i})"/><circle class="chart-point p3" cx="${x}" cy="${getY(d.tafsir)}" r="3" onclick="showTooltip(event,${i})"/>`;}});
    let labels='';const labelEvery=days<=7?1:days<=14?4:days<=30?7:15;chartData.forEach((d,i)=>{if(i%labelEvery===0||i===days-1)labels+=`<text class="chart-label" x="${getX(i)}" y="${h-3}" text-anchor="middle">${d.day}</text>`;});
    svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
    svg.innerHTML=grid+`<path class="chart-line l1" d="${makePath('text')}"/><path class="chart-line l2" d="${makePath('meaning')}"/><path class="chart-line l3" d="${makePath('tafsir')}"/>`+points+labels;
}

let chartDays=7;
function setChartRange(days,btn){
    chartDays=days;
    document.querySelectorAll('.chart-range-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderChart();
}

function showTooltip(e,idx){
    e.stopPropagation();
    const d=chartData[idx];
    const tooltip=document.getElementById('chart-tooltip');
    const card=document.querySelector('.chart-card');
    const rect=card.getBoundingClientRect();
    document.getElementById('tooltip-date').textContent=d.day+'/'+d.month;
    document.getElementById('tooltip-text').textContent=d.text;
    document.getElementById('tooltip-meaning').textContent=d.meaning;
    document.getElementById('tooltip-tafsir').textContent=d.tafsir;
    tooltip.classList.add('show');
    let left=e.clientX-rect.left-50;
    let top=e.clientY-rect.top+10;
    if(left<10)left=10;if(left>rect.width-120)left=rect.width-120;
    tooltip.style.left=left+'px';
    tooltip.style.top=top+'px';
}
function hideTooltip(){document.getElementById('chart-tooltip').classList.remove('show');}

function showStatModal(type){
    let list=[];
    const titles={surah:'ซูเราะฮ์จบสมบูรณ์',text:'ตัวบท',meaning:'ความหมาย',tafsir:'ตัฟซีร'};
    const colors={surah:'var(--done)',text:'var(--pri)',meaning:'var(--sec)',tafsir:'var(--tafsir)'};
    const bgColors={surah:'var(--done-l)',text:'var(--pri-ll)',meaning:'var(--sec-ll)',tafsir:'var(--tafsir-ll)'};
    const icons={
        surah:'<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        text:'<path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>',
        meaning:'<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>',
        tafsir:'<path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/>'
    };
    
    if(type==='surah'){
        SURAHS.forEach(s=>{const d=getSurah(s.n);if(calcStatus(d,s.ayah)===4)list.push({name:s.name,n:s.n})});
    }else{
        SURAHS.forEach(s=>{const d=getSurah(s.n);const v=d[type]||0;if(v>0)list.push({name:s.name,v,ay:s.ayah})});
    }
    
    const total=type==='surah'?list.length:list.reduce((a,b)=>a+b.v,0);
    
    const borderColors={surah:'var(--done-l)',text:'var(--pri-l)',meaning:'var(--sec-l)',tafsir:'var(--tafsir-l)'};
    
    document.getElementById('modal-stat-body').innerHTML=`
        <div style="text-align:center;padding:14px 12px 10px;background:linear-gradient(135deg,${bgColors[type]},var(--card));margin:0 -16px 12px -16px;border-bottom:1px solid ${borderColors[type]};border-radius:16px 16px 0 0">
            <div style="width:36px;height:36px;background:${colors[type]};border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">${icons[type]}</svg>
            </div>
            <div style="font-size:0.75rem;font-weight:600;color:${colors[type]}">${titles[type]}</div>
            <div style="font-size:0.5rem;color:var(--txt3)">${total} ${type==='surah'?'ซูเราะฮ์':'อายะฮ์'}</div>
        </div>
        ${list.length?`<div style="display:grid;gap:4px;max-height:50vh;overflow-y:auto">
            ${list.map(x=>`
                <div style="padding:7px 10px;background:linear-gradient(135deg,${bgColors[type]},#fff);border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-size:0.6rem">
                    <span style="font-weight:500;color:var(--txt)">${x.name}</span>
                    ${type!=='surah'?`<span style="color:${colors[type]};font-weight:600">${x.v}/${x.ay}</span>`:'<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="'+colors[type]+'" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'}
                </div>
            `).join('')}
        </div>`:'<div style="text-align:center;color:var(--txt3);padding:16px;font-size:0.65rem">ยังไม่มี</div>'}
    `;
    openModal('stat');
}

function renderGoals(){
    const goals=getGoals(),streak=get('streak',0);let totalText=0,completedSurahs=0;SURAHS.forEach(s=>{const d=getSurah(s.n);totalText+=d.text||0;if(calcStatus(d,s.ayah)===4)completedSurahs++});
    document.getElementById('goals-grid').innerHTML=goals.map(g=>{const current=g.ty==='surah'?completedSurahs:g.ty==='ayah'?totalText:streak,done=current>=g.n;return`<div class="goal-card ${done?'done':''}"><div class="goal-emoji">${g.e}</div><div class="goal-name">${g.t}</div><div class="goal-prog">${done?'✓':current+'/'+g.n}</div></div>`;}).join('')||'<div class="empty-state" style="grid-column:1/-1">ยังไม่มี</div>';
}

function renderRewards(){
    const rewards=getRewards(),streak=get('streak',0);let totalText=0,completedSurahs=0;SURAHS.forEach(s=>{const d=getSurah(s.n);totalText+=d.text||0;if(calcStatus(d,s.ayah)===4)completedSurahs++});
    document.getElementById('rewards-grid').innerHTML=rewards.map(r=>{const current=r.ty==='surah'?completedSurahs:r.ty==='ayah'?totalText:streak,done=current>=r.n;return`<div class="goal-card ${done?'done':''}"><div class="goal-emoji">${r.e}</div><div class="goal-name">${r.t}</div><div class="goal-prog">${done?'✓':current+'/'+r.n}</div></div>`;}).join('')||'<div class="empty-state" style="grid-column:1/-1">ยังไม่มี</div>';
}

function renderSurahGrid(){
    const memorizedSurahs=get('memorizedSurahs',[]);
    document.getElementById('surah-grid').innerHTML=SURAHS.map(s=>{
        const d=getSurah(s.n);
        // ถ้าอยู่ใน memorizedSurahs ให้ text = max
        const textVal=memorizedSurahs.includes(s.n)?s.ayah:(d.text||0);
        const textP=Math.round(textVal/s.ayah*100);
        const meaningP=Math.round((d.meaning||0)/s.ayah*100);
        const tafsirP=Math.round((d.tafsir||0)/s.ayah*100);
        // คำนวณ status ตามปกติ
        const t=textVal,m=d.meaning||0,f=d.tafsir||0;
        let status=0;
        if(t>=s.ayah&&m>=s.ayah&&f>=s.ayah)status=4;
        else if(f>0)status=3;
        else if(m>0)status=2;
        else if(t>0)status=1;
        const doneHtml=status===4?'<div class="surah-done"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>':'';
        return`<div class="surah-card s${status}" onclick="openDetail(${s.n})"><div class="surah-top"><div class="surah-num">${s.n}</div><div class="surah-ar">${s.ar}</div></div><div class="surah-name">${s.name}</div><div class="surah-meta">${s.ayah} อายะฮ์</div><div class="surah-bars"><div class="surah-bar b1"><div class="surah-bar-fill" style="width:${textP}%"></div></div><div class="surah-bar b2"><div class="surah-bar-fill" style="width:${meaningP}%"></div></div><div class="surah-bar b3"><div class="surah-bar-fill" style="width:${tafsirP}%"></div></div></div>${doneHtml}</div>`;
    }).join('');
}

function openDetail(n){
    currentSurah=n;currentNoteTab='notes';
    // หา surah จากทั้ง SURAHS และ PLUS_SURAHS
    const isPlus=typeof n==='string'&&n.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===n):SURAHS.find(x=>x.n===n);
    const d=getSurah(n);
    
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('page-detail').classList.add('active');
    pageHistory.push('detail');history.pushState({page:'detail'},'');
    document.getElementById('detail-name').textContent=s.name;
    document.getElementById('detail-meta').textContent=(isPlus?s.ref.replace(/:/g,' : '):('ซูเราะฮ์ '+s.n))+' • '+s.ayah+' อายะฮ์';
    document.getElementById('detail-ar').textContent=s.ar;
    
    // เพิ่มข้อมูล Plus (usage, hadith, note)
    const plusInfoEl=document.getElementById('detail-plus-info');
    if(plusInfoEl){
        if(isPlus&&(s.usage||s.hadith||s.note)){
            // Strength badge with corrected terminology
            const strengthLabels={sahih:'เศาะเฮียะห์',hasan:'หะสัน',daif:'ฎออีฟ',quran:'อัลกุรอาน'};
            const strengthBadge=s.hadithStrength?`<span class="hadith-badge ${s.hadithStrength}" style="font-size:9px;padding:2px 8px;vertical-align:middle">${strengthLabels[s.hadithStrength]||''}</span>`:'';
            
            let infoHtml='<div style="background:var(--gold-l);border-radius:var(--r-md);padding:14px 16px;margin-bottom:12px;border:1px solid rgba(184,149,107,0.3)">';
            if(s.usage)infoHtml+=`<div style="font-size:var(--text-2xs);color:var(--gold);margin-bottom:8px;font-weight:600;display:flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>${s.usage}</div>`;
            if(s.note)infoHtml+=`<div style="font-size:var(--text-2xs);color:var(--txt2);line-height:1.6;margin-bottom:8px">${s.note}</div>`;
            if(s.hadith)infoHtml+=`<div style="font-size:var(--text-2xs);color:var(--txt3);display:flex;align-items:center;gap:6px;flex-wrap:wrap"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>${s.hadith} ${strengthBadge}</div>`;
            if(s.extraHadith)infoHtml+=`<div style="font-size:var(--text-2xs);color:var(--txt3);margin-top:6px;padding-top:8px;border-top:1px dashed rgba(184,149,107,0.3);display:flex;align-items:flex-start;gap:6px"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;margin-top:2px"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>${s.extraHadith}</div>`;
            infoHtml+='</div>';
            plusInfoEl.innerHTML=infoHtml;
        }else{
            plusInfoEl.innerHTML='';
        }
    }
    
    renderDetailRings(s,d);renderDetailBody(s,d,isPlus);
    setTimeout(()=>window.scrollTo(0,0),10);
}

function renderDetailRings(s,d){
    const textP=Math.round((d.text||0)/s.ayah*100),meaningP=Math.round((d.meaning||0)/s.ayah*100),tafsirP=Math.round((d.tafsir||0)/s.ayah*100),c=2*Math.PI*18;
    document.getElementById('detail-rings').innerHTML=['r1','r2','r3'].map((cl,i)=>{const v=[d.text||0,d.meaning||0,d.tafsir||0][i],p=[textP,meaningP,tafsirP][i],l=['ตัวบท','ความหมาย','ตัฟซีร'][i];return`<div class="ring-item ${cl}"><div class="mini-ring"><svg width="48" height="48"><circle class="bg" cx="24" cy="24" r="18"/><circle class="fg" cx="24" cy="24" r="18" stroke-dasharray="${c}" stroke-dashoffset="${c-(c*p/100)}" style="transform:rotate(-90deg);transform-origin:center"/></svg><div class="mini-ring-num">${v}</div></div><div class="ring-item-label">${l}</div></div>`;}).join('');
}

// ตรวจสอบว่าซูเราะฮ์ต้องแสดงบัสมาละหรือไม่
function needsBasmala(s,isPlus){
    // Juz' Amma (78-114) - ทุกซูเราะฮ์ต้องแสดงบัสมาละ
    if(!isPlus&&typeof s.n==='number'&&s.n>=78&&s.n<=114){
        return true;
    }
    // Plus - ตรวจสอบว่าเป็นซูเราะฮ์เต็มที่เริ่มจากอายะฮ์ 1
    if(isPlus&&s.ref){
        // ดูว่า ref ขึ้นต้นด้วย ":1-" หรือ ":1" ที่เป็นอายะฮ์แรก
        const match=s.ref.match(/\d+:(\d+)/);
        if(match&&match[1]==='1'){
            return true; // เริ่มจากอายะฮ์ 1 = ซูเราะฮ์เต็ม
        }
    }
    return false;
}

function renderDetailBody(s,d,isPlus){
    const sn=isPlus?`'${s.n}'`:s.n;
    let html=`<div class="input-card"><div class="input-title"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>ความคืบหน้า</div>`;
    html+=`<div class="input-row"><div class="input-dot c1"></div><div class="input-label">ตัวบท</div><input type="number" class="input-field" id="input-text" value="${d.text||0}" min="0" max="${s.ayah}"><div class="input-max">/${s.ayah}</div></div>`;
    html+=`<div class="input-row"><div class="input-dot c2"></div><div class="input-label">ความหมาย</div><input type="number" class="input-field" id="input-meaning" value="${d.meaning||0}" min="0" max="${s.ayah}"><div class="input-max">/${s.ayah}</div></div>`;
    html+=`<div class="input-row"><div class="input-dot c3"></div><div class="input-label">ตัฟซีร</div><input type="number" class="input-field" id="input-tafsir" value="${d.tafsir||0}" min="0" max="${s.ayah}"><div class="input-max">/${s.ayah}</div></div>`;
    html+=`<button class="add-btn" style="width:100%;margin-top:10px" onclick="saveProgress(${sn})">บันทึก</button></div>`;
    
    html+=`<div class="tabs"><button class="tab active" onclick="switchMainTab('notes',this)">บันทึก</button><button class="tab" onclick="switchMainTab('habits',this)">นิสัย</button><button class="tab" onclick="switchMainTab('names',this)">พระนาม</button></div>`;
    
    html+=`<div class="tab-content active" id="main-tab-notes">`;
    html+=`<div class="notebook"><div class="notebook-head nh-overview"><div class="notebook-title nt-overview"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>ภาพรวมซูเราะฮ์</div><div class="toolbar compact-colors"><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('bold')"><b>B</b></button><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('italic')"><i>I</i></button><div class="tb-special-wrap menu-down"><button class="tb-special-btn" onmousedown="event.preventDefault()" onclick="toggleSpecialMenu(this)" title="เครื่องมือพิเศษ"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l7 7"/><path d="M18 13l-6-6"/></svg></button><div class="tb-special-menu"><button class="tb-special-item item-hl" onmousedown="event.preventDefault()" onclick="removeHighlightOnly()" title="ลบไฮไลท์">HL</button><button class="tb-special-item item-tc" onmousedown="event.preventDefault()" onclick="removeTextColorOnly()" title="ลบสีตัวอักษร">TC</button><button class="tb-special-item item-sz" onmousedown="event.preventDefault()" onclick="normalizeSize()" title="จัดขนาด">Sz</button><button class="tb-special-item item-all" onmousedown="event.preventDefault()" onclick="removeAllFormat()" title="ลบทั้งหมด">All</button></div></div><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-colors-wrap"><div class="tb-colors-btn" onmousedown="event.preventDefault()" onclick="toggleColorsPopup(this)" title="สีเพิ่มเติม"></div><div class="tb-colors-popup"><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-color c3" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FFF3CD')"></div><div class="tb-color c4" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#E8D5E8')"></div><div class="tb-color c5" onmousedown="event.preventDefault()" onclick="applyLastColor()"></div><div class="tb-color-add" onmousedown="event.preventDefault()" onclick="openColorPicker()">+</div></div></div></div></div><div class="notebook-body"><div class="note-edit" contenteditable="true" data-placeholder="เขียนภาพรวมของซูเราะฮ์..." id="overview-edit" onblur="saveOverview(${sn})">${d.overview||''}</div></div></div>`;
    html+=`<div class="notebook"><div class="notebook-head nh-reasons"><div class="notebook-title nt-reasons"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>สาเหตุการประทาน</div><div class="toolbar compact-colors"><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('bold')"><b>B</b></button><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('italic')"><i>I</i></button><div class="tb-special-wrap menu-down"><button class="tb-special-btn" onmousedown="event.preventDefault()" onclick="toggleSpecialMenu(this)" title="เครื่องมือพิเศษ"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l7 7"/><path d="M18 13l-6-6"/></svg></button><div class="tb-special-menu"><button class="tb-special-item item-hl" onmousedown="event.preventDefault()" onclick="removeHighlightOnly()" title="ลบไฮไลท์">HL</button><button class="tb-special-item item-tc" onmousedown="event.preventDefault()" onclick="removeTextColorOnly()" title="ลบสีตัวอักษร">TC</button><button class="tb-special-item item-sz" onmousedown="event.preventDefault()" onclick="normalizeSize()" title="จัดขนาด">Sz</button><button class="tb-special-item item-all" onmousedown="event.preventDefault()" onclick="removeAllFormat()" title="ลบทั้งหมด">All</button></div></div><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-colors-wrap"><div class="tb-colors-btn" onmousedown="event.preventDefault()" onclick="toggleColorsPopup(this)" title="สีเพิ่มเติม"></div><div class="tb-colors-popup"><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-color c3" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FFF3CD')"></div><div class="tb-color c4" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#E8D5E8')"></div><div class="tb-color c5" onmousedown="event.preventDefault()" onclick="applyLastColor()"></div><div class="tb-color-add" onmousedown="event.preventDefault()" onclick="openColorPicker()">+</div></div></div></div></div><div class="notebook-body"><div class="note-edit" contenteditable="true" data-placeholder="เขียนสาเหตุการประทาน..." id="reasons-edit" onblur="saveReasons(${sn})">${d.reasons||''}</div></div></div>`;
    html+=`<div class="notebook"><div class="notebook-head nh-stories"><div class="notebook-title nt-stories"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>เรื่องราวนบีและกลุ่มชน</div><div class="toolbar compact-colors"><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('bold')"><b>B</b></button><button class="tb-btn" onmousedown="event.preventDefault()" onclick="formatText('italic')"><i>I</i></button><div class="tb-special-wrap menu-down"><button class="tb-special-btn" onmousedown="event.preventDefault()" onclick="toggleSpecialMenu(this)" title="เครื่องมือพิเศษ"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l7 7"/><path d="M18 13l-6-6"/></svg></button><div class="tb-special-menu"><button class="tb-special-item item-hl" onmousedown="event.preventDefault()" onclick="removeHighlightOnly()" title="ลบไฮไลท์">HL</button><button class="tb-special-item item-tc" onmousedown="event.preventDefault()" onclick="removeTextColorOnly()" title="ลบสีตัวอักษร">TC</button><button class="tb-special-item item-sz" onmousedown="event.preventDefault()" onclick="normalizeSize()" title="จัดขนาด">Sz</button><button class="tb-special-item item-all" onmousedown="event.preventDefault()" onclick="removeAllFormat()" title="ลบทั้งหมด">All</button></div></div><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-colors-wrap"><div class="tb-colors-btn" onmousedown="event.preventDefault()" onclick="toggleColorsPopup(this)" title="สีเพิ่มเติม"></div><div class="tb-colors-popup"><div class="tb-color c1" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3')"></div><div class="tb-color c2" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC')"></div><div class="tb-color c3" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FFF3CD')"></div><div class="tb-color c4" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#E8D5E8')"></div><div class="tb-color c5" onmousedown="event.preventDefault()" onclick="applyLastColor()"></div><div class="tb-color-add" onmousedown="event.preventDefault()" onclick="openColorPicker()">+</div></div></div></div></div><div class="notebook-body"><div class="note-edit" contenteditable="true" data-placeholder="เรื่องราวของบรรดานบีหรือกลุ่มชนในอดีต..." id="stories-edit" onblur="saveStories(${sn})">${d.stories||''}</div></div></div>`;
    
    // ตรวจสอบว่าควรแสดงบัสมาละหรือไม่ (ซูเราะฮ์เต็มที่เริ่มจากอายะฮ์ 1)
    const showBasmala=needsBasmala(s,isPlus);
    const basmalaHtml=showBasmala?`<div class="basmala-wrap"><div class="basmala-inner"><span class="basmala-line"></span><span class="basmala-dot"></span><span class="basmala-text">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</span><span class="basmala-dot"></span><span class="basmala-line"></span></div></div>`:'';
    
    html+=`<div class="notebook"><div style="padding:10px 14px"><div class="note-tabs"><button class="note-tab t-notes active" onclick="switchNoteTab('notes',this,${sn})"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ความรู้</button><button class="note-tab t-meanings" onclick="switchNoteTab('meanings',this,${sn})"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>ความหมาย</button><button class="note-tab t-tafsirs" onclick="switchNoteTab('tafsirs',this,${sn})"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>ตัฟซีร</button></div>${basmalaHtml}<div class="ayah-list" id="ayah-list">${renderAyahList(s,d,'notes')}</div></div></div>`;
    html+=`</div>`;
    
    const customCats=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    html+=`<div class="tab-content" id="main-tab-habits"><div class="habits-container"><div class="habit-add-row"><input type="text" class="habit-input" id="habit-input" placeholder="นิสัยที่ได้เรียนรู้"><input type="number" class="habit-input habit-input-sm" id="habit-ayah" placeholder="อายะฮ์"><select class="habit-input" id="habit-category" style="width:90px">${customCats.map(c=>`<option value="${c}">${c}</option>`).join('')}</select><button class="add-btn" onclick="addHabit(${sn})">+</button></div><div class="habits-grid" id="habits-list">${renderHabits(s.n,d)}</div></div></div>`;
    
    html+=`<div class="tab-content" id="main-tab-names"><div class="names-container">`;
    html+=`<div class="name-add-toggle" onclick="toggleNameForm()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>เพิ่มพระนาม</div>`;
    html+=`<div class="name-add-form" id="name-add-form">`;
    html+=`<div class="name-add-form-title"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>เพิ่มพระนาม</div>`;
    html+=`<div class="name-add-grid"><input type="text" id="name-input" class="name-add-input ar" placeholder="พระนาม"><input type="text" id="name-meaning-short" class="name-add-input" placeholder="ความหมาย"><input type="number" id="name-ayah" class="name-add-input" placeholder="อายะฮ์" style="text-align:center"></div>`;
    html+=`<div class="name-add-row2"><div class="name-add-col"><label>ความรู้ที่ได้</label><div contenteditable="true" class="name-add-edit" id="name-lesson" data-placeholder="สิ่งที่เรียนรู้..."></div></div><div class="name-add-col"><label>ดุอาอ์/นิสัย</label><div contenteditable="true" class="name-add-edit" id="name-dua" data-placeholder="ดุอาอ์หรือนิสัย..."></div></div></div>`;
    html+=`<div class="name-add-footer" style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><div class="name-toolbar-shared" style="display:flex;gap:4px"><button type="button" style="width:26px;height:26px;border:1px solid var(--pink-l);border-radius:var(--r-xs);background:#fff;cursor:pointer;font-weight:700;color:var(--pink)" onmousedown="event.preventDefault()" onclick="applyNameFormat('bold')">B</button><button type="button" style="width:26px;height:26px;border:1px solid var(--pink-l);border-radius:var(--r-xs);background:#fff;cursor:pointer;font-style:italic;color:var(--pink)" onmousedown="event.preventDefault()" onclick="applyNameFormat('italic')">I</button><div style="width:20px;height:20px;border-radius:var(--r-xs);background:#FADEE3;cursor:pointer;border:1px solid rgba(0,0,0,0.08)" onmousedown="event.preventDefault()" onclick="applyNameHighlight('#FADEE3')"></div><div style="width:20px;height:20px;border-radius:var(--r-xs);background:#D4EDEC;cursor:pointer;border:1px solid rgba(0,0,0,0.08)" onmousedown="event.preventDefault()" onclick="applyNameHighlight('#D4EDEC')"></div><div style="width:20px;height:20px;border-radius:var(--r-xs);background:#FFF3CD;cursor:pointer;border:1px solid rgba(0,0,0,0.08)" onmousedown="event.preventDefault()" onclick="applyNameHighlight('#FFF3CD')"></div></div><button class="name-add-btn primary" onclick="addName(${sn})">บันทึก</button></div>`;
    html+=`</div>`;
    html+=`<div class="names-list" id="names-list">${renderNames(s,d)}</div></div></div>`;
    
    document.getElementById('detail-body').innerHTML=html;
}

function renderAyahList(s,d,key){
    let html='';
    const isPlus=typeof s.n==='string'&&s.n.startsWith('p');
    const snArg=isPlus?`'${s.n}'`:s.n;
    
    // ดึง userAyahTexts ที่ผู้ใช้บันทึกไว้
    const userTexts=get('userAyahTexts',{});
    const surahKey=isPlus?s.n:String(s.n);
    const surahTexts=userTexts[surahKey]||{};
    
    // ดึงสถานะเปิด/ปิดตัวบท
    const arOpenState=get('ayahArOpen',{});
    
    // ดึงตัวบทจาก QURAN_VERSES หรือ verses
    function getArText(ayahNum){
        // 1. ถ้าผู้ใช้บันทึกไว้ ใช้ของผู้ใช้
        if(surahTexts[ayahNum])return surahTexts[ayahNum];
        // 2. ถ้าเป็น Plus ที่มี verses
        if(s.verses){
            const v=s.verses.find(x=>String(x.num)===String(ayahNum));
            if(v)return v.ar;
        }
        // 3. ถ้าเป็น Juz Amma ดูจาก QURAN_VERSES
        if(!isPlus&&QURAN_VERSES[s.n]&&QURAN_VERSES[s.n][parseInt(ayahNum)]){
            return QURAN_VERSES[s.n][parseInt(ayahNum)];
        }
        return '';
    }
    
    // ดึงไฮไลท์ที่บันทึกไว้
    const ayahHighlights=get('ayahHighlights',{});
    
    function buildAyahHtml(ayahNum, arText){
        const hasAr=arText.length>0;
        const arKey=surahKey+'-'+ayahNum;
        const isOpen=arOpenState[arKey]||false;
        const savedHighlight=ayahHighlights[arKey]||arText;
        
        return `<div class="ayah-item">
            <div class="ayah-ar-wrap ${isOpen?'open':''}" id="ar-wrap-${surahKey}-${ayahNum}">
                <div class="ayah-ar-header ${hasAr?'has-text':''} ${isOpen?'open':''}" onclick="toggleAyahArDisplay('${surahKey}','${ayahNum}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    <span>${hasAr?'ตัวบท':'เพิ่มตัวบท'}</span>
                </div>
                <div class="ayah-ar-body">
                    ${hasAr?`<div class="ayah-ar-text">${savedHighlight}</div>`:'<div style="text-align:center;color:var(--txt3);font-size:var(--text-3xs);padding:12px">ยังไม่มีตัวบท กดปุ่มแก้ไขเพื่อเพิ่ม</div>'}
                    <div class="ayah-ar-edit" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <span class="ayah-ar-edit-btn" onclick="event.stopPropagation();openAyahArEditor(${snArg},'${ayahNum}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            แก้ไขตัวบท
                        </span>
                        <div class="ayah-mini-wrap">
                            <button class="ayah-mini-btn" onclick="event.stopPropagation();toggleAyahMiniMenu(this)" title="เครื่องมือจัดรูปแบบ">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M12 3v3M12 18v3M3 12h3M18 12h3M5.6 5.6l2.1 2.1M16.3 16.3l2.1 2.1M5.6 18.4l2.1-2.1M16.3 7.7l2.1-2.1"/></svg>
                            </button>
                            <div class="ayah-mini-menu">
                                <button class="ayah-mini-item" style="background:#f5f5f5;font-weight:700" onmousedown="event.preventDefault()" onclick="formatText('bold');closeAyahMiniMenus()" title="ตัวหนา">B</button>
                                <button class="ayah-mini-item" style="background:#f5f5f5;font-style:italic" onmousedown="event.preventDefault()" onclick="formatText('italic');closeAyahMiniMenus()" title="ตัวเอียง">I</button>
                                <button class="ayah-mini-color" style="background:#FADEE3" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FADEE3');closeAyahMiniMenus()" title="ชมพู"></button>
                                <button class="ayah-mini-color" style="background:#D4EDEC" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#D4EDEC');closeAyahMiniMenus()" title="เขียวมิ้นต์"></button>
                                <button class="ayah-mini-color" style="background:#FFF3CD" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FFF3CD');closeAyahMiniMenus()" title="เหลือง"></button>
                                <button class="ayah-mini-color" style="background:#E8D5E8" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#E8D5E8');closeAyahMiniMenus()" title="ม่วง"></button>
                                <button class="ayah-mini-color" style="background:#FFCECE" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#FFCECE');closeAyahMiniMenus()" title="แดงพาสเทล"></button>
                                <button class="ayah-mini-color" style="background:#C5E8FF" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#C5E8FF');closeAyahMiniMenus()" title="ฟ้าพาสเทล"></button>
                                <button class="ayah-mini-color" style="background:#C5F0C5" onmousedown="event.preventDefault()" onclick="formatText('hiliteColor','#C5F0C5');closeAyahMiniMenus()" title="เขียวพาสเทล"></button>
                                <button class="ayah-mini-hl-btn" onmousedown="event.preventDefault()" onclick="openColorPicker();closeAyahMiniMenus()" title="สีเพิ่มเติม"><svg viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.5"><path d="M12 2L4.5 14.5c-1.5 2.5 1 5.5 4 5.5h7c3 0 5.5-3 4-5.5L12 2z"/><line x1="4" y1="22" x2="20" y2="22" stroke-width="2"/></svg></button>
                                <div class="ayah-mini-sep"></div>
                                <button class="ayah-mini-item" style="background:#fff3e0;color:#e65100" onmousedown="event.preventDefault()" onclick="removeHighlightOnly();closeAyahMiniMenus()" title="ลบไฮไลท์">HL</button>
                                <button class="ayah-mini-item" style="background:#e3f2fd;color:#1565c0" onmousedown="event.preventDefault()" onclick="removeTextColorOnly();closeAyahMiniMenus()" title="ลบสี">TC</button>
                                <button class="ayah-mini-item" style="background:#e8f5e9;color:#2e7d32" onmousedown="event.preventDefault()" onclick="normalizeSize();closeAyahMiniMenus()" title="ขนาดปกติ">Sz</button>
                                <button class="ayah-mini-item" style="background:#fce4ec;color:#c2185b" onmousedown="event.preventDefault()" onclick="removeAllFormat();closeAyahMiniMenus()" title="ลบทั้งหมด">All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ayah-item-row"><div class="ayah-num an-${key}">${ayahNum}</div><div class="ayah-input" contenteditable="true" data-placeholder="อายะฮ์ ${ayahNum} ... " id="ayah-${key}-${ayahNum}" onblur="saveAyahNote(${snArg},'${key}','${ayahNum}')">${d[key]?.[ayahNum]||''}</div></div>
        </div>`;
    }
    
    // ถ้ามี verses ให้ใช้ verses แทน (สำหรับ Plus ที่มีการแบ่งย่อย)
    if(s.verses&&s.verses.length>0){
        s.verses.forEach((v,idx)=>{
            const arText=getArText(v.num);
            html+=buildAyahHtml(v.num, arText);
        });
    }else if(isPlus){
        // Plus ที่ไม่มี verses - ใช้เลขอายะฮ์จริงตาม ref
        const refMatch=s.ref?.match(/(\d+):(\d+)(?:-(\d+))?/);
        let startAyah=1;
        if(refMatch&&refMatch[2])startAyah=parseInt(refMatch[2]);
        
        for(let i=0;i<s.ayah;i++){
            const ayahNum=startAyah+i;
            const arText=getArText(ayahNum);
            html+=buildAyahHtml(ayahNum, arText);
        }
    }else{
        // Juz Amma - ใช้เลข 1 ถึง s.ayah
        for(let i=1;i<=s.ayah;i++){
            const arText=getArText(i);
            html+=buildAyahHtml(i, arText);
        }
    }
    return html;
}

// Toggle แสดง/ซ่อนตัวบทอาหรับ
function toggleAyahArDisplay(surahKey,ayahNum){
    const arKey=surahKey+'-'+ayahNum;
    const arOpenState=get('ayahArOpen',{});
    arOpenState[arKey]=!arOpenState[arKey];
    set('ayahArOpen',arOpenState);
    
    const wrap=document.getElementById('ar-wrap-'+surahKey+'-'+ayahNum);
    if(wrap){
        wrap.classList.toggle('open');
        wrap.querySelector('.ayah-ar-header').classList.toggle('open');
    }
}

// เปิด editor แก้ไขตัวบท
function openAyahArEditor(surahNum,ayahNum){
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const surahKey=isPlus?surahNum:String(surahNum);
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    
    // ดึงข้อความปัจจุบัน
    const userTexts=get('userAyahTexts',{});
    let currentText='';
    if(userTexts[surahKey]&&userTexts[surahKey][ayahNum]){
        currentText=userTexts[surahKey][ayahNum];
    }else if(s.verses){
        const v=s.verses.find(x=>String(x.num)===String(ayahNum));
        if(v)currentText=v.ar;
    }else if(!isPlus&&QURAN_VERSES[surahNum]&&QURAN_VERSES[surahNum][parseInt(ayahNum)]){
        currentText=QURAN_VERSES[surahNum][parseInt(ayahNum)];
    }
    
    // ดึงไฮไลท์ที่บันทึกไว้
    const ayahHighlights=get('ayahHighlights',{});
    const arKey=surahKey+'-'+ayahNum;
    const savedHighlight=ayahHighlights[arKey]||currentText;
    
    document.getElementById('modal-ayah-ar-content').innerHTML=`
        <div style="text-align:center;padding:16px 0 14px;border-bottom:1px solid var(--bdr-l);margin:0 -12px 16px;background:linear-gradient(135deg,var(--gold-l),var(--card));border-radius:var(--r-lg) var(--r-lg) 0 0">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" style="margin-bottom:8px"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
            <div style="font-size:var(--text-xs);font-weight:600;color:var(--gold)">ตัวบทอายะฮ์ ${ayahNum}</div>
            <div style="font-size:var(--text-3xs);color:var(--txt3);margin-top:2px">${s?s.name:''}</div>
        </div>
        <div id="ayah-ar-input" dir="rtl" contenteditable="true" style="width:100%;min-height:140px;font-family:'Amiri',serif;font-size:1.15rem;line-height:2.4;padding:16px;border:1px solid var(--bdr);border-radius:var(--r-sm);text-align:right;word-spacing:6px;background:#fff;overflow-y:auto">${savedHighlight}</div>
        <div style="display:flex;gap:4px;align-items:center;justify-content:center;margin-top:12px;padding:10px;background:#f8f8f8;border-radius:var(--r-sm);flex-wrap:wrap">
            <button class="tb-btn" onmousedown="event.preventDefault()" onclick="document.execCommand('bold')"><b>B</b></button>
            <button class="tb-btn" onmousedown="event.preventDefault()" onclick="document.execCommand('italic')"><i>I</i></button>
            <div class="tb-special-wrap"><button class="tb-special-btn" onmousedown="event.preventDefault()" onclick="toggleSpecialMenu(this)" title="เครื่องมือพิเศษ"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l7 7"/><path d="M18 13l-6-6"/></svg></button><div class="tb-special-menu"><button class="tb-special-item item-hl" onmousedown="event.preventDefault()" onclick="removeHighlightOnly()" title="ลบไฮไลท์">HL</button><button class="tb-special-item item-tc" onmousedown="event.preventDefault()" onclick="removeTextColorOnly()" title="ลบสีตัวอักษร">TC</button><button class="tb-special-item item-sz" onmousedown="event.preventDefault()" onclick="normalizeSize()" title="จัดขนาด">Sz</button><button class="tb-special-item item-all" onmousedown="event.preventDefault()" onclick="removeAllFormat()" title="ลบทั้งหมด">All</button></div></div>
            <div class="tb-color c1" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#FADEE3')"></div>
            <div class="tb-color c2" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#D4EDEC')"></div>
            <div class="tb-color c3" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#FFF3CD')"></div>
            <div class="tb-color c4" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#E8D5E8')" title="ม่วงพาสเทล"></div>
            <div class="tb-color c5" onmousedown="event.preventDefault()" onclick="applyLastColor()" title="สีล่าสุด"></div><div class="tb-color-add" onmousedown="event.preventDefault()" onclick="openColorPicker()" title="เลือกสีใหม่">+</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:16px">
            <button onclick="closeModal('ayah-ar')" style="flex:1;padding:14px;background:var(--card2);border:1px solid var(--bdr);border-radius:var(--r-sm);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;font-size:var(--text-2xs)">ยกเลิก</button>
            <button onclick="saveAyahArWithHighlight('${surahKey}','${ayahNum}')" style="flex:1;padding:14px;background:var(--gold);color:#fff;border:none;border-radius:var(--r-sm);cursor:pointer;font-family:'Noto Sans Thai',sans-serif;font-size:var(--text-2xs);font-weight:600">บันทึก</button>
        </div>
    `;
    openModal('ayah-ar');
}

// Toggle special tools menu
function toggleSpecialMenu(btn){
    const wrap=btn.closest('.tb-special-wrap');
    if(wrap){
        document.querySelectorAll('.tb-special-wrap.open').forEach(w=>{if(w!==wrap)w.classList.remove('open')});
        wrap.classList.toggle('open');
        if(wrap.classList.contains('open')){
            setTimeout(()=>{
                const closeHandler=e=>{
                    if(!wrap.contains(e.target)){
                        wrap.classList.remove('open');
                        document.removeEventListener('click',closeHandler);
                    }
                };
                document.addEventListener('click',closeHandler);
            },10);
        }
    }
}

// สีล่าสุดที่เลือก
let lastCustomColor=get('lastCustomColor','#fed6e3'); // default สีชมพูพาสเทล

// ใช้สีล่าสุด (สีที่ 5)
function applyLastColor(){
    document.execCommand('hiliteColor',false,lastCustomColor);
}

// เปิด color picker modal
function openColorPicker(){
    document.getElementById('custom-color-input').value=lastCustomColor;
    document.getElementById('color-picker-modal').classList.add('show');
}

// ปิด color picker modal
function closeColorPicker(){
    document.getElementById('color-picker-modal').classList.remove('show');
}

// ใช้สีที่เลือกจาก modal
function applyCustomColor(){
    const color=document.getElementById('custom-color-input').value;
    lastCustomColor=color;
    set('lastCustomColor',color);
    document.execCommand('hiliteColor',false,color);
    // อัพเดทสีปุ่ม c5 เฉพาะ toolbar ที่กำลังใช้งาน ไม่ใช่ทั้งหมด
    closeColorPicker();
}

// ลบเฉพาะไฮไลท์ (background-color) - เก็บ bold/italic/color/size
function removeHighlightOnly(){
    const sel=window.getSelection();
    if(sel.rangeCount>0&&!sel.isCollapsed){
        // ใช้ transparent เพื่อลบ background
        document.execCommand('hiliteColor',false,'transparent');
        document.execCommand('backColor',false,'transparent');
    }
    closeAllSpecialMenus();
}

// ลบเฉพาะสีตัวอักษร - เก็บ background/bold/italic/size
function removeTextColorOnly(){
    const sel=window.getSelection();
    if(sel.rangeCount>0&&!sel.isCollapsed){
        // ใช้ foreColor เป็นสีดำเพื่อ reset
        document.execCommand('foreColor',false,'#333333');
    }
    closeAllSpecialMenus();
}

// ลบเฉพาะขนาด - reset เป็นขนาดปกติของกล่องข้อความ
function normalizeSize(){
    const sel=window.getSelection();
    if(!sel.rangeCount||sel.isCollapsed)return;
    
    const range=sel.getRangeAt(0);
    const container=range.commonAncestorContainer;
    const parentEl=container.nodeType===3?container.parentElement:container;
    const editableRoot=parentEl.closest('[contenteditable="true"]');
    if(!editableRoot)return;
    
    // บันทึก HTML เดิม
    let html=editableRoot.innerHTML;
    
    // ลบ font-size จาก inline style (รองรับหลายรูปแบบ)
    // รูปแบบ: font-size: 12px; หรือ font-size:large; หรือ font-size: 1.5em
    html=html.replace(/font-size\s*:\s*[^;\"'<>]+;?/gi,'');
    
    // ลบ style attribute ที่ว่างเปล่าหลังจากลบ font-size
    html=html.replace(/\s*style\s*=\s*["']\s*["']/gi,'');
    html=html.replace(/\s*style\s*=\s*["']\s*;?\s*["']/gi,'');
    
    // ลบ size attribute จาก font tag
    html=html.replace(/(<font[^>]*)\s+size\s*=\s*["'][^"']*["']/gi,'$1');
    html=html.replace(/(<font[^>]*)\s+size\s*=\s*[^\s>]+/gi,'$1');
    
    // Unwrap <small>, <big>, <sub>, <sup> tags (รองรับ nested content)
    let changed=true;
    while(changed){
        const before=html;
        html=html.replace(/<small>([\s\S]*?)<\/small>/gi,'$1');
        html=html.replace(/<big>([\s\S]*?)<\/big>/gi,'$1');
        html=html.replace(/<sub>([\s\S]*?)<\/sub>/gi,'$1');
        html=html.replace(/<sup>([\s\S]*?)<\/sup>/gi,'$1');
        changed=(html!==before);
    }
    
    // Unwrap font tag ที่ไม่มี color หรือ face (เฉพาะที่มีแค่ size หรือว่างเปล่า)
    changed=true;
    while(changed){
        const before=html;
        // font tag ที่ไม่มี attribute เลย
        html=html.replace(/<font\s*>([\s\S]*?)<\/font>/gi,'$1');
        // font tag ที่มีแค่ whitespace
        html=html.replace(/<font\s+>([\s\S]*?)<\/font>/gi,'$1');
        changed=(html!==before);
    }
    
    // Unwrap span ที่ไม่มี style หรือ class
    changed=true;
    while(changed){
        const before=html;
        html=html.replace(/<span\s*>([\s\S]*?)<\/span>/gi,'$1');
        changed=(html!==before);
    }
    
    // ใส่ HTML กลับถ้ามีการเปลี่ยนแปลง
    if(html!==editableRoot.innerHTML){
        editableRoot.innerHTML=html;
    }
    
    closeAllSpecialMenus();
    closeAyahMiniMenus();
}

// ลบทั้งหมด (ไฮไลท์ + สี + ขนาด + bold + italic)
function removeAllFormat(){
    const sel=window.getSelection();
    if(sel.rangeCount>0&&!sel.isCollapsed){
        document.execCommand('removeFormat');
        document.execCommand('hiliteColor',false,'transparent');
        document.execCommand('backColor',false,'transparent');
    }
    closeAllSpecialMenus();
}

// ปิด special menus ทั้งหมด
function closeAllSpecialMenus(){
    document.querySelectorAll('.tb-special-wrap.open').forEach(w=>w.classList.remove('open'));
    document.querySelectorAll('.tb-colors-wrap.open').forEach(w=>w.classList.remove('open'));
    document.querySelectorAll('.ayah-mini-wrap.open').forEach(w=>w.classList.remove('open'));
}

// Toggle colors popup (สำหรับมือถือ)
function toggleColorsPopup(btn){
    const wrap=btn.closest('.tb-colors-wrap');
    const wasOpen=wrap.classList.contains('open');
    closeAllSpecialMenus();
    if(!wasOpen)wrap.classList.add('open');
}

// Toggle ayah mini menu (เครื่องมือในกล่องอายะฮ์)
function toggleAyahMiniMenu(btn){
    const wrap=btn.closest('.ayah-mini-wrap');
    const wasOpen=wrap.classList.contains('open');
    closeAyahMiniMenus();
    if(!wasOpen)wrap.classList.add('open');
}

function closeAyahMiniMenus(){
    document.querySelectorAll('.ayah-mini-wrap.open').forEach(w=>w.classList.remove('open'));
}

// บันทึกตัวบทพร้อมไฮไลท์
function saveAyahArWithHighlight(surahKey,ayahNum){
    const el=document.getElementById('ayah-ar-input');
    const htmlContent=el.innerHTML;
    const plainText=el.textContent.trim();
    
    // บันทึก plain text
    const userTexts=get('userAyahTexts',{});
    if(!userTexts[surahKey])userTexts[surahKey]={};
    if(plainText){
        userTexts[surahKey][ayahNum]=plainText;
    }else{
        delete userTexts[surahKey][ayahNum];
    }
    set('userAyahTexts',userTexts);
    
    // บันทึกไฮไลท์ (HTML)
    const ayahHighlights=get('ayahHighlights',{});
    const arKey=surahKey+'-'+ayahNum;
    if(htmlContent!==plainText){
        ayahHighlights[arKey]=htmlContent;
    }else{
        delete ayahHighlights[arKey];
    }
    set('ayahHighlights',ayahHighlights);
    
    closeModal('ayah-ar');
    
    // Refresh the current detail page
    const isPlus=surahKey.startsWith('p');
    const sn=isPlus?surahKey:parseInt(surahKey);
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===sn):SURAHS.find(x=>x.n===sn);
    const d=getSurah(sn);
    document.getElementById('ayah-list').innerHTML=renderAyahList(s,d,currentNoteTab);
}

function switchNoteTab(key,btn,surahNum){
    currentNoteTab=key;
    document.querySelectorAll('.note-tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    const d=getSurah(surahNum);
    document.getElementById('ayah-list').innerHTML=renderAyahList(s,d,key);
}

function saveAyahNote(n,key,ayah){
    const d=getSurah(n);
    if(!d[key])d[key]={};
    d[key][ayah]=document.getElementById(`ayah-${key}-${ayah}`).innerHTML;
    setSurah(n,d);
}

function formatText(cmd,val=null){
    const sel=window.getSelection();
    if(sel.rangeCount>0){
        document.execCommand(cmd,false,val);
    }
}

function switchMainTab(tab,btn){
    document.querySelectorAll('#page-detail .tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('#page-detail .tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('main-tab-'+tab).classList.add('active');
}

function renderHabits(n,d){
    if(!d.habits||!d.habits.length)return'<div class="empty-state">ยังไม่มี</div>';
    return d.habits.map((h,i)=>`<div class="habit-card"><div class="habit-check ${h.done?'done':''}" onclick="toggleHabit(${n},${i})"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="habit-info"><div class="habit-text">${h.text}</div>${h.ayah?`<div class="habit-meta">อายะฮ์ ${h.ayah}</div>`:''}${h.category?`<div class="habit-category">${h.category}</div>`:''}</div><div class="habit-del" onclick="deleteHabit(${n},${i})">×</div></div>`).join('');
}

function renderNames(s,d){
    if(!d.names||!d.names.length)return'<div class="empty-state">ยังไม่มี</div>';
    const isPlus=typeof s.n==='string'&&s.n.startsWith('p');
    const snArg=isPlus?`'${s.n}'`:s.n;
    return d.names.map((nm,i)=>`<div class="name-card"><button class="name-edit-btn" onclick="editName(${snArg},${i})"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="name-del" onclick="deleteName(${snArg},${i})"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button><div class="name-ar">${nm.name}</div>${nm.meaning?`<div class="name-meaning-main">${nm.meaning}</div>`:''}<div class="name-src">${s.name} : อายะฮ์ ${nm.ayah||'-'}</div>${(nm.lesson||nm.dua)?`<div style="display:grid;grid-template-columns:${nm.lesson&&nm.dua?'1fr 1fr':'1fr'};gap:8px;margin-top:8px">${nm.lesson?`<div class="name-content-box"><div class="name-content-label"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>ความรู้</div><div class="name-content-text">${nm.lesson}</div></div>`:''}${nm.dua?`<div class="name-content-box"><div class="name-content-label"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>ดุอาอ์/นิสัย</div><div class="name-content-text">${nm.dua}</div></div>`:''}</div>`:''}</div>`).join('');
}

function saveProgress(n){
    const isPlus=typeof n==='string'&&n.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===n):SURAHS.find(x=>x.n===n);
    const d=getSurah(n);
    const oldText=d.text||0,oldMeaning=d.meaning||0,oldTafsir=d.tafsir||0;
    d.text=Math.min(Math.max(0,parseInt(document.getElementById('input-text').value)||0),s.ayah);
    d.meaning=Math.min(Math.max(0,parseInt(document.getElementById('input-meaning').value)||0),s.ayah);
    d.tafsir=Math.min(Math.max(0,parseInt(document.getElementById('input-tafsir').value)||0),s.ayah);
    setSurah(n,d);
    if(d.text>oldText)logActivity('text',n,d.text-oldText,oldText+1,d.text);
    if(d.meaning>oldMeaning)logActivity('meaning',n,d.meaning-oldMeaning,oldMeaning+1,d.meaning);
    if(d.tafsir>oldTafsir)logActivity('tafsir',n,d.tafsir-oldTafsir,oldTafsir+1,d.tafsir);
    renderDetailRings(s,d);calculateCompletion();toast('บันทึกแล้ว');
    if(isPlus)renderPlus();
}

function saveOverview(n){const d=getSurah(n);d.overview=document.getElementById('overview-edit').innerHTML;setSurah(n,d);}
function saveReasons(n){const d=getSurah(n);d.reasons=document.getElementById('reasons-edit').innerHTML;setSurah(n,d);}
function saveStories(n){const d=getSurah(n);d.stories=document.getElementById('stories-edit').innerHTML;setSurah(n,d);}

function addHabit(n){const text=document.getElementById('habit-input').value.trim(),ayah=document.getElementById('habit-ayah').value,category=document.getElementById('habit-category')?document.getElementById('habit-category').value:'ทั่วไป';if(!text)return toast('กรุณาใส่ข้อมูล');const d=getSurah(n);if(!d.habits)d.habits=[];d.habits.push({text,ayah:ayah||null,category,done:false});setSurah(n,d);document.getElementById('habit-input').value='';document.getElementById('habit-ayah').value='';document.getElementById('habits-list').innerHTML=renderHabits(n,d);toast('เพิ่มแล้ว');}
function toggleHabit(n,i){const d=getSurah(n);if(d.habits&&d.habits[i])d.habits[i].done=!d.habits[i].done;setSurah(n,d);document.getElementById('habits-list').innerHTML=renderHabits(n,d);}
function deleteHabit(n,i){if(!confirm('ลบ ?'))return;const d=getSurah(n);if(d.habits)d.habits.splice(i,1);setSurah(n,d);document.getElementById('habits-list').innerHTML=renderHabits(n,d);}

function addName(n){const name=document.getElementById('name-input').value.trim(),ayah=document.getElementById('name-ayah').value,meaning=document.getElementById('name-meaning-short').value.trim(),lesson=document.getElementById('name-lesson').innerHTML.trim(),dua=document.getElementById('name-dua').innerHTML.trim();if(!name)return toast('กรุณาใส่พระนาม');const d=getSurah(n);if(!d.names)d.names=[];d.names.push({name,ayah:ayah||null,meaning,lesson,dua});setSurah(n,d);document.getElementById('name-input').value='';document.getElementById('name-ayah').value='';document.getElementById('name-meaning-short').value='';document.getElementById('name-lesson').innerHTML='';document.getElementById('name-dua').innerHTML='';const isPlus=typeof n==='string'&&n.startsWith('p');const s=isPlus?PLUS_SURAHS.find(x=>x.n===n):SURAHS.find(x=>x.n===n);document.getElementById('names-list').innerHTML=renderNames(s,d);toggleNameForm();toast('เพิ่มแล้ว');}

function applyNameFormat(cmd){
    const sel=window.getSelection();
    if(sel.rangeCount>0){
        document.execCommand(cmd,false,null);
    }
}

function applyNameHighlight(color){
    const sel=window.getSelection();
    if(sel.rangeCount>0&&!sel.isCollapsed){
        document.execCommand('hiliteColor',false,color);
    }
}

function toggleNameForm(){const form=document.getElementById('name-add-form');if(form)form.classList.toggle('show');}

let currentEditingName=null;
function editName(surahNum,nameIdx){
    const d=getSurah(surahNum);
    if(!d.names||!d.names[nameIdx])return;
    const nm=d.names[nameIdx];
    currentEditingName={surahNum,nameIdx};
    document.getElementById('modal-name-title').textContent='แก้ไขพระนาม';
    document.getElementById('modal-name-body').innerHTML=`
        <div style="text-align:center;margin-bottom:10px">
            <div style="font-family:'Amiri',serif;font-size:1.5rem;color:var(--pink)">${nm.name}</div>
        </div>
        <div style="margin-bottom:8px">
            <label style="font-size:0.55rem;color:var(--txt3);display:block;margin-bottom:3px">ความหมาย</label>
            <div contenteditable="true" class="note-edit" id="edit-name-meaning" oninput="autoSaveNameEdit()" style="min-height:32px;background:#fff;border:1px solid var(--bdr);border-radius:var(--r-sm);padding:8px;font-size:0.7rem">${nm.meaning||''}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
                <label style="font-size:0.55rem;color:var(--txt3);display:block;margin-bottom:3px">ความรู้ที่ได้</label>
                <div contenteditable="true" class="note-edit" id="edit-name-lesson" oninput="autoSaveNameEdit()" style="min-height:60px;background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:8px;font-size:0.65rem">${nm.lesson||''}</div>
            </div>
            <div>
                <label style="font-size:0.55rem;color:var(--txt3);display:block;margin-bottom:3px">ดุอาอ์/นิสัยจากพระนาม</label>
                <div contenteditable="true" class="note-edit" id="edit-name-dua" oninput="autoSaveNameEdit()" style="min-height:60px;background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:8px;font-size:0.65rem">${nm.dua||''}</div>
            </div>
        </div>
        <div style="display:flex;gap:4px;align-items:center;justify-content:center;flex-wrap:wrap">
            <button class="tb-btn" onmousedown="event.preventDefault()" onclick="document.execCommand('bold')"><b>B</b></button>
            <button class="tb-btn" onmousedown="event.preventDefault()" onclick="document.execCommand('italic')"><i>I</i></button>
            <div class="tb-special-wrap"><button class="tb-special-btn" onmousedown="event.preventDefault()" onclick="toggleSpecialMenu(this)" title="เครื่องมือพิเศษ"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8l10-10c.8-.8 2-.8 2.8 0l7 7"/><path d="M18 13l-6-6"/></svg></button><div class="tb-special-menu"><button class="tb-special-item item-hl" onmousedown="event.preventDefault()" onclick="removeHighlightOnly()" title="ลบไฮไลท์">HL</button><button class="tb-special-item item-tc" onmousedown="event.preventDefault()" onclick="removeTextColorOnly()" title="ลบสี">TC</button><button class="tb-special-item item-sz" onmousedown="event.preventDefault()" onclick="normalizeSize()" title="ขนาด">Sz</button><button class="tb-special-item item-all" onmousedown="event.preventDefault()" onclick="removeAllFormat()" title="ล้าง">All</button></div></div>
            <div class="tb-color c1" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#FADEE3')"></div>
            <div class="tb-color c2" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#D4EDEC')"></div>
            <div class="tb-color c3" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#FFF3CD')"></div>
            <div class="tb-color c4" onmousedown="event.preventDefault()" onclick="document.execCommand('hiliteColor',false,'#E8D5E8')"></div>
            <div class="tb-color c5" onmousedown="event.preventDefault()" onclick="applyLastColor()"></div>
            <div class="tb-color-add" onmousedown="event.preventDefault()" onclick="openColorPicker()">+</div>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:0.5rem;color:var(--txt3)">บันทึกอัตโนมัติ ✓</div>
    `;
    openModal('name');
}

let autoSaveNameTimer=null;
function autoSaveNameEdit(){
    if(autoSaveNameTimer)clearTimeout(autoSaveNameTimer);
    autoSaveNameTimer=setTimeout(()=>{
        if(!currentEditingName)return;
        const {surahNum,nameIdx}=currentEditingName;
        const d=getSurah(surahNum);
        if(!d.names||!d.names[nameIdx])return;
        d.names[nameIdx].meaning=document.getElementById('edit-name-meaning').innerHTML;
        d.names[nameIdx].lesson=document.getElementById('edit-name-lesson').innerHTML;
        d.names[nameIdx].dua=document.getElementById('edit-name-dua').innerHTML;
        setSurah(surahNum,d);
        // Real-time update
        const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
        const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
        if(document.getElementById('names-list'))document.getElementById('names-list').innerHTML=renderNames(s,d);
        renderKnowledge();
    },500);
}

function saveNameEdit(){
    if(!currentEditingName)return;
    const {surahNum,nameIdx}=currentEditingName;
    const d=getSurah(surahNum);
    if(!d.names||!d.names[nameIdx])return;
    d.names[nameIdx].meaning=document.getElementById('edit-name-meaning').innerHTML;
    d.names[nameIdx].lesson=document.getElementById('edit-name-lesson').innerHTML;
    d.names[nameIdx].dua=document.getElementById('edit-name-dua').innerHTML;
    setSurah(surahNum,d);
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    if(document.getElementById('names-list'))document.getElementById('names-list').innerHTML=renderNames(s,d);
    closeModal('name');
    currentEditingName=null;
    toast('บันทึกแล้ว');
    renderKnowledge();
}

function deleteName(n,i){if(!confirm('ลบ ?'))return;const d=getSurah(n);if(d.names)d.names.splice(i,1);setSurah(n,d);const isPlus=typeof n==='string'&&n.startsWith('p');const s=isPlus?PLUS_SURAHS.find(x=>x.n===n):SURAHS.find(x=>x.n===n);document.getElementById('names-list').innerHTML=renderNames(s,d);renderKnowledge();}

function logActivity(type,surahNum,count,from,to){
    const today=getLocalDate(),log=getLog();
    if(!log[today])log[today]={text:0,meaning:0,tafsir:0};
    log[today][type]+=count;set('log',log);
    const history=getHistory();
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    const uniqueId=Date.now()+'-'+type+'-'+surahNum;
    history.push({id:uniqueId,date:today,type,surahNum,name:s?s.name:'',isPlus,from,to,count,reviews:[1,3,7,14,30].map(d=>{const dt=new Date();dt.setDate(dt.getDate()+d);return dt.toLocaleDateString('en-CA')})});
    set('history',history);
}

let randomFontSize=0.75;
let surahFontSize=0.75;
function initFontSizes(){
    randomFontSize=get('randomFontSize',0.75);
    surahFontSize=get('surahFontSize',0.75);
}
function changeFontSize(delta){
    randomFontSize=Math.max(0.6,Math.min(1.2,randomFontSize+delta*0.1));
    set('randomFontSize',randomFontSize);
    document.querySelectorAll('.random-text').forEach(el=>{
        el.style.fontSize=randomFontSize+'rem';
    });
}
function applyRandomFontSize(){
    randomFontSize=get('randomFontSize',0.75);
    document.querySelectorAll('.random-text').forEach(el=>{
        el.style.fontSize=randomFontSize+'rem';
    });
}
function changeSurahFontSize(delta){
    surahFontSize=Math.max(0.6,Math.min(1.2,surahFontSize+delta*0.1));
    set('surahFontSize',surahFontSize);
    document.querySelectorAll('.surah-know-text').forEach(el=>{
        el.style.fontSize=surahFontSize+'rem';
    });
}
function applySurahFontSize(){
    surahFontSize=get('surahFontSize',0.75);
    document.querySelectorAll('.surah-know-text').forEach(el=>{
        el.style.fontSize=surahFontSize+'rem';
    });
}

// ===== Plus Page Functions =====
function renderPlus(){
    // คำนวณสถิติทั้ง 3 ประเภท
    let totalText=0,totalMeaning=0,totalTafsir=0;
    PLUS_SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        totalText+=Math.min(d.text||0,s.ayah);
        totalMeaning+=Math.min(d.meaning||0,s.ayah);
        totalTafsir+=Math.min(d.tafsir||0,s.ayah);
    });
    const textP=Math.round(totalText/PLUS_TOTAL_AYAH*100);
    const meaningP=Math.round(totalMeaning/PLUS_TOTAL_AYAH*100);
    const tafsirP=Math.round(totalTafsir/PLUS_TOTAL_AYAH*100);
    
    // อัพเดท header
    document.getElementById('plus-main-percent').textContent=textP+'%';
    document.getElementById('plus-total-ayah').textContent=totalText+' / '+PLUS_TOTAL_AYAH+' อายะฮ์';
    
    // อัพเดท 3 วงกลม (circumference = 2 * π * 16 = 100.5)
    const ringCircum=100.5;
    const textRing=document.getElementById('plus-ring-text');
    const meaningRing=document.getElementById('plus-ring-meaning');
    const tafsirRing=document.getElementById('plus-ring-tafsir');
    if(textRing)textRing.style.strokeDashoffset=ringCircum-(ringCircum*textP/100);
    if(meaningRing)meaningRing.style.strokeDashoffset=ringCircum-(ringCircum*meaningP/100);
    if(tafsirRing)tafsirRing.style.strokeDashoffset=ringCircum-(ringCircum*tafsirP/100);
    
    const textNum=document.getElementById('plus-text-num');
    const meaningNum=document.getElementById('plus-meaning-num');
    const tafsirNum=document.getElementById('plus-tafsir-num');
    if(textNum)textNum.textContent=textP+'%';
    if(meaningNum)meaningNum.textContent=meaningP+'%';
    if(tafsirNum)tafsirNum.textContent=tafsirP+'%';
    
    // Render แต่ละ category
    ['daily','weekly','manhaj'].forEach(cat=>{
        const grid=document.getElementById('plus-grid-'+cat);
        if(!grid)return;
        
        const items=PLUS_SURAHS.filter(s=>s.category===cat);
        grid.innerHTML=items.map(s=>{
            const d=getSurah(s.n);
            const status=calcStatus(d,s.ayah);
            const tP=Math.min(100,Math.round((d.text||0)/s.ayah*100));
            const mP=Math.min(100,Math.round((d.meaning||0)/s.ayah*100));
            const tfP=Math.min(100,Math.round((d.tafsir||0)/s.ayah*100));
            const doneHtml=status===4?'<div class="surah-done"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>':'';
            // แสดงชื่อเต็ม ไม่ใช้ ... - ใช้ CSS ลดขนาดตัวอักษรสำหรับชื่อยาว
            let displayName=s.name;
            let nameStyle='';
            if(s.name.length>14){
                nameStyle='font-size:0.58rem;line-height:1.2';
            }
            
            return `<div class="surah-card s${status}" onclick="openDetail('${s.n}')"><div class="surah-top"><div class="surah-num">${s.ref.replace(/:/g,' : ')}</div><div class="surah-ar">${s.ar}</div></div><div class="surah-name" style="${nameStyle}">${displayName}</div><div class="surah-meta">${s.ayah} อายะฮ์</div><div class="surah-bars"><div class="surah-bar b1"><div class="surah-bar-fill" style="width:${tP}%"></div></div><div class="surah-bar b2"><div class="surah-bar-fill" style="width:${mP}%"></div></div><div class="surah-bar b3"><div class="surah-bar-fill" style="width:${tfP}%"></div></div></div>${doneHtml}</div>`;
        }).join('');
    });
}

function renderKnowledge(){
    let totalNotes=0,totalHabits=0,totalNames=0;const allNotes=[],allHabits=[],allNames={};
    const surahFilterEl=document.getElementById('random-surah-filter');
    const surahFilter=surahFilterEl?surahFilterEl.value:'all';
    const customCategories=['ทั้งหมด',...get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้'])];
    
    // ดึง userAyahTexts
    const userTexts=get('userAyahTexts',{});
    const ayahHighlights=get('ayahHighlights',{});
    
    function getArText(surahNum,ayahNum){
        const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
        const surahKey=isPlus?surahNum:String(surahNum);
        const arKey=surahKey+'-'+ayahNum;
        
        // 1. ถ้ามี highlight ใช้ highlight (ที่มีไฮไลท์สี)
        if(ayahHighlights[arKey])return ayahHighlights[arKey];
        // 2. ถ้าผู้ใช้บันทึก userTexts
        if(userTexts[surahKey]&&userTexts[surahKey][ayahNum])return userTexts[surahKey][ayahNum];
        // 3. ถ้าเป็น Plus
        if(isPlus){
            const s=PLUS_SURAHS.find(x=>x.n===surahNum);
            if(s&&s.verses){
                const v=s.verses.find(x=>String(x.num)===String(ayahNum));
                if(v)return v.ar;
            }
        }else{
            if(QURAN_VERSES[surahNum]&&QURAN_VERSES[surahNum][parseInt(ayahNum)]){
                return QURAN_VERSES[surahNum][parseInt(ayahNum)];
            }
        }
        return '';
    }
    
    // รวมข้อมูลจาก SURAHS
    SURAHS.forEach(s=>{const d=getSurah(s.n);['notes','meanings','tafsirs'].forEach(key=>{if(d[key]){Object.keys(d[key]).forEach(ayah=>{if(d[key][ayah]){totalNotes++;allNotes.push({type:key,text:d[key][ayah],surah:s.name,surahNum:s.n,ayah,arText:getArText(s.n,ayah)});}});}});if(d.overview){totalNotes++;allNotes.push({type:'overview',text:d.overview,surah:s.name,surahNum:s.n,ayah:'-'});}if(d.reasons){totalNotes++;allNotes.push({type:'reasons',text:d.reasons,surah:s.name,surahNum:s.n,ayah:'-'});}if(d.stories){totalNotes++;allNotes.push({type:'stories',text:d.stories,surah:s.name,surahNum:s.n,ayah:'-'});}if(d.habits){d.habits.forEach(h=>{totalHabits++;allHabits.push({...h,surahName:s.name,surahNum:s.n});});}if(d.names){d.names.forEach((nm,idx)=>{totalNames++;if(!allNames[nm.name])allNames[nm.name]={name:nm.name,sources:[]};allNames[nm.name].sources.push({meaning:nm.meaning,lesson:nm.lesson,dua:nm.dua,surah:s.name,ayah:nm.ayah,surahNum:s.n,nameIdx:idx,isPlus:false});});}});
    
    // รวมข้อมูลจาก PLUS_SURAHS ด้วย
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);['notes','meanings','tafsirs'].forEach(key=>{if(d[key]){Object.keys(d[key]).forEach(ayah=>{if(d[key][ayah]){totalNotes++;allNotes.push({type:key,text:d[key][ayah],surah:s.name+' (Plus)',surahNum:s.n,ayah,isPlus:true,arText:getArText(s.n,ayah)});}});}});if(d.overview){totalNotes++;allNotes.push({type:'overview',text:d.overview,surah:s.name+' (Plus)',surahNum:s.n,ayah:'-',isPlus:true});}if(d.reasons){totalNotes++;allNotes.push({type:'reasons',text:d.reasons,surah:s.name+' (Plus)',surahNum:s.n,ayah:'-',isPlus:true});}if(d.stories){totalNotes++;allNotes.push({type:'stories',text:d.stories,surah:s.name+' (Plus)',surahNum:s.n,ayah:'-',isPlus:true});}if(d.habits){d.habits.forEach(h=>{totalHabits++;allHabits.push({...h,surahName:s.name+' (Plus)',surahNum:s.n,isPlus:true});});}if(d.names){d.names.forEach((nm,idx)=>{totalNames++;if(!allNames[nm.name])allNames[nm.name]={name:nm.name,sources:[]};allNames[nm.name].sources.push({meaning:nm.meaning,lesson:nm.lesson,dua:nm.dua,surah:s.name+' (Plus)',ayah:nm.ayah,surahNum:s.n,nameIdx:idx,isPlus:true});});}});
    
    const namesArr=Object.values(allNames);
    // รวบรวมทุกความหมายสำหรับแต่ละพระนาม
    namesArr.forEach(n=>{
        const allMeanings=[];
        n.sources.forEach(s=>{
            if(s.meaning&&!allMeanings.includes(s.meaning)){
                allMeanings.push(s.meaning);
            }
        });
        n.allMeanings=allMeanings;
    });
    const notesEl=document.getElementById('know-notes');if(notesEl)notesEl.textContent=totalNotes;
    const habitsEl=document.getElementById('know-habits');if(habitsEl)habitsEl.textContent=totalHabits;
    const namesEl=document.getElementById('know-names');if(namesEl)namesEl.textContent=namesArr.length;
    
    const namesSec=document.getElementById('know-names-section');
    if(namesSec)namesSec.innerHTML=namesArr.length?`<div class="names-section"><div class="names-section-title"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>พระนามอัลลอฮ์ (${namesArr.length})</div><div class="names-grid">${namesArr.map(n=>`<div class="name-chip" onclick="showNameModal('${n.name.replace(/'/g,"\\'")}')"><div class="name-chip-ar">${n.name}</div><div class="name-chip-meaning">${n.allMeanings.length>0?n.allMeanings.join(' / '):''}</div>${n.sources.length>1?`<div style="font-size:7px;color:var(--txt3);margin-top:2px">${n.sources.length} ซูเราะฮ์</div>`:''}</div>`).join('')}</div></div>`:'';
    
    const habitsSec=document.getElementById('know-habits-section');
    if(habitsSec)habitsSec.innerHTML=allHabits.length?`<div class="habits-section"><div class="habits-section-title"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>นิสัยจากอัลกุรอาน (${allHabits.length})</div><div class="habits-filter-row" id="habits-filter-row">${customCategories.map((c,i)=>`<button class="habits-filter-btn ${i===0?'active':''}" onclick="filterHabitsKnow('${c==='ทั้งหมด'?'all':c}',this)">${c}</button>`).join('')}<button class="habits-filter-btn" onclick="openCategoryManager()" style="background:var(--pri-ll);border-color:var(--pri)">+</button></div><div class="habits-grid" id="habits-know-grid">${allHabits.map((h,idx)=>{const snArg=h.isPlus?`'${h.surahNum}'`:h.surahNum;return `<div class="habit-card" data-category="${h.category||'ทั่วไป'}" onclick="editHabitKnow(${snArg},'${h.text.replace(/'/g,"\\'")}')"><div class="habit-check ${h.done?'done':''}" onclick="event.stopPropagation();toggleHabitKnow(${snArg},'${h.text.replace(/'/g,"\\'")}',this)"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="habit-info"><div class="habit-text">${h.text}</div><div class="habit-meta">${h.surahName}${h.ayah?' • อายะฮ์ '+h.ayah:''}</div>${h.category?`<div class="habit-category">${h.category}</div>`:''}</div></div>`;}).join('')}</div></div>`:'';
    
    const filterRow=document.getElementById('filter-row');
    if(filterRow)filterRow.innerHTML=['all','overview','reasons','stories','notes','meanings','tafsirs'].map(f=>`<button class="filter-btn ${currentFilters.has(f)?'active':''}" onclick="toggleFilter('${f}')">${f==='all'?'ทั้งหมด':f==='overview'?'ภาพรวม':f==='reasons'?'สาเหตุ':f==='stories'?'นบี/กลุ่มชน':f==='notes'?'ความรู้':f==='meanings'?'ความหมาย':'ตัฟซีร'}</button>`).join('');
    
    let notesForRandom=allNotes.filter(n=>surahFilter==='all'||String(n.surahNum)===String(surahFilter));
    if(!currentFilters.has('all'))notesForRandom=notesForRandom.filter(n=>currentFilters.has(n.type));
    const shuffled=[...notesForRandom].sort(()=>Math.random()-.5).slice(0,5);
    const typeLabels={notes:'ความรู้',meanings:'ความหมาย',tafsirs:'ตัฟซีร',overview:'ภาพรวม',reasons:'สาเหตุ',stories:'นบี/กลุ่มชน'};
    const randomArOpen=get('randomArOpen',{});
    const randomList=document.getElementById('random-list');
    if(randomList)randomList.innerHTML=shuffled.length?shuffled.map((n,idx)=>{
        const hasAr=n.arText&&n.arText.length>0;
        const arKey='random-'+idx;
        const isOpen=randomArOpen[arKey]||false;
        return `<div class="random-card">
            <div class="random-head">
                <span class="random-type t-${n.type}">${typeLabels[n.type]}</span>
                <span class="random-source">${n.surah} : ${n.ayah}</span>
            </div>
            ${hasAr?`<div class="random-ar-wrap">
                <div class="random-ar-toggle ${isOpen?'open':''}" onclick="toggleRandomAr('${arKey}',this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    <span>ตัวบท</span>
                </div>
                <div class="random-ar-text" id="${arKey}" style="display:${isOpen?'block':'none'}">${n.arText}</div>
            </div>`:''}
            <div class="random-text">${n.text}</div>
        </div>`;
    }).join(''):'<div class="empty-state">ยังไม่มีบันทึก</div>';
    applyRandomFontSize();
    
    const surahSelect=document.getElementById('surah-know-select');
    if(surahSelect&&surahSelect.value)renderSurahKnowledge();
}

function toggleRandomAr(arKey,el){
    const randomArOpen=get('randomArOpen',{});
    randomArOpen[arKey]=!randomArOpen[arKey];
    set('randomArOpen',randomArOpen);
    const arEl=document.getElementById(arKey);
    if(arEl){
        arEl.style.display=randomArOpen[arKey]?'block':'none';
        el.classList.toggle('open');
    }
}

function shuffleRandom(){renderKnowledge();}

function toggleFilter(f){
    if(f==='all'){
        currentFilters=new Set(['all']);
    }else{
        currentFilters.delete('all');
        if(currentFilters.has(f)){
            currentFilters.delete(f);
            if(currentFilters.size===0)currentFilters.add('all');
        }else{
            currentFilters.add(f);
        }
    }
    renderKnowledge();
}
function toggleHabitKnow(surahNum,text,el){
    const d=getSurah(surahNum);
    if(d.habits){
        const idx=d.habits.findIndex(h=>h.text===text);
        if(idx>=0){
            d.habits[idx].done=!d.habits[idx].done;
            setSurah(surahNum,d);
            const checkEl=el.closest('.habit-card').querySelector('.habit-check');
            if(d.habits[idx].done){
                checkEl.classList.add('done');
            }else{
                checkEl.classList.remove('done');
            }
        }
    }
}

function editHabitKnow(surahNum,text){
    const d=getSurah(surahNum);
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    if(!d.habits)return;
    const idx=d.habits.findIndex(h=>h.text===text);
    if(idx<0)return;
    const habit=d.habits[idx];
    const categories=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    const snArg=isPlus?`'${surahNum}'`:surahNum;
    
    document.getElementById('modal-habit-edit-content').innerHTML=`
        <div style="text-align:center;padding:12px 0 10px;border-bottom:1px solid var(--bdr-l);margin:0 -12px 12px -12px;background:linear-gradient(135deg,var(--sec-ll),var(--card));border-radius:16px 16px 0 0">
            <div style="width:36px;height:36px;background:var(--sec);border-radius:50%;margin:0 auto 8px;display:flex;align-items:center;justify-content:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
            <div style="font-size:0.85rem;font-weight:600;color:var(--sec)">แก้ไขนิสัย</div>
            <div style="font-size:0.6rem;color:var(--txt3)">${s?s.name:''}</div>
        </div>
        <div style="margin-bottom:10px">
            <label style="font-size:0.6rem;color:var(--txt3);display:block;margin-bottom:3px">ข้อความ</label>
            <textarea id="edit-habit-text" style="width:100%;padding:8px 10px;border:1px solid var(--bdr);border-radius:6px;font-size:0.7rem;min-height:50px;resize:none;font-family:'Noto Sans Thai',sans-serif">${habit.text}</textarea>
        </div>
        <div style="margin-bottom:10px">
            <label style="font-size:0.6rem;color:var(--txt3);display:block;margin-bottom:3px">หมวดหมู่</label>
            <select id="edit-habit-category" style="width:100%;padding:8px 10px;border:1px solid var(--bdr);border-radius:6px;font-size:0.7rem;font-family:'Noto Sans Thai',sans-serif">
                ${categories.map(c=>`<option value="${c}" ${habit.category===c?'selected':''}>${c}</option>`).join('')}
            </select>
        </div>
        <div style="display:flex;gap:6px;margin-top:12px">
            <button onclick="confirmDeleteHabit(${snArg},'${text.replace(/'/g,"\\'")}')" style="flex:1;padding:8px;border:none;border-radius:6px;background:rgba(180,80,80,0.08);color:#B45050;font-size:0.65rem;cursor:pointer;font-family:'Noto Sans Thai',sans-serif">ลบ</button>
            <button onclick="saveHabitEdit(${snArg},'${text.replace(/'/g,"\\'")}');closeModal('habit-edit')" style="flex:2;padding:8px;border:none;border-radius:6px;background:var(--sec);color:#fff;font-size:0.65rem;cursor:pointer;font-family:'Noto Sans Thai',sans-serif">บันทึก</button>
        </div>
    `;
    openModal('habit-edit');
}

function confirmDeleteHabit(surahNum,text){
    if(confirm('ต้องการลบนิสัยนี้ ?')){
        deleteHabitKnow(surahNum,text);
        closeModal('habit-edit');
    }
}

function saveHabitEdit(surahNum,oldText){
    const d=getSurah(surahNum);
    if(!d.habits)return;
    const idx=d.habits.findIndex(h=>h.text===oldText);
    if(idx<0)return;
    
    const newText=document.getElementById('edit-habit-text').value.trim();
    const newCategory=document.getElementById('edit-habit-category').value;
    
    if(newText){
        d.habits[idx].text=newText;
        d.habits[idx].category=newCategory;
        setSurah(surahNum,d);
        renderKnowledge();
        toast('บันทึกแล้ว');
    }
}

function deleteHabitKnow(surahNum,text){
    const d=getSurah(surahNum);
    if(!d.habits)return;
    d.habits=d.habits.filter(h=>h.text!==text);
    setSurah(surahNum,d);
    renderKnowledge();
    toast('ลบแล้ว');
}

function filterHabitsKnow(category,btn){
    document.querySelectorAll('.habits-filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const cards=document.querySelectorAll('#habits-know-grid .habit-card');
    cards.forEach(card=>{
        if(category==='all'||card.dataset.category===category){
            card.style.display='';
        }else{
            card.style.display='none';
        }
    });
}

function openCategoryManager(){
    const categories=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    document.getElementById('modal-category-body').innerHTML=`
        <div style="margin-bottom:14px">${categories.map((c,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:10px;background:var(--card2);border-radius:var(--r-sm);margin-bottom:6px"><span style="flex:1;font-size:0.68rem">${c}</span>${i>0?`<button style="background:rgba(180,80,80,0.1);color:#B45050;border:none;padding:4px 8px;border-radius:4px;font-size:0.6rem;cursor:pointer" onclick="deleteCategory(${i})">ลบ</button>`:''}</div>`).join('')}</div>
        <div style="display:flex;gap:6px">
            <input type="text" id="new-category" placeholder="หมวดหมู่ใหม่" style="flex:1;padding:10px;border:1px solid var(--bdr);border-radius:var(--r-sm);font-size:0.68rem">
            <button onclick="addCategory()" style="padding:10px 14px;background:var(--pri);color:#fff;border:none;border-radius:var(--r-sm);font-size:0.65rem;cursor:pointer">เพิ่ม</button>
        </div>
    `;
    openModal('category');
}

function showKnowledgePopup(type){
    const allNames=[],allHabits=[],allNotes=[];
    // รวมจาก SURAHS
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        if(d.names)d.names.forEach(nm=>allNames.push({...nm,surahName:s.name,surahNum:s.n,isPlus:false}));
        if(d.habits)d.habits.forEach(h=>allHabits.push({...h,surahName:s.name,isPlus:false}));
        for(let i=1;i<=s.ayah;i++){
            if(d.notes&&d.notes[i])allNotes.push({ayah:i,text:d.notes[i],surahName:s.name,type:'notes',isPlus:false});
            if(d.meanings&&d.meanings[i])allNotes.push({ayah:i,text:d.meanings[i],surahName:s.name,type:'meanings',isPlus:false});
            if(d.tafsirs&&d.tafsirs[i])allNotes.push({ayah:i,text:d.tafsirs[i],surahName:s.name,type:'tafsirs',isPlus:false});
        }
    });
    // รวมจาก PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        if(d.names)d.names.forEach(nm=>allNames.push({...nm,surahName:s.name+' (Plus)',surahNum:s.n,isPlus:true}));
        if(d.habits)d.habits.forEach(h=>allHabits.push({...h,surahName:s.name+' (Plus)',isPlus:true}));
        const refMatch=s.ref?.match(/(\d+):(\d+)(?:-(\d+))?/);
        let startAyah=1;
        if(refMatch&&refMatch[2])startAyah=parseInt(refMatch[2]);
        for(let i=0;i<s.ayah;i++){
            const ayahNum=s.verses?s.verses[i]?.num:(startAyah+i);
            if(d.notes&&d.notes[ayahNum])allNotes.push({ayah:ayahNum,text:d.notes[ayahNum],surahName:s.name+' (Plus)',type:'notes',isPlus:true});
            if(d.meanings&&d.meanings[ayahNum])allNotes.push({ayah:ayahNum,text:d.meanings[ayahNum],surahName:s.name+' (Plus)',type:'meanings',isPlus:true});
            if(d.tafsirs&&d.tafsirs[ayahNum])allNotes.push({ayah:ayahNum,text:d.tafsirs[ayahNum],surahName:s.name+' (Plus)',type:'tafsirs',isPlus:true});
        }
    });
    
    let html='',title='';
    if(type==='names'){
        title='พระนามอัลลอฮ์';
        // รวมพระนามที่ซ้ำกัน
        const grouped={};
        allNames.forEach(n=>{
            const key=n.name.trim();
            if(!grouped[key])grouped[key]={name:n.name,meaning:n.meaning||'',surahs:[]};
            if(n.meaning&&!grouped[key].meaning)grouped[key].meaning=n.meaning;
            grouped[key].surahs.push(n.surahName);
        });
        const uniqueNames=Object.values(grouped);
        const count=uniqueNames.length;
        html=count?`
            <div style="display:grid;gap:8px;max-height:55vh;overflow-y:auto">
                ${uniqueNames.map(n=>`
                    <div style="background:linear-gradient(145deg,#fff,var(--pink-ll));border-radius:10px;padding:12px;border:1px solid rgba(212,115,140,0.1)">
                        <div style="font-family:'Amiri',serif;font-size:1.2rem;color:var(--pink);text-align:center;font-weight:600">${n.name}</div>
                        ${n.meaning?`<div style="font-size:0.65rem;color:var(--txt);text-align:center;margin-top:3px">${n.meaning}</div>`:''}
                        <div style="display:flex;flex-wrap:wrap;gap:3px;justify-content:center;margin-top:6px">
                            ${n.surahs.map(s=>`<span style="font-size:0.5rem;color:var(--txt3);background:var(--pink-ll);padding:2px 6px;border-radius:8px">${s}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>`:'<div style="text-align:center;color:var(--txt3);padding:20px;font-size:0.75rem">ยังไม่มีพระนาม</div>';
        document.getElementById('modal-knowledge-content').innerHTML=`
            <div style="text-align:center;padding:14px 12px 10px;background:linear-gradient(135deg,var(--pink-ll),var(--card));margin:0 -12px 12px -12px;border-bottom:1px solid var(--pink-l);border-radius:16px 16px 0 0">
                <div style="width:36px;height:36px;background:var(--pink);border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                </div>
                <div style="font-size:0.8rem;font-weight:600;color:var(--pink)">${title}</div>
                <div style="font-size:0.55rem;color:var(--txt3)">${count} พระนาม</div>
            </div>
            ${html}
        `;
    }else if(type==='habits'){
        title='นิสัยจากอัลกุรอาน';
        html=allHabits.length?`
            <div style="display:grid;gap:6px;max-height:55vh;overflow-y:auto">
                ${allHabits.map(h=>`
                    <div style="background:linear-gradient(135deg,#fff,var(--sec-ll));border-radius:8px;padding:10px;border:1px solid rgba(122,158,159,0.1);display:flex;gap:8px;align-items:center">
                        <div style="width:16px;height:16px;border-radius:50%;background:${h.done?'var(--done)':'#e0e0e0'};flex-shrink:0;display:flex;align-items:center;justify-content:center">
                            ${h.done?'<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}
                        </div>
                        <div style="flex:1">
                            <div style="font-size:0.7rem;font-weight:500;color:var(--txt)">${h.text}</div>
                            <div style="font-size:0.5rem;color:var(--txt3);margin-top:1px">${h.surahName}${h.category?' • '+h.category:''}</div>
                        </div>
                    </div>
                `).join('')}
            </div>`:'<div style="text-align:center;color:var(--txt3);padding:20px;font-size:0.75rem">ยังไม่มีนิสัย</div>';
        document.getElementById('modal-knowledge-content').innerHTML=`
            <div style="text-align:center;padding:14px 12px 10px;background:linear-gradient(135deg,var(--sec-ll),var(--card));margin:0 -12px 12px -12px;border-bottom:1px solid var(--sec-l);border-radius:16px 16px 0 0">
                <div style="width:36px;height:36px;background:var(--sec);border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <div style="font-size:0.8rem;font-weight:600;color:var(--sec)">${title}</div>
                <div style="font-size:0.55rem;color:var(--txt3)">${allHabits.length} นิสัย</div>
            </div>
            ${html}
        `;
    }else{
        title='บันทึกทั้งหมด';
        const typeLabel={'notes':'ความรู้','meanings':'ความหมาย','tafsirs':'ตัฟซีร'};
        const typeColors={'notes':'var(--pri)','meanings':'var(--sec)','tafsirs':'var(--tafsir)'};
        const typeBg={'notes':'var(--pri-ll)','meanings':'var(--sec-ll)','tafsirs':'var(--tafsir-ll)'};
        html=allNotes.length?`
            <div style="display:grid;gap:6px;max-height:55vh;overflow-y:auto">
                ${allNotes.slice(0,50).map(n=>`
                    <div style="background:#fff;border-radius:6px;padding:0;overflow:hidden;border:1px solid var(--bdr-l)">
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:${typeBg[n.type]};border-bottom:1px solid var(--bdr-l)">
                            <span style="font-size:0.55rem;font-weight:500;color:var(--txt2)">${n.surahName} : ${n.ayah}</span>
                            <span style="font-size:0.5rem;color:${typeColors[n.type]};background:#fff;padding:2px 6px;border-radius:6px">${typeLabel[n.type]}</span>
                        </div>
                        <div style="padding:8px 10px;font-size:0.6rem;line-height:1.5;color:var(--txt)">${n.text}</div>
                    </div>
                `).join('')}
            </div>`:'<div style="text-align:center;color:var(--txt3);padding:20px;font-size:0.75rem">ยังไม่มีบันทึก</div>';
        document.getElementById('modal-knowledge-content').innerHTML=`
            <div style="text-align:center;padding:14px 12px 10px;background:linear-gradient(135deg,var(--pri-ll),var(--card));margin:0 -12px 12px -12px;border-bottom:1px solid var(--pri-l);border-radius:16px 16px 0 0">
                <div style="width:36px;height:36px;background:var(--pri);border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                </div>
                <div style="font-size:0.8rem;font-weight:600;color:var(--pri)">${title}</div>
                <div style="font-size:0.55rem;color:var(--txt3)">${allNotes.length} รายการ</div>
            </div>
            ${html}
        `;
    }
    openModal('knowledge');
}

function showTodayDetailPopup(type){
    const today=getLocalDate(),log=getLog(),todayLog=log[today]||{text:0,meaning:0,tafsir:0};
    const history=getHistory();
    // รวม history ทั้ง Juz Amma และ Plus
    const todayHistory=history.filter(h=>h.date===today&&h.type===type);
    
    const titles={text:'ตัวบท',meaning:'ความหมาย',tafsir:'ตัฟซีร'};
    const colors={text:'var(--pri)',meaning:'var(--sec)',tafsir:'var(--tafsir)'};
    const bgColors={text:'var(--pri-ll)',meaning:'var(--sec-ll)',tafsir:'var(--tafsir-ll)'};
    const icons={
        text:'<path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>',
        meaning:'<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>',
        tafsir:'<path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/>'
    };
    
    let html=todayHistory.length?`
        <div style="display:grid;gap:6px;max-height:45vh;overflow-y:auto">
            ${todayHistory.map(h=>{
                const surahName=h.name||'ซูเราะฮ์';
                const isPlus=h.isPlus||false;
                return `
                <div style="background:linear-gradient(135deg,${bgColors[type]},#fff);border-radius:8px;padding:10px 12px;border:1px solid rgba(0,0,0,0.05)">
                    <div style="font-weight:600;font-size:0.75rem;color:var(--txt)">${surahName}${isPlus?' <span style="font-size:0.5rem;color:var(--gold)">(Plus)</span>':''}</div>
                    <div style="font-size:0.6rem;color:var(--txt3);margin-top:2px">อายะฮ์ ${h.from||1} - ${h.to||h.count} <span style="color:${colors[type]};font-weight:500">(${h.count} อายะฮ์)</span></div>
                </div>`;
            }).join('')}
        </div>`:`
        <div style="text-align:center;padding:24px">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--bdr)" stroke-width="1.5" style="margin-bottom:8px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <div style="font-size:0.75rem;color:var(--txt3)">ยังไม่มีการบันทึกวันนี้</div>
        </div>`;
    
    const borderColors={text:'var(--pri-l)',meaning:'var(--sec-l)',tafsir:'var(--tafsir-l)'};
    
    document.getElementById('modal-today-detail-content').innerHTML=`
        <div style="text-align:center;padding:14px 0 12px;background:linear-gradient(135deg,${bgColors[type]},var(--card));margin:0 -12px 12px -12px;border-bottom:1px solid ${borderColors[type]};border-radius:16px 16px 0 0">
            <div style="width:36px;height:36px;border-radius:50%;background:${colors[type]};margin:0 auto 5px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                <span style="font-size:0.85rem;font-weight:700;color:#fff">${todayLog[type]||0}</span>
            </div>
            <div style="font-size:0.75rem;font-weight:600;color:${colors[type]}">${titles[type]}</div>
            <div style="font-size:0.5rem;color:var(--txt3)">ที่ท่องวันนี้</div>
        </div>
        ${html}
    `;
    openModal('today-detail');
}

function addCategory(){
    const name=document.getElementById('new-category').value.trim();
    if(!name)return toast('กรุณาใส่ชื่อหมวดหมู่');
    const categories=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    if(categories.includes(name))return toast('หมวดหมู่นี้มีอยู่แล้ว');
    categories.push(name);
    set('habitCategories',categories);
    openCategoryManager();
    renderKnowledge();
    updateCategorySelects();
    toast('เพิ่มหมวดหมู่แล้ว');
}

function deleteCategory(idx){
    if(!confirm('ลบหมวดหมู่นี้ ?'))return;
    const categories=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    categories.splice(idx,1);
    set('habitCategories',categories);
    openCategoryManager();
    renderKnowledge();
    updateCategorySelects();
}

function updateCategorySelects(){
    const cats=get('habitCategories',['ทั่วไป','อิบาดะห์','อัคลาก','ความสัมพันธ์','การเรียนรู้']);
    const sel=document.getElementById('habit-category');
    if(sel){sel.innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join('');}
}

function updateHabitsSection(){
    const allHabits=[];
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        if(d.habits){
            d.habits.forEach(h=>{
                allHabits.push({...h,surahName:s.name,surahNum:s.n});
            });
        }
    });
    document.getElementById('know-habits-section').innerHTML=allHabits.length?`<div class="habits-section"><div class="habits-section-title"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>นิสัยจากอัลกุรอาน (${allHabits.length})</div><div class="habits-grid">${allHabits.map(h=>`<div class="habit-card"><div class="habit-check ${h.done?'done':''}" onclick="event.stopPropagation();toggleHabitKnow(${h.surahNum},'${h.text.replace(/'/g,"\\'")}',this)">${h.done?'<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>':''}</div><div class="habit-info"><div class="habit-text">${h.text}</div><div class="habit-meta">${h.surahName}</div></div></div>`).join('')}</div></div>`:'';
}

function renderSurahKnowledge(){
    const selVal=document.getElementById('surah-know-select').value;
    if(selVal==='all'){document.getElementById('surah-know-list').innerHTML='<div class="empty-state">เลือกซูเราะฮ์เพื่อดูบันทึก</div>';return;}
    const isPlus=selVal.startsWith('p');
    const surahNum=isPlus?selVal:parseInt(selVal);
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    const d=getSurah(surahNum);
    const snArg=isPlus?`'${surahNum}'`:surahNum;
    const habitStatus=get('habitStatus',{});
    const statusInfo={0:{label:'ยังไม่เริ่ม',color:'#9e9e9e'},1:{label:'วางแผน',color:'#ff9800'},2:{label:'ฝืนทน 5',color:'#f44336'},3:{label:'ฝืนทน 4',color:'#ff5722'},4:{label:'ง่ายขึ้น 3',color:'#ffc107'},5:{label:'ง่ายขึ้น 2',color:'#8bc34a'},6:{label:'เป็นนิสัย',color:'#4caf50'}};
    
    // ดึง userAyahTexts, ayahHighlights และ QURAN_VERSES
    const userTexts=get('userAyahTexts',{});
    const ayahHighlights=get('ayahHighlights',{});
    const surahKey=isPlus?s.n:String(s.n);
    const surahTexts=userTexts[surahKey]||{};
    const knowArOpen=get('knowArOpen',{});
    
    function getArText(ayahNum){
        const arKey=surahKey+'-'+ayahNum;
        // 1. ถ้ามี highlight ใช้ highlight (ที่มีไฮไลท์สี)
        if(ayahHighlights[arKey])return ayahHighlights[arKey];
        // 2. ถ้าผู้ใช้บันทึก userTexts
        if(surahTexts[ayahNum])return surahTexts[ayahNum];
        // 3. ถ้าเป็น Plus
        if(s.verses){
            const v=s.verses.find(x=>String(x.num)===String(ayahNum));
            if(v)return v.ar;
        }
        // 4. ถ้าเป็น Juz Amma
        if(!isPlus&&QURAN_VERSES[s.n]&&QURAN_VERSES[s.n][parseInt(ayahNum)]){
            return QURAN_VERSES[s.n][parseInt(ayahNum)];
        }
        return '';
    }
    
    let html='';
    
    // การ์ดพระนาม
    if(d.names&&d.names.length>0){
        html+=`<div class="surah-know-card names-card">
            <div class="skc-header"><div class="skc-icon" style="background:linear-gradient(135deg,var(--pink),#e91e63)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg></div><span class="skc-title">พระนามอัลลอฮ์</span><span class="skc-count">${d.names.length}</span></div>
            <div class="skc-body names-body">${d.names.map((n,i)=>`<div class="name-pill" onclick="showNameDetailFromKnowledge(${snArg},${i})">${n.name}</div>`).join('')}</div>
        </div>`;
    }
    
    // การ์ดนิสัย
    if(d.habits&&d.habits.length>0){
        const byCategory={};
        d.habits.forEach((h,i)=>{const cat=h.category||'ทั่วไป';if(!byCategory[cat])byCategory[cat]=[];byCategory[cat].push({...h,idx:i,key:surahNum+'-'+i});});
        
        html+=`<div class="surah-know-card habits-card">
            <div class="skc-header"><div class="skc-icon" style="background:linear-gradient(135deg,var(--sec),#00897b)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div><span class="skc-title">นิสัยจากอัลกุรอาน</span><span class="skc-count">${d.habits.length}</span></div>
            <div class="skc-body">${Object.keys(byCategory).map(cat=>`
                <div class="habit-cat-group">
                    <div class="habit-cat-label">${cat}</div>
                    ${byCategory[cat].map(h=>{
                        const st=habitStatus[h.key]||0;
                        const info=statusInfo[st];
                        return `<div class="habit-row">
                            <div class="habit-status-dot" style="background:${info.color}" title="${info.label}"></div>
                            <span class="habit-row-text">${h.text}</span>
                            <span class="habit-row-status" style="color:${info.color}">${info.label}</span>
                        </div>`;
                    }).join('')}
                </div>
            `).join('')}</div>
        </div>`;
    }
    
    // การ์ดบันทึก
    const hasNotes=d.overview||d.reasons||d.stories||Object.keys(d.notes||{}).length||Object.keys(d.meanings||{}).length||Object.keys(d.tafsirs||{}).length;
    if(hasNotes){
        // สร้าง ayah list พร้อมตัวบทอาหรับ
        let ayahHtml='';
        
        // รวบรวม ayah ที่มีบันทึก
        const ayahsWithNotes=new Set();
        Object.keys(d.notes||{}).forEach(a=>ayahsWithNotes.add(a));
        Object.keys(d.meanings||{}).forEach(a=>ayahsWithNotes.add(a));
        Object.keys(d.tafsirs||{}).forEach(a=>ayahsWithNotes.add(a));
        
        // เรียงลำดับ
        const sortedAyahs=[...ayahsWithNotes].sort((a,b)=>{
            const numA=parseFloat(a),numB=parseFloat(b);
            return numA-numB;
        });
        
        sortedAyahs.forEach(ayahNum=>{
            const notes=d.notes?.[ayahNum],meanings=d.meanings?.[ayahNum],tafsirs=d.tafsirs?.[ayahNum];
            if(!notes&&!meanings&&!tafsirs)return;
            
            const arText=getArText(ayahNum);
            const hasAr=arText.length>0;
            const arKey='know-'+surahKey+'-'+ayahNum;
            const isArOpen=knowArOpen[arKey]||false;
            
            ayahHtml+=`<div class="notebook-ayah">
                <div class="notebook-ayah-head">
                    <span class="notebook-ayah-num">อายะฮ์ ${ayahNum}</span>
                    ${hasAr?`<span class="notebook-ayah-ar-toggle ${isArOpen?'open':''}" onclick="toggleKnowAr('${arKey}',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        ตัวบท
                    </span>`:''}
                </div>
                ${hasAr?`<div class="notebook-ayah-ar" id="${arKey}" style="display:${isArOpen?'block':'none'}">${arText}</div>`:''}
                <div class="notebook-ayah-content">
                    ${notes?`<div class="notebook-note"><span class="notebook-note-label nl-notes">ความรู้</span><span class="surah-know-text">${notes}</span></div>`:''}
                    ${meanings?`<div class="notebook-note"><span class="notebook-note-label nl-meanings">ความหมาย</span><span class="surah-know-text">${meanings}</span></div>`:''}
                    ${tafsirs?`<div class="notebook-note"><span class="notebook-note-label nl-tafsirs">ตัฟซีร</span><span class="surah-know-text">${tafsirs}</span></div>`:''}
                </div>
            </div>`;
        });
        
        html+=`<div class="surah-know-card notes-card">
            <div class="skc-header"><div class="skc-icon" style="background:linear-gradient(135deg,var(--pri),#5e35b1)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><span class="skc-title">${s.name}</span><span class="skc-subtitle">${s.ar} • ${s.ayah} อายะฮ์</span></div>
            <div class="skc-body notebook-page">
                ${d.overview?`<div class="notebook-overview"><div class="notebook-overview-label">ภาพรวมซูเราะฮ์</div><div class="notebook-overview-text surah-know-text">${d.overview}</div></div>`:''}
                ${d.reasons?`<div class="notebook-reasons"><div class="notebook-reasons-label">สาเหตุการประทาน</div><div class="notebook-reasons-text surah-know-text">${d.reasons}</div></div>`:''}
                ${d.stories?`<div class="notebook-stories"><div class="notebook-stories-label">เรื่องราวนบี/กลุ่มชน</div><div class="notebook-stories-text surah-know-text">${d.stories}</div></div>`:''}
                ${ayahHtml}
            </div>
        </div>`;
    }
    
    const hasData=(d.names&&d.names.length)||(d.habits&&d.habits.length)||hasNotes;
    document.getElementById('surah-know-list').innerHTML=hasData?html:'<div class="empty-state">ยังไม่มีบันทึก</div>';
    applySurahFontSize();
}

// Toggle ตัวบทในหน้าความรู้
function toggleKnowAr(arKey,el){
    const knowArOpen=get('knowArOpen',{});
    knowArOpen[arKey]=!knowArOpen[arKey];
    set('knowArOpen',knowArOpen);
    
    const arEl=document.getElementById(arKey);
    if(arEl){
        arEl.style.display=knowArOpen[arKey]?'block':'none';
        el.classList.toggle('open');
    }
}

function toggleHabitFromSurah(surahNum,habitIdx){
    const d=getSurah(surahNum);
    if(d.habits&&d.habits[habitIdx]){d.habits[habitIdx].done=!d.habits[habitIdx].done;setSurah(surahNum,d);renderSurahKnowledge();renderKnowledge();}
}

function showNameModal(name){
    const allNames={};
    // รวมจาก SURAHS
    SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names){d.names.forEach(n=>{if(!allNames[n.name])allNames[n.name]={name:n.name,items:[],surahs:[]};allNames[n.name].items.push({meaning:n.meaning,lesson:n.lesson,dua:n.dua,surah:s.name,ayah:n.ayah});if(!allNames[n.name].surahs.includes(s.name))allNames[n.name].surahs.push(s.name);});}});
    // รวมจาก PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names){d.names.forEach(n=>{if(!allNames[n.name])allNames[n.name]={name:n.name,items:[],surahs:[]};allNames[n.name].items.push({meaning:n.meaning,lesson:n.lesson,dua:n.dua,surah:s.name+' (Plus)',ayah:n.ayah});if(!allNames[n.name].surahs.includes(s.name+' (Plus)'))allNames[n.name].surahs.push(s.name+' (Plus)');});}});
    
    const data=allNames[name];if(!data)return;document.getElementById('modal-name-title').innerHTML=`<button onclick="editNameFromModal('${name.replace(/'/g,"\\'")}')" style="position:absolute;left:16px;top:16px;width:28px;height:28px;border-radius:50%;border:none;background:var(--pink-ll);cursor:pointer;display:flex;align-items:center;justify-content:center"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><span style="font-family:'Amiri',serif;font-size:1.6rem;color:var(--pink);display:block;text-align:center">${name}</span><div style="font-size:0.62rem;color:var(--pri);text-align:center;margin-top:4px">${data.items[0]?.meaning||''}</div>`;document.getElementById('modal-name-body').innerHTML=`${data.items.map(x=>`<div style="font-size:0.5rem;color:var(--txt3);margin-bottom:6px;padding:4px 8px;background:var(--pink-ll);border-radius:var(--r-xs);display:inline-block">${x.surah} : อายะฮ์ ${x.ayah||'-'}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">${x.lesson?`<div style="background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:10px"><div style="font-size:0.48rem;color:var(--pink);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:4px"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>ความรู้</div><div style="font-size:0.55rem;line-height:1.5;color:var(--txt)">${x.lesson}</div></div>`:'<div></div>'}${x.dua?`<div style="background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:10px"><div style="font-size:0.48rem;color:var(--pink);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:4px"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>ดุอาอ์/นิสัย</div><div style="font-size:0.55rem;line-height:1.5;color:var(--txt)">${x.dua}</div></div>`:'<div></div>'}</div>`).join('')}`;openModal('name');
}

function calculateCompletion(){
    const s=getSettings();
    const textPerDay=Math.max(1,s.textMin||3);
    const meaningPerDay=Math.max(1,s.meaningMin||1);
    const tafsirPerDay=Math.max(1,s.tafsirMin||1);
    
    let textRemain=TOTAL_AYAH,meaningRemain=TOTAL_AYAH,tafsirRemain=TOTAL_AYAH;
    SURAHS.forEach(su=>{
        const d=getSurah(su.n);
        textRemain-=(d.text||0);
        meaningRemain-=(d.meaning||0);
        tafsirRemain-=(d.tafsir||0);
    });
    
    const textDays=Math.ceil(Math.max(0,textRemain)/textPerDay);
    const meaningDays=(s.meaningMin||0)>0?Math.ceil(Math.max(0,meaningRemain)/meaningPerDay):0;
    const tafsirDays=(s.tafsirMin||0)>0?Math.ceil(Math.max(0,tafsirRemain)/tafsirPerDay):0;
    
    predictDate=new Date();
    predictDate.setDate(predictDate.getDate()+textDays);
    
    const formatDuration=(days)=>{
        if(days<=0)return'จบแล้ว !';
        const y=Math.floor(days/365);
        const m=Math.floor((days%365)/30);
        const d=days%30;
        let parts=[];
        if(y>0)parts.push(y+' ปี');
        if(m>0)parts.push(m+' เดือน');
        if(d>0||parts.length===0)parts.push(d+' วัน');
        return parts.join(' ');
    };
    
    const predictStr=predictDate.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'});
    const el=document.getElementById('settings-predict');
    if(el){
        const mDate=new Date();mDate.setDate(mDate.getDate()+meaningDays);
        const tDate=new Date();tDate.setDate(tDate.getDate()+tafsirDays);
        let html=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:0.55rem">`;
        html+=`<div style="text-align:center"><div style="color:var(--pri);font-weight:600;margin-bottom:4px">ตัวบท</div><div style="color:var(--txt2)">${textRemain<=0?'จบแล้ว':`เหลือ ${textRemain}`}</div><div style="color:var(--txt3);font-size:0.5rem">${formatDuration(textDays)}</div><div style="color:var(--txt);font-weight:500;margin-top:2px">${textRemain<=0?'-':predictStr}</div></div>`;
        html+=`<div style="text-align:center;border-left:1px solid var(--bdr-l);border-right:1px solid var(--bdr-l);padding:0 8px"><div style="color:var(--sec);font-weight:600;margin-bottom:4px">ความหมาย</div><div style="color:var(--txt2)">${(s.meaningMin||0)>0?(meaningRemain<=0?'จบแล้ว':`เหลือ ${meaningRemain}`):'ไม่ได้ตั้ง'}</div><div style="color:var(--txt3);font-size:0.5rem">${(s.meaningMin||0)>0?formatDuration(meaningDays):'-'}</div><div style="color:var(--txt);font-weight:500;margin-top:2px">${(s.meaningMin||0)>0?(meaningRemain<=0?'-':mDate.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})):'-'}</div></div>`;
        html+=`<div style="text-align:center"><div style="color:var(--tafsir);font-weight:600;margin-bottom:4px">ตัฟซีร</div><div style="color:var(--txt2)">${(s.tafsirMin||0)>0?(tafsirRemain<=0?'จบแล้ว':`เหลือ ${tafsirRemain}`):'ไม่ได้ตั้ง'}</div><div style="color:var(--txt3);font-size:0.5rem">${(s.tafsirMin||0)>0?formatDuration(tafsirDays):'-'}</div><div style="color:var(--txt);font-weight:500;margin-top:2px">${(s.tafsirMin||0)>0?(tafsirRemain<=0?'-':tDate.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})):'-'}</div></div>`;
        html+=`</div>`;
        el.innerHTML=html;
    }
    if(document.getElementById('calc-date'))document.getElementById('calc-date').textContent=textRemain<=0?'จบแล้ว !':predictStr;
}

function renderCalendar(){
    const today=getLocalDate(),log=getLog(),todayLog=log[today]||{text:0,meaning:0,tafsir:0},s=getSettings();
    calculateCompletion();
    const predictStr=predictDate?predictDate.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'}):'ยังไม่กำหนด';
    const ayahPerDay=Math.max(1,s.textMin||3);
    const dateStr=getLocalDateObj().toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long'});
    const dailyNotes=get('dailyNotes',{});
    const todayNote=dailyNotes[today]||'';
    
    // การ์ดวันนี้แบบใหม่ - คล้ายหัวคลังความรู้
    document.getElementById('cal-today-card').innerHTML=`
        <div class="cal-today-header">
            <div class="cal-today-title"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><h2>วันนี้</h2></div>
            <div style="display:flex;align-items:center;gap:6px">
                <button onclick="openDailyNoteModal('${today}')" style="width:28px;height:28px;border-radius:50%;border:none;background:${todayNote?'var(--note)':'rgba(255,255,255,0.8)'};cursor:pointer;display:flex;align-items:center;justify-content:center" title="บันทึกประจำวัน">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${todayNote?'#fff':'var(--txt3)'}" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <div class="cal-today-date">${dateStr}</div>
            </div>
        </div>
        <div class="cal-today-hadith">"การงานที่เป็นที่รักยิ่ง ณ ที่อัลลอฮ์นั้นคือ การงานที่ทำอย่างสม่ำเสมอ แม้จะเป็นเพียงเล็กน้อยก็ตาม"<span class="hadith-ref">[มุสลิม : 782]</span></div>
        <div class="cal-today-stats">
            <div class="cal-today-stat s1" onclick="showTodayDetailPopup('text')"><div class="cal-today-stat-num">${todayLog.text||0}</div><div class="cal-today-stat-label">ตัวบท</div></div>
            <div class="cal-today-stat s2" onclick="showTodayDetailPopup('meaning')"><div class="cal-today-stat-num">${todayLog.meaning||0}</div><div class="cal-today-stat-label">ความหมาย</div></div>
            <div class="cal-today-stat s3" onclick="showTodayDetailPopup('tafsir')"><div class="cal-today-stat-num">${todayLog.tafsir||0}</div><div class="cal-today-stat-label">ตัฟซีร</div></div>
        </div>`;
    
    renderChart();
    renderCalendarGrid();
    
    // อัปเดตเลขวันนี้ใน legend
    const todayNum=getLocalDateObj().getDate();
    document.getElementById('legend-today-num').textContent=todayNum;
}

function openDailyNoteModal(dateStr){
    const dailyNotes=get('dailyNotes',{});
    const note=dailyNotes[dateStr]||'';
    const dateObj=new Date(dateStr);
    const dateLabel=dateObj.toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'});
    
    document.getElementById('modal-today-detail-content').innerHTML=`
        <div style="text-align:center;padding:14px 12px 10px;background:linear-gradient(135deg,var(--gold-l),var(--card));margin:0 -12px 12px -12px;border-bottom:1px solid rgba(184,149,107,0.2);border-radius:16px 16px 0 0">
            <div style="width:32px;height:32px;background:var(--note);border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
            <div style="font-size:0.8rem;font-weight:600;color:var(--note)">บันทึกประจำวัน</div>
            <div style="font-size:0.5rem;color:var(--txt3)">${dateLabel}</div>
        </div>
        <textarea id="daily-note-input" oninput="autoSaveDailyNote('${dateStr}')" placeholder="เขียนบันทึกสั้นๆ ..." style="width:100%;min-height:70px;border:1px solid var(--bdr);border-radius:8px;padding:8px;font-size:0.65rem;font-family:'Noto Sans Thai',sans-serif;resize:none">${note}</textarea>
        <div style="text-align:center;margin-top:5px;font-size:0.45rem;color:var(--txt3)">บันทึกอัตโนมัติ ✓</div>
    `;
    openModal('today-detail');
}

let dailyNoteTimer=null;
function autoSaveDailyNote(dateStr){
    if(dailyNoteTimer)clearTimeout(dailyNoteTimer);
    dailyNoteTimer=setTimeout(()=>{
        const note=document.getElementById('daily-note-input').value;
        const dailyNotes=get('dailyNotes',{});
        if(note.trim()){
            dailyNotes[dateStr]=note;
        }else{
            delete dailyNotes[dateStr];
        }
        set('dailyNotes',dailyNotes);
        renderCalendar();
    },500);
}

function toggleGoalManual(type){
    toast('ไปบันทึกความคืบหน้าที่หน้าซูเราะฮ์');
}


function renderTodayReview(){
    const today=getLocalDate(),history=getHistory(),done=get('reviewDone',{}),reviews=[];
    history.forEach(h=>{if(h.reviews){h.reviews.forEach((r,i)=>{if(r===today)reviews.push({...h,round:i+1,key:h.id+'-'+i})});}});
    const typeLabel={'text':'ตัวบท','meaning':'ความหมาย','tafsir':'ตัฟซีร'};
    const html=reviews.length?reviews.map(r=>`<div class="review-item ${done[r.key]?'done-item':''}" onclick="toggleReviewHome('${r.key}')"><div class="review-check ${done[r.key]?'done':''}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><span class="review-text">${r.name} ${r.from}-${r.to}</span><span class="review-badge rb${r.type==='text'?'1':r.type==='meaning'?'2':'3'}">${typeLabel[r.type]} ร.${r.round}</span></div>`).join(''):'<div class="empty-state">ไม่มีงานทบทวน</div>';
    // Render ที่หน้า Home เท่านั้น
    const el=document.getElementById('home-review-list');
    if(el)el.innerHTML=html;
}

function renderCalendarGrid(){
    const months=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    document.getElementById('calendar-title').textContent=months[currentMonth]+' '+(currentYear+543);
    const firstDay=new Date(currentYear,currentMonth,1).getDay(),daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
    const todayStr=getLocalDate(),log=getLog(),history=getHistory(),settings=getSettings(),goalPassed=getGoalPassed();
    const minGoal=Math.max(1,settings.textMin||3);
    const tasks={};
    history.forEach(h=>{[h.date,...(h.reviews||[])].forEach(d=>{if(!tasks[d])tasks[d]={text:false,meaning:false,tafsir:false,memReview:false};tasks[d][h.type]=true});});
    
    // เพิ่ม mem-review tasks จาก surahReviewData (วันที่ทบทวนไปแล้ว)
    const reviewData=get('surahReviewData',{});
    Object.keys(reviewData).forEach(sn=>{
        const rd=reviewData[sn];
        if(rd.lastReview){
            const d=new Date(rd.lastReview).toLocaleDateString('en-CA');
            if(!tasks[d])tasks[d]={text:false,meaning:false,tafsir:false,memReview:false};
            tasks[d].memReview=true;
        }
    });
    
    // ดึง schedule ทั้งหมด (รวมทุกรอบในอนาคต)
    const reviewSchedule=getFullReviewSchedule();
    
    const predictDateStr=predictDate?predictDate.toLocaleDateString('en-CA'):'';
    
    let html='';for(let i=0;i<firstDay;i++)html+='<div class="calendar-day"></div>';
    for(let day=1;day<=daysInMonth;day++){
        const dateStr=currentYear+'-'+String(currentMonth+1).padStart(2,'0')+'-'+String(day).padStart(2,'0');
        const dayLog=log[dateStr]||{text:0,meaning:0,tafsir:0};
        const textDone=(dayLog.text||0);
        const t=tasks[dateStr];
        const scheduled=reviewSchedule[dateStr];
        const hasMemReview=(t&&t.memReview)||(scheduled&&scheduled.length>0);
        const isGoalPassed=goalPassed[dateStr];
        const isPredictDay=dateStr===predictDateStr;
        let lvClass='';
        if(textDone>=minGoal){
            const ratio=textDone/minGoal;
            if(ratio>=3)lvClass='lv6';
            else if(ratio>=2.5)lvClass='lv5';
            else if(ratio>=2)lvClass='lv4';
            else if(ratio>=1.5)lvClass='lv3';
            else if(ratio>=1.25)lvClass='lv2';
            else lvClass='lv1';
        }
        const isToday=dateStr===todayStr;
        const hasDots=(t&&(t.text||t.meaning||t.tafsir))||hasMemReview;
        // แสดงจำนวนงานทบทวนถ้ามี
        const reviewCount=scheduled?scheduled.length:0;
        html+=`<div class="calendar-day ${isToday?'today':''} ${isPredictDay?'predict-day':''} ${lvClass}" onclick="showDayModal('${dateStr}')"><div class="day-num">${day}</div>${hasDots?`<div class="calendar-dots">${(t&&t.text)||hasMemReview?'<span class="calendar-dot cd1"></span>':''}${t&&t.meaning?'<span class="calendar-dot cd2"></span>':''}${t&&t.tafsir?'<span class="calendar-dot cd3"></span>':''}${reviewCount>1?`<span style="font-size:6px;color:var(--pri);font-weight:600">+${reviewCount}</span>`:''}</div>`:''}</div>`;
    }
    document.getElementById('calendar-days').innerHTML=html;
}

function prevMonth(){currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;}renderCalendarGrid();}
function nextMonth(){currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;}renderCalendarGrid();}

function showDayModal(dateStr){
    const log=getLog(),dayLog=log[dateStr]||{text:0,meaning:0,tafsir:0},history=getHistory(),settings=getSettings(),dateObj=new Date(dateStr);
    const dayHistory=history.filter(h=>h.date===dateStr);
    const reviewDone=get('reviewDone',{});
    const reviews=[];history.forEach(h=>{if(h.reviews){h.reviews.forEach((r,i)=>{if(r===dateStr)reviews.push({...h,round:i+1,key:h.id+'-'+i})});}});
    const isPast=new Date(dateStr)<new Date(getLocalDate());
    const dailyNotes=get('dailyNotes',{});
    const dayNote=dailyNotes[dateStr]||'';
    const isToday=dateStr===getLocalDate();
    
    let planHtml='';
    if(!isPast){
        // === 1. เป้าหมายรายวัน ===
        let dailyGoals=[];
        if((settings.textMin||0)>0)dailyGoals.push({text:`ท่องตัวบท ${settings.textMin}+ อายะฮ์`,done:(dayLog.text||0)>=(settings.textMin||0),color:'pri'});
        if((settings.meaningMin||0)>0)dailyGoals.push({text:`อ่านความหมาย ${settings.meaningMin}+ อายะฮ์`,done:(dayLog.meaning||0)>=(settings.meaningMin||0),color:'sec'});
        if((settings.tafsirMin||0)>0)dailyGoals.push({text:`อ่านตัฟซีร ${settings.tafsirMin}+ อายะฮ์`,done:(dayLog.tafsir||0)>=(settings.tafsirMin||0),color:'tafsir'});
        
        // === 2. ทบทวนตัวบท (Spaced Repetition) ===
        // ระบบจัดคิวตาม perDay แล้ว ไม่มี "ค้าง" - มีแค่ "งานวันนี้" กับ "รอคิว"
        const scheduled=getScheduledReviewsForDate(dateStr);
        let round1Items=[], round2PlusItems=[];
        
        if(isToday){
            const memReviewTasks=getMemorizedReviewTasks();
            memReviewTasks.forEach(t=>{
                const item={name:t.surahName, round:t.round, done:t.doneToday};
                if(t.round===1) round1Items.push(item);
                else round2PlusItems.push(item);
            });
        }else if(scheduled.length>0){
            // วันอนาคต - แสดงตามที่จัดคิวไว้
            scheduled.forEach(t=>{
                const item={name:t.surahName, round:t.round, done:false};
                if(t.round===1) round1Items.push(item);
                else round2PlusItems.push(item);
            });
        }
        
        // === 3. ทบทวนจากประวัติ (Flash Card) ===
        let historyReviews=[];
        reviews.forEach(r=>{
            const typeLabel=r.type==='text'?'ตัวบท':r.type==='meaning'?'ความหมาย':'ตัฟซีร';
            historyReviews.push({
                text:`${r.name} ${r.from}-${r.to}`,
                sub:typeLabel,
                round:r.round,
                done:reviewDone[r.key]||false,
                color:r.type==='text'?'pri':r.type==='meaning'?'sec':'tafsir'
            });
        });
        
        // สร้าง HTML แบบแบ่งหมวดหมู่
        planHtml=`<div style="margin-top:10px">`;
        
        // หมวด: เป้าหมายรายวัน
        if(dailyGoals.length>0){
            planHtml+=`<div style="margin-bottom:10px">
                <div style="font-size:0.48rem;font-weight:600;color:var(--txt2);margin-bottom:5px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pri)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    เป้าหมายรายวัน
                </div>
                <div style="background:#fff;border-radius:8px;border:1px solid var(--bdr-l);overflow:hidden">`;
            dailyGoals.forEach((item,idx)=>{
                const isLast=idx===dailyGoals.length-1;
                planHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;${isLast?'':'border-bottom:1px solid var(--bdr-l)'}">
                    <div style="width:11px;height:11px;border-radius:3px;border:1.5px solid var(--${item.color});background:${item.done?`var(--${item.color})`:'#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0">${item.done?'<svg width="6" height="6" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
                    <div style="font-size:0.48rem;color:${item.done?'var(--txt3)':'var(--txt)'};${item.done?'text-decoration:line-through':''}">${item.text}</div>
                </div>`;
            });
            planHtml+=`</div></div>`;
        }
        
        // หมวด: ทบทวนครั้งแรก (รอบ 1)
        if(round1Items.length>0){
            planHtml+=`<div style="margin-bottom:10px">
                <div style="font-size:0.48rem;font-weight:600;color:var(--pri);margin-bottom:5px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pri)" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    ทบทวนครั้งแรก
                </div>
                <div style="background:linear-gradient(135deg,var(--pri-ll),#fff);border-radius:8px;border:1px solid rgba(139,115,176,0.3);overflow:hidden">`;
            round1Items.forEach((item,idx)=>{
                const isLast=idx===round1Items.length-1;
                planHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;${isLast?'':'border-bottom:1px solid rgba(139,115,176,0.15)'}">
                    <div style="width:11px;height:11px;border-radius:3px;border:1.5px solid var(--pri);background:${item.done?'var(--pri)':'#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0">${item.done?'<svg width="6" height="6" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
                    <div style="flex:1"><div style="font-size:0.48rem;color:${item.done?'var(--txt3)':'var(--txt)'};${item.done?'text-decoration:line-through':''}">${item.name}</div><div style="font-size:0.38rem;color:var(--pri)">รอบ 1</div></div>
                </div>`;
            });
            planHtml+=`</div></div>`;
        }
        
        // หมวด: ทบทวนต่อเนื่อง (รอบ 2+)
        if(round2PlusItems.length>0){
            planHtml+=`<div style="margin-bottom:10px">
                <div style="font-size:0.48rem;font-weight:600;color:var(--sec);margin-bottom:5px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--sec)" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    ทบทวนต่อเนื่อง
                </div>
                <div style="background:linear-gradient(135deg,var(--sec-ll),#fff);border-radius:8px;border:1px solid rgba(122,158,159,0.3);overflow:hidden">`;
            round2PlusItems.forEach((item,idx)=>{
                const isLast=idx===round2PlusItems.length-1;
                planHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;${isLast?'':'border-bottom:1px solid rgba(122,158,159,0.15)'}">
                    <div style="width:11px;height:11px;border-radius:3px;border:1.5px solid var(--sec);background:${item.done?'var(--sec)':'#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0">${item.done?'<svg width="6" height="6" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
                    <div style="flex:1"><div style="font-size:0.48rem;color:${item.done?'var(--txt3)':'var(--txt)'};${item.done?'text-decoration:line-through':''}">${item.name}</div><div style="font-size:0.38rem;color:var(--sec)">รอบ ${item.round}</div></div>
                </div>`;
            });
            planHtml+=`</div></div>`;
        }
        
        // หมวด: ทบทวน Flash Card
        if(historyReviews.length>0){
            planHtml+=`<div style="margin-bottom:10px">
                <div style="font-size:0.48rem;font-weight:600;color:var(--gold);margin-bottom:5px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                    ทบทวนที่บันทึกไว้
                </div>
                <div style="background:linear-gradient(135deg,var(--gold-l),#fff);border-radius:8px;border:1px solid rgba(184,149,107,0.3);overflow:hidden">`;
            historyReviews.forEach((item,idx)=>{
                const isLast=idx===historyReviews.length-1;
                planHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;${isLast?'':'border-bottom:1px solid rgba(184,149,107,0.15)'}">
                    <div style="width:11px;height:11px;border-radius:3px;border:1.5px solid var(--${item.color});background:${item.done?`var(--${item.color})`:'#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0">${item.done?'<svg width="6" height="6" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
                    <div style="flex:1"><div style="font-size:0.48rem;color:${item.done?'var(--txt3)':'var(--txt)'};${item.done?'text-decoration:line-through':''}">${item.text}</div><div style="font-size:0.38rem;color:var(--${item.color})">${item.sub} • รอบ ${item.round}</div></div>
                </div>`;
            });
            planHtml+=`</div></div>`;
        }
        
        // ถ้าไม่มีอะไรเลย
        if(dailyGoals.length===0 && round1Items.length===0 && round2PlusItems.length===0 && historyReviews.length===0){
            planHtml+=`<div style="text-align:center;padding:16px;color:var(--txt3);font-size:0.5rem">ไม่มีงานที่ต้องทำ 🎉</div>`;
        }
        
        planHtml+=`</div>`;
    }
    
    let historyHtml='';
    if(dayHistory.length){
        historyHtml=`<div style="margin-top:8px"><div style="font-size:0.45rem;font-weight:600;color:var(--txt3);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px">สิ่งที่ท่องวันนี้</div><div style="display:grid;gap:4px">`+dayHistory.map(h=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:linear-gradient(135deg,var(--${h.type==='text'?'pri':h.type==='meaning'?'sec':'tafsir'}-ll),#fff);border-radius:8px;border:1px solid var(--bdr-l)"><div style="width:24px;height:24px;border-radius:6px;background:var(--${h.type==='text'?'pri':h.type==='meaning'?'sec':'tafsir'});display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">${h.type==='text'?'<path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>':h.type==='meaning'?'<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>':'<path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/>'}</svg></div><div style="flex:1;min-width:0"><div style="font-size:0.55rem;font-weight:600;color:var(--txt)">${h.name}</div><div style="font-size:0.42rem;color:var(--txt3)">${h.type==='text'?'ตัวบท':h.type==='meaning'?'ความหมาย':'ตัฟซีร'} อายะฮ์ ${h.from}-${h.to}</div></div></div>`).join('')+`</div></div>`;
    }
    
    // Note section
    let noteHtml='';
    if(dayNote){
        noteHtml=`<div style="margin-top:10px;padding:8px;background:linear-gradient(135deg,var(--note-l),#fff);border-radius:var(--r-sm);border:1px solid rgba(232,166,76,0.2)"><div style="font-size:var(--text-3xs);font-weight:600;color:var(--note);margin-bottom:3px;display:flex;align-items:center;gap:4px"><svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--note)" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>บันทึก</div><div style="font-size:var(--text-2xs);color:var(--txt);line-height:1.5">${dayNote}</div></div>`;
    }
    
    document.getElementById('modal-day-body').innerHTML=`
        <div style="padding:22px 16px 16px 16px;background:linear-gradient(135deg,#b7b1ce 0%,#e6eeef 50%,#e9c7d7 100%);margin:-16px -16px 12px -16px;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between;box-sizing:border-box">
            <div style="font-size:0.85rem;font-weight:600;color:#4a4063;text-shadow:0 1px 1px rgba(255,255,255,0.5);line-height:1.2">${dateObj.toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long'})}</div>
            <button onclick="closeModal('day');openDailyNoteModal('${dateStr}')" style="width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,0.5);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-left:10px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#4a4063" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px">
            <div style="text-align:center;padding:7px 4px;background:var(--pri-ll);border-radius:8px"><div style="font-size:0.7rem;font-weight:700;color:var(--pri)">${dayLog.text||0}</div><div style="font-size:0.42rem;color:var(--txt3)">ตัวบท</div></div>
            <div style="text-align:center;padding:7px 4px;background:var(--sec-ll);border-radius:8px"><div style="font-size:0.7rem;font-weight:700;color:var(--sec)">${dayLog.meaning||0}</div><div style="font-size:0.42rem;color:var(--txt3)">ความหมาย</div></div>
            <div style="text-align:center;padding:7px 4px;background:var(--tafsir-ll);border-radius:8px"><div style="font-size:0.7rem;font-weight:700;color:var(--tafsir)">${dayLog.tafsir||0}</div><div style="font-size:0.42rem;color:var(--txt3)">ตัฟซีร</div></div>
        </div>
        ${noteHtml}${planHtml}${historyHtml}
    `;
    openModal('day');
}

function renderSettings(){
    const s=getSettings();
    document.getElementById('settings-username').value=getUsername();
    document.getElementById('goal-text-min').value=s.textMin!==undefined?s.textMin:3;
    document.getElementById('goal-text-max').value=s.textMax!==undefined?s.textMax:10;
    document.getElementById('goal-meaning-min').value=s.meaningMin!==undefined?s.meaningMin:0;
    document.getElementById('goal-meaning-max').value=s.meaningMax!==undefined?s.meaningMax:5;
    document.getElementById('goal-tafsir-min').value=s.tafsirMin!==undefined?s.tafsirMin:0;
    document.getElementById('goal-tafsir-max').value=s.tafsirMax!==undefined?s.tafsirMax:3;
    
    // Review settings
    const reviewSettings=get('reviewSettings',{});
    const perDayInput=document.getElementById('settings-review-perday');
    if(perDayInput)perDayInput.value=reviewSettings.perDay!==undefined?reviewSettings.perDay:3;
    renderMemorizedSummary();
    
    renderSettingsGoals();
    renderSettingsRewards();
    calculateCompletion();
}

function saveSettings(){
    const s=getSettings();
    s.textMin=parseInt(document.getElementById('goal-text-min').value)||0;
    s.textMax=parseInt(document.getElementById('goal-text-max').value)||10;
    s.meaningMin=parseInt(document.getElementById('goal-meaning-min').value)||0;
    s.meaningMax=parseInt(document.getElementById('goal-meaning-max').value)||5;
    s.tafsirMin=parseInt(document.getElementById('goal-tafsir-min').value)||0;
    s.tafsirMax=parseInt(document.getElementById('goal-tafsir-max').value)||3;
    set('settings',s);
    calculateCompletion();
}

function renderSettingsGoals(){
    const goals=getGoals(),streak=get('streak',0);let totalText=0,completedSurahs=0;SURAHS.forEach(s=>{const d=getSurah(s.n);totalText+=d.text||0;if(calcStatus(d,s.ayah)===4)completedSurahs++});
    document.getElementById('settings-goals').innerHTML=goals.map((g,i)=>{const current=g.ty==='surah'?completedSurahs:g.ty==='ayah'?totalText:streak;return`<div class="settings-goal"><button class="settings-goal-del" onclick="deleteGoal(${i})">×</button><div class="settings-goal-emoji">${g.e}</div><div class="settings-goal-name">${g.t}</div><div class="settings-goal-prog">${current}/${g.n}</div></div>`;}).join('')||'<div class="empty-state" style="grid-column:1/-1">ยังไม่มี</div>';
}

function renderSettingsRewards(){
    const rewards=getRewards(),streak=get('streak',0);let totalText=0,completedSurahs=0;SURAHS.forEach(s=>{const d=getSurah(s.n);totalText+=d.text||0;if(calcStatus(d,s.ayah)===4)completedSurahs++});
    document.getElementById('settings-rewards').innerHTML=rewards.map((r,i)=>{const current=r.ty==='surah'?completedSurahs:r.ty==='ayah'?totalText:streak;return`<div class="settings-goal"><button class="settings-goal-del" onclick="deleteReward(${i})">×</button><div class="settings-goal-emoji">${r.e}</div><div class="settings-goal-name">${r.t}</div><div class="settings-goal-prog">${current}/${r.n}</div></div>`;}).join('')||'<div class="empty-state" style="grid-column:1/-1">ยังไม่มี</div>';
}

function addGoal(){
    const e=document.getElementById('add-goal-emoji').value||'🎯';
    const t=document.getElementById('add-goal-name').value.trim();
    const ty=document.getElementById('add-goal-type').value;
    const n=parseInt(document.getElementById('add-goal-target').value)||1;
    if(!t)return toast('กรุณาใส่ชื่อ');
    const goals=getGoals();goals.push({e,t,ty,n});set('goals',goals);
    document.getElementById('add-goal-emoji').value='🎯';
    document.getElementById('add-goal-name').value='';
    document.getElementById('add-goal-target').value='';
    renderSettingsGoals();renderGoals();toast('เพิ่มแล้ว');
}

function deleteGoal(i){if(!confirm('ลบ ?'))return;const goals=getGoals();goals.splice(i,1);set('goals',goals);renderSettingsGoals();renderGoals();}

function addReward(){
    const e=document.getElementById('add-reward-emoji').value||'🎁';
    const t=document.getElementById('add-reward-name').value.trim();
    const ty=document.getElementById('add-reward-type').value;
    const n=parseInt(document.getElementById('add-reward-target').value)||1;
    if(!t)return toast('กรุณาใส่ชื่อ');
    const rewards=getRewards();rewards.push({e,t,ty,n});set('rewards',rewards);
    document.getElementById('add-reward-emoji').value='🎁';
    document.getElementById('add-reward-name').value='';
    document.getElementById('add-reward-target').value='';
    renderSettingsRewards();renderRewards();toast('เพิ่มแล้ว');
}

function deleteReward(i){if(!confirm('ลบ ?'))return;const rewards=getRewards();rewards.splice(i,1);set('rewards',rewards);renderSettingsRewards();renderRewards();}

function getDefaultResources(){
    return [
        {e:'📖',name:'Quran.com',url:'https://quran.com/juz/30',desc:'อ่านอัลกุรอาน+คำแปล',cats:['อัลกุรอาน'],color:'#6B5B7A',group:''},
        {e:'🎧',name:'QuranicAudio',url:'https://quranicaudio.com',desc:'ฟังเสียงอ่าน',cats:['เสียง'],color:'#7A9E9F',group:''},
        {e:'📱',name:'Tarteel AI',url:'https://tarteel.ai',desc:'แอปช่วยท่องจำ',cats:['แอป'],color:'#C4867B',group:''},
        {e:'🎬',name:'17 ซูเราะฮ์สำคัญ',url:'https://www.youtube.com/watch?v=gVmUKqKJ8e0&list=PLJyuv-gZb_m5xYhkrMFcOC_fAYFTTKOnB',desc:'บทเรียนสำคัญ+ตัฟซีร',cats:['YouTube','ตัฟซีร'],color:'#FF0000',group:''},
        {e:'🔤',name:'ภาษาอาหรับเพื่ออัลกุรอาน',url:'https://www.youtube.com/watch?v=yn9l3RIcPJo&list=PLFlTCqJe3BOk7H5Xr0xbIMJMKrg3uANp5',desc:'เรียนภาษาอาหรับ',cats:['YouTube'],color:'#FF0000',group:''},
        {e:'🗣️',name:'ฝึกอ่านอัลกุรอาน YT',url:'https://www.youtube.com/watch?v=ALop9YuDr6g&list=PLFlTCqJe3BOnm64F8m9EEQ2qXKtkhTtPS',desc:'แบบเรียนฉบับเร็ว',cats:['YouTube'],color:'#FF0000',group:''},
        {e:'📚',name:'Daasee หน้าหลัก',url:'https://www.daasee.com',desc:'คลังความรู้อิสลาม',cats:['อัลกุรอาน'],color:'#4CAF50',group:'daasee'},
        {e:'📖',name:'อ่านอัลกุรอาน',url:'https://www.daasee.com/quran/quranbrowser/index.php',desc:'อ่านออนไลน์',cats:['อัลกุรอาน'],color:'#4CAF50',group:'daasee'},
        {e:'🔤',name:'คำแปลอัลกุรอาน',url:'https://www.daasee.com/quran/quranmeaning/index.php',desc:'พร้อมคำแปลไทย',cats:['อัลกุรอาน'],color:'#4CAF50',group:'daasee'},
        {e:'📝',name:'คำต่อคำ',url:'https://www.daasee.com/quran/quranwordbyword/index.php',desc:'แบบคำต่อคำ',cats:['อัลกุรอาน'],color:'#4CAF50',group:'daasee'},
        {e:'🗣️',name:'ฝึกอ่าน Daasee',url:'https://www.daasee.com/deen/qprac.php?lessonno=1',desc:'ฝึกอ่านและภาษาอาหรับ',cats:['อัลกุรอาน'],color:'#4CAF50',group:'daasee'},
        {e:'💎',name:'99 พระนาม',url:'https://www.daasee.com/99names/index.php?code=99&gid=4',desc:'พระนามของอัลลอฮ์',cats:['พระนาม'],color:'#4CAF50',group:'daasee'}
    ];
}

function getDefaultResourceCats(){
    return [
        {id:'all',name:'ทั้งหมด',color:'#6B5B7A'},
        {id:'quran',name:'อัลกุรอาน',color:'#6B5B7A'},
        {id:'tafsir',name:'ตัฟซีร',color:'#B8956B'},
        {id:'youtube',name:'YouTube',color:'#FF0000'},
        {id:'audio',name:'เสียง',color:'#7A9E9F'},
        {id:'app',name:'แอป',color:'#C4867B'},
        {id:'names',name:'พระนาม',color:'#D4738C'},
        {id:'other',name:'อื่นๆ',color:'#777777'}
    ];
}

function getDefaultResourceGroups(){
    return [{id:'daasee',name:'Daasee',emoji:'🌿',desc:'คลังความรู้อิสลาม',color:'#4CAF50'}];
}

function getResourceCats(){return get('resourceCats',getDefaultResourceCats());}
function getResourceGroups(){return get('resourceGroups',getDefaultResourceGroups());}

function getResources(){
    const saved=get('resources',null);
    if(saved===null){set('resources',getDefaultResources());return getDefaultResources();}
    return saved.map(r=>{
        if(r.cat&&!r.cats)r.cats=[r.cat];
        if(!r.cats)r.cats=[];
        if(!r.color)r.color='#6B5B7A';
        if(!r.group)r.group='';
        return r;
    });
}

let currentResourceCat='ทั้งหมด';
const resourceColors=['#c84c7a','#fbc332','#f45436','#a995b3','#4b9cd1','#496252','#6b9748','#74434b'];

function renderResources(){
    const resources=getResources();
    const cats=getResourceCats();
    const groups=getResourceGroups();
    const catsContainer=document.getElementById('resources-cats');
    const listContainer=document.getElementById('resources-list');
    if(!catsContainer||!listContainer)return;
    
    let filtered=resources;
    if(currentResourceCat!=='ทั้งหมด'){
        filtered=resources.filter(r=>r.cats&&r.cats.includes(currentResourceCat));
    }
    
    catsContainer.innerHTML=cats.map(c=>{
        const isActive=currentResourceCat===(c.name==='ทั้งหมด'?'ทั้งหมด':c.name);
        return `<button onclick="filterResources('${c.name}')" class="res-cat-btn ${isActive?'active':''}"><span class="cat-color" style="background:${c.color}"></span>${c.name}</button>`;
    }).join('');
    
    const grouped={};const standalone=[];
    filtered.forEach((r,idx)=>{
        const realIdx=resources.indexOf(r);
        if(r.group){if(!grouped[r.group])grouped[r.group]=[];grouped[r.group].push({...r,realIdx});}
        else{standalone.push({...r,realIdx});}
    });
    
    let html='';
    groups.forEach(g=>{
        if(grouped[g.id]&&grouped[g.id].length>0){
            html+=`<div class="res-group">
                <div class="res-group-header" style="background:${g.color}10">
                    <div class="res-group-icon" style="background:${g.color}20">${g.emoji}</div>
                    <div class="res-group-info"><div class="res-group-name" style="color:${g.color}">${g.name}</div><div class="res-group-desc">${g.desc}</div></div>
                    <div class="res-group-actions"><button class="res-group-btn" onclick="editGroup('${g.id}')" title="แก้ไข"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></div>
                </div>
                <div class="res-group-items">${grouped[g.id].map(r=>renderResourceItem(r,g.color)).join('')}</div>
            </div>`;
        }
    });
    if(standalone.length>0){html+=`<div class="res-standalone">${standalone.map(r=>renderResourceItem(r,r.color)).join('')}</div>`;}
    if(html===''){html='<div style="text-align:center;color:var(--txt3);padding:var(--sp-4);font-size:var(--text-2xs)">ไม่มีในหมวดนี้</div>';}
    listContainer.innerHTML=html;
}

function renderResourceItem(r,defaultColor){
    const color=r.color||defaultColor||'#6B5B7A';
    const catsHtml=r.cats&&r.cats.length>0?`<div class="res-info-cats">${r.cats.slice(0,2).map(c=>`<span class="res-info-cat">${c}</span>`).join('')}</div>`:'';
    return `<div class="res-item">
        <div class="res-icon" style="background:${color}15">${r.e}</div>
        <div class="res-info"><a href="${r.url}" target="_blank" rel="noopener" class="res-info-name">${r.name}</a>${r.desc?`<div class="res-info-desc">${r.desc}</div>`:''}${catsHtml}</div>
        <a href="${r.url}" target="_blank" rel="noopener" class="res-link" style="background:${color}"><svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>
        <div class="res-actions"><button class="res-action-btn" onclick="openEditResource(${r.realIdx})" title="แก้ไข"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="res-action-btn del" onclick="deleteResource(${r.realIdx})" title="ลบ"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    </div>`;
}

function filterResources(cat){currentResourceCat=cat;renderResources();}

function openAddResourceModal(){
    const cats=getResourceCats().filter(c=>c.name!=='ทั้งหมด');
    const groups=getResourceGroups();
    document.getElementById('new-res-emoji').value='📚';
    document.getElementById('new-res-name').value='';
    document.getElementById('new-res-url').value='';
    document.getElementById('new-res-desc').value='';
    document.getElementById('new-res-cats').innerHTML=cats.map(c=>`<div class="res-modal-cat" onclick="toggleResCat(this)" data-cat="${c.name}"><span class="cat-dot" style="background:${c.color}"></span>${c.name}</div>`).join('');
    document.getElementById('new-res-group').innerHTML=`<option value="">ไม่อยู่ในกลุ่ม</option>${groups.map(g=>`<option value="${g.id}">${g.emoji} ${g.name}</option>`).join('')}`;
    document.getElementById('new-res-color').innerHTML=resourceColors.map((c,i)=>`<div class="res-color-opt ${i===0?'selected':''}" style="background:${c}" onclick="selectResColor(this,'new')" data-color="${c}"></div>`).join('');
    openModal('add-resource');
}

function toggleResCat(el){el.classList.toggle('selected');}
function selectResColor(el,prefix){document.querySelectorAll(`#${prefix}-res-color .res-color-opt`).forEach(e=>e.classList.remove('selected'));el.classList.add('selected');}

function saveNewResource(){
    const e=document.getElementById('new-res-emoji').value||'📚';
    const name=document.getElementById('new-res-name').value.trim();
    const url=document.getElementById('new-res-url').value.trim();
    const desc=document.getElementById('new-res-desc').value.trim();
    const group=document.getElementById('new-res-group').value;
    const selectedCats=Array.from(document.querySelectorAll('#new-res-cats .res-modal-cat.selected')).map(el=>el.dataset.cat);
    const color=document.querySelector('#new-res-color .res-color-opt.selected')?.dataset.color||'#6B5B7A';
    if(!name||!url)return toast('กรุณาใส่ชื่อและลิงก์');
    if(!url.startsWith('http'))return toast('ลิงก์ต้องเริ่มด้วย http://');
    const resources=getResources();
    resources.push({e,name,url,desc,cats:selectedCats,color,group});
    set('resources',resources);
    closeModal('add-resource');renderResources();toast('เพิ่มแล้ว');
}

function openEditResource(idx){
    const resources=getResources();const r=resources[idx];if(!r)return;
    const cats=getResourceCats().filter(c=>c.name!=='ทั้งหมด');
    const groups=getResourceGroups();
    document.getElementById('edit-res-emoji').value=r.e||'📚';
    document.getElementById('edit-res-name').value=r.name||'';
    document.getElementById('edit-res-url').value=r.url||'';
    document.getElementById('edit-res-desc').value=r.desc||'';
    document.getElementById('edit-res-idx').value=idx;
    document.getElementById('edit-res-cats').innerHTML=cats.map(c=>{const selected=r.cats&&r.cats.includes(c.name)?'selected':'';return `<div class="res-modal-cat ${selected}" onclick="toggleResCat(this)" data-cat="${c.name}"><span class="cat-dot" style="background:${c.color}"></span>${c.name}</div>`;}).join('');
    document.getElementById('edit-res-group').innerHTML=`<option value="">ไม่อยู่ในกลุ่ม</option>${groups.map(g=>`<option value="${g.id}" ${r.group===g.id?'selected':''}>${g.emoji} ${g.name}</option>`).join('')}`;
    document.getElementById('edit-res-color').innerHTML=resourceColors.map(c=>`<div class="res-color-opt ${r.color===c?'selected':''}" style="background:${c}" onclick="selectResColor(this,'edit')" data-color="${c}"></div>`).join('');
    openModal('edit-resource');
}

function saveEditResource(){
    const idx=parseInt(document.getElementById('edit-res-idx').value);const resources=getResources();if(!resources[idx])return;
    resources[idx].e=document.getElementById('edit-res-emoji').value||'📚';
    resources[idx].name=document.getElementById('edit-res-name').value.trim();
    resources[idx].url=document.getElementById('edit-res-url').value.trim();
    resources[idx].desc=document.getElementById('edit-res-desc').value.trim();
    resources[idx].group=document.getElementById('edit-res-group').value;
    resources[idx].cats=Array.from(document.querySelectorAll('#edit-res-cats .res-modal-cat.selected')).map(el=>el.dataset.cat);
    resources[idx].color=document.querySelector('#edit-res-color .res-color-opt.selected')?.dataset.color||'#6B5B7A';
    set('resources',resources);closeModal('edit-resource');renderResources();toast('บันทึกแล้ว');
}

function deleteResourceFromModal(){
    const idx=parseInt(document.getElementById('edit-res-idx').value);
    if(!confirm('ลบแหล่งเรียนรู้นี้ ?'))return;
    const resources=getResources();resources.splice(idx,1);set('resources',resources);
    closeModal('edit-resource');renderResources();toast('ลบแล้ว');
}

function deleteResource(idx){
    if(!confirm('ลบแหล่งเรียนรู้นี้ ?'))return;
    const resources=getResources();resources.splice(idx,1);set('resources',resources);renderResources();
}

function openResourceSettings(){renderResCatsList();renderResGroupsList();showResSettingsTab('cats');openModal('resource-settings');}

function showResSettingsTab(tab){
    document.getElementById('res-settings-cats-content').style.display=tab==='cats'?'block':'none';
    document.getElementById('res-settings-groups-content').style.display=tab==='groups'?'block':'none';
    document.getElementById('res-settings-tab-cats').className=tab==='cats'?'settings-btn':'settings-btn settings-btn-light';
    document.getElementById('res-settings-tab-groups').className=tab==='groups'?'settings-btn':'settings-btn settings-btn-light';
}

function renderResCatsList(){
    const cats=getResourceCats().filter(c=>c.name!=='ทั้งหมด');
    document.getElementById('res-cats-list').innerHTML=cats.map((c,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--card2);border-radius:var(--r-sm);margin-bottom:4px"><span style="width:16px;height:16px;border-radius:50%;background:${c.color}"></span><span style="flex:1;font-size:var(--text-2xs)">${c.name}</span><button onclick="deleteResourceCat(${i+1})" style="background:none;border:none;color:var(--txt3);cursor:pointer;padding:4px">×</button></div>`).join('')||'<div style="text-align:center;color:var(--txt3);padding:var(--sp-2);font-size:var(--text-3xs)">ยังไม่มีหมวดหมู่</div>';
}

function renderResGroupsList(){
    const groups=getResourceGroups();
    document.getElementById('res-groups-list').innerHTML=groups.map((g,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:${g.color}10;border-radius:var(--r-sm);margin-bottom:4px"><span style="font-size:1rem">${g.emoji}</span><div style="flex:1"><div style="font-size:var(--text-2xs);font-weight:500">${g.name}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">${g.desc}</div></div><button onclick="deleteResourceGroup(${i})" style="background:none;border:none;color:var(--txt3);cursor:pointer;padding:4px">×</button></div>`).join('')||'<div style="text-align:center;color:var(--txt3);padding:var(--sp-2);font-size:var(--text-3xs)">ยังไม่มีกลุ่ม</div>';
}

function addResourceCategory(){
    const name=document.getElementById('new-cat-name').value.trim();const color=document.getElementById('new-cat-color').value;
    if(!name)return toast('กรุณาใส่ชื่อหมวดหมู่');
    const cats=getResourceCats();if(cats.find(c=>c.name===name))return toast('หมวดหมู่นี้มีอยู่แล้ว');
    cats.push({id:name.toLowerCase(),name,color});set('resourceCats',cats);
    document.getElementById('new-cat-name').value='';renderResCatsList();toast('เพิ่มหมวดหมู่แล้ว');
}

function deleteResourceCat(idx){if(!confirm('ลบหมวดหมู่นี้ ?'))return;const cats=getResourceCats();cats.splice(idx,1);set('resourceCats',cats);renderResCatsList();}

function addResourceGroup(){
    const emoji=document.getElementById('new-group-emoji').value||'🌿';
    const name=document.getElementById('new-group-name').value.trim();
    const desc=document.getElementById('new-group-desc').value.trim();
    const color=document.getElementById('new-group-color').value;
    if(!name)return toast('กรุณาใส่ชื่อกลุ่ม');
    const groups=getResourceGroups();const id=name.toLowerCase().replace(/\s/g,'-');
    if(groups.find(g=>g.id===id))return toast('กลุ่มนี้มีอยู่แล้ว');
    groups.push({id,name,emoji,desc,color});set('resourceGroups',groups);
    document.getElementById('new-group-name').value='';document.getElementById('new-group-desc').value='';
    renderResGroupsList();toast('เพิ่มกลุ่มแล้ว');
}

function deleteResourceGroup(idx){
    if(!confirm('ลบกลุ่มนี้ ?'))return;
    const groups=getResourceGroups();const groupId=groups[idx].id;groups.splice(idx,1);set('resourceGroups',groups);
    const resources=getResources();resources.forEach(r=>{if(r.group===groupId)r.group='';});set('resources',resources);
    renderResGroupsList();renderResources();
}

function editGroup(groupId){
    const groups=getResourceGroups();const g=groups.find(x=>x.id===groupId);if(!g)return;
    const newName=prompt('ชื่อกลุ่มใหม่ :',g.name);
    if(newName&&newName.trim()){g.name=newName.trim();set('resourceGroups',groups);renderResources();}
}

function resetResourceData(){
    if(!confirm('รีเซ็ตแหล่งเรียนรู้ทั้งหมดเป็นค่าเริ่มต้น ?'))return;
    set('resources',getDefaultResources());set('resourceCats',getDefaultResourceCats());set('resourceGroups',getDefaultResourceGroups());
    currentResourceCat='ทั้งหมด';renderResCatsList();renderResGroupsList();renderResources();toast('รีเซ็ตแล้ว');
}

function exportResources(){
    const resources=getResources();
    const data={resources,exportedAt:new Date().toISOString(),version:'1.0'};
    const json=JSON.stringify(data,null,2);
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    const username=getUsername()||'user';
    const safeUsername=username.replace(/[^a-zA-Z0-9ก-๙]/g,'_');
    a.href=url;a.download='juz-amma-resources_'+safeUsername+'_'+new Date().toISOString().split('T')[0]+'.json';
    a.click();URL.revokeObjectURL(url);
    toast('ส่งออกสำเร็จ !');
}

function importResources(){
    const input=document.createElement('input');
    input.type='file';input.accept='.json';
    input.onchange=e=>{
        const file=e.target.files[0];if(!file)return;
        const reader=new FileReader();
        reader.onload=ev=>{
            try{
                const data=JSON.parse(ev.target.result);
                if(!data.resources||!Array.isArray(data.resources)){toast('ไฟล์ไม่ถูกต้อง');return;}
                const currentRes=getResources();
                let added=0;
                data.resources.forEach(newRes=>{
                    const exists=currentRes.some(r=>r.url===newRes.url&&r.name===newRes.name);
                    if(!exists){currentRes.push(newRes);added++;}
                });
                set('resources',currentRes);
                renderResources();
                toast(`นำเข้าสำเร็จ ! เพิ่ม ${added} รายการ`);
            }catch(err){toast('ไม่สามารถอ่านไฟล์ได้');}
        };
        reader.readAsText(file);
    };
    input.click();
}

function switchKnowTab(tab,btn){
    document.querySelectorAll('.know-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.know-content').forEach(c=>c.style.display='none');
    btn.classList.add('active');
    document.getElementById('know-content-'+tab).style.display='block';
    if(tab==='resources')renderResources();
    if(tab==='names')renderNamesFullSection();
    if(tab==='habits')renderHabitsFullSection();
    if(tab==='surah')renderSurahKnowledge();
    if(tab==='overview'||tab==='random')renderKnowledge();
}

function renderNamesFullSection(){
    let allNames=[];
    // รวมจาก SURAHS
    SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names&&d.names.length){d.names.forEach((n,i)=>allNames.push({...n,surahName:s.name,surahNum:s.n,nameIdx:i,isPlus:false}));}});
    // รวมจาก PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names&&d.names.length){d.names.forEach((n,i)=>allNames.push({...n,surahName:s.name+' (Plus)',surahNum:s.n,nameIdx:i,isPlus:true}));}});
    
    const container=document.getElementById('know-names-full-section');if(!container)return;
    if(allNames.length===0){container.innerHTML='<div style="text-align:center;color:var(--txt3);padding:var(--sp-4);font-size:var(--text-2xs)">ยังไม่มีพระนามที่บันทึก</div>';return;}
    
    // รวมพระนามที่ซ้ำกัน
    const uniqueNames={};
    allNames.forEach(n=>{
        if(!uniqueNames[n.name]){
            uniqueNames[n.name]={...n,sources:[{surahName:n.surahName,surahNum:n.surahNum,nameIdx:n.nameIdx,isPlus:n.isPlus,meaning:n.meaning,lesson:n.lesson,dua:n.dua,ayah:n.ayah}]};
        }else{
            uniqueNames[n.name].sources.push({surahName:n.surahName,surahNum:n.surahNum,nameIdx:n.nameIdx,isPlus:n.isPlus,meaning:n.meaning,lesson:n.lesson,dua:n.dua,ayah:n.ayah});
            if(!uniqueNames[n.name].meaning&&n.meaning)uniqueNames[n.name].meaning=n.meaning;
            if(!uniqueNames[n.name].lesson&&n.lesson)uniqueNames[n.name].lesson=n.lesson;
            if(!uniqueNames[n.name].dua&&n.dua)uniqueNames[n.name].dua=n.dua;
        }
    });
    const mergedNames=Object.values(uniqueNames);
    
    // รวบรวมทุกความหมายจากทุก source
    mergedNames.forEach(n=>{
        const allMeanings=[];
        n.sources.forEach(s=>{
            if(s.meaning&&!allMeanings.includes(s.meaning)){
                allMeanings.push(s.meaning);
            }
        });
        n.allMeanings=allMeanings;
    });
    
    container.innerHTML=`<div class="flip-card-container">${mergedNames.map((n,idx)=>`
        <div class="flip-card" onclick="toggleFlipCard(this)" data-idx="${idx}">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <div class="name-ar">${n.name}</div>
                    ${n.sources.length>1?`<div style="font-size:8px;color:var(--pink);opacity:0.7;margin-top:4px">${n.sources.length} ซูเราะฮ์</div>`:''}
                    <div class="flip-card-more" onclick="event.stopPropagation();showNameModalAll('${n.name.replace(/'/g,"\\'")}')"><svg viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
                </div>
                <div class="flip-card-back">
                    <div class="name-meaning">${n.allMeanings.length>0?n.allMeanings.join(' / '):'ไม่มีความหมาย'}</div>
                    <div class="flip-card-more" onclick="event.stopPropagation();showNameModalAll('${n.name.replace(/'/g,"\\'")}')"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
                </div>
            </div>
        </div>
    `).join('')}</div>`;
}

// ป๊อปอัพพระนามแสดงทุกซูเราะฮ์
function showNameModalAll(name){
    const allItems=[];
    // รวมจาก SURAHS
    SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names){d.names.forEach((n,idx)=>{if(n.name===name)allItems.push({...n,surah:s.name,surahNum:s.n,nameIdx:idx,isPlus:false});});}});
    // รวมจาก PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names){d.names.forEach((n,idx)=>{if(n.name===name)allItems.push({...n,surah:s.name+' (Plus)',surahNum:s.n,nameIdx:idx,isPlus:true});});}});
    
    if(allItems.length===0)return;
    const firstItem=allItems[0];
    
    document.getElementById('modal-name-title').innerHTML=`
        <span style="font-family:'Amiri',serif;font-size:1.6rem;color:var(--pink);display:block;text-align:center">${name}</span>
        <div style="font-size:0.62rem;color:var(--pri);text-align:center;margin-top:4px">${firstItem.meaning||''}</div>
        ${allItems.length>1?`<div style="font-size:0.5rem;color:var(--txt3);text-align:center;margin-top:2px">ปรากฏใน ${allItems.length} ซูเราะฮ์</div>`:''}
    `;
    
    document.getElementById('modal-name-body').innerHTML=allItems.map(x=>`
        <div style="font-size:0.5rem;color:var(--txt3);margin-bottom:6px;padding:4px 8px;background:var(--pink-ll);border-radius:var(--r-xs);display:inline-block">${x.surah} : อายะฮ์ ${x.ayah||'-'}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
            ${x.lesson?`<div style="background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:10px">
                <div style="font-size:0.48rem;color:var(--pink);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>ความรู้
                </div>
                <div style="font-size:0.55rem;line-height:1.5;color:var(--txt)">${x.lesson}</div>
            </div>`:'<div></div>'}
            ${x.dua?`<div style="background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-sm);padding:10px">
                <div style="font-size:0.48rem;color:var(--pink);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:4px">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--pink)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>ดุอาอ์/นิสัย
                </div>
                <div style="font-size:0.55rem;line-height:1.5;color:var(--txt)">${x.dua}</div>
            </div>`:'<div></div>'}
        </div>
    `).join('');
    openModal('name');
}

function toggleFlipCard(el){el.classList.toggle('flipped');}

// Flashcard Mode for Names
let fcNames=[],fcIndex=0,fcFlipped=false,fcFrontField='name',fcBackField='meaning';
let fcSpacedData={},nameFcShowSettings=false;
let nameFcMode='all'; // new, all, review

function toggleNameFcSettings(e){
    if(e)e.stopPropagation();
    nameFcShowSettings=!nameFcShowSettings;
    document.getElementById('name-fc-settings-panel').classList.toggle('show',nameFcShowSettings);
}

function closeNameFcSettingsOnClick(e){
    if(nameFcShowSettings && !e.target.closest('.fc-settings-panel') && !e.target.closest('.fc-toggle-btn')){
        nameFcShowSettings=false;
        document.getElementById('name-fc-settings-panel')?.classList.remove('show');
    }
}

// คำนวณว่าการ์ดพระนามถึงเวลาทบทวนหรือยัง
function isNameDueForReview(spData){
    if(!spData||!spData.lastReview)return false;
    const lastReview=new Date(spData.lastReview);
    const now=new Date();
    const daysSince=Math.floor((now-lastReview)/(1000*60*60*24));
    const interval=spData.interval||1;
    return daysSince>=interval;
}

function setNameFcMode(mode){
    nameFcMode=mode;
    closeFlashcard();
    openNamesFlashcard();
}

function openNamesFlashcard(){
    let allNames=[];
    const userTexts=get('userAyahTexts',{});
    const ayahHighlights=get('ayahHighlights',{});
    
    // ฟังก์ชันดึงตัวบท พร้อมไฮไลท์
    function getArText(surahNum,ayahNum){
        const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
        const surahKey=isPlus?surahNum:String(surahNum);
        const arKey=surahKey+'-'+ayahNum;
        
        // 1. ถ้ามี highlight ใช้ highlight
        if(ayahHighlights[arKey])return ayahHighlights[arKey];
        // 2. ถ้าผู้ใช้บันทึก
        if(userTexts[surahKey]&&userTexts[surahKey][ayahNum])return userTexts[surahKey][ayahNum];
        if(isPlus){
            const s=PLUS_SURAHS.find(x=>x.n===surahNum);
            if(s&&s.verses){
                const v=s.verses.find(x=>String(x.num)===String(ayahNum));
                if(v)return v.ar;
            }
        }else{
            if(QURAN_VERSES[surahNum]&&QURAN_VERSES[surahNum][parseInt(ayahNum)]){
                return QURAN_VERSES[surahNum][parseInt(ayahNum)];
            }
        }
        return '';
    }
    
    // รวมจาก SURAHS
    SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names&&d.names.length){d.names.forEach((n,i)=>{
        const arText=getArText(s.n,n.ayah);
        allNames.push({...n,surahName:s.name,surahNum:s.n,nameIdx:i,isPlus:false,arText:arText});
    });}});
    // รวมจาก PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.names&&d.names.length){d.names.forEach((n,i)=>{
        const arText=getArText(s.n,n.ayah);
        allNames.push({...n,surahName:s.name+' (Plus)',surahNum:s.n,nameIdx:i,isPlus:true,arText:arText});
    });}});
    
    // รวมพระนามที่ซ้ำกัน
    const uniqueNames={};
    allNames.forEach(n=>{
        const nameKey=n.name.trim();
        if(!uniqueNames[nameKey]){
            uniqueNames[nameKey]={
                name:n.name,
                meaning:n.meaning||'',
                lesson:n.lesson||'',
                dua:n.dua||'',
                arText:n.arText||'',
                sources:[{surahName:n.surahName,surahNum:n.surahNum,nameIdx:n.nameIdx,isPlus:n.isPlus,ayah:n.ayah,meaning:n.meaning,lesson:n.lesson,dua:n.dua,arText:n.arText}],
                key:nameKey
            };
        }else{
            uniqueNames[nameKey].sources.push({surahName:n.surahName,surahNum:n.surahNum,nameIdx:n.nameIdx,isPlus:n.isPlus,ayah:n.ayah,meaning:n.meaning,lesson:n.lesson,dua:n.dua,arText:n.arText});
            // รวมข้อมูลที่มี
            if(n.meaning&&!uniqueNames[nameKey].meaning)uniqueNames[nameKey].meaning=n.meaning;
            if(n.lesson&&!uniqueNames[nameKey].lesson)uniqueNames[nameKey].lesson=n.lesson;
            if(n.dua&&!uniqueNames[nameKey].dua)uniqueNames[nameKey].dua=n.dua;
            if(n.arText&&!uniqueNames[nameKey].arText)uniqueNames[nameKey].arText=n.arText;
        }
    });
    const mergedNames=Object.values(uniqueNames);
    
    fcSpacedData=get('fcSpacedData',{});
    const nameWrongHistory=get('nameWrongHistory',{});
    
    // นับจำนวนการ์ดแต่ละประเภท
    const newCount=mergedNames.filter(n=>!fcSpacedData[n.key]||!fcSpacedData[n.key].reviewed).length;
    const reviewCount=mergedNames.filter(n=>{
        const sp=fcSpacedData[n.key];
        if(!sp||!sp.reviewed)return false;
        const wrongCount=nameWrongHistory[n.key]||0;
        return wrongCount>=2||isNameDueForReview(sp);
    }).length;
    
    // Filter by mode
    if(nameFcMode==='new'){
        fcNames=mergedNames.filter(n=>!fcSpacedData[n.key]||!fcSpacedData[n.key].reviewed);
    }else if(nameFcMode==='review'){
        fcNames=mergedNames.filter(n=>{
            const sp=fcSpacedData[n.key];
            if(!sp||!sp.reviewed)return false;
            const wrongCount=nameWrongHistory[n.key]||0;
            return wrongCount>=2||isNameDueForReview(sp);
        });
        // เรียงตามความสำคัญ: ผิดบ่อยก่อน
        fcNames.sort((a,b)=>{
            const aWrong=nameWrongHistory[a.key]||0;
            const bWrong=nameWrongHistory[b.key]||0;
            if(aWrong!==bWrong)return bWrong-aWrong;
            const aDate=fcSpacedData[a.key]?.lastReview?new Date(fcSpacedData[a.key].lastReview):new Date();
            const bDate=fcSpacedData[b.key]?.lastReview?new Date(fcSpacedData[b.key].lastReview):new Date();
            return aDate-bDate;
        });
    }else{
        // all - ทั้งหมด
        fcNames=shuffleArray([...mergedNames]);
    }
    
    fcIndex=0;fcFlipped=false;
    fcResults=[];fcWrongCards=[];fcWrongCount={};fcRelearning=false;fcStartTime=Date.now();fcAnswered=[];
    
    const overlay=document.createElement('div');
    overlay.className='flashcard-overlay';overlay.id='flashcard-overlay';
    overlay.style.background='linear-gradient(180deg,#1a1a2e 0%,#16213e 100%)';
    overlay.onclick=closeNameFcSettingsOnClick;
    overlay.innerHTML=`
        <button class="flashcard-close" onclick="closeFlashcard()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        
        <div class="fc-mini-settings">
            <button class="fc-toggle-btn" onclick="toggleNameFcSettings(event)"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
            <span class="fc-count" style="font-size:var(--text-3xs)">${fcNames.length} การ์ด</span>
            <div class="fc-mode-toggle">
                <button class="fc-mode-btn ${nameFcMode==='new'?'active':''}" onclick="setNameFcMode('new')" style="font-size:var(--text-3xs)">ใหม่ (${newCount})</button>
                <button class="fc-mode-btn ${nameFcMode==='all'?'active':''}" onclick="setNameFcMode('all')" style="font-size:var(--text-3xs)">ทั้งหมด</button>
                <button class="fc-mode-btn ${nameFcMode==='review'?'active':''}" onclick="setNameFcMode('review')" style="font-size:var(--text-3xs)">ทบทวน (${reviewCount})</button>
            </div>
        </div>
        
        <div class="fc-settings-panel ${nameFcShowSettings?'show':''}" id="name-fc-settings-panel">
            <div class="fc-settings-section">
                <div class="fc-settings-title" style="font-size:var(--text-3xs)">การ์ด</div>
                <div class="fc-card-opts">
                    <span style="font-size:var(--text-3xs)">หน้า :</span>
                    <button class="fc-opt-btn ${fcFrontField==='name'?'active':''}" onclick="setFcFront('name')" style="font-size:var(--text-3xs)">พระนาม</button>
                    <button class="fc-opt-btn ${fcFrontField==='meaning'?'active':''}" onclick="setFcFront('meaning')" style="font-size:var(--text-3xs)">ความหมาย</button>
                    <button class="fc-opt-btn ${fcFrontField==='lesson'?'active':''}" onclick="setFcFront('lesson')" style="font-size:var(--text-3xs)">บทเรียน</button>
                    <button class="fc-opt-btn ${fcFrontField==='dua'?'active':''}" onclick="setFcFront('dua')" style="font-size:var(--text-3xs)">ดุอาอ์</button>
                    <button class="fc-opt-btn ${fcFrontField==='surah'?'active':''}" onclick="setFcFront('surah')" style="font-size:var(--text-3xs)">ตัวบท</button>
                </div>
                <div class="fc-card-opts" style="margin-top:6px">
                    <span style="font-size:var(--text-3xs)">หลัง :</span>
                    <button class="fc-opt-btn ${fcBackField==='name'?'active':''}" onclick="setFcBack('name')" style="font-size:var(--text-3xs)">พระนาม</button>
                    <button class="fc-opt-btn ${fcBackField==='meaning'?'active':''}" onclick="setFcBack('meaning')" style="font-size:var(--text-3xs)">ความหมาย</button>
                    <button class="fc-opt-btn ${fcBackField==='lesson'?'active':''}" onclick="setFcBack('lesson')" style="font-size:var(--text-3xs)">บทเรียน</button>
                    <button class="fc-opt-btn ${fcBackField==='dua'?'active':''}" onclick="setFcBack('dua')" style="font-size:var(--text-3xs)">ดุอาอ์</button>
                    <button class="fc-opt-btn ${fcBackField==='surah'?'active':''}" onclick="setFcBack('surah')" style="font-size:var(--text-3xs)">ตัวบท</button>
                </div>
            </div>
        </div>
        
        <div class="flashcard-progress" id="fc-progress" style="font-size:var(--text-3xs)">1 / ${fcNames.length}</div>
        <div class="flashcard-nav">
            <button class="fc-nav-btn" onclick="fcPrev()" id="fc-prev-btn"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
            <div class="flashcard-main" onclick="flipFlashcard()">
                <div class="flashcard-card" id="fc-card">
                    <div class="flashcard-face flashcard-front" style="background:linear-gradient(145deg,#fff,#fef7f9)"><div class="fc-text" id="fc-front" style="color:#c2185b;font-size:var(--text-lg)"></div></div>
                    <div class="flashcard-face flashcard-back" style="background:linear-gradient(145deg,#e57399,#f48fb1)"><div class="fc-text" id="fc-back" style="font-size:var(--text-sm)"></div></div>
                </div>
            </div>
            <button class="fc-nav-btn" onclick="fcNext()" id="fc-next-btn"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
        <div class="flashcard-controls-simple">
            <button class="fc-btn-simple wrong" onclick="rateFlashcard('hard')"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <button class="fc-btn-simple correct" onclick="rateFlashcard('easy')"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></button>
        </div>
    `;
    document.body.appendChild(overlay);renderFlashcard();
}

function fcPrev(){
    if(fcIndex>0){fcIndex--;fcFlipped=false;renderFlashcard();}
}
function fcNext(){
    if(fcIndex<fcNames.length-1){fcIndex++;fcFlipped=false;renderFlashcard();}
}

function setFcFront(val){fcFrontField=val;renderFlashcard();closeFlashcard();openNamesFlashcard();}
function setFcBack(val){fcBackField=val;renderFlashcard();closeFlashcard();openNamesFlashcard();}

let fcResults=[],fcWrongCards=[],fcStartTime=0,fcWrongCount={},fcRelearning=false;

function renderFlashcard(){
    const overlay=document.getElementById('flashcard-overlay');
    if(!overlay)return;
    
    // ถ้าไม่มีการ์ดเลย แสดงข้อความ
    if(fcNames.length===0){
        const modeText=nameFcMode==='new'?'ใหม่':nameFcMode==='review'?'ที่ต้องทบทวน':'';
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeFlashcard()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:20px">
                <div style="text-align:center;color:#fff">
                    <div style="font-size:48px;margin-bottom:16px">🎉</div>
                    <div style="font-size:var(--text-sm);font-weight:600;margin-bottom:8px">ไม่มีการ์ด${modeText}</div>
                    <div style="font-size:var(--text-2xs);opacity:0.7;margin-bottom:24px">${nameFcMode==='new'?'คุณเรียนการ์ดทั้งหมดแล้ว !':nameFcMode==='review'?'ยังไม่มีการ์ดที่ต้องทบทวน':'ยังไม่มีพระนามที่บันทึก'}</div>
                    <button onclick="setNameFcMode('all')" style="padding:12px 24px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:#fff;font-size:var(--text-2xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif">ดูการ์ดทั้งหมด</button>
                </div>
            </div>`;
        return;
    }
    
    // นับจำนวนการ์ดที่ตอบแล้ว
    const answeredCount=fcAnswered.length;
    const allAnswered=answeredCount>=fcNames.length;
    
    // ถ้ายังมีการ์ดที่ผิดค้างอยู่ และตอบครบแล้ว ให้วนทวนก่อน
    if(allAnswered&&fcWrongCards.length>0&&!fcRelearning){
        fcRelearning=true;
        fcNames=[...fcWrongCards];fcWrongCards=[];fcIndex=0;fcAnswered=[];
        document.getElementById('fc-progress').textContent='ทวนซ้ำ • '+fcNames.length+' การ์ด';
        renderFlashcard();return;
    }
    
    // ตรวจสอบว่าตอบครบหรือยัง
    if(allAnswered){
        // แสดงสรุป
        const correct=Object.values(fcResults).filter(r=>r==='correct').length;
        const wrong=Object.values(fcResults).filter(r=>r==='wrong').length;
        const total=correct+wrong;
        const percent=total>0?Math.round((correct/total)*100):0;
        const timeSpent=Math.floor((Date.now()-fcStartTime)/1000);
        const mins=Math.floor(timeSpent/60);const secs=timeSpent%60;
        const toughest=Object.entries(fcWrongCount).sort((a,b)=>b[1]-a[1]);
        const gradeColor=percent>=80?'#4caf50':percent>=50?'#ff9800':'#f44336';
        const gradeText=percent>=80?'เยี่ยมมาก !':percent>=50?'ดีขึ้นเรื่อย ๆ !':'ฝึกต่อนะ !';
        
        // สร้างหน้าสรุปใหม่ทั้งหมด
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeFlashcard()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:20px;overflow-y:auto">
                <div style="width:100%;max-width:340px;background:#fff;border-radius:24px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,0.4);max-height:calc(100vh - 100px);overflow-y:auto">
                    <div style="text-align:center">
                        <div style="width:80px;height:80px;border-radius:50%;background:${gradeColor}15;margin:0 auto 16px;display:flex;align-items:center;justify-content:center">
                            <span style="font-size:24px;font-weight:800;color:${gradeColor}">${percent}%</span>
                        </div>
                        <div style="font-size:var(--text-sm);font-weight:600;color:var(--txt);margin-bottom:4px">${gradeText}</div>
                        <div style="font-size:var(--text-2xs);color:var(--txt3)">จำได้ ${correct} จาก ${total} การ์ด</div>
                        
                        <div style="display:flex;justify-content:center;gap:20px;margin-top:20px;padding:14px;background:#f8f9fa;border-radius:14px">
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:#4caf50">${correct}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">ถูก</div></div>
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:#f44336">${wrong}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">ผิด</div></div>
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:var(--txt2)">${mins}:${secs.toString().padStart(2,'0')}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">เวลา</div></div>
                        </div>
                        
                        ${toughest.length?`<div style="margin-top:16px;text-align:left;padding:14px;background:#fff5f5;border-radius:12px;max-height:150px;overflow-y:auto">
                            <div style="font-size:var(--text-3xs);color:#f44336;margin-bottom:8px;font-weight:600">การ์ดที่ยาก (${toughest.length})</div>
                            ${toughest.map(([name,count])=>`<div style="font-size:var(--text-2xs);color:var(--txt);padding:5px 0;border-bottom:1px solid #fee;display:flex;justify-content:space-between;align-items:center"><span>${name}</span><span style="color:#f44336;font-weight:600;font-size:var(--text-3xs)">${count}x</span></div>`).join('')}
                        </div>`:''}
                        
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
                            ${wrong>0?`<button onclick="retestWrong()" style="width:100%;padding:14px;background:linear-gradient(135deg,#f44336,#e91e63);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:var(--text-2xs);font-weight:600;box-shadow:0 4px 15px rgba(244,67,54,0.3);font-family:'Noto Sans Thai',sans-serif">ทวนเฉพาะที่ผิด (${wrong})</button>`:''}
                            <button onclick="restartFlashcard()" style="width:100%;padding:14px;background:linear-gradient(135deg,#e57399,#f48fb1);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:var(--text-2xs);font-weight:600;box-shadow:0 4px 15px rgba(229,115,153,0.3);font-family:'Noto Sans Thai',sans-serif">เริ่มใหม่ทั้งหมด</button>
                        </div>
                    </div>
                </div>
            </div>`;
        return;
    }
    
    // แสดงการ์ดปกติ
    const n=fcNames[fcIndex];
    const isCurrentAnswered=fcAnswered.includes(fcIndex);
    const progressText=fcRelearning?`ทวนซ้ำ ${answeredCount}/${fcNames.length}`:`${answeredCount} / ${fcNames.length} ตอบแล้ว`;
    document.getElementById('fc-progress').textContent=progressText;
    
    // รวบรวมข้อมูลทุกซูเราะ
    const allSurahs=n.sources?n.sources.map(s=>s.surahName).join(', '):(n.surahName||'');
    const allAyahs=n.sources?n.sources.map(s=>s.surahName+' : '+s.ayah).join(' | '):'';
    
    // รวมตัวบทจากทุกซูเราะ
    let allArTexts=[];
    if(n.sources){
        n.sources.forEach(s=>{
            if(s.arText)allArTexts.push({surah:s.surahName,text:s.arText});
        });
    }else if(n.arText){
        allArTexts.push({surah:n.surahName,text:n.arText});
    }
    
    // รวมความหมาย/บทเรียน/ดุอาอ์จากทุกซูเราะ
    let allMeanings=[], allLessons=[], allDuas=[];
    if(n.sources){
        n.sources.forEach(s=>{
            if(s.meaning&&!allMeanings.includes(s.meaning))allMeanings.push(s.meaning);
            if(s.lesson&&!allLessons.includes(s.lesson))allLessons.push(s.lesson);
            if(s.dua&&!allDuas.includes(s.dua))allDuas.push(s.dua);
        });
    }
    
    // ดึงค่าตาม field
    let frontVal='', backVal='';
    
    // หน้า
    if(fcFrontField==='surah'){
        if(allArTexts.length>0){
            frontVal=`<div style="direction:rtl;text-align:right;font-family:'Amiri',serif;font-size:1.1rem;line-height:2">${allArTexts.map(a=>`<div style="margin-bottom:8px">${a.text}<div style="font-size:0.5rem;color:rgba(194,24,91,0.7);direction:ltr;text-align:center;margin-top:2px">${a.surah}</div></div>`).join('')}</div>`;
        }else{
            frontVal=`<div style="font-size:0.7rem;color:var(--txt3)">ไม่มีตัวบท</div>`;
        }
    }else if(fcFrontField==='meaning'){
        frontVal=`<span style="font-size:1rem">${allMeanings.length>0?allMeanings.join(' / '):'-'}</span>`;
    }else if(fcFrontField==='lesson'){
        frontVal=`<span style="font-size:0.8rem;line-height:1.6">${allLessons.length>0?allLessons.join('<br><br>'):'-'}</span>`;
    }else if(fcFrontField==='dua'){
        frontVal=`<span style="font-size:0.8rem;line-height:1.6">${allDuas.length>0?allDuas.join('<br><br>'):'-'}</span>`;
    }else{
        // name - แสดงพระนามและซูเราะที่ปรากฏ
        frontVal=`<span style="font-size:1.5rem;font-weight:600">${n.name||'-'}</span>`;
        if(n.sources&&n.sources.length>1){
            frontVal+=`<div style="font-size:0.5rem;color:rgba(194,24,91,0.7);margin-top:6px">${n.sources.length} ซูเราะฮ์</div>`;
        }
    }
    
    // หลัง
    if(fcBackField==='surah'){
        if(allArTexts.length>0){
            backVal=`<div style="direction:rtl;text-align:right;font-family:'Amiri',serif;font-size:1rem;line-height:2">${allArTexts.map(a=>`<div style="margin-bottom:6px">${a.text}<div style="font-size:0.45rem;color:rgba(255,255,255,0.7);direction:ltr;text-align:center;margin-top:2px">${a.surah}</div></div>`).join('')}</div>`;
        }else{
            backVal=`<div style="font-size:0.7rem">ไม่มีตัวบท</div>`;
        }
    }else if(fcBackField==='meaning'){
        backVal=`<span style="font-size:var(--text-sm)">${allMeanings.length>0?allMeanings.join(' / '):'-'}</span>`;
        if(n.sources&&n.sources.length>1){
            backVal+=`<div style="font-size:0.4rem;opacity:0.8;margin-top:6px">${allSurahs}</div>`;
        }
    }else if(fcBackField==='lesson'){
        backVal=`<span style="font-size:0.7rem;line-height:1.5">${allLessons.length>0?allLessons.join('<br><br>'):'-'}</span>`;
    }else if(fcBackField==='dua'){
        backVal=`<span style="font-size:0.7rem;line-height:1.5">${allDuas.length>0?allDuas.join('<br><br>'):'-'}</span>`;
    }else{
        // name
        backVal=`<span style="font-size:1.3rem;font-weight:600">${n.name||'-'}</span>`;
        if(n.sources&&n.sources.length>1){
            backVal+=`<div style="font-size:0.4rem;opacity:0.8;margin-top:6px">${allSurahs}</div>`;
        }
    }
    
    document.getElementById('fc-front').innerHTML=frontVal;
    document.getElementById('fc-back').innerHTML=backVal;
    document.getElementById('fc-card').classList.remove('flipped');fcFlipped=false;
    
    // Update nav buttons
    const prevBtn=document.getElementById('fc-prev-btn');
    const nextBtn=document.getElementById('fc-next-btn');
    if(prevBtn)prevBtn.disabled=fcIndex===0;
    if(nextBtn)nextBtn.disabled=fcIndex>=fcNames.length-1;
}

function restartFlashcard(){
    closeFlashcard();
    setTimeout(()=>openNamesFlashcard(),100);
}

function retestWrong(){
    const wrongNames=fcResults.map((r,i)=>r==='wrong'?fcNames[i]:null).filter(n=>n);
    if(wrongNames.length===0)return;
    closeFlashcard();
    setTimeout(()=>{
        fcNames=wrongNames;fcIndex=0;fcResults=[];fcWrongCards=[];fcRelearning=true;fcStartTime=Date.now();
        
        const overlay=document.createElement('div');
        overlay.className='flashcard-overlay';overlay.id='flashcard-overlay';
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeFlashcard()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div class="fc-mini-settings">
                <span class="fc-count" style="font-size:var(--text-2xs)">ทวนซ้ำ ${fcNames.length} การ์ด</span>
            </div>
            <div class="flashcard-progress" id="fc-progress" style="font-size:var(--text-2xs)">1 / ${fcNames.length}</div>
            <div class="flashcard-main" onclick="flipFlashcard()">
                <div class="flashcard-card" id="fc-card">
                    <div class="flashcard-face flashcard-front" style="background:linear-gradient(145deg,#fff,#fef7f9)"><div class="fc-text" id="fc-front" style="color:#c2185b"></div></div>
                    <div class="flashcard-face flashcard-back" style="background:linear-gradient(145deg,#e57399,#f48fb1)"><div class="fc-text" id="fc-back" style="color:#fff"></div></div>
                </div>
            </div>
            <div class="flashcard-controls-simple">
                <button class="fc-btn-simple wrong" onclick="rateFlashcard('hard')"><svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                <button class="fc-btn-simple correct" onclick="rateFlashcard('easy')"><svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></button>
            </div>
        `;
        document.body.appendChild(overlay);renderFlashcard();
    },100);
}

function flipFlashcard(){
    document.getElementById('fc-card').classList.toggle('flipped');
    fcFlipped=!fcFlipped;
}

// Track ว่าการ์ดไหนตอบแล้ว
let fcAnswered=[];

function rateFlashcard(rating){
    const n=fcNames[fcIndex];
    const isWrong=rating==='hard';
    
    // Mark as answered
    if(!fcAnswered.includes(fcIndex)){
        fcAnswered.push(fcIndex);
        fcResults[fcIndex]=isWrong?'wrong':'correct';
    }else{
        fcResults[fcIndex]=isWrong?'wrong':'correct';
    }
    
    // ถ้าตอบผิด ให้เก็บการ์ดไว้ทวนซ้ำ และนับจำนวนครั้ง
    if(isWrong){
        if(!fcWrongCards.find(c=>c.key===n.key))fcWrongCards.push(n);
        fcWrongCount[n.name]=(fcWrongCount[n.name]||0)+1;
        // บันทึก wrongHistory
        const nameWrongHistory=get('nameWrongHistory',{});
        nameWrongHistory[n.key]=(nameWrongHistory[n.key]||0)+1;
        set('nameWrongHistory',nameWrongHistory);
    }
    
    if(!fcSpacedData[n.key])fcSpacedData[n.key]={interval:1,reviewed:false};
    const data=fcSpacedData[n.key];
    data.lastReview=new Date().toISOString();
    data.reviewed=true;
    data.correct=!isWrong;
    
    // คำนวณ interval ใหม่ตามหลัก Spaced Repetition
    if(isWrong){
        data.interval=1; // reset เป็น 1 วัน
    }else{
        // ถ้าถูก ให้เพิ่ม interval (1 -> 3 -> 7 -> 14 -> 30 -> 60)
        const currentInterval=data.interval||1;
        const nextIntervals={1:3,3:7,7:14,14:30,30:60,60:90};
        data.interval=nextIntervals[currentInterval]||Math.min(currentInterval*2,90);
    }
    
    set('fcSpacedData',fcSpacedData);
    
    // หาการ์ดถัดไปที่ยังไม่ได้ตอบ
    let nextUnanswered=-1;
    for(let i=0;i<fcNames.length;i++){
        if(!fcAnswered.includes(i)){
            nextUnanswered=i;
            break;
        }
    }
    
    if(nextUnanswered>=0){
        fcIndex=nextUnanswered;
    }else{
        fcIndex=fcNames.length; // ไปหน้าสรุป
    }
    renderFlashcard();
}

function closeFlashcard(){document.getElementById('flashcard-overlay')?.remove();}
function shuffleArray(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

// Flashcard Mode for Random Knowledge
let randomFcData=[],randomFcIdx=0,randomSpaced={};
let fcSettings={types:['notes','meanings','tafsirs','overview','reasons','stories'],surahs:[],front:'source',back:'text',mode:'all'};
let fcShowSettings=false;

// คำนวณว่าการ์ดถึงเวลาทบทวนหรือยัง (Spaced Repetition)
function isDueForReview(spData){
    if(!spData||!spData.lastReview)return false;
    const lastReview=new Date(spData.lastReview);
    const now=new Date();
    const daysSince=Math.floor((now-lastReview)/(1000*60*60*24));
    // ถ้าตอบผิดครั้งล่าสุด ให้ทบทวนทันที
    if(spData.correct===false)return true;
    // ใช้ interval หรือค่าเริ่มต้น 1 วัน
    const interval=spData.interval||1;
    return daysSince>=interval;
}

// นับจำนวนครั้งที่ผิด
function getWrongCount(key){
    const rfcWrongHistory=get('rfcWrongHistory',{});
    return rfcWrongHistory[key]||0;
}

function openFlashcardMode(){
    let allNotes=[];
    
    // รวม SURAHS - ใช้ QURAN_VERSES สำหรับตัวบทอาหรับ
    SURAHS.forEach(s=>{const d=getSurah(s.n);
        ['notes','meanings','tafsirs'].forEach(key=>{if(d[key]){Object.keys(d[key]).forEach(ayah=>{
            // หาตัวบทอาหรับจาก QURAN_VERSES
            let arText='';
            if(QURAN_VERSES[s.n]&&QURAN_VERSES[s.n][ayah])arText=QURAN_VERSES[s.n][ayah];
            if(d[key][ayah]){allNotes.push({type:key,text:d[key][ayah],surah:s.name,surahNum:s.n,ayah,key:s.n+'-'+key+'-'+ayah,isPlus:false,arText});}
        });}});
        if(d.overview)allNotes.push({type:'overview',text:d.overview,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-overview',isPlus:false});
        if(d.reasons)allNotes.push({type:'reasons',text:d.reasons,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-reasons',isPlus:false});
        if(d.stories)allNotes.push({type:'stories',text:d.stories,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-stories',isPlus:false});
    });
    
    // รวม PLUS_SURAHS
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);
        ['notes','meanings','tafsirs'].forEach(key=>{if(d[key]){Object.keys(d[key]).forEach(ayah=>{
            // หาตัวบทอาหรับถ้ามี
            let arText='';
            if(s.verses){const v=s.verses.find(x=>String(x.num)===String(ayah));if(v)arText=v.ar;}
            if(d[key][ayah]){allNotes.push({type:key,text:d[key][ayah],surah:s.name,surahNum:s.n,ayah,key:s.n+'-'+key+'-'+ayah,isPlus:true,arText});}
        });}});
        if(d.overview)allNotes.push({type:'overview',text:d.overview,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-overview',isPlus:true});
        if(d.reasons)allNotes.push({type:'reasons',text:d.reasons,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-reasons',isPlus:true});
        if(d.stories)allNotes.push({type:'stories',text:d.stories,surah:s.name,surahNum:s.n,ayah:'-',key:s.n+'-stories',isPlus:true});
    });
    
    randomSpaced=get('randomSpaced',{});
    const rfcWrongHistory=get('rfcWrongHistory',{});
    
    // Filter by settings (type และ surah)
    let filteredNotes=allNotes.filter(n=>fcSettings.types.includes(n.type));
    if(fcSettings.surahs.length>0)filteredNotes=filteredNotes.filter(n=>fcSettings.surahs.includes(n.surahNum));
    
    // นับจำนวนการ์ดแต่ละประเภท
    const newCount=filteredNotes.filter(n=>!randomSpaced[n.key]||!randomSpaced[n.key].reviewed).length;
    const reviewCount=filteredNotes.filter(n=>{
        const sp=randomSpaced[n.key];
        if(!sp||!sp.reviewed)return false;
        // การ์ดที่ผิดบ่อย (wrongCount >= 2) หรือถึงเวลาทบทวน
        const wrongCount=rfcWrongHistory[n.key]||0;
        return wrongCount>=2||isDueForReview(sp);
    }).length;
    
    // Filter by mode
    if(fcSettings.mode==='new'){
        randomFcData=filteredNotes.filter(n=>!randomSpaced[n.key]||!randomSpaced[n.key].reviewed);
    }else if(fcSettings.mode==='review'){
        randomFcData=filteredNotes.filter(n=>{
            const sp=randomSpaced[n.key];
            if(!sp||!sp.reviewed)return false;
            const wrongCount=rfcWrongHistory[n.key]||0;
            return wrongCount>=2||isDueForReview(sp);
        });
        // เรียงตามความสำคัญ: ผิดบ่อยก่อน แล้วค่อยตามวันที่เก่า
        randomFcData.sort((a,b)=>{
            const aWrong=rfcWrongHistory[a.key]||0;
            const bWrong=rfcWrongHistory[b.key]||0;
            if(aWrong!==bWrong)return bWrong-aWrong;
            const aDate=randomSpaced[a.key]?.lastReview?new Date(randomSpaced[a.key].lastReview):new Date();
            const bDate=randomSpaced[b.key]?.lastReview?new Date(randomSpaced[b.key].lastReview):new Date();
            return aDate-bDate;
        });
    }else{
        // all - ทั้งหมด
        randomFcData=[...filteredNotes];
        // สลับแบบสุ่ม
        shuffleArray(randomFcData);
    }
    
    randomFcIdx=0;rfcResults=[];rfcWrongCards=[];rfcWrongCount={};rfcRelearning=false;rfcStartTime=Date.now();
    
    // Get surahs that have notes
    const surahsWithNotes=[...new Set(allNotes.map(n=>n.surahNum))];
    const juzAmmaSurahs=surahsWithNotes.filter(sn=>typeof sn==='number');
    const plusSurahsWithNotes=surahsWithNotes.filter(sn=>typeof sn==='string'&&sn.startsWith('p'));
    
    const overlay=document.createElement('div');
    overlay.className='flashcard-overlay';overlay.id='random-fc-overlay';
    overlay.style.background='linear-gradient(180deg,#1a1a2e 0%,#16213e 100%)';
    overlay.onclick=closeFcSettingsOnClick;
    overlay.innerHTML=`
        <button class="flashcard-close" onclick="closeRandomFc()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        
        <div class="fc-mini-settings">
            <button class="fc-toggle-btn" onclick="toggleFcSettings(event)"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
            <span class="fc-count" style="font-size:var(--text-3xs)">${randomFcData.length} การ์ด</span>
            <div class="fc-mode-toggle">
                <button class="fc-mode-btn ${fcSettings.mode==='new'?'active':''}" onclick="setFcMode2('new')" style="font-size:var(--text-3xs)">ใหม่ (${newCount})</button>
                <button class="fc-mode-btn ${fcSettings.mode==='all'?'active':''}" onclick="setFcMode2('all')" style="font-size:var(--text-3xs)">ทั้งหมด</button>
                <button class="fc-mode-btn ${fcSettings.mode==='review'?'active':''}" onclick="setFcMode2('review')" style="font-size:var(--text-3xs)">ทบทวน (${reviewCount})</button>
            </div>
        </div>
        
        <div class="fc-settings-panel ${fcShowSettings?'show':''}" id="fc-settings-panel">
            <div class="fc-settings-section">
                <div class="fc-settings-title" style="font-size:var(--text-3xs)">เลือกซูเราะฮ์</div>
                <div class="fc-surah-grid">
                    <button class="fc-surah-btn ${fcSettings.surahs.length===0?'active':''}" onclick="selectAllSurahs()" style="font-size:var(--text-3xs)">ทั้งหมด</button>
                    ${juzAmmaSurahs.map(sn=>{
                        const s=SURAHS.find(x=>x.n===sn);
                        return `<button class="fc-surah-btn ${fcSettings.surahs.includes(sn)?'active':''}" onclick="toggleFcSurah(${sn})" style="font-size:var(--text-3xs)">${s.name}</button>`;
                    }).join('')}
                </div>
                ${plusSurahsWithNotes.length>0?`
                <div class="fc-settings-title" style="font-size:var(--text-3xs);margin-top:8px">Plus</div>
                <div class="fc-surah-grid">
                    ${plusSurahsWithNotes.map(sn=>{
                        const s=PLUS_SURAHS.find(x=>x.n===sn);
                        return `<button class="fc-surah-btn ${fcSettings.surahs.includes(sn)?'active':''}" onclick="toggleFcSurah('${sn}')" style="font-size:var(--text-3xs)">${s.name}</button>`;
                    }).join('')}
                </div>
                `:''}
            </div>
            <div class="fc-settings-section">
                <div class="fc-settings-title" style="font-size:var(--text-3xs)">ประเภท</div>
                <div class="fc-type-row">
                    <button class="fc-type-btn ${fcSettings.types.includes('overview')?'active':''}" onclick="toggleFcType('overview')" style="font-size:var(--text-3xs)">ภาพรวม</button>
                    <button class="fc-type-btn ${fcSettings.types.includes('reasons')?'active':''}" onclick="toggleFcType('reasons')" style="font-size:var(--text-3xs)">สาเหตุ</button>
                    <button class="fc-type-btn ${fcSettings.types.includes('stories')?'active':''}" onclick="toggleFcType('stories')" style="font-size:var(--text-3xs)">นบี</button>
                    <button class="fc-type-btn ${fcSettings.types.includes('notes')?'active':''}" onclick="toggleFcType('notes')" style="font-size:var(--text-3xs)">ความรู้</button>
                    <button class="fc-type-btn ${fcSettings.types.includes('meanings')?'active':''}" onclick="toggleFcType('meanings')" style="font-size:var(--text-3xs)">ความหมาย</button>
                    <button class="fc-type-btn ${fcSettings.types.includes('tafsirs')?'active':''}" onclick="toggleFcType('tafsirs')" style="font-size:var(--text-3xs)">ตัฟซีร</button>
                </div>
            </div>
            <div class="fc-settings-section">
                <div class="fc-settings-title" style="font-size:var(--text-3xs)">การ์ด</div>
                <div class="fc-card-opts">
                    <span style="font-size:var(--text-3xs)">หน้า :</span>
                    <button class="fc-opt-btn ${fcSettings.front==='source'?'active':''}" onclick="setRfcFront('source')" style="font-size:var(--text-3xs)">ที่มา</button>
                    <button class="fc-opt-btn ${fcSettings.front==='text'?'active':''}" onclick="setRfcFront('text')" style="font-size:var(--text-3xs)">เนื้อหา</button>
                    <span style="margin-left:8px;font-size:var(--text-3xs)">หลัง :</span>
                    <button class="fc-opt-btn ${fcSettings.back==='text'?'active':''}" onclick="setRfcBack('text')" style="font-size:var(--text-3xs)">เนื้อหา</button>
                    <button class="fc-opt-btn ${fcSettings.back==='source'?'active':''}" onclick="setRfcBack('source')" style="font-size:var(--text-3xs)">ที่มา</button>
                </div>
            </div>
        </div>
        
        <div class="flashcard-progress" id="rfc-progress" style="font-size:var(--text-3xs)">1 / ${randomFcData.length}</div>
        <div class="flashcard-main" onclick="flipRandomFc()">
            <div class="flashcard-card" id="rfc-card">
                <div class="flashcard-face flashcard-front" style="padding:20px;background:linear-gradient(145deg,#fff,#f8f4ff)">
                    <div id="rfc-type" style="font-size:9px;padding:3px 10px;border-radius:var(--r-full);background:var(--pri);color:#fff;margin-bottom:8px"></div>
                    <div id="rfc-front-text" style="font-size:13px;color:var(--txt);font-weight:500;text-align:center;line-height:1.5"></div>
                </div>
                <div class="flashcard-face flashcard-back" style="background:linear-gradient(145deg,var(--pri),#7c4dff);padding:20px">
                    <div class="fc-text" id="rfc-back-text" style="font-size:12px;line-height:1.6;text-align:left"></div>
                </div>
            </div>
        </div>
        <div class="flashcard-controls-simple">
            <button class="fc-btn-simple wrong" onclick="rateRandomFc('wrong')"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <button class="fc-btn-simple correct" onclick="rateRandomFc('correct')"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button>
        </div>
    `;
    document.body.appendChild(overlay);
    renderRandomFc();
}

function toggleFcSettings(e){
    if(e)e.stopPropagation();
    fcShowSettings=!fcShowSettings;
    document.getElementById('fc-settings-panel').classList.toggle('show',fcShowSettings);
}

function closeFcSettingsOnClick(e){
    if(fcShowSettings && !e.target.closest('.fc-settings-panel') && !e.target.closest('.fc-toggle-btn')){
        fcShowSettings=false;
        document.getElementById('fc-settings-panel')?.classList.remove('show');
    }
}
function selectAllSurahs(){fcSettings.surahs=[];closeRandomFc();openFlashcardMode();}
function toggleFcSurah(sn){
    const idx=fcSettings.surahs.indexOf(sn);
    if(idx>=0)fcSettings.surahs.splice(idx,1);
    else fcSettings.surahs.push(sn);
    closeRandomFc();openFlashcardMode();
}
function setFcMode2(mode){fcSettings.mode=mode;closeRandomFc();openFlashcardMode();}
function setRfcFront(val){fcSettings.front=val;closeRandomFc();openFlashcardMode();}
function setRfcBack(val){fcSettings.back=val;closeRandomFc();openFlashcardMode();}

function toggleFcType(type){
    const idx=fcSettings.types.indexOf(type);
    if(idx>=0)fcSettings.types.splice(idx,1);
    else fcSettings.types.push(type);
    if(fcSettings.types.length===0)fcSettings.types=['notes'];
    closeRandomFc();openFlashcardMode();
}

function setFcMode(mode){
    fcSettings.mode=mode;
    closeRandomFc();openFlashcardMode();
}

let rfcResults=[],rfcWrongCards=[],rfcStartTime=0,rfcWrongCount={},rfcRelearning=false;

function renderRandomFc(){
    const overlay=document.getElementById('random-fc-overlay');
    if(!overlay)return;
    
    const typeLabels={notes:'ความรู้',meanings:'ความหมาย',tafsirs:'ตัฟซีร',overview:'ภาพรวม',reasons:'สาเหตุ',stories:'นบี/กลุ่มชน'};
    
    // ถ้าไม่มีการ์ดเลย แสดงข้อความ
    if(randomFcData.length===0){
        const modeText=fcSettings.mode==='new'?'ใหม่':fcSettings.mode==='review'?'ที่ต้องทบทวน':'';
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeRandomFc()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:20px">
                <div style="text-align:center;color:#fff">
                    <div style="font-size:48px;margin-bottom:16px">🎉</div>
                    <div style="font-size:var(--text-sm);font-weight:600;margin-bottom:8px">ไม่มีการ์ด${modeText}</div>
                    <div style="font-size:var(--text-2xs);opacity:0.7;margin-bottom:24px">${fcSettings.mode==='new'?'คุณเรียนการ์ดทั้งหมดแล้ว !':fcSettings.mode==='review'?'ยังไม่มีการ์ดที่ต้องทบทวน':'ยังไม่มีบันทึกข้อมูล'}</div>
                    <button onclick="setFcMode2('all')" style="padding:12px 24px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:#fff;font-size:var(--text-2xs);cursor:pointer;font-family:'Noto Sans Thai',sans-serif">ดูการ์ดทั้งหมด</button>
                </div>
            </div>`;
        return;
    }
    
    // ถ้ายังมีการ์ดที่ผิดค้างอยู่ ให้วนทวนก่อน
    if(randomFcIdx>=randomFcData.length&&rfcWrongCards.length>0&&!rfcRelearning){
        rfcRelearning=true;
        randomFcData=[...rfcWrongCards];rfcWrongCards=[];randomFcIdx=0;
        document.getElementById('rfc-progress').textContent='ทวนซ้ำ • '+randomFcData.length+' การ์ด';
        renderRandomFc();return;
    }
    
    if(randomFcIdx>=randomFcData.length){
        const correct=rfcResults.filter(r=>r==='correct').length;
        const wrong=rfcResults.filter(r=>r==='wrong').length;
        const total=rfcResults.length;
        const percent=total>0?Math.round((correct/total)*100):0;
        const timeSpent=Math.floor((Date.now()-rfcStartTime)/1000);
        const mins=Math.floor(timeSpent/60);const secs=timeSpent%60;
        const toughest=Object.entries(rfcWrongCount).sort((a,b)=>b[1]-a[1]);
        const gradeColor=percent>=80?'#4caf50':percent>=50?'#ff9800':'#f44336';
        const gradeText=percent>=80?'เยี่ยมมาก !':percent>=50?'ดีขึ้นเรื่อย ๆ !':'ฝึกต่อนะ !';
        
        // สร้างหน้าสรุปใหม่ทั้งหมด
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeRandomFc()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:20px;overflow-y:auto">
                <div style="width:100%;max-width:340px;background:#fff;border-radius:24px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,0.4);max-height:calc(100vh - 100px);overflow-y:auto">
                    <div style="text-align:center">
                        <div style="width:80px;height:80px;border-radius:50%;background:${gradeColor}15;margin:0 auto 16px;display:flex;align-items:center;justify-content:center">
                            <span style="font-size:24px;font-weight:800;color:${gradeColor}">${percent}%</span>
                        </div>
                        <div style="font-size:var(--text-sm);font-weight:600;color:var(--txt);margin-bottom:4px">${gradeText}</div>
                        <div style="font-size:var(--text-2xs);color:var(--txt3)">จำได้ ${correct} จาก ${total} การ์ด</div>
                        
                        <div style="display:flex;justify-content:center;gap:20px;margin-top:20px;padding:14px;background:#f8f9fa;border-radius:14px">
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:#4caf50">${correct}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">ถูก</div></div>
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:#f44336">${wrong}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">ผิด</div></div>
                            <div style="text-align:center"><div style="font-size:var(--text-sm);font-weight:700;color:var(--txt2)">${mins}:${secs.toString().padStart(2,'0')}</div><div style="font-size:var(--text-3xs);color:var(--txt3)">เวลา</div></div>
                        </div>
                        
                        ${toughest.length?`<div style="margin-top:16px;text-align:left;padding:14px;background:#fff5f5;border-radius:12px;max-height:150px;overflow-y:auto">
                            <div style="font-size:var(--text-3xs);color:#f44336;margin-bottom:8px;font-weight:600">การ์ดที่ยาก (${toughest.length})</div>
                            ${toughest.map(([name,count])=>`<div style="font-size:var(--text-2xs);color:var(--txt);padding:5px 0;border-bottom:1px solid #fee;display:flex;justify-content:space-between;align-items:center"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:8px">${name}</span><span style="color:#f44336;font-weight:600;font-size:var(--text-3xs);flex-shrink:0">${count}x</span></div>`).join('')}
                        </div>`:''}
                        
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
                            ${wrong>0?`<button onclick="retestWrongRfc()" style="width:100%;padding:14px;background:linear-gradient(135deg,#f44336,#e91e63);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:var(--text-2xs);font-weight:600;box-shadow:0 4px 15px rgba(244,67,54,0.3);font-family:'Noto Sans Thai',sans-serif">ทวนเฉพาะที่ผิด (${wrong})</button>`:''}
                            <button onclick="restartRandomFc()" style="width:100%;padding:14px;background:linear-gradient(135deg,#3b2d49,#6b5b7a);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:var(--text-2xs);font-weight:600;box-shadow:0 4px 15px rgba(59,45,73,0.3);font-family:'Noto Sans Thai',sans-serif">เริ่มใหม่ทั้งหมด</button>
                        </div>
                    </div>
                </div>
            </div>`;
        return;
    }
    
    // แสดงการ์ดปกติ
    const n=randomFcData[randomFcIdx];
    const progressText=rfcRelearning?`ทวนซ้ำ ${randomFcIdx+1}/${randomFcData.length}`:`${randomFcIdx+1} / ${randomFcData.length}`;
    document.getElementById('rfc-progress').textContent=progressText;
    document.getElementById('rfc-type').textContent=typeLabels[n.type]||n.type;
    document.getElementById('rfc-type').style.display='';
    const sourceText=`${n.surah} • อายะฮ์ ${n.ayah}`;
    
    // แสดงตัวบทอาหรับถ้ามี
    let arTextHtml='';
    if(n.arText){
        arTextHtml=`<div style="font-family:'Amiri',serif;font-size:var(--text-xs);color:var(--gold);direction:rtl;text-align:center;line-height:1.8;padding:8px;background:rgba(184,149,107,0.1);border-radius:var(--r-sm);margin:8px 0">${n.arText}</div>`;
    }
    
    document.getElementById('rfc-front-text').innerHTML=`<span style="font-size:var(--text-sm)">${fcSettings.front==='source'?sourceText:n.text}</span>${fcSettings.front==='source'?arTextHtml:''}`;
    document.getElementById('rfc-back-text').innerHTML=`${arTextHtml}<span style="font-size:var(--text-2xs)">${fcSettings.back==='text'?n.text:sourceText}</span>`;
    document.getElementById('rfc-card').classList.remove('flipped');
}

function retestWrongRfc(){
    const wrongData=rfcResults.map((r,i)=>r==='wrong'?randomFcData[i]:null).filter(n=>n);
    if(wrongData.length===0)return;
    closeRandomFc();
    setTimeout(()=>{
        randomFcData=wrongData;randomFcIdx=0;rfcResults=[];rfcWrongCards=[];rfcRelearning=true;rfcStartTime=Date.now();
        
        const overlay=document.createElement('div');
        overlay.className='flashcard-overlay';overlay.id='random-fc-overlay';
        overlay.style.background='linear-gradient(180deg,#1a1a2e 0%,#16213e 100%)';
        overlay.innerHTML=`
            <button class="flashcard-close" onclick="closeRandomFc()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <div class="fc-mini-settings">
                <span class="fc-count" style="font-size:var(--text-2xs)">ทวนซ้ำ ${randomFcData.length} การ์ด</span>
            </div>
            <div class="flashcard-progress" id="rfc-progress" style="font-size:var(--text-2xs)">1 / ${randomFcData.length}</div>
            <div class="flashcard-main" onclick="flipRandomFc()">
                <div class="flashcard-card" id="rfc-card">
                    <div class="flashcard-face flashcard-front" style="padding:20px;background:linear-gradient(145deg,#fff,#f8f4ff)">
                        <div id="rfc-type" style="font-size:9px;padding:3px 10px;border-radius:var(--r-full);background:var(--pri);color:#fff;margin-bottom:8px"></div>
                        <div id="rfc-front-text" style="font-size:13px;color:var(--txt);font-weight:500;text-align:center;line-height:1.5"></div>
                    </div>
                    <div class="flashcard-face flashcard-back" style="background:linear-gradient(145deg,var(--pri),#7c4dff);padding:20px">
                        <div class="fc-text" id="rfc-back-text" style="font-size:12px;line-height:1.6;text-align:left"></div>
                    </div>
                </div>
            </div>
            <div class="flashcard-controls-simple">
                <button class="fc-btn-simple wrong" onclick="rateRandomFc('wrong')"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                <button class="fc-btn-simple correct" onclick="rateRandomFc('correct')"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button>
            </div>
        `;
        document.body.appendChild(overlay);renderRandomFc();
    },100);
}

function restartRandomFc(){
    closeRandomFc();openFlashcardMode();
}

function resetRandomFc(){
    randomFcIdx=0;rfcResults=[];rfcWrongCards=[];rfcWrongCount={};rfcRelearning=false;rfcStartTime=Date.now();
    const controls=document.querySelector('#random-fc-overlay .flashcard-controls-simple');
    if(controls)controls.style.display='flex';
    document.getElementById('rfc-type').style.display='';
    renderRandomFc();
}

function flipRandomFc(){document.getElementById('rfc-card').classList.toggle('flipped');}

function rateRandomFc(rating){
    const n=randomFcData[randomFcIdx];
    const isWrong=rating==='wrong';
    rfcResults.push(isWrong?'wrong':'correct');
    
    // ถ้าตอบผิด ให้เก็บการ์ดไว้ทวนซ้ำ และบันทึก wrongHistory
    if(isWrong){
        rfcWrongCards.push(n);
        const key=n.surah+' '+n.ayah;
        rfcWrongCount[key]=(rfcWrongCount[key]||0)+1;
        // บันทึก wrongHistory
        const rfcWrongHistory=get('rfcWrongHistory',{});
        rfcWrongHistory[n.key]=(rfcWrongHistory[n.key]||0)+1;
        set('rfcWrongHistory',rfcWrongHistory);
    }
    
    if(!randomSpaced[n.key])randomSpaced[n.key]={reviewed:false,interval:1};
    randomSpaced[n.key].lastReview=new Date().toISOString();
    randomSpaced[n.key].reviewed=true;
    randomSpaced[n.key].correct=!isWrong;
    
    // คำนวณ interval ใหม่ตามหลัก Spaced Repetition
    if(isWrong){
        randomSpaced[n.key].interval=1; // reset เป็น 1 วัน
    }else{
        // ถ้าถูก ให้เพิ่ม interval (1 -> 3 -> 7 -> 14 -> 30 -> 60)
        const currentInterval=randomSpaced[n.key].interval||1;
        const nextIntervals={1:3,3:7,7:14,14:30,30:60,60:90};
        randomSpaced[n.key].interval=nextIntervals[currentInterval]||Math.min(currentInterval*2,90);
    }
    
    set('randomSpaced',randomSpaced);
    randomFcIdx++;renderRandomFc();
}

function closeRandomFc(){document.getElementById('random-fc-overlay')?.remove();}

function showNameDetailFromKnowledge(surahNum,nameIdx){
    const d=getSurah(surahNum);
    const isPlus=typeof surahNum==='string'&&surahNum.startsWith('p');
    const s=isPlus?PLUS_SURAHS.find(x=>x.n===surahNum):SURAHS.find(x=>x.n===surahNum);
    if(!d.names||!d.names[nameIdx])return;
    const n=d.names[nameIdx];
    document.getElementById('modal-knowledge-content').innerHTML=`
        <div style="background:linear-gradient(135deg,#e57399,#f48fb1);color:#fff;padding:14px;margin:-0px -12px 12px;border-radius:var(--r-lg) var(--r-lg) 0 0;text-align:center">
            <div style="width:36px;height:36px;background:rgba(255,255,255,0.2);border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg></div>
            <div style="font-size:0.75rem;font-weight:600">${n.name}</div>
            <div style="font-size:0.5rem;opacity:0.9">${s?s.name:''}${n.ayah?' • อายะฮ์ '+n.ayah:''}</div>
        </div>
        ${n.meaning?`<div style="margin-bottom:10px"><div style="font-size:var(--text-3xs);color:var(--txt3);margin-bottom:2px">ความหมาย</div><div style="font-size:var(--text-2xs);color:var(--txt)">${n.meaning}</div></div>`:''}
        ${n.lesson?`<div style="margin-bottom:10px"><div style="font-size:var(--text-3xs);color:var(--txt3);margin-bottom:2px">บทเรียน</div><div style="font-size:var(--text-2xs);color:var(--txt)">${n.lesson}</div></div>`:''}
        ${n.dua?`<div><div style="font-size:var(--text-3xs);color:var(--txt3);margin-bottom:2px">ดุอาอ์</div><div style="font-size:var(--text-2xs);color:var(--txt)">${n.dua}</div></div>`:''}
    `;
    openModal('knowledge');
}

function renderHabitsFullSection(){
    let allHabits=[];
    SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.habits&&d.habits.length){d.habits.forEach((h,i)=>allHabits.push({...h,surahName:s.name,surahNum:s.n,habitIdx:i,key:s.n+'-'+i,isPlus:false}));}});
    PLUS_SURAHS.forEach(s=>{const d=getSurah(s.n);if(d.habits&&d.habits.length){d.habits.forEach((h,i)=>allHabits.push({...h,surahName:s.name+' (Plus)',surahNum:s.n,habitIdx:i,key:s.n+'-'+i,isPlus:true}));}});
    const container=document.getElementById('know-habits-full-section');if(!container)return;
    if(allHabits.length===0){container.innerHTML='<div style="text-align:center;color:var(--txt3);padding:var(--sp-4);font-size:var(--text-2xs)">ยังไม่มีนิสัยที่บันทึก</div>';return;}
    
    const habitStatusData=get('habitStatusData',{});
    const statusConfig=[
        {id:0,label:'ยังไม่เริ่ม',color:'#9e9e9e'},
        {id:1,label:'วางแผน',color:'#ff9800'},
        {id:2,label:'ฝืนทน 5',color:'#f44336'},
        {id:3,label:'ฝืนทน 4',color:'#ff5722'},
        {id:4,label:'ง่ายขึ้น 3',color:'#ffc107'},
        {id:5,label:'ง่ายขึ้น 2',color:'#8bc34a'},
        {id:6,label:'เป็นนิสัย',color:'#4caf50'}
    ];
    
    allHabits.forEach(h=>{
        const data=habitStatusData[h.key]||{status:0,history:[]};
        h.statusData=data;
    });
    
    const categories=[...new Set(allHabits.map(h=>h.category||'ทั่วไป'))];
    
    // ตัวกรองหมวดหมู่ - สีจางลง ขนาดเล็ก
    let filterHtml=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">
        <button onclick="filterHabitCat(null)" style="padding:4px 10px;border:none;border-radius:16px;font-size:var(--text-3xs);cursor:pointer;background:${!window.habitCatFilter?'rgba(50,75,76,0.15)':'#f8f8f8'};color:${!window.habitCatFilter?'#324b4c':'#999'};font-weight:500;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif">ทั้งหมด</button>
        ${categories.map(c=>`<button onclick="filterHabitCat('${c}')" style="padding:4px 10px;border:none;border-radius:16px;font-size:var(--text-3xs);cursor:pointer;background:${window.habitCatFilter===c?'rgba(50,75,76,0.15)':'#f8f8f8'};color:${window.habitCatFilter===c?'#324b4c':'#999'};font-weight:500;transition:all 0.2s;font-family:'Noto Sans Thai',sans-serif">${c}</button>`).join('')}
    </div>`;
    
    // กรองตามหมวดหมู่ที่เลือก
    let filteredHabits=window.habitCatFilter?allHabits.filter(h=>(h.category||'ทั่วไป')===window.habitCatFilter):allHabits;
    
    // เรียงตามสถานะ (0 ก่อน แล้วค่อย 1, 2, ...)
    filteredHabits.sort((a,b)=>(a.statusData.status||0)-(b.statusData.status||0));
    
    let html=filterHtml+'<div style="display:grid;gap:8px">';
    filteredHabits.forEach(h=>{
        const status=statusConfig.find(s=>s.id===(h.statusData.status||0));
        const startDate=h.statusData.startedAt?new Date(h.statusData.startedAt):null;
        let daysText='';
        if(startDate&&(h.statusData.status||0)>0){
            const diffMs=new Date()-startDate;
            const days=Math.floor(diffMs/(1000*60*60*24))+1; // +1 เพราะวันแรกนับเป็น 1 วัน
            daysText=days===1?'วันแรก':days+' วัน';
        }
        html+=`<div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,0.04)">
            <div style="display:flex;align-items:flex-start;gap:12px">
                <div style="width:8px;height:8px;border-radius:50%;background:${status?status.color:'#ccc'};margin-top:5px;flex-shrink:0"></div>
                <div style="flex:1;min-width:0">
                    <div style="font-size:var(--text-2xs);color:var(--txt);line-height:1.5">${h.text}</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap">
                        <span style="font-size:var(--text-3xs);color:var(--txt3)">${h.surahName}</span>
                        <span style="font-size:var(--text-3xs);padding:3px 8px;border-radius:12px;background:${status?status.color:'#ccc'}15;color:${status?status.color:'#666'};font-weight:500">${status?status.label:'-'}${daysText?' • '+daysText:''}</span>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
                    <button onclick="event.stopPropagation();showHabitCalendar('${h.key}','${h.text.replace(/'/g,"\\'")}')" style="width:32px;height:32px;border:none;background:#f5f5f5;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent" title="ดูปฏิทิน"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#888" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></button>
                    <select onchange="updateHabitStatusData('${h.key}',this.value)" style="font-size:var(--text-3xs);padding:6px 8px;border:1px solid #e8e8e8;border-radius:8px;background:#fff;cursor:pointer;min-width:75px;color:var(--txt);font-family:'Noto Sans Thai',sans-serif">
                        ${statusConfig.map(s=>`<option value="${s.id}" ${(h.statusData.status||0)==s.id?'selected':''}>${s.label}</option>`).join('')}
                    </select>
                </div>
            </div>
        </div>`;
    });
    html+='</div>';
    container.innerHTML=html;
}

window.habitCatFilter=null;
function filterHabitCat(cat){window.habitCatFilter=cat;renderHabitsFullSection();}

function renderHabitHistory(history,statusConfig){
    if(!history||history.length===0)return '';
    return history.slice(-5).map(h=>{
        const cfg=statusConfig.find(s=>s.id===h.to);
        return `<span style="display:inline-block;width:16px;height:6px;background:${cfg?cfg.color:'#ccc'};border-radius:3px;margin-right:2px" title="${cfg?cfg.label:''}"></span>`;
    }).join('');
}

function showHabitCalendar(key,text,monthOffset=0){
    window.habitCalKey=key;
    window.habitCalText=text;
    window.habitCalMonthOffset=monthOffset||0;
    
    const habitStatusData=get('habitStatusData',{});
    const data=habitStatusData[key]||{status:0,history:[]};
    const statusConfig=[
        {id:0,label:'ยังไม่เริ่ม',color:'#9e9e9e'},
        {id:1,label:'วางแผน + ดุอาอ์',color:'#ff9800'},
        {id:2,label:'ฝืนทน ระดับ 5',color:'#f44336'},
        {id:3,label:'ฝืนทน ระดับ 4',color:'#ff5722'},
        {id:4,label:'ง่ายขึ้น ระดับ 3',color:'#ffc107'},
        {id:5,label:'ง่ายขึ้น ระดับ 2',color:'#8bc34a'},
        {id:6,label:'เป็นนิสัยแล้ว',color:'#4caf50'}
    ];
    
    const history=data.history||[];
    const currentCfg=statusConfig.find(s=>s.id===(data.status||0));
    const startDate=data.startedAt?new Date(data.startedAt):null;
    let currentDays=0;
    let currentDaysText='';
    if(startDate&&(data.status||0)>0){
        const diffMs=new Date()-startDate;
        currentDays=Math.floor(diffMs/(1000*60*60*24))+1; // +1 เพราะวันแรกนับเป็น 1 วัน
        currentDaysText=currentDays===1?'วันแรก':currentDays+' วัน';
    }
    
    // สร้างปฏิทินตาม offset
    const now=new Date();
    const targetDate=new Date(now.getFullYear(),now.getMonth()+window.habitCalMonthOffset,1);
    const year=targetDate.getFullYear();
    const month=targetDate.getMonth();
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();
    const monthNames=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
    
    // สร้างข้อมูลสีแต่ละวัน
    const dayColors={};
    history.forEach((h,i)=>{
        const startDate=new Date(h.date);
        const endDate=history[i+1]?new Date(history[i+1].date):new Date();
        const cfg=statusConfig.find(s=>s.id===h.to);
        if(cfg){
            for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1)){
                if(d.getMonth()===month&&d.getFullYear()===year){
                    dayColors[d.getDate()]=cfg.color;
                }
            }
        }
    });
    
    let calHtml=`<div style="background:#f8f9fa;border-radius:12px;padding:14px;margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <button onclick="showHabitCalendar('${key}','${text.replace(/'/g,"\\'")}',${window.habitCalMonthOffset-1})" style="width:28px;height:28px;border:none;background:#fff;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#666" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
            <div style="font-size:var(--text-2xs);color:var(--txt);font-weight:600">${monthNames[month]} ${year+543}</div>
            <button onclick="showHabitCalendar('${key}','${text.replace(/'/g,"\\'")}',${window.habitCalMonthOffset+1})" style="width:28px;height:28px;border:none;background:${window.habitCalMonthOffset>=0?'#eee':'#fff'};border-radius:50%;cursor:${window.habitCalMonthOffset>=0?'not-allowed':'pointer'};display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);opacity:${window.habitCalMonthOffset>=0?'0.4':'1'}"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#666" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;font-size:9px;color:var(--txt3);margin-bottom:6px;font-weight:500"><span>อา</span><span>จ</span><span>อ</span><span>พ</span><span>พฤ</span><span>ศ</span><span>ส</span></div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px">`;
    for(let i=0;i<firstDay;i++)calHtml+=`<div></div>`;
    for(let day=1;day<=daysInMonth;day++){
        const color=dayColors[day]||'#e8e8e8';
        const isToday=day===now.getDate()&&month===now.getMonth()&&year===now.getFullYear();
        calHtml+=`<div style="width:26px;height:26px;border-radius:8px;background:${color};display:flex;align-items:center;justify-content:center;font-size:10px;color:${color!=='#e8e8e8'?'#fff':'var(--txt3)'};font-weight:${isToday?'700':'400'};${isToday?'box-shadow:0 0 0 2px #324b4c;':''}margin:0 auto">${day}</div>`;
    }
    calHtml+=`</div></div>`;
    
    // สร้าง timeline แบบ Gantt chart
    let timelineHtml='';
    if(history.length>0){
        let totalDays=0;
        const segments=[];
        history.forEach((h,i)=>{
            const next=history[i+1];
            const endDate=next?new Date(next.date):new Date();
            const startDate=new Date(h.date);
            const days=Math.floor((endDate-startDate)/(1000*60*60*24))+1;
            totalDays+=days;
            const cfg=statusConfig.find(s=>s.id===h.to);
            segments.push({cfg,days,startDate,endDate});
        });
        
        // สร้าง Gantt bar
        let ganttHtml='<div style="display:flex;height:20px;border-radius:10px;overflow:hidden;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08)">';
        segments.forEach(seg=>{
            const percent=(seg.days/totalDays)*100;
            ganttHtml+=`<div style="width:${percent}%;background:${seg.cfg?seg.cfg.color:'#ccc'};display:flex;align-items:center;justify-content:center;font-size:8px;color:#fff;font-weight:600;min-width:${seg.days>3?'auto':'16px'}">${seg.days>5?seg.days+'d':''}</div>`;
        });
        ganttHtml+='</div>';
        
        timelineHtml=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid #eee">
            <div style="font-size:var(--text-3xs);color:var(--txt2);margin-bottom:10px;font-weight:600;display:flex;align-items:center;gap:6px">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="#999" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                การเดินทาง
            </div>
            ${ganttHtml}
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
                ${segments.map(seg=>`<div style="display:flex;align-items:center;gap:3px">
                    <div style="width:8px;height:8px;border-radius:2px;background:${seg.cfg?seg.cfg.color:'#ccc'}"></div>
                    <span style="font-size:9px;color:var(--txt2)">${seg.cfg?seg.cfg.label:''}</span>
                    <span style="font-size:9px;color:var(--txt3)">${seg.days} วัน</span>
                </div>`).join('')}
            </div>
            <div style="margin-top:10px;text-align:center;font-size:var(--text-3xs);color:var(--txt2);padding:8px;background:#f8f9fa;border-radius:8px">รวมทั้งหมด <strong style="color:var(--txt);font-size:var(--text-2xs)">${totalDays}</strong> วัน</div>
        </div>`;
    }
    
    document.getElementById('modal-knowledge-content').innerHTML=`
        <div style="background:linear-gradient(135deg,#b2d7dc 0%,#95b0b4 50%,#b2d7dc 100%);color:#fff;padding:14px;margin:-0px -12px 14px;border-radius:var(--r-lg) var(--r-lg) 0 0;text-align:center">
            <div style="font-size:var(--text-2xs);font-weight:600;line-height:1.5">${text}</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:14px;align-items:stretch">
            <div style="flex:1;text-align:center;padding:12px;background:${currentCfg?currentCfg.color:'#ccc'}12;border-radius:10px">
                <div style="font-size:var(--text-xs);font-weight:700;color:${currentCfg?currentCfg.color:'#333'}">${currentCfg?currentCfg.label:'-'}</div>
                <div style="font-size:var(--text-3xs);color:var(--txt3);margin-top:3px">${currentDaysText||'-'}</div>
            </div>
            <button onclick="resetHabitStatus('${key}');closeModal('knowledge')" style="padding:10px 12px;background:#f8f8f8;border:none;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-family:'Noto Sans Thai',sans-serif">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#aaa" stroke-width="2"><path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                <span style="font-size:var(--text-3xs);color:#aaa">รีเซ็ต</span>
            </button>
        </div>
        ${calHtml}
        ${timelineHtml}
    `;
    openModal('knowledge');
}

function getStatusColor(st){
    const colors={0:'#888',1:'#e65100',2:'#c62828',3:'#f57f17',4:'#2e7d32',5:'#1565c0',6:'#7b1fa2'};
    return colors[st]||'#888';
}

function updateHabitStatusData(key,status){
    const habitStatusData=get('habitStatusData',{});
    const newStatus=parseInt(status);
    if(!habitStatusData[key])habitStatusData[key]={status:0,history:[]};
    const oldStatus=habitStatusData[key].status||0;
    if(oldStatus!==newStatus){
        habitStatusData[key].history=habitStatusData[key].history||[];
        habitStatusData[key].history.push({from:oldStatus,to:newStatus,date:new Date().toISOString()});
        habitStatusData[key].status=newStatus;
        habitStatusData[key].startedAt=new Date().toISOString();
    }
    set('habitStatusData',habitStatusData);
    // Migrate old data
    const oldHabitStatus=get('habitStatus',{});
    oldHabitStatus[key]=newStatus;
    set('habitStatus',oldHabitStatus);
    renderHabitsFullSection();
}

function resetHabitStatus(key){
    if(!confirm('รีเซ็ตสถานะนิสัยนี้ ?'))return;
    const habitStatusData=get('habitStatusData',{});
    habitStatusData[key]={status:0,history:[],startedAt:null};
    set('habitStatusData',habitStatusData);
    const oldHabitStatus=get('habitStatus',{});
    oldHabitStatus[key]=0;
    set('habitStatus',oldHabitStatus);
    renderHabitsFullSection();
    toast('รีเซ็ตแล้ว');
}

function updateHabitStatus(key,status){
    const habitStatus=get('habitStatus',{});
    habitStatus[key]=parseInt(status);
    set('habitStatus',habitStatus);
    renderHabitsFullSection();
    toast('อัปเดตสถานะแล้ว');
}

function toggleHabitFromKnowledge(surahNum,habitIdx){
    const d=getSurah(surahNum);
    if(d.habits&&d.habits[habitIdx]){d.habits[habitIdx].done=!d.habits[habitIdx].done;setSurah(surahNum,d);renderHabitsFullSection();renderKnowledge();}
}

let currentOpenModal=null;
function openModal(name){
    document.getElementById('modal-'+name).classList.add('show');
    if(name==='intention')document.getElementById('intention-input').value=getSettings().intention||'';
    if(name==='quotes')renderQuotesList();
    currentOpenModal=name;
    const modal=document.getElementById('modal-'+name);
    let startX=0,startY=0;
    modal.ontouchstart=e=>{startX=e.touches[0].clientX;startY=e.touches[0].clientY;};
    modal.ontouchend=e=>{
        const diffX=e.changedTouches[0].clientX-startX;
        const diffY=e.changedTouches[0].clientY-startY;
        if(Math.abs(diffX)>60&&Math.abs(diffX)>Math.abs(diffY)){closeModal(name);}
    };
}
function closeModal(name){
    document.getElementById('modal-'+name).classList.remove('show');
    // Real-time update เมื่อปิด modal name
    if(name==='name'&&currentEditingName){
        currentEditingName=null;
        renderKnowledge();
    }
    currentOpenModal=null;
}

function editNameFromModal(name){
    closeModal('name');
    
    // รวบรวมทุก source ของพระนามนี้
    let allSources=[];
    
    SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        if(d.names){
            d.names.forEach((n,i)=>{
                if(n.name===name){
                    allSources.push({surahNum:s.n,surahName:s.name,nameIdx:i,isPlus:false,name:n});
                }
            });
        }
    });
    
    PLUS_SURAHS.forEach(s=>{
        const d=getSurah(s.n);
        if(d.names){
            d.names.forEach((n,i)=>{
                if(n.name===name){
                    allSources.push({surahNum:s.n,surahName:s.name+' (Plus)',nameIdx:i,isPlus:true,name:n});
                }
            });
        }
    });
    
    if(allSources.length===0)return;
    
    // เก็บ sources ไว้สำหรับ auto-save
    window.currentEditingAllSources=allSources;
    
    // สร้าง form แก้ไขแยกตาม source
    let formHtml=`<div style="text-align:center;margin-bottom:12px">
        <div style="font-family:'Amiri',serif;font-size:1.5rem;color:var(--pink)">${name}</div>
        <div style="font-size:0.55rem;color:var(--txt3)">${allSources.length} ซูเราะฮ์</div>
    </div>`;
    
    allSources.forEach((src,idx)=>{
        const nm=src.name;
        formHtml+=`<div style="background:#fdf2f5;border-radius:var(--r-sm);padding:10px;margin-bottom:10px">
            <div style="font-size:0.55rem;color:var(--pink);font-weight:600;margin-bottom:8px">${src.surahName} : อายะฮ์ ${nm.ayah||'-'}</div>
            <div style="margin-bottom:6px">
                <label style="font-size:0.5rem;color:var(--txt3)">ความหมาย</label>
                <div contenteditable="true" class="note-edit" id="edit-name-meaning-${idx}" oninput="autoSaveAllNames()" style="min-height:28px;background:#fff;border:1px solid var(--bdr);border-radius:var(--r-xs);padding:6px;font-size:0.65rem">${nm.meaning||''}</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
                <div>
                    <label style="font-size:0.5rem;color:var(--txt3)">ความรู้ที่ได้</label>
                    <div contenteditable="true" class="note-edit" id="edit-name-lesson-${idx}" oninput="autoSaveAllNames()" style="min-height:50px;background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-xs);padding:6px;font-size:0.6rem">${nm.lesson||''}</div>
                </div>
                <div>
                    <label style="font-size:0.5rem;color:var(--txt3)">ดุอาอ์/นิสัย</label>
                    <div contenteditable="true" class="note-edit" id="edit-name-dua-${idx}" oninput="autoSaveAllNames()" style="min-height:50px;background:#fff;border:1px solid var(--pink-l);border-radius:var(--r-xs);padding:6px;font-size:0.6rem">${nm.dua||''}</div>
                </div>
            </div>
        </div>`;
    });
    
    formHtml+=`<div style="text-align:center;margin-top:8px;font-size:0.5rem;color:var(--done)">บันทึกอัตโนมัติทุก source ✓</div>`;
    
    document.getElementById('modal-name-title').textContent='แก้ไขพระนาม';
    document.getElementById('modal-name-body').innerHTML=formHtml;
    setTimeout(()=>openModal('name'),100);
}

let autoSaveAllNamesTimer=null;
function autoSaveAllNames(){
    if(autoSaveAllNamesTimer)clearTimeout(autoSaveAllNamesTimer);
    autoSaveAllNamesTimer=setTimeout(()=>{
        const sources=window.currentEditingAllSources;
        if(!sources)return;
        
        sources.forEach((src,idx)=>{
            const d=getSurah(src.surahNum);
            if(!d.names||!d.names[src.nameIdx])return;
            
            const meaningEl=document.getElementById('edit-name-meaning-'+idx);
            const lessonEl=document.getElementById('edit-name-lesson-'+idx);
            const duaEl=document.getElementById('edit-name-dua-'+idx);
            
            if(meaningEl)d.names[src.nameIdx].meaning=meaningEl.innerHTML;
            if(lessonEl)d.names[src.nameIdx].lesson=lessonEl.innerHTML;
            if(duaEl)d.names[src.nameIdx].dua=duaEl.innerHTML;
            
            setSurah(src.surahNum,d);
        });
        
        renderKnowledge();
    },500);
}

function saveIntention(){const s=getSettings();s.intention=document.getElementById('intention-input').value.trim();set('settings',s);renderIntention();closeModal('intention');toast('บันทึกแล้ว');}

function renderQuotesList(){
    const quotes=getQuotes();
    document.getElementById('quotes-list').innerHTML=quotes.map((q,i)=>`<div style="display:flex;gap:10px;padding:10px;background:var(--card2);border-radius:var(--r-sm);margin-bottom:6px"><div style="flex:1;font-size:0.65rem">${q}</div><button style="background:none;border:none;color:var(--txt3);cursor:pointer" onclick="deleteQuote(${i})">×</button></div>`).join('');
}

function addQuote(){
    const q=document.getElementById('new-quote').value.trim();
    if(!q)return toast('กรุณาใส่ข้อความ');
    const quotes=getQuotes();quotes.push(q);set('quotes',quotes);
    document.getElementById('new-quote').value='';
    renderQuotesList();toast('เพิ่มแล้ว');
}

function deleteQuote(i){const quotes=getQuotes();quotes.splice(i,1);set('quotes',quotes);renderQuotesList();}

function exportData(){
    const data={version:1,exportDate:new Date().toISOString(),username:getUsername(),settings:getSettings(),quotes:getQuotes(),goals:getGoals(),rewards:getRewards(),log:getLog(),history:getHistory(),goalPassed:getGoalPassed(),reviewDone:get('reviewDone',{}),streak:get('streak',0),lastActive:get('lastActive',''),surahs:{}};
    SURAHS.forEach(s=>data.surahs[s.n]=getSurah(s.n));
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const username=getUsername()||'user';
    const safeUsername=username.replace(/[^a-zA-Z0-9ก-๙]/g,'_');
    const a=document.createElement('a');a.href=url;a.download='juz-amma-backup_'+safeUsername+'_'+getLocalDate()+'.json';a.click();
    URL.revokeObjectURL(url);toast('ส่งออกแล้ว');
}

function importData(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const data=JSON.parse(ev.target.result);
            if(data.username)set('username',data.username);
            if(data.settings)set('settings',data.settings);
            if(data.quotes)set('quotes',data.quotes);
            if(data.goals)set('goals',data.goals);
            if(data.rewards)set('rewards',data.rewards);
            if(data.log)set('log',data.log);
            if(data.history)set('history',data.history);
            if(data.goalPassed)set('goalPassed',data.goalPassed);
            if(data.reviewDone)set('reviewDone',data.reviewDone);
            if(data.streak)set('streak',data.streak);
            if(data.lastActive)set('lastActive',data.lastActive);
            if(data.surahs){Object.keys(data.surahs).forEach(n=>setSurah(n,data.surahs[n]));}
            toast('นำเข้าแล้ว');location.reload();
        }catch(err){toast('ไฟล์ไม่ถูกต้อง');}
    };
    reader.readAsText(file);
    e.target.value='';
}

function clearData(){
    if(!confirm('ลบข้อมูลทั้งหมด ?'))return;
    if(!confirm('ยืนยันอีกครั้ง ?'))return;
    localStorage.clear();toast('ลบแล้ว');location.reload();
}

function toast(msg){
    const existing=document.querySelector('.toast');if(existing)existing.remove();
    const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);
    setTimeout(()=>t.remove(),2000);
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>